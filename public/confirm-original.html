<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>クレジット｜最終確認</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root{--bg:#f6f7f9;--card:#fff;--text:#111827;--muted:#6b7280;--line:#e5e7eb;--pri2:#123b66;--danger:#b91c1c;--radius:14px;--shadow:0 1px 3px rgba(0,0,0,.06);}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:860px;margin:0 auto;padding:14px 14px 26px}
    h1{margin:0 0 6px;font-size:18px}
    .muted{color:var(--muted);font-size:13px;line-height:1.5}
    .err{color:var(--danger);font-weight:900;white-space:pre-line}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:12px;margin-top:12px;box-shadow:var(--shadow)}
    .row{display:flex;justify-content:space-between;gap:10px;margin:0;padding:6px 0;font-size:14px}
    .btn{width:100%;border:none;border-radius:14px;padding:12px 14px;font-weight:1000;cursor:pointer;margin-top:10px;background:var(--pri2);color:#fff}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .kv{display:flex;justify-content:space-between;gap:10px;padding:6px 0}
    .kv .k{color:var(--muted);font-size:13px}
    .kv .v{font-weight:1000;font-size:14px;text-align:right}
    #shipAddr{white-space:pre-line}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>クレジット｜最終確認</h1>
    <div class="muted" id="status">読み込み中…</div>

    <div class="card">
      <div class="muted">お支払い方法</div>
      <div style="margin-top:6px;font-weight:1000">クレジット（Stripe決済）</div>
      <div class="muted" style="margin-top:6px">※代引手数料はかかりません。</div>
    </div>

    <div class="card" id="shipCard" style="display:none">
      <div class="muted">お届け先</div>

      <div class="kv" style="margin-top:6px;border-top:1px solid var(--line);padding-top:10px">
        <div class="k">お届け先氏名</div>
        <div class="v" id="shipName">—</div>
      </div>

      <div id="shipAddr" style="font-weight:900;margin-top:6px">—</div>
      <div class="muted" id="shipTel" style="margin-top:6px">—</div>

      <div class="muted" style="margin-top:8px">
        ※住所・氏名の変更は「戻る（内容確認へ）」から行えます。
      </div>
    </div>

    <div class="card">
      <div class="row"><div>小計</div><div id="subtotal">—</div></div>
      <div class="row"><div>送料</div><div id="shipping">—</div></div>
      <div class="row" style="border-top:2px solid var(--line);padding-top:10px">
        <div style="font-weight:1000">合計（クレジット）</div>
        <div style="font-weight:1000;font-size:18px" id="totalCard">—</div>
      </div>

      <button id="submit" class="btn" type="button">クレジット決済へ進む</button>
      <button id="back" class="btn" type="button" style="background:#fff;color:#111827;border:1px solid var(--line)">戻る（内容確認へ）</button>
    </div>
  </div>

<script>
(async function(){
  "use strict";

  const LIFF_ID_ORDER = "2008406620-G5j1gjzM";
  const KEY_UID ="isoya_userId";
  const KEY_LAST_QUOTE = "isoya_last_quote";
  const KEY_STRIPE = "isoya_stripe_payment";

  const qs = new URLSearchParams(location.search);
  const mode = (qs.get("mode")||"").trim();
  const v = (qs.get("v") || "20260205").trim();

  const yen=n=>(Number(n)||0).toLocaleString("ja-JP")+"円";
  const status=document.getElementById("status");
  const subtotalEl=document.getElementById("subtotal");
  const shippingEl=document.getElementById("shipping");
  const totalCardEl=document.getElementById("totalCard");
  const submit=document.getElementById("submit");
  const back=document.getElementById("back");

  const shipCard=document.getElementById("shipCard");
  const shipNameEl=document.getElementById("shipName");
  const shipAddrEl=document.getElementById("shipAddr");
  const shipTelEl=document.getElementById("shipTel");

  function loadJson(k){ try{return JSON.parse(localStorage.getItem(k)||"");}catch{return null;} }

  function showErr(title, err){
    const msg = (err && err.message) ? err.message : String(err);
    status.classList.remove("muted");
    status.classList.add("err");
    status.textContent = `${title}\n${msg}`;
  }

  async function fetchJson(url){
    const r = await fetch(url, { cache: "no-store" });
    const text = await r.text();
    let d = null;
    try { d = JSON.parse(text); } catch { /* ignore */ }
    if(!r.ok){
      const detail = d?.error || d?.message || text || ("HTTP " + r.status);
      throw new Error(`URL: ${url}\nHTTP ${r.status}\n${detail}`);
    }
    return d ?? {};
  }

  function pickName(addr){
    const candidates = [
      addr?.name, addr?.full_name, addr?.fullName,
      addr?.recipient_name, addr?.recipientName,
      addr?.customer_name, addr?.customerName,
      addr?.receiver_name, addr?.receiverName,
      addr?.to_name, addr?.toName,
      addr?.addressee, addr?.display_name, addr?.displayName,
    ];
    const s = candidates.find(v => typeof v === "string" && v.trim());
    return (s || "").trim();
  }

  async function getAddress(userId){
    const d = await fetchJson(`/api/address/get?userId=${encodeURIComponent(userId)}`);
    return d?.address || d?.addr || d?.data?.address || null;
  }

  async function ensureUserSoft(){
    const cached=(localStorage.getItem(KEY_UID)||"").trim();
    if(cached) return cached;
    await liff.init({ liffId: LIFF_ID_ORDER });
    if(!liff.isLoggedIn()) return null;
    const prof=await liff.getProfile();
    const uid=(prof?.userId||"").trim();
    if(uid) localStorage.setItem(KEY_UID, uid);
    return uid||null;
  }

  const KEY_CART =
    (mode === "original") ? "isoya_cart_original"
  : (mode === "fukubako" || mode === "trial") ? "isoya_cart_fukubako"
  : (mode === "store") ? "isoya_cart_store"
  : "isoya_cart";

  const RETURN_CONFIRM =
    (mode === "fukubako" || mode === "trial") ? "/confirm.html?mode=fukubako"
  : (mode === "original") ? "/confirm-original.html"
  : (mode === "store") ? "/confirm.html?mode=store"
  : "/confirm.html";

  try{
    const uid = await ensureUserSoft();
    if(!uid){
      showErr("ユーザー情報が取得できません。", "商品ページから開き直してください。");
      return;
    }

    const quote = loadJson(KEY_LAST_QUOTE);
    if(!quote){
      showErr("見積情報がありません。", "確認画面へ戻ってください。");
      return;
    }

    const shipping = Number(quote.shippingFee ?? quote.shipping_fee ?? 0);
    const subtotal = Number(quote.subtotal ?? 0);
    const totalCard = subtotal + shipping;

    subtotalEl.textContent = yen(subtotal);
    shippingEl.textContent = yen(shipping);
    totalCardEl.textContent = yen(totalCard);

    let addr = null;
    try { addr = await getAddress(uid); } catch(e){ /* ignore */ }
    if(addr){
      const name = pickName(addr);
      const body = `〒${addr.postal||""} ${addr.prefecture||""}${addr.city||""}${addr.address1||""} ${addr.address2||""}`.trim();
      const tel = String(addr.phone || addr.tel || "").trim();

      shipCard.style.display = "block";
      shipNameEl.textContent = name || "（未入力）";
      shipAddrEl.textContent = body || "（住所未入力）";
      shipTelEl.textContent  = tel ? ("TEL: " + tel) : "";
    }else{
      shipCard.style.display = "none";
    }

    status.classList.remove("err");
    status.classList.add("muted");
    status.textContent="最終確認をお願いします。";

    back.onclick = ()=> {
      const u = new URL(RETURN_CONFIRM, location.origin);
      if(v) u.searchParams.set("v", v);
      location.href = u.toString();
    };

    submit.onclick = async ()=> {
      submit.disabled = true;
      submit.textContent = "準備中…";
      try{
        const cart = loadJson(KEY_CART) || {items:[]};
        const items = (Array.isArray(cart.items) ? cart.items : []).filter(x=>x?.id && Number(x.qty||0)>0);
        if(items.length===0) throw new Error("カートが空です。");

        const r = await fetch("/api/pay/stripe/intent",{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ uid, checkout:{ items }, mode })
        });

        const text = await r.text();
        let d = {};
        try{ d = JSON.parse(text); }catch{ d = {}; }
        if(!r.ok) throw new Error(d?.error || d?.message || text || ("HTTP "+r.status));
        if(!d?.clientSecret) throw new Error("clientSecret missing");

        localStorage.setItem(KEY_STRIPE, JSON.stringify({
          clientSecret: d.clientSecret,
          mode,
          createdAt: Date.now()
        }));

        const q = new URLSearchParams();
        if(mode) q.set("mode", mode);     // ✅ mode=（空）を作らない
        if(v) q.set("v", v);
        location.href = `/pay-card.html?${q.toString()}`;

      }catch(e){
        alert("クレジット決済の準備に失敗しました: " + (e?.message||e));
        submit.disabled = false;
        submit.textContent = "クレジット決済へ進む";
      }
    };

  }catch(e){
    console.error(e);
    showErr("読み込みに失敗しました。", e);
  }
})();
</script>
</body>
</html>
<!-- confirm_card.html patched -->
