<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>送料・合計金額の目安</title>

<style>
  :root{
    --bg:#f7f7f7; --card:#fff; --text:#111827; --muted:#6b7280;
    --line:#e5e7eb; --pri:#0b3a53; --danger:#b91c1c;
    --radius:14px; --shadow:0 1px 3px rgba(0,0,0,.08);
  }
  *{ box-sizing:border-box; }
  body{
    margin:0; padding:16px;
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    background:var(--bg); color:var(--text);
  }
  .wrap{ max-width:760px; margin:0 auto; }
  h1{ font-size:20px; margin:0 0 12px; }

  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:var(--radius);
    padding:14px;
    margin-bottom:12px;
    box-shadow:var(--shadow);
  }

  label{
    font-size:13px;
    font-weight:900;
    display:block;
    margin:10px 0 6px;
  }

  select,input{
    width:100%;
    padding:11px 12px;
    font-size:15px;
    border-radius:12px;
    border:1px solid #d1d5db;
    background:#fff;
  }

  .row{ display:flex; gap:10px; flex-wrap:wrap; }
  .col{ flex:1; min-width:220px; }

  button{
    width:100%;
    padding:14px 12px;
    font-size:16px;
    border-radius:14px;
    border:0;
    background:var(--pri);
    color:#fff;
    font-weight:900;
    cursor:pointer;
    box-shadow:0 6px 18px rgba(11,58,83,.18);
  }
  button:disabled{
    opacity:.55;
    cursor:not-allowed;
    box-shadow:none;
  }

  .result{
    font-size:15px;
    line-height:1.8;
  }

  .big{
    font-size:18px;
    font-weight:900;
    margin-top:6px;
  }

  .hr{
    height:1px;
    background:#eee;
    margin:10px 0;
  }

  .muted{
    font-size:12px;
    color:var(--muted);
  }

  .err{
    color:var(--danger);
    font-weight:900;
  }
</style>
</head>

<body>
<div class="wrap">

  <h1>送料・合計金額の目安</h1>

  <!-- お届け先 -->
  <div class="card">
    <label>お届け先（都道府県）</label>
    <select id="pref">
      <option value="">選択してください</option>
      <option>北海道</option><option>青森県</option><option>岩手県</option><option>宮城県</option>
      <option>秋田県</option><option>山形県</option><option>福島県</option>
      <option>茨城県</option><option>栃木県</option><option>群馬県</option><option>埼玉県</option>
      <option>千葉県</option><option>東京都</option><option>神奈川県</option>
      <option>新潟県</option><option>富山県</option><option>石川県</option><option>福井県</option>
      <option>長野県</option><option>岐阜県</option><option>静岡県</option><option>愛知県</option><option>三重県</option>
      <option>滋賀県</option><option>京都府</option><option>大阪府</option>
      <option>兵庫県</option><option>奈良県</option><option>和歌山県</option>
      <option>鳥取県</option><option>島根県</option><option>岡山県</option><option>広島県</option><option>山口県</option>
      <option>徳島県</option><option>香川県</option><option>愛媛県</option><option>高知県</option>
      <option>福岡県</option><option>佐賀県</option><option>長崎県</option><option>熊本県</option>
      <option>大分県</option><option>宮崎県</option><option>鹿児島県</option><option>沖縄県</option>
    </select>
  </div>

  <!-- 商品 -->
  <div class="card">
    <div class="row">
      <div class="col">
        <label>商品</label>
        <select id="productId">
          <option value="">読み込み中…</option>
        </select>
      </div>

      <div class="col">
        <label>数量</label>
        <input type="number" id="qty" min="1" step="1" value="1" />
      </div>
    </div>

    <p class="muted" style="margin-top:10px">
      ※表示される金額は目安です。最終金額は注文確定時に確定します。
    </p>
  </div>

  <div class="card">
    <button id="calcBtn" type="button">送料を確認する</button>
  </div>

  <div class="card">
    <div id="result" class="result">―</div>
  </div>

</div>

<script>
(function(){
  "use strict";

  const $ = (id)=>document.getElementById(id);
  const prefEl = $("pref");
  const productEl = $("productId");
  const qtyEl = $("qty");
  const btn = $("calcBtn");
  const result = $("result");

  const yen = (n)=> (Number(n)||0).toLocaleString("ja-JP") + "円";

  function setBusy(b){
    btn.disabled = b;
    btn.textContent = b ? "計算中…" : "送料を確認する";
  }

  function showErr(msg){
    result.innerHTML = `<span class="err">${escapeHtml(msg)}</span>`;
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  async function loadProducts(){
    try{
      productEl.innerHTML = `<option value="">読み込み中…</option>`;

      // DBが正：/api/products から取得して select を生成（IDハードコード禁止）
      const res = await fetch(location.origin + "/api/products", { method:"GET" });
      const d = await res.json();

      if(!res.ok || !d.ok || !Array.isArray(d.products)){
        throw new Error("products_api_error");
      }

      // 表示順：オリジナルセット→あかしゃ→久助（ざっくり優先）
      const priority = (id)=>{
        if(id === "original-set-2000") return 0;
        if(id.includes("akasha")) return 1;
        if(id.includes("kusuke")) return 2;
        return 9;
      };

      const products = d.products
        .filter(p => p && p.id && (p.is_active === undefined || p.is_active === true))
        .sort((a,b)=>{
          const pa = priority(String(a.id));
          const pb = priority(String(b.id));
          if(pa !== pb) return pa - pb;
          return String(a.id).localeCompare(String(b.id), "ja");
        });

      const opts = [`<option value="">選択してください</option>`];
      for(const p of products){
        const id = String(p.id);
        const name = String(p.name || p.id);

        // 今回の対象だけに絞りたい場合はここでフィルタ可能
        // if(!(id.includes("akasha") || id.includes("kusuke") || id.includes("original-set"))) continue;

        opts.push(`<option value="${escapeHtml(id)}">${escapeHtml(name)}</option>`);
      }

      productEl.innerHTML = opts.join("");
    }catch(e){
      productEl.innerHTML = `<option value="">商品を取得できませんでした</option>`;
    }
  }

  async function calc(){
    const pref = prefEl.value;
    const productId = productEl.value;
    const qty = Math.max(1, Math.floor(Number(qtyEl.value || 1)));
    qtyEl.value = qty;

    if(!pref || !productId){
      showErr("お届け先・商品・数量を選択してください。");
      return;
    }

    setBusy(true);
    result.textContent = "計算中…";

    try{
      const res = await fetch(location.origin + "/api/shipping/quote", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          pref,
          // DBの product_id をそのまま送る（変換禁止）
          items:[{ product_id: productId, qty }],
          // strict=true：ルール未設定はエラー（100に逃げない）
          strict:true
        })
      });

      const d = await res.json();

      if(!res.ok || !d.ok){
        // サーバが詳細を返す場合に備えて表示（無ければ汎用）
        const msg = d && (d.message || d.error) ? String(d.message || d.error) : "送料を計算できませんでした。内容を変更してお試しください。";
        showErr(msg);
        return;
      }

      result.innerHTML =
        `お届け先：<b>${escapeHtml(d.region)}</b><br>` +
        `配送サイズ：<b>${escapeHtml(d.size)}サイズ</b><br>` +
        `<div class="hr"></div>` +
        `商品合計：<b>${yen(d.subtotal)}</b><br>` +
        `送料：<b>${yen(d.shipping_fee)}</b><br>` +
        `<div class="big">合計金額の目安：${yen(d.total)}</div>`;

    }catch(e){
      showErr("送料を計算できませんでした。しばらくしてからお試しください。");
    }finally{
      setBusy(false);
    }
  }

  // 初期ロード
  loadProducts();

  btn.addEventListener("click", calc);
})();
</script>

</body>
</html>
