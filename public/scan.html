<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#111111" />
  <title>Scan（発送通知）</title>
  <style>
    :root{
      --bg:#0b0b0c; --card:#141416; --muted:#9aa0a6; --text:#f5f5f7;
      --danger:#ff4d4f; --ok:#35c759; --line:#2a2a2d; --btn:#1f1f22; --accent:#4da3ff;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-left: env(safe-area-inset-left, 0px);
      --safe-right: env(safe-area-inset-right, 0px);
      --vh: 1dvh;
    }
    *{ box-sizing:border-box; }
    html,body{ margin:0; padding:0; background:var(--bg); color:var(--text);
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif; overscroll-behavior:none; }
    body{ min-height: calc(var(--vh) * 100);
      padding: calc(12px + var(--safe-top)) calc(12px + var(--safe-left)) calc(14px + var(--safe-bottom)) calc(12px + var(--safe-right)); }

    .wrap{ max-width: 920px; margin:0 auto; display:flex; flex-direction:column; gap:12px; }
    .header{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .title{ font-size:16px; font-weight:700; letter-spacing:.3px; }
    .sub{ font-size:12px; color:var(--muted); margin-top:2px; }

    .card{ background:var(--card); border:1px solid var(--line); border-radius:16px; padding:12px; box-shadow:0 10px 22px rgba(0,0,0,.25); }

    .videoWrap{ position:relative; border-radius:16px; overflow:hidden; background:#000; border:1px solid var(--line);
      height: clamp(280px, 52dvh, 560px); }
    /* ✅ coverだと切れることがあるので contain（解析に有利） */
    video{ width:100%; height:100%; object-fit: contain; background:#000; }

    .reticle{ pointer-events:none; position:absolute; inset:0; display:flex; align-items:center; justify-content:center; }
    /* ✅ 線バーコード用：横長・薄め */
    .reticle > div{
      width: min(78vw, 620px);
      height: min(16vh, 120px);
      border:2px solid rgba(255,255,255,.65);
      border-radius:14px;
      box-shadow:0 0 0 9999px rgba(0,0,0,.25);
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .btn{
      appearance:none; border:1px solid var(--line); background:var(--btn); color:var(--text);
      padding:14px 14px; border-radius:14px; font-weight:700; font-size:14px; min-height:48px;
      cursor:pointer; user-select:none; touch-action:manipulation;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{ background: linear-gradient(180deg, #2a6dff, #2a50ff); border-color: rgba(77,163,255,.35); }
    .btn.danger{ background:#2a1212; border-color: rgba(255,77,79,.35); color:#ffd7d7; }
    .btn.ghost{ background:transparent; }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }

    .input{
      width:100%; padding:14px 14px; border-radius:14px; border:1px solid var(--line);
      background:#0f0f11; color:var(--text); font-size:16px; outline:none; min-height:48px;
    }
    .hint{ font-size:12px; color:var(--muted); line-height:1.35; }
    .status{ font-size:12px; color:var(--muted); display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .pill{ padding:6px 10px; border-radius:999px; background:#0f0f11; border:1px solid var(--line); color:var(--muted); font-size:12px; }
    .pill.ok{ color:#caffd8; border-color: rgba(53,199,89,.35); }
    .pill.bad{ color:#ffd0d0; border-color: rgba(255,77,79,.35); }

    .grid2{ display:grid; grid-template-columns:1fr; gap:12px; }
    @media (min-width: 760px){
      .grid2{ grid-template-columns: 1.2fr .8fr; align-items:start; }
      .videoWrap{ height: clamp(420px, 62dvh, 620px); }
    }
    .controls{ display:flex; flex-direction:column; gap:10px; }
    .log{
      font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;
      font-size:12px; background:#0f0f11; border:1px solid var(--line); border-radius:14px;
      padding:10px; max-height:260px; overflow:auto; white-space:pre-wrap; word-break:break-word;
    }

    .toast{ position:fixed; left:12px; right:12px; bottom: calc(12px + var(--safe-bottom));
      display:flex; justify-content:center; pointer-events:none; z-index:9999; }
    .toast > div{
      pointer-events:auto; max-width:920px; width:100%;
      background: rgba(20,20,22,.96); border:1px solid var(--line); border-radius:14px; padding:12px;
      box-shadow:0 12px 28px rgba(0,0,0,.35);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      opacity:0; transform: translateY(10px); transition:.18s ease;
    }
    .toast.show > div{ opacity:1; transform: translateY(0); }
    .toast strong{ color:var(--text); }
    .toast .small{ color:var(--muted); font-size:12px; }

    .sliderRow{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    input[type="range"]{ width:180px; accent-color: var(--accent); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div>
        <div class="title">発送スキャン（追跡番号 → shipped → 即通知）</div>
        <div class="sub">バーコード → <code>/api/admin/ship/scan-and-notify</code></div>
      </div>
      <div class="status">
        <span id="camPill" class="pill">camera: idle</span>
        <span id="netPill" class="pill">api: -</span>
        <span id="zxPill"  class="pill">zxing: -</span>
      </div>
    </div>

    <div class="grid2">
      <div class="card">
        <div class="videoWrap">
          <video id="video" playsinline muted></video>
          <div class="reticle"><div></div></div>
        </div>

        <div style="height:10px"></div>

        <div class="row">
          <button id="btnStart" class="btn primary" type="button">カメラ開始</button>
          <button id="btnStop" class="btn danger" type="button" disabled>停止</button>
          <button id="btnTorch" class="btn" type="button" disabled>ライト</button>
          <button id="btnSwitch" class="btn" type="button" disabled>カメラ切替</button>
        </div>

        <div style="height:8px"></div>

        <div class="sliderRow">
          <div class="hint">ズーム</div>
          <input id="zoom" type="range" min="1" max="1" step="0.1" value="1" disabled />
          <span id="zoomLabel" class="pill">x1.0</span>
          <span class="hint">※対応端末のみ</span>
        </div>

        <div style="height:8px"></div>
        <div class="hint">
          線バーコードは <b>枠いっぱいに横長</b>＋<b>20〜25cm</b>＋<b>0.5秒静止</b> が一番通る。反射は少し斜め。
        </div>
      </div>

      <div class="card controls">
        <div>
          <div style="font-weight:700; margin-bottom:6px;">管理トークン</div>
          <input id="token" class="input" type="password" placeholder="X-Admin-Token（必須）" autocomplete="off" />
          <div class="hint">サーバの <code>ADMIN_API_TOKEN</code> / <code>ADMIN_CODE</code> と同じ値</div>
        </div>

        <div>
          <div style="font-weight:700; margin-bottom:6px;">追跡番号（手入力もOK）</div>
          <input id="code" class="input" inputmode="numeric" placeholder="例：489518570015" />
          <div class="hint">数字以外は自動で除去（8〜16桁）</div>
        </div>

        <div class="row">
          <button id="btnSend" class="btn primary" type="button">送信（通知）</button>
          <button id="btnClear" class="btn ghost" type="button">クリア</button>
        </div>

        <div style="font-weight:700;">ログ</div>
        <div id="log" class="log"></div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"><div>
    <div>
      <strong id="toastTitle">-</strong><div class="small" id="toastMsg">-</div>
    </div>
    <button id="toastBtn" class="btn" type="button" style="min-height:40px; padding:10px 12px;">OK</button>
  </div></div>

  <!-- ✅ ZXing（ローカル） -->
  <script src="/vendor/zxing/library.min.js"></script>
  <script src="/vendor/zxing/browser.min.js"></script>
  <script>window.ZXing = window.ZXing || window.ZXingBrowser;</script>

  <script>
    (function setVh(){
      const v = window.visualViewport;
      const h = v ? v.height : window.innerHeight;
      document.documentElement.style.setProperty('--vh', (h * 0.01) + 'px');
    })();
    window.addEventListener('resize', () => {
      const v = window.visualViewport;
      const h = v ? v.height : window.innerHeight;
      document.documentElement.style.setProperty('--vh', (h * 0.01) + 'px');
    });

    const $ = (id) => document.getElementById(id);

    const logEl = $("log");
    const video = $("video");

    const btnStart  = $("btnStart");
    const btnStop   = $("btnStop");
    const btnTorch  = $("btnTorch");
    const btnSwitch = $("btnSwitch");
    const btnSend   = $("btnSend");
    const btnClear  = $("btnClear");

    const tokenEl = $("token");
    const codeEl  = $("code");

    const camPill = $("camPill");
    const netPill = $("netPill");
    const zxPill  = $("zxPill");

    const zoomEl = $("zoom");
    const zoomLabel = $("zoomLabel");

    const toast = $("toast");
    const toastTitle = $("toastTitle");
    const toastMsg = $("toastMsg");
    const toastBtn = $("toastBtn");

    function log(...args){
      const line = args.map(x => (typeof x === 'string' ? x : JSON.stringify(x))).join(' ');
      const t = new Date();
      const ts = t.toLocaleString('sv-SE', { timeZone: 'Asia/Tokyo' }).replace('T',' ');
      logEl.textContent = `[${ts}] ${line}\n` + logEl.textContent;
    }

    function showToast(title, msg){
      toastTitle.textContent = title;
      toastMsg.textContent = msg || '';
      toast.classList.add('show');
    }
    toastBtn.addEventListener('click', () => toast.classList.remove('show'));

    function setPill(el, label, ok=null){
      el.textContent = label;
      el.classList.remove('ok','bad');
      if(ok === true) el.classList.add('ok');
      if(ok === false) el.classList.add('bad');
    }
    const setCam = (t, ok=null) => setPill(camPill, `camera: ${t}`, ok);
    const setNet = (t, ok=null) => setPill(netPill, `api: ${t}`, ok);
    const setZx  = (t, ok=null) => setPill(zxPill,  `zxing: ${t}`, ok);

    // ===== state =====
    let stream = null;
    let track  = null;
    let usingDeviceId = null;
    let deviceIds = [];
    let torchOn = false;

    let reader = null;
    let scanning = false;
    let lastScanAt = 0;
    let lastApiAt  = 0;

    function normalizeTracking(v){
      return String(v || '').replace(/\s+/g,'').replace(/\D/g,'');
    }
    function isValidTracking(v){
      return /^\d{8,16}$/.test(v);
    }

    function zxingReady(){
      return (typeof window.ZXing !== 'undefined') && !!ZXing.BrowserMultiFormatReader;
    }

    function makeReader(){
      const hints = new Map();
      // ✅ ヤマト系：CODE128/ITFを最優先（絞るほど強い）
      hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
        ZXing.BarcodeFormat.CODE_128,
        ZXing.BarcodeFormat.ITF
      ]);
      hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
      hints.set(ZXing.DecodeHintType.ALSO_INVERTED, true);

      // delayBetweenScanAttempts: 250〜350 がブレ耐性良い
      return new ZXing.BrowserMultiFormatReader(hints, 300);
    }

    async function listVideoDevices(){
      const devices = await navigator.mediaDevices.enumerateDevices();
      const cams = devices.filter(d => d.kind === 'videoinput');
      deviceIds = cams.map(c => c.deviceId).filter(Boolean);
      return cams;
    }

    async function applyBestConstraints(){
      if(!track) return;

      // ✅ 可能なら「連続オートフォーカス/露出」を有効化
      try{
        const caps = track.getCapabilities ? track.getCapabilities() : {};
        const adv = [];

        // focusMode が取れる端末だけ
        if(caps.focusMode && Array.isArray(caps.focusMode)){
          if(caps.focusMode.includes('continuous')) adv.push({ focusMode: 'continuous' });
          else if(caps.focusMode.includes('auto'))   adv.push({ focusMode: 'auto' });
        }
        if(caps.exposureMode && Array.isArray(caps.exposureMode)){
          if(caps.exposureMode.includes('continuous')) adv.push({ exposureMode: 'continuous' });
        }
        if(caps.whiteBalanceMode && Array.isArray(caps.whiteBalanceMode)){
          if(caps.whiteBalanceMode.includes('continuous')) adv.push({ whiteBalanceMode: 'continuous' });
        }

        if(adv.length){
          await track.applyConstraints({ advanced: adv });
          log('applied advanced constraints', adv);
        }
      }catch(e){
        log('applyBestConstraints failed', e?.message || e);
      }

      // ✅ 初期ズーム（最大3.0まで：線バーコードに効く）
      try{
        const caps = track.getCapabilities ? track.getCapabilities() : {};
        if(caps.zoom){
          const z = Math.min(3.0, caps.zoom.max || 3.0);
          await track.applyConstraints({ advanced: [{ zoom: z }] });
          zoomLabel.textContent = `x${Number(z).toFixed(1)}`;
        }
      }catch{}
    }

    async function refreshZoomUI(){
      zoomEl.disabled = true;
      zoomEl.min = 1; zoomEl.max = 1; zoomEl.value = 1;
      zoomLabel.textContent = 'x1.0';

      btnTorch.disabled = true;

      if(!track) return;

      try{
        const caps = track.getCapabilities ? track.getCapabilities() : {};
        const settings = track.getSettings ? track.getSettings() : {};

        if(caps && caps.zoom){
          zoomEl.disabled = false;
          zoomEl.min = caps.zoom.min || 1;
          zoomEl.max = caps.zoom.max || 1;
          zoomEl.step = caps.zoom.step || 0.1;
          const z = settings.zoom || 1;
          zoomEl.value = z;
          zoomLabel.textContent = `x${Number(z).toFixed(1)}`;
        }
        if(caps && 'torch' in caps){
          btnTorch.disabled = false;
        }
      }catch(e){
        log('refreshZoomUI failed', e?.message || e);
      }
    }

    async function startCamera(preferredDeviceId=null){
      if(scanning) return;

      const zxOk = zxingReady();
      setZx(zxOk ? 'ok' : 'missing', zxOk);
      if(!zxOk){
        showToast('ZXingが読み込めていません', 'library.min.js / browser.min.js の配置とパスを確認して');
        return;
      }

      if(!navigator.mediaDevices?.getUserMedia){
        showToast('この端末ではカメラが使えません', '別の端末/ブラウザで試して');
        return;
      }

      setCam('starting...', null);
      log('startCamera...');

      const constraints = {
        audio:false,
        video:{
          facingMode:{ ideal:'environment' },
          width:  { ideal: 1920 },
          height: { ideal: 1080 }
        }
      };
      if(preferredDeviceId){
        constraints.video.deviceId = { exact: preferredDeviceId };
        delete constraints.video.facingMode;
      }

      try{
        stream = await navigator.mediaDevices.getUserMedia(constraints);
      }catch(e){
        log('getUserMedia failed', e?.name || String(e));
        showToast('カメラ開始に失敗', '権限/HTTPS/別ブラウザを確認して');
        setCam('failed', false);
        return;
      }

      video.srcObject = stream;
      video.setAttribute('autoplay','');
      video.setAttribute('playsinline','');

      try{ await video.play(); }catch(e){ log('video.play failed', e?.message || e); }

      track = stream.getVideoTracks()[0] || null;
      if(!track){
        showToast('カメラトラックが取れない', '');
        setCam('no track', false);
        return;
      }

      try{
        const s = track.getSettings ? track.getSettings() : {};
        usingDeviceId = s.deviceId || preferredDeviceId || null;
        log('camera settings', s);
      }catch{}

      await applyBestConstraints();
      await refreshZoomUI();

      reader = makeReader();
      scanning = true;
      setCam('running', true);
      setZx('zxing-only', true);

      // ✅ 連続デコード（video element）
      reader.decodeFromVideoElementContinuously(video, (result, err) => {
        if(!scanning) return;

        if(result){
          const raw = result.getText();
          const code = normalizeTracking(raw);

          const now = Date.now();
          if(now - lastScanAt < 800) return;
          lastScanAt = now;

          codeEl.value = code;
          log('scanned:', raw, '->', code);

          if(!isValidTracking(code)){
            showToast('桁が違う', `取得: ${code}（8〜16桁のみ）`);
            return;
          }

          try{ navigator.vibrate && navigator.vibrate(30); }catch{}
          sendScan(code).catch(()=>{});
          return;
        }

        // NotFoundは通常（無視）
        if(err){
          const name = err.name || err.constructor?.name || '';
          if(name && name !== 'NotFoundException'){
            log('decode err:', name, err.message || String(err));
          }
        }
      });

      btnStart.disabled = true;
      btnStop.disabled = false;

      btnSwitch.disabled = true;
      try{
        const cams = await listVideoDevices();
        if((cams || []).length >= 2) btnSwitch.disabled = false;
      }catch{}
    }

    async function stopCamera(){
      scanning = false;

      try{ reader && reader.reset && reader.reset(); }catch{}
      reader = null;

      if(stream){
        for(const t of stream.getTracks()){
          try{ t.stop(); }catch{}
        }
      }
      stream = null;
      track = null;
      usingDeviceId = null;
      torchOn = false;

      btnStart.disabled = false;
      btnStop.disabled = true;
      btnTorch.disabled = true;
      btnSwitch.disabled = true;
      zoomEl.disabled = true;

      setCam('stopped', null);
      log('camera stopped');
    }

    async function toggleTorch(){
      if(!track){
        showToast('カメラが未開始', '先に「カメラ開始」');
        return;
      }
      try{
        const caps = track.getCapabilities ? track.getCapabilities() : {};
        if(!caps || !('torch' in caps)){
          showToast('ライト非対応', 'この端末/ブラウザはtorch制御できない');
          return;
        }
        torchOn = !torchOn;
        await track.applyConstraints({ advanced: [{ torch: torchOn }] });
        btnTorch.textContent = torchOn ? 'ライトON' : 'ライト';
        log('torch', torchOn ? 'on' : 'off');
      }catch(e){
        log('torch failed', e?.message || e);
        showToast('ライト切替失敗', '端末制限でできない場合あり');
      }
    }

    async function switchCamera(){
      try{
        const cams = await listVideoDevices();
        if((cams || []).length < 2){
          showToast('カメラが1つしかない', '');
          return;
        }
        const idx = deviceIds.indexOf(usingDeviceId);
        const nextId = deviceIds[(idx >= 0 ? idx+1 : 0) % deviceIds.length];
        log('switch camera', usingDeviceId, '->', nextId);
        await stopCamera();
        await startCamera(nextId);
      }catch(e){
        log('switchCamera failed', e?.message || e);
        showToast('カメラ切替失敗', '停止→開始で試して');
      }
    }

    async function setZoom(val){
      if(!track) return;
      try{
        const z = Number(val);
        await track.applyConstraints({ advanced: [{ zoom: z }] });
        zoomLabel.textContent = `x${z.toFixed(1)}`;
      }catch(e){
        log('zoom failed', e?.message || e);
      }
    }

    async function sendScan(code){
      const token = String(tokenEl.value || '').trim();
      if(!token){
        setNet('token required', false);
        showToast('トークン必要', 'X-Admin-Token を入力して');
        return;
      }

      const tracking_no = normalizeTracking(codeEl.value || code);
      if(!isValidTracking(tracking_no)){
        setNet('invalid tracking', false);
        showToast('追跡番号不正', '8〜16桁の数字のみ');
        return;
      }

      const now = Date.now();
      if(now - lastApiAt < 800) return;
      lastApiAt = now;

      setNet('sending...', null);
      log('POST /api/admin/ship/scan-and-notify', tracking_no);

      try{
        const r = await fetch('/api/admin/ship/scan-and-notify', {
          method:'POST',
          headers:{ 'Content-Type':'application/json', 'X-Admin-Token': token },
          body: JSON.stringify({ tracking_no })
        });

        const text = await r.text();
        let j = null;
        try{ j = text ? JSON.parse(text) : null; }catch{ j = { raw: text }; }

        if(!r.ok){
          setNet(`error ${r.status}`, false);
          log('api error', r.status, j || '(no json)');
          showToast('送信失敗', (j && j.error) ? j.error : 'server error');
          return;
        }

        if(j && j.already_notified){
          setNet('already notified', true);
          showToast('通知済み', `注文ID: ${j.orderId}`);
        }else{
          setNet('sent', true);
          showToast('OK', `発送通知しました（注文ID: ${j.orderId}）`);
        }
        codeEl.select();
      }catch(e){
        setNet('network error', false);
        log('fetch failed', e?.message || e);
        showToast('通信失敗', 'ネットワーク/トークン確認');
      }
    }

    // UI
    btnStart.addEventListener('click', () => startCamera());
    btnStop.addEventListener('click',  () => stopCamera());
    btnTorch.addEventListener('click', () => toggleTorch());
    btnSwitch.addEventListener('click', () => switchCamera());
    btnSend.addEventListener('click', () => sendScan(codeEl.value));
    btnClear.addEventListener('click', () => { codeEl.value=''; codeEl.focus(); setNet('-', null); });
    zoomEl.addEventListener('input', (e) => setZoom(e.target.value));

    // init
    log('scan.html ready');
    setCam('idle', null);
    setNet('-', null);
    setZx(zxingReady() ? 'ok' : 'missing', zxingReady());
  </script>
</body>
</html>