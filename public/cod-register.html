<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>住所入力</title>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root{
      --bg:#f7f7f7; --card:#fff; --text:#111827; --muted:#6b7280;
      --pri:#0b3a53; --border:#e5e7eb; --radius:14px;
      --danger:#b91c1c; --ok:#0a7b19;
    }
    body{ margin:0; font-family:system-ui,-apple-system,"Segoe UI",sans-serif; background:var(--bg); color:var(--text); }
    .wrap{ max-width:720px; margin:0 auto; padding:14px 14px 28px; }
    h1{ font-size:18px; margin:0 0 6px; }
    .muted{ color:var(--muted); font-size:13px; line-height:1.5; }
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
      padding:14px; margin-top:12px;
    }
    label{ font-size:13px; font-weight:800; display:block; margin-top:10px; }
    input{
      width:100%; padding:10px; border-radius:10px; border:1px solid var(--border);
      font-size:15px; box-sizing:border-box;
    }
    .btn{
      margin-top:14px; width:100%; padding:14px;
      border-radius:14px; border:none;
      background:var(--pri); color:#fff;
      font-weight:900; font-size:16px; cursor:pointer;
    }
    .btnSub{ background:#fff; color:var(--text); border:1px solid var(--border); }
    .debug{
      margin-top:12px; font-size:12px; white-space:pre-line;
      color:#374151; background:#fff; border:1px dashed var(--border);
      border-radius:12px; padding:10px;
    }
    .err{ color:var(--danger); font-weight:800; }
    .ok{ color:var(--ok); font-weight:800; }
  </style>
</head>

<body>
<div class="wrap">
  <h1>住所入力</h1>
  <div class="muted">注文のために住所を入力してください（登録済みの場合は自動で表示されます）</div>

  <div class="card">
    <label>お名前</label>
    <input id="name" placeholder="例）磯屋 太郎">

    <label>電話番号</label>
    <input id="phone" placeholder="例）090-1234-5678">

    <label>郵便番号</label>
    <input id="postal" placeholder="例）470-0000">

    <label>都道府県</label>
    <input id="prefecture" placeholder="例）愛知県">

    <label>市区町村</label>
    <input id="city" placeholder="例）知多郡武豊町">

    <label>番地</label>
    <input id="address1" placeholder="例）字〇〇 1-2-3">

    <label>建物名など（任意）</label>
    <input id="address2" placeholder="任意">

    <button class="btn" id="saveBtn" type="button">保存して次へ</button>
    <button class="btn btnSub" id="backBtn" type="button">商品へ戻る</button>

    <div class="debug" id="debug">debug: 起動中…</div>
  </div>
</div>

<script>
(async function(){
  "use strict";

  const LIFF_ID_ADDRESS = "2008406620-4kyQVyqe"; // 住所入力用
  const KEY_UID  = "isoya_userId";
  const KEY_CART = "isoya_cart";

  const qs = new URLSearchParams(location.search);
  const returnTo = (qs.get("returnTo") || "/confirm.html").trim();

  const $ = (id) => document.getElementById(id);
  const debugEl = $("debug");
  const setDebug = (msg) => { debugEl.textContent = msg; };
  const addDebug = (msg) => { debugEl.textContent += "\n" + msg; };

  async function fetchJson(url, opts){
    const res = await fetch(url, opts);
    const text = await res.text();
    let data = {};
    try { data = text ? JSON.parse(text) : {}; } catch { data = { _raw: text }; }
    return { res, data, raw: text };
  }

  async function initLiff(){
    await liff.init({ liffId: LIFF_ID_ADDRESS });
    if(!liff.isLoggedIn()){
      liff.login({ redirectUri: location.href });
      return null;
    }
    const prof = await liff.getProfile();
    const userId = (prof?.userId || "").trim();
    if(userId) localStorage.setItem(KEY_UID, userId);
    return userId;
  }

  async function loadAddress(userId){
    const u = `/api/address/get?userId=${encodeURIComponent(userId)}`;
    const { res, data } = await fetchJson(u, { cache:"no-store" });
    addDebug(`GET ${res.status} ${u}`);
    if(res.ok && data?.ok && data?.address) return data.address;
    return null;
  }

  async function saveAddress(payload){
    const u = "/api/address/set";
    const { res, data, raw } = await fetchJson(u, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    addDebug(`POST ${res.status} ${u}`);
    if(res.ok && data?.ok) return data.address;
    throw new Error(data?.error || raw || ("HTTP "+res.status));
  }

  function hasCart(){
    try{
      const c = JSON.parse(localStorage.getItem(KEY_CART) || "");
      return Array.isArray(c?.items) && c.items.length > 0;
    }catch{ return false; }
  }

  setDebug(
    `debug:start\n`+
    `LIFF_ID_ADDRESS=${LIFF_ID_ADDRESS}\n`+
    `returnTo=${returnTo}\n`
  );

  let userId = "";
  try{
    userId = await initLiff();
    if(!userId) return;
    addDebug(`OK: userId=${userId}`);
    debugEl.classList.add("ok");
  }catch(e){
    console.error(e);
    debugEl.classList.add("err");
    addDebug(`ERR: LIFF init failed: ${e?.message || e}`);
    alert("初期化に失敗しました（住所入力LIFF）。LIFF ID/登録URLを確認してください。");
    return;
  }

  // 既存住所ロード
  try{
    const a = await loadAddress(userId);
    if(a){
      $("name").value = a.name || "";
      $("phone").value = a.phone || "";
      $("postal").value = a.postal || "";
      $("prefecture").value = a.prefecture || "";
      $("city").value = a.city || "";
      $("address1").value = a.address1 || "";
      $("address2").value = a.address2 || "";
      addDebug("OK: address prefilled");
    }else{
      addDebug("INFO: no address yet");
    }
  }catch(e){
    addDebug(`WARN: loadAddress failed: ${e?.message || e}`);
  }

  $("backBtn").onclick = ()=>{
    // カートがあるなら戻ってもOK。なければ商品へ。
    location.href = "/products.html";
  };

  $("saveBtn").onclick = async ()=>{
    const payload = {
      userId,
      name: $("name").value.trim(),
      phone: $("phone").value.trim(),
      postal: $("postal").value.trim(),
      prefecture: $("prefecture").value.trim(),
      city: $("city").value.trim(),
      address1: $("address1").value.trim(),
      address2: $("address2").value.trim(),
    };

    if(!payload.name || !payload.phone || !payload.postal || !payload.prefecture || !payload.city || !payload.address1){
      alert("必須項目（名前/電話/郵便/都道府県/市区町村/番地）を入力してください。");
      return;
    }
    if(!hasCart()){
      alert("カートが空です。先に商品を選んでください。");
      location.href = "/products.html";
      return;
    }

    addDebug("\n--- SAVE ---");
    try{
      await saveAddress(payload);
      alert("住所を保存しました。");
      location.href = returnTo || "/confirm.html";
    }catch(e){
      console.error(e);
      debugEl.classList.add("err");
      addDebug(`ERR: save failed: ${e?.message || e}`);
      alert("保存に失敗しました。下のdebugを確認してください。");
    }
  };
})();
</script>
</body>
</html>
