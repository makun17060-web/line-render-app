<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>カード決済｜入力</title>

  <script src="https://js.stripe.com/v3/"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root{
      --bg:#f6f7f9;--card:#fff;--text:#111827;--muted:#6b7280;--line:#e5e7eb;
      --pri:#123b66;--danger:#b91c1c;
      --radius:14px;--shadow:0 1px 3px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:860px;margin:0 auto;padding:14px 14px 26px}
    h1{margin:0 0 6px;font-size:18px}
    .muted{color:var(--muted);font-size:13px;line-height:1.5}
    .err{color:var(--danger);font-weight:900;white-space:pre-line}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:12px;margin-top:12px;box-shadow:var(--shadow)}
    .btn{
      width:100%;border:none;border-radius:14px;padding:12px 14px;
      font-weight:1000;cursor:pointer;margin-top:10px;background:var(--pri);color:#fff
    }
    .btn.secondary{background:#fff;color:#111827;border:1px solid var(--line)}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    #payment-element{margin-top:10px}
    .kv{display:flex;justify-content:space-between;gap:10px;padding:6px 0}
    .kv .k{color:var(--muted);font-size:13px}
    .kv .v{font-weight:1000;font-size:14px;text-align:right}
    .badge{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;background:#eef2ff;color:#1e3a8a;font-weight:800}
  </style>
</head>

<body>
  <div class="wrap">
    <h1>カード決済｜入力</h1>
    <div class="muted" id="status">読み込み中…</div>

    <div class="card">
      <div class="muted">決済情報</div>
      <div class="kv" style="margin-top:6px;border-top:1px solid var(--line);padding-top:10px">
        <div class="k">方式</div>
        <div class="v"><span class="badge">Stripe Payment Element</span></div>
      </div>
      <div class="kv">
        <div class="k">モード</div>
        <div class="v" id="modeLabel">—</div>
      </div>
    </div>

    <div class="card">
      <div class="muted">カード情報の入力</div>
      <div id="payment-element"></div>

      <button id="payBtn" class="btn" type="button" disabled>支払う</button>
      <button id="backBtn" class="btn secondary" type="button">戻る</button>

      <div id="err" class="err" style="margin-top:10px"></div>
    </div>
  </div>

<script>
(async function(){
  "use strict";

  // =========================
  // LIFF（任意）
  // =========================
  const LIFF_ID_ORDER = "2008406620-G5j1gjzM";

  // localStorage keys
  const KEY_UID = "isoya_userId";
  const KEY_STRIPE = "isoya_stripe_payment";   // confirm-card が保存する想定

  // =========================
  // DOM
  // =========================
  const status = document.getElementById("status");
  const errEl  = document.getElementById("err");
  const payBtn = document.getElementById("payBtn");
  const backBtn= document.getElementById("backBtn");
  const modeLabel = document.getElementById("modeLabel");

  const qs = new URLSearchParams(location.search);
  const mode = (qs.get("mode") || "").trim(); // original / fukubako / ""(default)

  function setStatus(text, isError=false){
    status.classList.remove("err");
    status.classList.add("muted");
    if(isError){
      status.classList.remove("muted");
      status.classList.add("err");
    }
    status.textContent = text;
  }
  function setErr(text){ errEl.textContent = text || ""; }

  function loadJson(k){
    try { return JSON.parse(localStorage.getItem(k) || ""); }
    catch { return null; }
  }

  // 戻り先
  const RETURN_CONFIRM =
      (mode === "fukubako") ? "/confirm.html?mode=fukubako"
    : (mode === "original") ? "/confirm-original.html"
    : "/confirm.html";

  // 決済後戻り先
  const RETURN_URL =
      (mode === "fukubako") ? (location.origin + "/pay-return.html?mode=fukubako")
    : (mode === "original") ? (location.origin + "/pay-return.html?mode=original")
    : (location.origin + "/pay-return.html");

  // =========================
  // LIFF（取れればuid取得）
  // =========================
  async function ensureUserSoft(){
    const cached = (localStorage.getItem(KEY_UID) || "").trim();
    if(cached) return cached;

    try{
      await liff.init({ liffId: LIFF_ID_ORDER });
      if(!liff.isLoggedIn()) return null;
      const prof = await liff.getProfile();
      const uid = (prof?.userId || "").trim();
      if(uid) localStorage.setItem(KEY_UID, uid);
      return uid || null;
    }catch(e){
      return null; // LIFF失敗しても続行
    }
  }

  // =========================
  // Stripe config 取得（ここが今回の修正）
  // =========================
  async function fetchStripeConfig(){
    // 同一オリジンでまず試す
    const urls = [
      location.origin + "/api/stripe/config",
      "/api/stripe/config",
    ];

    let lastErr = null;
    for(const u of urls){
      try{
        const r = await fetch(u, { cache: "no-store" });
        if(!r.ok) throw new Error("HTTP " + r.status);
        const j = await r.json();

        const publishableKey = String(j.publishableKey || j.publishable_key || "").trim();
        const appBaseUrl = String(j.appBaseUrl || j.app_base_url || "").trim();

        return { publishableKey, appBaseUrl };
      }catch(e){
        lastErr = e;
      }
    }
    throw new Error("Stripe設定の取得に失敗しました: " + (lastErr?.message || lastErr));
  }

  // =========================
  // main
  // =========================
  try{
    modeLabel.textContent =
      (mode === "fukubako") ? "福箱"
    : (mode === "original") ? "オリジナル"
    : "通常";

    setStatus("決済情報を確認しています…");
    setErr("");

    // 1) clientSecret を localStorage から取得
    const saved = loadJson(KEY_STRIPE);

    if(!saved?.clientSecret){
      setStatus("決済情報が見つかりません。", true);
      setErr("この画面は「最終確認」から進んでください。\n（clientSecret not found in localStorage）");
      payBtn.disabled = true;
      backBtn.onclick = ()=> location.href = RETURN_CONFIRM;
      return;
    }

    // 2) 期限チェック（任意：30分）
    const ageMs = Date.now() - Number(saved.createdAt || 0);
    if(saved.createdAt && ageMs > 30 * 60 * 1000){
      setStatus("決済情報の有効期限が切れています。", true);
      setErr("恐れ入りますが、最終確認からもう一度お進みください。");
      payBtn.disabled = true;
      backBtn.onclick = ()=> location.href = RETURN_CONFIRM;
      return;
    }

    // 3) uid（取れれば）
    await ensureUserSoft();

    // 4) Stripe 初期化（configからpkを取得）
    if(!window.Stripe) throw new Error("Stripe.js の読み込みに失敗しました。");

    setStatus("Stripe設定を取得しています…");
    const cfg = await fetchStripeConfig();

    if(!cfg.publishableKey){
      throw new Error("Stripe 公開可能キーが未設定です（/api/stripe/config の publishableKey が空です）");
    }

    // appBaseUrl（将来使うなら）：空ならlocation.origin
    const APP_BASE = cfg.appBaseUrl || location.origin;

    setStatus("カード入力欄を準備しています…");
    const stripe = Stripe(cfg.publishableKey);

    const elements = stripe.elements({
      clientSecret: saved.clientSecret,
    });

    const paymentElement = elements.create("payment");
    paymentElement.mount("#payment-element");

    // 5) ボタン
    backBtn.onclick = ()=> location.href = RETURN_CONFIRM;

    payBtn.disabled = false;
    payBtn.onclick = async ()=> {
      payBtn.disabled = true;
      payBtn.textContent = "処理中…";
      setErr("");
      try{
        const result = await stripe.confirmPayment({
          elements,
          confirmParams: {
            // RETURN_URLは location.origin 前提なので、
            // もし別オリジンで開くなら APP_BASE を使う形にする
            return_url: RETURN_URL
            // return_url: APP_BASE + "/pay-return.html" みたいにしてもOK
          }
        });

        if(result?.error){
          throw new Error(result.error.message || "決済に失敗しました。");
        }
      }catch(e){
        const msg = e?.message || String(e);
        setErr("決済を完了できませんでした。\n" + msg);
        payBtn.disabled = false;
        payBtn.textContent = "支払う";
      }
    };

    setStatus("カード情報を入力して「支払う」を押してください。");

  }catch(e){
    console.error(e);
    setStatus("読み込みに失敗しました。", true);
    setErr((e && e.message) ? e.message : String(e));
    payBtn.disabled = true;
    backBtn.onclick = ()=> location.href = RETURN_CONFIRM;
  }
})();
</script>

</body>
</html>
