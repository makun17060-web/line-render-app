<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>宅配付きえびせん注文ミニアプリ | 手造りえびせんべい 磯屋</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
      margin: 0;
      padding: 0;
      background: #fafafa;
    }
    header {
      background: #b22222;
      color: #fff;
      padding: 14px 16px;
      font-size: 18px;
      text-align: center;
    }
    .container {
      max-width: 720px;
      margin: 0 auto;
      padding: 12px 16px 24px;
    }
    h1 {
      font-size: 18px;
      margin: 8px 0 12px;
    }
    h2 {
      font-size: 16px;
      margin: 18px 0 8px;
      border-left: 4px solid #b22222;
      padding-left: 6px;
    }
    .notice {
      font-size: 12px;
      color: #666;
      margin-bottom: 8px;
    }
    .product-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .product {
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      padding: 10px;
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }
    .product img {
      width: 72px;
      height: 72px;
      object-fit: cover;
      border-radius: 4px;
      flex-shrink: 0;
      background: #eee;
    }
    .product-body {
      flex: 1;
      min-width: 0;
    }
    .product-title {
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 4px;
    }
    .product-desc {
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
    }
    .product-meta {
      font-size: 12px;
      color: #444;
      margin-bottom: 4px;
    }
    .qty-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 4px;
    }
    .qty-row button {
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: #fff;
      font-size: 14px;
    }
    .qty-row span {
      min-width: 24px;
      text-align: center;
      font-size: 14px;
    }

    /* ▼ サマリーカード */
    .summary-card {
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      padding: 10px;
      font-size: 14px;
      margin-top: 8px;
    }
    .summary-row {
      display: flex;
      justify-content: space-between;
      margin: 2px 0;
    }
    .summary-row.total {
      font-weight: bold;
      margin-top: 6px;
      border-top: 1px solid #eee;
      padding-top: 4px;
    }

    /* ▼ 明細リスト */
    .detail-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 4px;
    }
    .detail-item {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      padding: 2px 0;
      border-bottom: 1px dashed #eee;
    }

    .btn-main {
      display: block;
      width: 100%;
      padding: 12px;
      margin-top: 16px;
      border-radius: 6px;
      border: none;
      background: #b22222;
      color: #fff;
      font-size: 16px;
      font-weight: bold;
    }
    .btn-sub {
      display: block;
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border-radius: 6px;
      border: 1px solid #b22222;
      background: #fff;
      color: #b22222;
      font-size: 14px;
    }
    .btn-main:disabled,
    .btn-sub:disabled {
      opacity: 0.5;
    }
    .addr-form {
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      padding: 10px;
      font-size: 14px;
      margin-top: 8px;
    }
    .form-row {
      margin-bottom: 8px;
    }
    .form-row label {
      display: block;
      font-size: 12px;
      margin-bottom: 2px;
    }
    .form-row input,
    .form-row select {
      width: 100%;
      padding: 6px 8px;
      box-sizing: border-box;
      font-size: 14px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    .small {
      font-size: 11px;
      color: #666;
      margin-top: 4px;
      white-space: pre-line;
    }
    .step-labels {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      margin: 6px 0 10px;
      color: #666;
    }
    .step-labels span.active {
      font-weight: bold;
      color: #b22222;
    }
    .hidden {
      display: none;
    }
    .error {
      color: #c00;
      font-size: 12px;
      margin-top: 4px;
      white-space: pre-line;
    }
    .ok-msg {
      color: #060;
      font-size: 12px;
      margin-top: 4px;
      white-space: pre-line;
    }
  </style>
</head>
<body>
<header>
  手造りえびせんべい 磯屋<br>宅配付きご注文ミニアプリ
</header>

<div class="container">

  <div class="step-labels">
    <span id="stepLabel1" class="active">① 商品選択</span>
    <span id="stepLabel2">② お届け先入力</span>
    <span id="stepLabel3">③ 最終確認</span>
  </div>

  <!-- ユーザー情報表示 -->
  <div class="summary-card">
    <div class="summary-row">
      <span>LINEユーザー：</span>
      <span id="lineUserName">取得中...</span>
    </div>
    <div class="small">
      ※ LINEアプリの中から開いてください。
    </div>
  </div>

  <!-- ① 商品選択 -->
  <h2>① 商品を選ぶ</h2>
  <div class="notice">
    ご希望の商品と数量をお選びください。<br>
    ※久助はテキスト注文専用のため、この画面には表示していません。
  </div>
  <div id="productList" class="product-list">
    読み込み中...
  </div>

  <!-- 商品選択時のサマリー -->
  <div id="cartSummary" class="summary-card hidden">
    <div style="font-weight:bold; margin-bottom:6px;">ご注文明細（商品）</div>
    <div id="detailList" class="detail-list"></div>

    <div class="summary-row" style="margin-top:6px;">
      <span>商品合計</span>
      <span id="itemsTotal">0円</span>
    </div>
    <div class="summary-row">
      <span>送料</span>
      <span id="shipFee">0円</span>
    </div>
    <div class="summary-row total">
      <span>お支払予定金額</span>
      <span id="grandTotal">0円</span>
    </div>
    <div class="small" id="shipNote"></div>
  </div>

  <button id="goAddressBtn" class="btn-main" disabled>
    ② お届け先入力へ進む
  </button>

  <!-- ② 住所入力 -->
  <h2>② お届け先情報</h2>
  <div class="notice">
    宅配をご希望の方は、お届け先住所をご入力ください。
  </div>

  <div id="addressSection" class="addr-form">
    <div class="form-row">
      <label>お名前</label>
      <input type="text" id="addrName" placeholder="例：磯屋 太郎" />
    </div>
    <div class="form-row">
      <label>電話番号</label>
      <input type="tel" id="addrPhone" placeholder="例：09012345678" />
    </div>
    <div class="form-row">
      <label>郵便番号</label>
      <input type="text" id="addrPostal" placeholder="例：4701234" />
    </div>
    <div class="form-row">
      <label>都道府県</label>
      <select id="addrPref">
        <option value="">選択してください</option>
        <option>北海道</option>
        <option>青森県</option><option>岩手県</option><option>宮城県</option><option>秋田県</option><option>山形県</option><option>福島県</option>
        <option>茨城県</option><option>栃木県</option><option>群馬県</option><option>埼玉県</option><option>千葉県</option><option>東京都</option><option>神奈川県</option>
        <option>新潟県</option><option>富山県</option><option>石川県</option><option>福井県</option><option>山梨県</option><option>長野県</option>
        <option>岐阜県</option><option>静岡県</option><option>愛知県</option><option>三重県</option>
        <option>滋賀県</option><option>京都府</option><option>大阪府</option><option>兵庫県</option><option>奈良県</option><option>和歌山県</option>
        <option>鳥取県</option><option>島根県</option><option>岡山県</option><option>広島県</option><option>山口県</option>
        <option>徳島県</option><option>香川県</option><option>愛媛県</option><option>高知県</option>
        <option>福岡県</option><option>佐賀県</option><option>長崎県</option><option>熊本県</option><option>大分県</option><option>宮崎県</option><option>鹿児島県</option>
        <option>沖縄県</option>
      </select>
    </div>
    <div class="form-row">
      <label>市区町村</label>
      <input type="text" id="addrCity" placeholder="例：〇〇市△△町" />
    </div>
    <div class="form-row">
      <label>番地・建物名など</label>
      <input type="text" id="addrAddress1" placeholder="例：1-2-3 磯屋マンション101号" />
    </div>
    <div class="form-row">
      <label>建物名・部屋番号など（任意）</label>
      <input type="text" id="addrAddress2" placeholder="任意" />
    </div>

    <button id="saveAddressBtn" class="btn-sub">
      この住所を登録する（②完了）
    </button>
    <div id="addrStatus" class=""></div>
  </div>

  <!-- ③ 最終確認＆決済 -->
  <h2>③ ご注文の最終確認</h2>
  <div class="notice">
    商品と送料、合計金額をご確認の上「クレジットカードで支払う」を押してください。
  </div>

  <div id="finalConfirmCard" class="summary-card hidden">
    <div style="font-weight:bold; margin-bottom:6px;">ご注文明細</div>
    <div id="finalDetailList" class="detail-list"></div>

    <div class="summary-row" style="margin-top:8px;">
      <span>商品合計</span><span id="finalItemsTotal">0円</span>
    </div>
    <div class="summary-row">
      <span>送料</span><span id="finalShipFee">0円</span>
    </div>
    <div class="summary-row total">
      <span>お支払合計</span><span id="finalGrandTotal">0円</span>
    </div>

    <div class="small" id="finalShipNote"></div>

    <button id="payButton" class="btn-main" disabled>
      クレジットカードで支払う
    </button>
    <div id="payStatus" class="error hidden"></div>
  </div>

  <button id="backToLineBtn" class="btn-sub">
    LINEトーク画面に戻る
  </button>
</div>

<script>
  // ★このミニアプリ用の LIFF ID ★
  const LIFF_ID = "2008406620-G5j1gjzM";

  const STATE = {
    lineUserId: "",
    lineUserName: "",
    products: [],
    cart: {}, // { productId: qty }
    addressSaved: false,
    shipFee: 0,
    shipRegion: "",
    shipPref: "",
  };

  function yen(n) {
    return (Number(n) || 0).toLocaleString("ja-JP") + "円";
  }

  function setStep(step) {
    document.getElementById("stepLabel1").classList.toggle("active", step === 1);
    document.getElementById("stepLabel2").classList.toggle("active", step === 2);
    document.getElementById("stepLabel3").classList.toggle("active", step === 3);
  }

  async function initLiff() {
    try {
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isInClient()) {
        document.getElementById("lineUserName").textContent = "ブラウザで開いています";
      }
      const profile = await liff.getProfile();
      STATE.lineUserId = profile.userId;
      STATE.lineUserName = profile.displayName || "LINEユーザー";
      document.getElementById("lineUserName").textContent = STATE.lineUserName;
    } catch (e) {
      console.error("LIFF init error", e);
      document.getElementById("lineUserName").textContent = "取得失敗（LINEアプリから再度お試しください）";
    }
  }

  async function loadProducts() {
    const listEl = document.getElementById("productList");
    listEl.textContent = "読み込み中...";
    try {
      const res = await fetch("/api/products");
      const json = await res.json();
      if (!json.ok) throw new Error(json.error || "server_error");
      STATE.products = json.products || [];
      renderProducts();
    } catch (e) {
      console.error("loadProducts error", e);
      listEl.textContent = "商品一覧の取得に失敗しました。時間をおいて再度お試しください。";
    }
  }

  function renderProducts() {
    const listEl = document.getElementById("productList");
    listEl.innerHTML = "";

    if (!STATE.products.length) {
      listEl.textContent = "現在、販売中の商品がありません。";
      return;
    }

    STATE.products.forEach(p => {
      const qty = STATE.cart[p.id] || 0;

      const root = document.createElement("div");
      root.className = "product";

      const img = document.createElement("img");
      img.src = p.image || "";
      img.alt = p.name;
      img.onerror = () => { img.style.display = "none"; };

      const body = document.createElement("div");
      body.className = "product-body";

      const title = document.createElement("div");
      title.className = "product-title";
      title.textContent = p.name;

      const desc = document.createElement("div");
      desc.className = "product-desc";
      desc.textContent = p.desc || "";

      const meta = document.createElement("div");
      meta.className = "product-meta";
      meta.textContent = `価格：${yen(p.price)}　在庫：${p.stock ?? 0}袋`;

      const qtyRow = document.createElement("div");
      qtyRow.className = "qty-row";

      const btnMinus = document.createElement("button");
      btnMinus.textContent = "−";
      btnMinus.onclick = () => {
        const current = STATE.cart[p.id] || 0;
        const next = Math.max(0, current - 1);
        if (next === 0) delete STATE.cart[p.id]; else STATE.cart[p.id] = next;
        renderProducts();
        updateSummary();
      };

      const qtySpan = document.createElement("span");
      qtySpan.textContent = qty;

      const btnPlus = document.createElement("button");
      btnPlus.textContent = "+";
      btnPlus.onclick = () => {
        const current = STATE.cart[p.id] || 0;
        const next = current + 1;
        STATE.cart[p.id] = next;
        renderProducts();
        updateSummary();
      };

      qtyRow.appendChild(btnMinus);
      qtyRow.appendChild(qtySpan);
      qtyRow.appendChild(btnPlus);

      body.appendChild(title);
      body.appendChild(desc);
      body.appendChild(meta);
      body.appendChild(qtyRow);

      root.appendChild(img);
      root.appendChild(body);
      listEl.appendChild(root);
    });

    updateSummary();
  }

  // ▼ 都道府県→送料地域の簡易判定（server.jsの設定に合わせた概算）
  function calcShipFeeFromPref(pref) {
    if (!pref) return { region:"未選択", fee:0 };

    const map = {
      "北海道": 1100,
      "東北": 900,
      "関東": 800,
      "中部": 800,
      "近畿": 900,
      "中国": 1000,
      "四国": 1000,
      "九州": 1100,
      "沖縄": 1400
    };

    const tohoku = ["青森県","岩手県","宮城県","秋田県","山形県","福島県"];
    const kanto = ["茨城県","栃木県","群馬県","埼玉県","千葉県","東京都","神奈川県"];
    const chubu = ["新潟県","富山県","石川県","福井県","山梨県","長野県","岐阜県","静岡県","愛知県"];
    const kinki = ["三重県","滋賀県","京都府","大阪府","兵庫県","奈良県","和歌山県"];
    const chugoku = ["鳥取県","島根県","岡山県","広島県","山口県"];
    const shikoku = ["徳島県","香川県","愛媛県","高知県"];
    const kyushu = ["福岡県","佐賀県","長崎県","熊本県","大分県","宮崎県","鹿児島県"];

    let region = "中部";
    if (pref === "北海道") region = "北海道";
    else if (tohoku.includes(pref)) region = "東北";
    else if (kanto.includes(pref)) region = "関東";
    else if (chubu.includes(pref)) region = "中部";
    else if (kinki.includes(pref)) region = "近畿";
    else if (chugoku.includes(pref)) region = "中国";
    else if (shikoku.includes(pref)) region = "四国";
    else if (kyushu.includes(pref)) region = "九州";
    else if (pref === "沖縄県") region = "沖縄";

    return { region, fee: map[region] || 0 };
  }

  function updateSummary() {
    const cartSummary = document.getElementById("cartSummary");
    const goAddressBtn = document.getElementById("goAddressBtn");
    const detailList = document.getElementById("detailList");
    const shipNote = document.getElementById("shipNote");

    // ③ 最終確認側
    const finalCard = document.getElementById("finalConfirmCard");
    const finalDetailList = document.getElementById("finalDetailList");
    const finalShipNote = document.getElementById("finalShipNote");
    const payButton = document.getElementById("payButton");

    const ids = Object.keys(STATE.cart);

    if (!ids.length) {
      cartSummary.classList.add("hidden");
      goAddressBtn.disabled = true;

      document.getElementById("itemsTotal").textContent = "0円";
      document.getElementById("shipFee").textContent = "0円";
      document.getElementById("grandTotal").textContent = "0円";
      detailList.innerHTML = "";
      shipNote.textContent = "";

      finalCard.classList.add("hidden");
      finalDetailList.innerHTML = "";
      payButton.disabled = true;
      return;
    }

    let itemsTotal = 0;
    detailList.innerHTML = "";
    finalDetailList.innerHTML = "";

    ids.forEach(id => {
      const p = STATE.products.find(x => x.id === id);
      if (!p) return;
      const qty = STATE.cart[id] || 0;
      const sub = Number(p.price) * qty;
      itemsTotal += sub;

      const rowHtml = `
        <div class="detail-item">
          <span>${p.name} × ${qty}</span>
          <span>${yen(sub)}</span>
        </div>
      `;
      detailList.insertAdjacentHTML("beforeend", rowHtml);
      finalDetailList.insertAdjacentHTML("beforeend", rowHtml);
    });

    // 送料計算（都道府県から）
    const pref = document.getElementById("addrPref").value.trim();
    const { region, fee } = calcShipFeeFromPref(pref);
    STATE.shipFee = fee;
    STATE.shipRegion = region;
    STATE.shipPref = pref;

    const grandTotal = itemsTotal + fee;

    // ①小サマリー
    document.getElementById("itemsTotal").textContent = yen(itemsTotal);
    document.getElementById("shipFee").textContent = yen(fee);
    document.getElementById("grandTotal").textContent = yen(grandTotal);
    shipNote.textContent = pref
      ? `配送地域：${region} / 送料：${yen(fee)}`
      : "※都道府県を選ぶと送料が確定します";

    cartSummary.classList.remove("hidden");
    goAddressBtn.disabled = false;

    // ③最終確認
    document.getElementById("finalItemsTotal").textContent = yen(itemsTotal);
    document.getElementById("finalShipFee").textContent = yen(fee);
    document.getElementById("finalGrandTotal").textContent = yen(grandTotal);
    finalShipNote.textContent = pref
      ? `配送地域：${region} / 送料：${yen(fee)}`
      : "※都道府県を選ぶと送料が確定します";

    if (STATE.addressSaved) {
      finalCard.classList.remove("hidden");
      payButton.disabled = false;
    } else {
      finalCard.classList.add("hidden");
      payButton.disabled = true;
    }
  }

  async function saveAddress() {
    const name = document.getElementById("addrName").value.trim();
    const phone = document.getElementById("addrPhone").value.trim();
    const postal = document.getElementById("addrPostal").value.trim();
    const pref = document.getElementById("addrPref").value.trim();
    const city = document.getElementById("addrCity").value.trim();
    const addr1 = document.getElementById("addrAddress1").value.trim();
    const addr2 = document.getElementById("addrAddress2").value.trim();

    const statusEl = document.getElementById("addrStatus");
    statusEl.className = "";
    statusEl.textContent = "";

    if (!name || !phone || !postal || !pref || !city || !addr1) {
      statusEl.className = "error";
      statusEl.textContent = "未入力の項目があります。";
      return;
    }
    if (!STATE.lineUserId) {
      statusEl.className = "error";
      statusEl.textContent = "LINEユーザーIDが取得できませんでした。LINEアプリから再度お試しください。";
      return;
    }

    try {
      const res = await fetch("/api/liff/address", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          userId: STATE.lineUserId,
          name, phone, postal,
          prefecture: pref,
          city, address1: addr1, address2: addr2
        })
      });
      const json = await res.json();
      if (!json.ok) throw new Error(json.error || "server_error");

      STATE.addressSaved = true;
      statusEl.className = "ok-msg";
      statusEl.textContent = "住所を登録しました。③ 最終確認に進みます。";

      updateSummary();
      setStep(3);

      document.getElementById("finalConfirmCard")
        .scrollIntoView({ behavior:"smooth", block:"start" });

    } catch (e) {
      console.error("saveAddress error", e);
      statusEl.className = "error";
      statusEl.textContent = "住所の登録に失敗しました。時間をおいて再度お試しください。";
    }
  }

  async function startPayment() {
    const payStatus = document.getElementById("payStatus");
    payStatus.classList.add("hidden");
    payStatus.textContent = "";

    const ids = Object.keys(STATE.cart);
    if (!ids.length) {
      payStatus.classList.remove("hidden");
      payStatus.textContent = "カートが空です。商品を選択してください。";
      return;
    }
    if (!STATE.addressSaved) {
      payStatus.classList.remove("hidden");
      payStatus.textContent = "先に② お届け先情報を登録してください。";
      setStep(2);
      return;
    }

    let itemsTotal = 0;
    const items = [];
    ids.forEach(id => {
      const p = STATE.products.find(x => x.id === id);
      if (!p) return;
      const qty = STATE.cart[id] || 0;
      const sub = Number(p.price) * qty;
      itemsTotal += sub;
      items.push({ id: p.id, name: p.name, price: Number(p.price), qty });
    });

    // 送料を足した合計（最終確認と一致）
    const total = itemsTotal + (STATE.shipFee || 0);

    try {
      const res = await fetch("/api/pay", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          items,
          total,
          lineUserId: STATE.lineUserId,
          lineUserName: STATE.lineUserName
        })
      });
      const json = await res.json();
      if (!json.ok) throw new Error(json.error || "決済の開始に失敗しました");

      if (json.redirectUrl) {
        location.href = json.redirectUrl; // イプシロン決済画面へ移動
        return;
      }
      throw new Error("決済画面URLが取得できませんでした");

    } catch (e) {
      console.error("startPayment error", e);
      payStatus.classList.remove("hidden");
      payStatus.textContent =
        "決済の開始に失敗しました。\n" +
        "時間をおいて再度お試しください。";
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    initLiff();
    loadProducts();

    document.getElementById("goAddressBtn").addEventListener("click", () => {
      setStep(2);
      document.getElementById("addressSection")
        .scrollIntoView({ behavior: "smooth", block: "start" });
    });

    document.getElementById("saveAddressBtn").addEventListener("click", saveAddress);
    document.getElementById("payButton").addEventListener("click", startPayment);

    // 都道府県変更で送料再計算
    document.getElementById("addrPref").addEventListener("change", updateSummary);

    document.getElementById("backToLineBtn").addEventListener("click", () => {
      if (window.liff && liff.isInClient()) liff.closeWindow();
      else window.history.back();
    });
  });
</script>
</body>
</html>
