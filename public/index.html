<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ã”æ³¨æ–‡æ–¹æ³•é¸æŠ</title>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="/liff-config.js"></script>

  <style>
    :root{
      --bg:#f6f7f9;
      --card:#fff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;

      --trial:#c2410c;
      --original:#7a1f1f;
      --akasha:#0b3a53;
      --store:#0a7b19;

      --shadow:0 1px 4px rgba(0,0,0,.08);
      --radius:16px;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    .wrap{
      max-width:760px;
      margin:0 auto;
      padding:16px 14px 30px;
    }

    h1{
      margin:0 0 6px;
      font-size:20px;
    }

    .muted{
      color:var(--muted);
      font-size:13px;
      line-height:1.6;
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      margin-top:14px;
    }

    .btn{
      display:block;
      width:100%;
      padding:16px 14px;
      border-radius:14px;
      font-weight:900;
      font-size:16px;
      text-align:center;
      text-decoration:none;
      border:none;
      cursor:pointer;
    }

    .btnTrial{ background:var(--trial); color:#fff; }
    .btnOriginal{ background:var(--original); color:#fff; }
    .btnAkasha{ background:var(--akasha); color:#fff; }
    .btnStore{ background:var(--store); color:#fff; }

    /* âœ… åˆæœŸã¯å¿…ãšéè¡¨ç¤ºï¼ˆãƒãƒ©è¦‹ãˆé˜²æ­¢ï¼‰ */
    #cardTrial{ display:none; }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>ã”æ³¨æ–‡ã¯ã“ã¡ã‚‰</h1>

    <div class="muted" id="subtext">
      èª­ã¿è¾¼ã¿ä¸­â€¦
    </div>

    <!-- åˆã‚ã¦ã‚»ãƒƒãƒˆ -->
    <div class="card" id="cardTrial">
      <a class="btn btnTrial" id="btnTrial" href="#">
        ğŸ†• åˆã‚ã¦ã®æ–¹é™å®šã‚»ãƒƒãƒˆ
      </a>
      <div class="muted" style="margin-top:8px;">
        â€»åˆå›é™å®š
      </div>
    </div>

    <div class="card">
      <a class="btn btnOriginal" id="btnOriginal" href="#">
        ğŸ ã‚ªãƒªã‚¸ãƒŠãƒ«ã‚»ãƒƒãƒˆ
      </a>
    </div>

    <div class="card">
      <a class="btn btnAkasha" id="btnAkasha" href="#">
        ğŸ˜ ã‚ã‹ã—ã‚ƒã‚·ãƒªãƒ¼ã‚º
      </a>
    </div>

    <div class="card">
      <a class="btn btnStore" id="btnStore" href="#">
        ğŸ  åº—é ­å—å–ï¼ˆç¾é‡‘ï¼‰
      </a>
    </div>
  </div>

<script>
(async function(){
  "use strict";

  // ===== è¦ç´  =====
  const btnTrial    = document.getElementById("btnTrial");
  const btnOriginal = document.getElementById("btnOriginal");
  const btnAkasha   = document.getElementById("btnAkasha");
  const btnStore    = document.getElementById("btnStore");
  const cardTrial   = document.getElementById("cardTrial");
  const subtext     = document.getElementById("subtext");

  if (!btnTrial || !btnOriginal || !btnAkasha || !btnStore || !cardTrial || !subtext) {
    console.error("Missing DOM elements", { btnTrial, btnOriginal, btnAkasha, btnStore, cardTrial, subtext });
    return;
  }

  // ===== ã‚¯ã‚¨ãƒªå–å¾—ï¼ˆé€šå¸¸ + liff.state ä¸¡å¯¾å¿œï¼‰=====
  function getQueryParam(name) {
    const qs = new URLSearchParams(location.search);
    const v1 = qs.get(name);
    if (v1 != null) return v1;

    // LIFF: liff.state ã®ä¸­ã« "?a=1&b=2" ã®å½¢ã§å…¥ã‚‹ã“ã¨ãŒã‚ã‚‹
    const st = qs.get("liff.state");
    if (st) {
      const s = st.startsWith("?") ? st.slice(1) : st;
      const qs2 = new URLSearchParams(s);
      const v2 = qs2.get(name);
      if (v2 != null) return v2;
    }
    return null;
  }

  // ===== LIFF/ãƒªãƒ³ã‚¯è¨­å®š =====
  const LIFF_ID_MENU = window.LIFF_ID_MENU || "2008406620-8CWfgEKh";

  // âœ… configãŒç„¡ã„/èª­ã‚ã¦ãªã„æ™‚ã§ã‚‚æ­»ãªãªã„ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  const LINK_TRIAL    = window.LIFF_LINK_TRIAL    || "https://liff.line.me/2008406620-yQFRswAu";
  const LINK_ORIGINAL = window.LIFF_LINK_ORIGINAL || "https://liff.line.me/2008406620-Bd9Zo9od";
  const LINK_AKASHA   = window.LIFF_LINK_AKASHA   || "https://liff.line.me/2008406620-G5j1gjzM";
  const LINK_STORE    = window.LIFF_LINK_STORE    || "https://liff.line.me/2008406620-7tSkOcqd";

  btnTrial.href    = LINK_TRIAL;
  btnOriginal.href = LINK_ORIGINAL;
  btnAkasha.href   = LINK_AKASHA;
  btnStore.href    = LINK_STORE;

  // ===== show_trial=1ï¼ˆæ¤œè¨¼ç”¨ã€‚è³¼å…¥è€…ã§ã‚‚trialè¡¨ç¤ºï¼‰=====
  const SHOW_TRIAL = getQueryParam("show_trial") === "1";

  // âœ… æ¤œè¨¼ã¯å¿…ãšåŠ¹ã‹ã›ã‚‹ï¼šAPIãŒè½ã¡ã¦ã‚‚å…ˆã«è¡¨ç¤ºã™ã‚‹
  if (SHOW_TRIAL) {
    cardTrial.style.display = "";
    subtext.textContent = "ï¼ˆæ¤œè¨¼ï¼‰åˆã‚ã¦ã‚»ãƒƒãƒˆã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚";
  }

  const API_STATUS = location.origin + "/api/user/status";

  // ===== LIFF init/login =====
  try {
    await liff.init({ liffId: LIFF_ID_MENU });
  } catch (e) {
    console.error("liff.init failed", e);
    // LIFFã§é–‹ã„ã¦ã‚‹å‰æãªã®ã§ã€ã“ã“ã§æ­¢ã¾ã‚‹ã®ã¯ç•°å¸¸
    subtext.textContent = "èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆLIFFåˆæœŸåŒ–ï¼‰ã€‚";
    return;
  }

  if (!liff.isLoggedIn()) {
    liff.login({ redirectUri: location.href });
    return;
  }

  // ===== userIdï¼ˆprofileå„ªå…ˆã€‚subã¯Uå½¢å¼ã®æ™‚ã ã‘ï¼‰=====
  let userId = null;
  try { userId = (await liff.getProfile())?.userId || null; } catch(e){}

  if (!userId) {
    try {
      const sub = liff.getDecodedIDToken()?.sub || null;
      if (sub && /^U[0-9a-f]{32}$/i.test(sub)) userId = sub;
    } catch(e){}
  }

  if (!userId) {
    subtext.textContent = "èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆuserIdå–å¾—ï¼‰ã€‚";
    return;
  }

  // ===== status =====
  // âœ… å¤±æ•—æ™‚ã¯ã€Œæœªè³¼å…¥æ‰±ã„ã€ã§ trial ã‚’å‡ºã™ï¼ˆå›åå„ªå…ˆï¼‰
  let isBuyer = false;
  let showTrialAlways = false;
  let statusOk = false;

  try {
    const res = await fetch(API_STATUS + "?userId=" + encodeURIComponent(userId), {
      method: "GET",
      headers: { "cache-control": "no-store" }
    });
    const json = await res.json().catch(()=>null);

    if (res.ok && json && json.ok === true) {
      statusOk = true;
      isBuyer = !!json.isBuyer;
      showTrialAlways = !!json.showTrialAlways;
    } else {
      console.warn("status failed", res.status, json);
    }
  } catch(e) {
    console.warn("status error", e);
  }

  // ===== è¡¨ç¤ºåˆ¶å¾¡ =====
  // canShowTrial:
  // - ã¾ã è²·ã£ã¦ãªã„ â†’ å‡ºã™
  // - show_trial=1 â†’ å‡ºã™ï¼ˆæ¤œè¨¼ç”¨ï¼‰
  // - showTrialAlways â†’ å‡ºã™ï¼ˆä¾‹å¤–é‹ç”¨ï¼‰
  // - statuså–å¾—å¤±æ•— â†’ å‡ºã™ï¼ˆå›åå„ªå…ˆï¼‰
  const canShowTrial = (!statusOk) || (!isBuyer) || SHOW_TRIAL || showTrialAlways;

  if (canShowTrial) {
    cardTrial.style.display = "";
    subtext.textContent = statusOk
      ? "ã”å¸Œæœ›ã®å•†å“ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"
      : "ï¼ˆé€šä¿¡ãŒä¸å®‰å®šã§ã™ï¼‰ãƒœã‚¿ãƒ³ã‹ã‚‰ãŠé€²ã¿ãã ã•ã„ã€‚";
  } else {
    cardTrial.style.display = "none";
    subtext.textContent = "ã„ã¤ã‚‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ğŸ˜Š";
  }

  // ===== äº‹æ•…é˜²æ­¢ï¼ˆè³¼å…¥è€…ãŒtrialã‚’æŠ¼ã—ãŸæ™‚ï¼‰=====
  // â€» show_trial=1 / showTrialAlways ã®ã¨ãã¯æ¤œè¨¼ãƒ»ä¾‹å¤–é‹ç”¨ãªã®ã§æ­¢ã‚ãªã„
  if (statusOk && isBuyer && !SHOW_TRIAL && !showTrialAlways) {
    btnTrial.addEventListener("click", (e)=>{
      e.preventDefault();
      alert("åˆã‚ã¦ã‚»ãƒƒãƒˆã¯åˆå›é™å®šã§ã™ã€‚");
    });
  }

  // ãƒ‡ãƒãƒƒã‚°ï¼ˆå¿…è¦ãªã‚‰ã‚³ãƒ¡ãƒ³ãƒˆå¤–ã™ï¼‰
  // console.log({ userId, statusOk, isBuyer, showTrialAlways, SHOW_TRIAL, canShowTrial });

})();
</script>
</body>
</html>