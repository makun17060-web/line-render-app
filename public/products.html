<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>住所登録</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body{font-family:system-ui;background:#f7f7f7;margin:0;padding:16px}
.card{background:#fff;border-radius:14px;padding:14px}
button{width:100%;padding:14px;border-radius:14px;font-weight:900}
</style>
</head>

<body>
<div class="card">
  <h2>お届け先住所</h2>
  <input id="addr" placeholder="住所" style="width:100%;padding:12px"><br><br>
  <button id="save">保存</button>
</div>

<script>
(async ()=>{
"use strict";

/* ====== 住所用 LIFF ====== */
const LIFF_ID_ADDRESS = "2008406620-XXXXXXXX"; // ★必須
await liff.init({ liffId: LIFF_ID_ADDRESS });

if(!liff.isLoggedIn()){
  liff.login({ redirectUri: location.href });
  return;
}

/* ====== URL params ====== */
const qs = new URLSearchParams(location.search);
const mode = qs.get("mode");
const returnTo = qs.get("returnTo");

/* ====== 保存 ====== */
document.getElementById("save").onclick = async ()=>{
  const addr = document.getElementById("addr").value.trim();
  if(!addr){ alert("住所を入力してください"); return; }

  await fetch("/api/address/set",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ address:addr })
  });

  if(mode==="order" && returnTo){
    location.replace(returnTo);
  }else{
    liff.closeWindow();
  }
};
})();
</script>
</body>
</html>
