<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>決済完了</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 24px;
      background: #f7f7f7;
      color: #333;
      text-align: center;
    }
    .card {
      max-width: 480px;
      margin: 40px auto;
      background: #fff;
      border-radius: 12px;
      padding: 24px 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    }
    h1 {
      font-size: 20px;
      margin-bottom: 8px;
    }
    p {
      font-size: 14px;
      line-height: 1.6;
      margin: 8px 0;
    }
    #status {
      margin-top: 12px;
      font-size: 13px;
      color: #666;
      white-space: pre-line;
    }
    button {
      margin-top: 16px;
      padding: 10px 18px;
      font-size: 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
    }
    #backLineBtn {
      background: #06c755;
      color: #fff;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>決済が完了しました</h1>
    <p>ありがとうございました。ご注文内容をお店に送信しています。</p>
    <p>しばらくしても LINE に明細が届かない場合は、お店までお問い合わせください。</p>
    <div id="status">注文情報を送信中です…</div>
    <button id="backLineBtn">LINEトーク画面に戻る</button>
  </div>

  <script>
    // confirm.js と同じ候補キー
    const STORAGE_KEYS = [
      "lastStripeOrder", // 優先
      "orderData",
      "miniappOrder",
      "currentOrder",
      "liffOrder",
    ];

    function tryParse(json) {
      try {
        return JSON.parse(json);
      } catch (e) {
        console.warn("JSON parse error:", e);
        return null;
      }
    }

    // いろんな型の注文データを /api/order/complete 用に正規化
    function normalizeOrder(raw) {
      if (!raw) return null;

      // raw.data や raw.order に入っている場合も想定
      const src = raw.data || raw.order || raw;

      let itemsSrc =
        Array.isArray(src.items) ? src.items :
        Array.isArray(src.cart)  ? src.cart  :
        null;

      if (!itemsSrc || !itemsSrc.length) {
        return null;
      }

      const items = [];
      let calcItemsTotal = 0;

      for (const it of itemsSrc) {
        if (!it) continue;

        const id =
          it.id ||
          it.productId ||
          it.code ||
          "";

        const name =
          it.name ||
          it.productName ||
          "商品";

        const price =
          Number(
            it.price ||
            it.unitPrice ||
            it.unit_price ||
            it.unit ||
            0
          ) || 0;

        const qty =
          Number(
            it.qty ||
            it.quantity ||
            it.count ||
            it.num ||
            0
          ) || 0;

        if (!qty || price < 0) continue;

        items.push({ id, name, price, qty });
        calcItemsTotal += price * qty;
      }

      if (!items.length) return null;

      const itemsTotal =
        Number(src.itemsTotal || src.totalAmount || src.total || 0) || calcItemsTotal;

      const shipping = Number(src.shipping || 0) || 0;
      const codFee   = Number(src.codFee   || 0) || 0;
      const finalTotal =
        Number(src.finalTotal || 0) || (itemsTotal + shipping + codFee);

      const address = src.address || null;
      const lineUserId   = src.lineUserId   || src.userId   || "";
      const lineUserName = src.lineUserName || src.userName || "";

      return {
        items,
        itemsTotal,
        shipping,
        codFee,
        finalTotal,
        address,
        lineUserId,
        lineUserName,
      };
    }

    // localStorage / sessionStorage を総当りして注文データを探す
    function loadOrderFromStorage() {
      // 1) lastStripeOrder を最優先
      const directRaw =
        localStorage.getItem("lastStripeOrder") ||
        sessionStorage.getItem("lastStripeOrder");
      if (directRaw) {
        const parsed = tryParse(directRaw);
        if (parsed) {
          console.log("confirm-success: lastStripeOrder 使用", parsed);
          // lastStripeOrder はすでに /api/order/complete 用形式の想定なのでほぼそのまま
          return normalizeOrder({ data: parsed });
        }
      }

      // 2) それ以外の候補キーを順に見る
      for (const key of STORAGE_KEYS) {
        if (key === "lastStripeOrder") continue;
        const raw =
          sessionStorage.getItem(key) ||
          localStorage.getItem(key);
        if (!raw) continue;

        const parsed = tryParse(raw);
        if (!parsed) continue;

        const normalized = normalizeOrder(parsed);
        if (normalized) {
          console.log("confirm-success: キー", key, "から注文データを復元:", normalized);
          return normalized;
        }
      }

      return null;
    }

    async function sendOrderComplete() {
      const statusEl = document.getElementById("status");

      const order = loadOrderFromStorage();
      if (!order) {
        statusEl.textContent =
          "注文情報が見つかりませんでした。\n" +
          "LINEのトーク画面に戻って、注文内容をスクリーンショットしてお店にお知らせください。";
        return;
      }

      try {
        const res = await fetch("/api/order/complete", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(order),
        });

        let data = null;
        try {
          data = await res.json();
        } catch (_) {}

        if (res.ok && data && data.ok) {
          statusEl.textContent =
            "ご注文内容をお店に送信しました。\nLINEのトーク画面に明細が届きます。";
        } else {
          statusEl.textContent =
            "ご注文内容の送信に失敗しました。\n通信状況をご確認のうえ、必要であればお店までご連絡ください。";
          console.error("order/complete error:", data);
        }
      } catch (e) {
        console.error("order/complete exception:", e);
        statusEl.textContent =
          "ご注文内容の送信中にエラーが発生しました。\n必要であればお店までご連絡ください。";
      }
    }

    window.addEventListener("DOMContentLoaded", () => {
      sendOrderComplete();

      document.getElementById("backLineBtn").addEventListener("click", () => {
        // LIFF 内で開いていれば closeWindow、それ以外なら戻る
        if (window.liff && typeof liff.closeWindow === "function") {
          liff.closeWindow();
        } else {
          history.back();
        }
      });
    });
  </script>
</body>
</html>
