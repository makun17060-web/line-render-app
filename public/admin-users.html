<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>管理: ユーザーID & セグメント送信</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  body{font-family:system-ui,Segoe UI,Roboto,sans-serif;max-width:900px;margin:24px auto;padding:0 12px}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  input,textarea,button{font-size:14px}
  input,textarea{width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;box-sizing:border-box}
  textarea{height:180px;font-family:ui-monospace,Consolas,monospace}
  button{padding:10px 14px;border:0;border-radius:8px;cursor:pointer}
  .primary{background:#06C755;color:#fff;font-weight:600}
  .muted{background:#eee}
  .list{white-space:pre-wrap;background:#fafafa;border:1px dashed #ddd;border-radius:8px;padding:10px}
  label{font-size:12px;color:#555}
</style>
</head>
<body>
<h2>管理: ユーザーID取得 & セグメント送信</h2>

<div class="row">
  <input id="token" placeholder="ADMIN_API_TOKEN（必須）">
</div>

<!-- 取得系 -->
<h3>ユーザーIDの取得</h3>
<div class="row">
  <input id="date" placeholder="日付（例: 20251109）空欄で直近ログ">
  <button class="muted" onclick="fetchActive()">今日のユニーク送信者を取得</button>
  <button class="muted" onclick="fetchReservations()">予約者（商品ID指定）</button>
  <input id="pid" placeholder="商品ID/別名（例: 久助 or kusuke-250）">
</div>

<div class="row">
  <button class="muted" onclick="fetchOrders()">注文者（フィルタ任意）</button>
  <input id="ordersPid" placeholder="商品ID（カンマ可）">
  <input id="ordersMethod" placeholder="method（delivery/pickup）">
  <input id="ordersPayment" placeholder="payment（cod/bank/cash）">
</div>

<div class="row">
  <button class="muted" onclick="fetchAddresses()">住所登録済みユーザー</button>
</div>

<div class="row">
  <label>取得した userId</label>
  <textarea id="uids" placeholder="ここに一覧が入ります"></textarea>
  <button onclick="copyIds()">コピー</button>
</div>

<!-- 送信系（テキスト / Flex） -->
<h3>セグメント配信</h3>
<div class="row">
  <label>送信先 userId（上の結果をそのまま貼り付けOK。改行 or カンマ区切り）</label>
  <textarea id="uidsSend" placeholder="Uxxxxxxxxx..."></textarea>
</div>
<div class="row">
  <label>テキスト送信</label>
  <textarea id="msg" placeholder="メッセージ本文（テキスト）"></textarea>
  <button class="primary" onclick="sendText()">テキスト送信</button>
</div>
<div class="row">
  <label>Flex送信（altText と JSON 必須）</label>
  <input id="altText" placeholder="altText（通知に表示）">
  <textarea id="flex" placeholder='{"type":"bubble","body":{"type":"box","layout":"vertical","contents":[{"type":"text","text":"サンプル"}]}}'></textarea>
  <button class="primary" onclick="sendFlex()">Flex送信</button>
</div>

<pre id="out" class="list"></pre>

<script>
const $ = (id)=>document.getElementById(id);
function auth(){return {Authorization:"Bearer "+($("token").value.trim())} }
function parseIds(text){
  return Array.from(new Set(
    text.split(/[\s,]+/).map(s=>s.trim()).filter(Boolean)
  ));
}
function show(obj){ $("out").textContent = typeof obj==="string" ? obj : JSON.stringify(obj,null,2); }

async function fetchActive(){
  const q = new URLSearchParams(); const d=$("date").value.trim();
  if(d) { q.set("date", d); q.set("list", "true"); } else { q.set("list","true"); }
  const r = await fetch("/api/admin/active-chatters?"+q.toString(), { headers:auth() });
  const j = await r.json();
  show(j);
  $("uids").value = (j.users||[]).join("\n");
  $("uidsSend").value = $("uids").value;
}

async function fetchReservations(){
  const pid = $("pid").value.trim();
  const r = await fetch("/api/admin/reservations"+(pid?`?productId=${encodeURIComponent(pid)}`:""), { headers:auth() });
  const j = await r.json();
  const ids = [...new Set((j.items||[]).filter(x=>x.userId).map(x=>x.userId))];
  show({ total:(j.items||[]).length, unique:ids.length, sample:ids.slice(0,10) });
  $("uids").value = ids.join("\n");
  $("uidsSend").value = $("uids").value;
}

async function fetchOrders(){
  const q = new URLSearchParams();
  const p = $("ordersPid").value.trim(); if(p) q.set("productIds", p);
  const m = $("ordersMethod").value.trim(); if(m) q.set("method", m);
  const pay = $("ordersPayment").value.trim(); if(pay) q.set("payment", pay);
  const r = await fetch("/api/admin/orders?"+q.toString(), { headers:auth() });
  const j = await r.json();
  const ids = [...new Set((j.items||[]).map(x=>x.userId).filter(Boolean))];
  show({ total:(j.items||[]).length, unique:ids.length, sample:ids.slice(0,10) });
  $("uids").value = ids.join("\n");
  $("uidsSend").value = $("uids").value;
}

async function fetchAddresses(){
  const r = await fetch("/api/admin/addresses", { headers:auth() });
  const j = await r.json();
  const ids = Object.keys(j.items||{});
  show({ total: ids.length, sample: ids.slice(0,10) });
  $("uids").value = ids.join("\n");
  $("uidsSend").value = $("uids").value;
}

function copyIds(){
  $("uids").select(); document.execCommand("copy");
}

async function sendText(){
  const ids = parseIds($("uidsSend").value);
  const msg = $("msg").value.trim();
  if(ids.length===0 || !msg){ alert("送信先と本文を入力してください"); return; }
  const r = await fetch("/api/admin/segment/send", {
    method:"POST",
    headers:{...auth(),"Content-Type":"application/json"},
    body: JSON.stringify({ userIds: ids, message: msg })
  });
  show(await r.json());
}

async function sendFlex(){
  const ids = parseIds($("uidsSend").value);
  const alt = $("altText").value.trim();
  let contents;
  try{ contents = JSON.parse($("flex").value); }catch(e){ alert("Flex JSONが不正です"); return; }
  if(ids.length===0 || !alt){ alert("送信先とaltTextを入力してください"); return; }
  const r = await fetch("/api/admin/segment/send-flex", {
    method:"POST",
    headers:{...auth(),"Content-Type":"application/json"},
    body: JSON.stringify({ userIds: ids, altText: alt, contents })
  });
  show(await r.json());
}
</script>
</body>
</html>
