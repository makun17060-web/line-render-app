<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>住所入力</title>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root{
      --bg:#f7f7f7; --card:#fff; --text:#111827; --muted:#6b7280;
      --pri:#0b3a53; --border:#e5e7eb; --radius:14px;
      --danger:#b91c1c;
    }
    body{ margin:0; font-family:system-ui,-apple-system,"Segoe UI",sans-serif; background:var(--bg); color:var(--text); }
    .wrap{ max-width:720px; margin:0 auto; padding:14px 14px 28px; }
    h1{ font-size:18px; margin:0 0 6px; }
    .muted{ color:var(--muted); font-size:13px; line-height:1.5; }
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
      padding:14px; margin-top:12px;
    }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .chip{
      border:1px solid var(--border);
      padding:8px 10px; border-radius:999px; background:#fff;
      font-size:13px; cursor:pointer; user-select:none;
    }
    .chip input{ margin-right:6px; }
    .addrList{
      margin-top:10px; display:flex; flex-direction:column; gap:8px;
    }
    .addrItem{
      border:1px solid var(--border); border-radius:12px;
      padding:10px; background:#fff; cursor:pointer;
    }
    .addrItem.active{ outline:2px solid var(--pri); }
    .addrTop{ display:flex; justify-content:space-between; gap:10px; align-items:center; }
    .addrLabel{ font-weight:900; font-size:13px; }
    .addrSmall{ font-size:12px; color:var(--muted); margin-top:4px; line-height:1.4; }
    label{ font-size:13px; font-weight:800; display:block; margin-top:10px; }
    input, select{
      width:100%; padding:10px; border-radius:10px; border:1px solid var(--border);
      font-size:15px; box-sizing:border-box;
    }
    .btn{
      margin-top:14px; width:100%; padding:14px;
      border-radius:14px; border:none;
      background:var(--pri); color:#fff;
      font-weight:900; font-size:16px; cursor:pointer;
    }
    .btnSub{ background:#fff; color:var(--text); border:1px solid var(--border); }
    .note{ font-size:12px; color:var(--muted); margin-top:8px; }
    .hide{ display:none !important; }
  </style>
</head>

<body>
<div class="wrap">
  <h1>住所入力</h1>
  <div class="muted" id="lead">
    注文のために住所を入力してください（登録済みの場合は選択できます）
  </div>

  <div class="card">
    <div style="font-weight:900; font-size:14px;">お届け先</div>
    <div class="note">ギフトの場合は、今回の配送先を別で登録できます（自宅住所は残ります）</div>

    <div class="row" style="margin-top:10px;">
      <label class="chip">
        <input type="radio" name="shipMode" value="self" checked>
        自宅に送る
      </label>
      <label class="chip">
        <input type="radio" name="shipMode" value="gift">
        ギフトで送る（別住所）
      </label>
    </div>

    <div id="addrBookWrap" class="hide" style="margin-top:10px;">
      <div style="font-weight:900; font-size:13px;">登録済み住所から選ぶ（タップで即切替）</div>
      <div id="addrList" class="addrList"></div>

      <button class="btn btnSub" id="newAddrBtn" type="button">＋ 新しい住所を入力する</button>
    </div>
  </div>

  <div class="card" id="formCard">
    <label>ラベル（例：自宅 / 実家 / 贈り先）</label>
    <input id="label" placeholder="自宅">

    <label>お名前</label>
    <input id="name">

    <label>電話番号</label>
    <input id="phone">

    <label>郵便番号</label>
    <input id="postal">

    <label>都道府県</label>
    <input id="prefecture">

    <label>市区町村</label>
    <input id="city">

    <label>番地</label>
    <input id="address1">

    <label>建物名など（任意）</label>
    <input id="address2">

    <label style="margin-top:12px;">
      <input type="checkbox" id="setDefault" style="width:auto; margin-right:8px;">
      この住所を「自宅（デフォルト）」にする
    </label>

    <button class="btn" id="saveBtn" type="button">保存して次へ</button>
    <button class="btn btnSub" id="backBtn" type="button">戻る</button>
  </div>
</div>

<script>
(async function(){
  "use strict";

  // =========================
  // 設計（今回の仕様）
  // - 次回は必ず「自宅表示」から開始（安全）
  // - 自宅 = is_default を自動入力（固定）
  // - ギフト = 前回使ったギフト住所（あれば）を自動入力 / なければ新規
  // - 住所一覧タップで即切替（self/gift それぞれの選択を別保存）
  // - ✅ 重要：gift のとき confirm に戻る際に ship=gift を付ける + isoya_ship_to を保存
  // =========================

  const LIFF_ID_ADDRESS = "2008406620-4kyQVyqe";
  const KEY_UID = "isoya_userId";

  const qs = new URLSearchParams(location.search);
  const mode = (qs.get("mode") || "").trim(); // "", "original", "fukubako"
  const returnToParam = (qs.get("returnTo") || "").trim();

  const KEY_CART =
    (mode === "original") ? "isoya_cart_original"
  : (mode === "fukubako") ? "isoya_cart_fukubako"
  : "isoya_cart";

  const defaultReturnTo =
    (mode === "original") ? "/confirm-original.html"
  : (mode === "fukubako") ? "/confirm.html?mode=fukubako"
  : "/confirm.html";
  const returnTo = returnToParam || defaultReturnTo;

  const backTo =
    (mode === "original") ? "/original-set.html"
  : (mode === "fukubako") ? "/fukubako.html"
  : "/products.html";

  // ✅ self/gift の選択IDを分けて保存（混乱防止）
  const KEY_SELF_ADDR_ID =
    (mode === "original") ? "isoya_selfaddr_original"
  : (mode === "fukubako") ? "isoya_selfaddr_fukubako"
  : "isoya_selfaddr";

  const KEY_GIFT_ADDR_ID =
    (mode === "original") ? "isoya_giftaddr_original"
  : (mode === "fukubako") ? "isoya_giftaddr_fukubako"
  : "isoya_giftaddr";

  const $ = id => document.getElementById(id);

  // ✅ gift/self を confirm に確実に伝える（URL + localStorage）
  function getShipModeSafe(){
    try{
      if (typeof getShipMode === "function") return (getShipMode() || "self").trim();
    }catch{}
    const el = document.querySelector('input[name="shipMode"]:checked');
    return ((el && el.value) ? el.value : "self").trim();
  }
  function persistShipTo(){
    const m = getShipModeSafe();
    localStorage.setItem("isoya_ship_to", (m === "gift") ? "gift" : "self");
    return m;
  }
  function withShipParam(url){
    try{
      const m = getShipModeSafe();
      const u = new URL(url, location.origin);
      if(m === "gift") u.searchParams.set("ship","gift");
      else u.searchParams.delete("ship");
      return u.pathname + u.search;
    }catch{
      const m = getShipModeSafe();
      if(m !== "gift") return url;
      return (url.includes("?") ? (url + "&ship=gift") : (url + "?ship=gift"));
    }
  }
  function goReturnTo(){
    persistShipTo();
    location.href = withShipParam(returnTo);
  }

  function hasCart(){
    try{
      const c = JSON.parse(localStorage.getItem(KEY_CART) || "");
      return Array.isArray(c?.items) && c.items.some(x => x?.id && Number(x.qty||0) > 0);
    }catch{ return false; }
  }

  function setLead(){
    const lead = $("lead");
    if(mode === "fukubako"){
      lead.textContent = "福箱の注文のためにお届け先を選択してください（登録済み住所はタップで即切替できます）";
    }else{
      lead.textContent = "注文のためにお届け先を選択してください（登録済み住所はタップで即切替できます）";
    }
  }
  setLead();

  // =========================
  // LIFF init
  // =========================
  try{
    await liff.init({ liffId: LIFF_ID_ADDRESS });
    if(!liff.isLoggedIn()){
      liff.login({ redirectUri: location.href });
      return;
    }
    const prof = await liff.getProfile();
    if(prof?.userId){
      localStorage.setItem(KEY_UID, prof.userId);
    }
  }catch{
    alert("住所登録画面の初期化に失敗しました");
    return;
  }

  const uid = (localStorage.getItem(KEY_UID) || "").trim();
  if(!uid){
    alert("ユーザー情報が取得できません。ページを開き直してください。");
    return;
  }

  // =========================
  // Address book load
  // =========================
  let addressBook = [];

  // self/gift の選択ID（別保存）
  let selfSelectedId = Number(localStorage.getItem(KEY_SELF_ADDR_ID) || "") || null;
  let giftSelectedId = Number(localStorage.getItem(KEY_GIFT_ADDR_ID) || "") || null;

  async function loadAddressBook(){
    try{
      // ✅ /api/address/list が必要（サーバ側で追加）
      const r = await fetch(`/api/address/list?userId=${encodeURIComponent(uid)}`, { cache:"no-store" });
      const d = await r.json().catch(()=>({}));
      if(r.ok && d?.ok && Array.isArray(d.addresses)){
        addressBook = d.addresses;
      }else{
        addressBook = [];
      }
    }catch{
      addressBook = [];
    }
  }

  // =========================
  // Mode helpers
  // =========================
  function getShipMode(){
    return document.querySelector('input[name="shipMode"]:checked')?.value || "self";
  }
  function setShipMode(v){
    const el = document.querySelector(`input[name="shipMode"][value="${v}"]`);
    if(el) el.checked = true;
  }

  function currentSelectedId(){
    return (getShipMode() === "self") ? selfSelectedId : giftSelectedId;
  }
  function setCurrentSelectedId(id){
    if(getShipMode() === "self"){
      selfSelectedId = id;
      if(id) localStorage.setItem(KEY_SELF_ADDR_ID, String(id));
      else localStorage.removeItem(KEY_SELF_ADDR_ID);
    }else{
      giftSelectedId = id;
      if(id) localStorage.setItem(KEY_GIFT_ADDR_ID, String(id));
      else localStorage.removeItem(KEY_GIFT_ADDR_ID);
    }
  }

  // =========================
  // Form fill / clear
  // =========================
  function fillFormFromAddress(a){
    $("label").value = (a.label || (a.is_default ? "自宅" : ""));
    $("name").value = a.name || "";
    $("phone").value = a.phone || "";
    $("postal").value = a.postal || "";
    $("prefecture").value = a.prefecture || "";
    $("city").value = a.city || "";
    $("address1").value = a.address1 || "";
    $("address2").value = a.address2 || "";
    $("setDefault").checked = !!a.is_default;
  }

  function clearFormForNew(){
    $("label").value = "";
    $("name").value = "";
    $("phone").value = "";
    $("postal").value = "";
    $("prefecture").value = "";
    $("city").value = "";
    $("address1").value = "";
    $("address2").value = "";
    $("setDefault").checked = false;
    // 新規入力 = 今のモード側IDを消す
    setCurrentSelectedId(null);
  }

  // =========================
  // Auto fill policy (今回仕様)
  // =========================
  // ✅ 自宅 = 常に is_default（なければ先頭）
  function ensureSelfAutoFill(){
    const def = addressBook.find(a => a.is_default) || addressBook[0];
    if(!def){
      // 住所帳が空ならフォームは空のまま（入力して保存）
      clearFormForNew();
      $("label").value = "自宅";
      return;
    }
    selfSelectedId = def.id;
    localStorage.setItem(KEY_SELF_ADDR_ID, String(def.id));
    fillFormFromAddress(def);
    if(!$("label").value.trim()) $("label").value = "自宅";
  }

  // ✅ ギフト = 前回ギフト（あれば）/ なければ新規
  function ensureGiftAutoFill(){
    if(giftSelectedId){
      const hit = addressBook.find(a => a.id === giftSelectedId);
      if(hit){
        fillFormFromAddress(hit);
        if(!$("label").value.trim()) $("label").value = "贈り先";
        return;
      }
    }
    clearFormForNew();
    $("label").value = "贈り先";
  }

  // =========================
  // Render address book
  // =========================
  function renderAddressBook(){
    const wrap = $("addrBookWrap");
    const list = $("addrList");
    list.innerHTML = "";

    if(addressBook.length === 0){
      wrap.classList.add("hide");
      return;
    }
    wrap.classList.remove("hide");

    const sid = currentSelectedId();

    for(const a of addressBook){
      const div = document.createElement("div");
      div.className = "addrItem" + (a.id === sid ? " active" : "");
      div.dataset.id = String(a.id);

      const label = (a.label || (a.is_default ? "自宅" : "住所"));
      const topRight = a.is_default ? "自宅(デフォルト)" : "";

      div.innerHTML = `
        <div class="addrTop">
          <div class="addrLabel">${escapeHtml(label)}</div>
          <div class="addrSmall">${escapeHtml(topRight)}</div>
        </div>
        <div class="addrSmall">
          ${escapeHtml(a.name||"")} / ${escapeHtml(a.phone||"")}<br>
          〒${escapeHtml(a.postal||"")} ${escapeHtml(a.prefecture||"")}${escapeHtml(a.city||"")} ${escapeHtml(a.address1||"")} ${escapeHtml(a.address2||"")}
        </div>
      `;

      // ✅ タップで即切替（今のモード側に保存）
      div.onclick = ()=>{
        setCurrentSelectedId(a.id);
        fillFormFromAddress(a);

        document.querySelectorAll(".addrItem").forEach(el=>el.classList.remove("active"));
        div.classList.add("active");
      };

      list.appendChild(div);
    }
  }

  // =========================
  // Mode change handler
  // =========================
  function onModeChanged(){
    const m = getShipMode();

    // ✅ ここで必ず現在のモードを保存（confirm側の判定材料になる）
    persistShipTo();

    if(addressBook.length > 0){
      if(m === "self"){
        // ✅ self は毎回デフォルトへ（前回の self 選択は使わない）
        ensureSelfAutoFill();
      }else{
        // ✅ gift は前回ギフトを復元 or 新規
        ensureGiftAutoFill();
      }
    }else{
      // 住所帳が空のとき
      if(m === "gift"){
        clearFormForNew();
        $("label").value = "贈り先";
      }else{
        clearFormForNew();
        $("label").value = "自宅";
      }
    }

    renderAddressBook();
  }

  document.querySelectorAll('input[name="shipMode"]').forEach(r=>{
    r.addEventListener("change", onModeChanged);
  });

  $("backBtn").onclick = ()=>{
    // 戻るでもモード保存（混乱防止）
    persistShipTo();
    location.href = backTo;
  };

  $("newAddrBtn").onclick = ()=>{
    // 新規入力に切替（今のモード側IDを外す）
    clearFormForNew();
    $("label").value = (getShipMode() === "gift") ? "贈り先" : "自宅";
    renderAddressBook();
  };

  // =========================
  // Boot
  // =========================
  await loadAddressBook();
  renderAddressBook();

  // ✅ 次回は必ず「自宅表示」から開始（安全）
  setShipMode("self");

  // 初期反映
  onModeChanged();

  // =========================
  // Save
  // =========================
  $("saveBtn").onclick = async ()=>{
    if(!hasCart()){
      alert("カートが空です。商品選択からやり直してください。");
      location.href = backTo;
      return;
    }

    const shipMode = getShipMode();

    // ✅ gift/self を保存（confirm側で判定できるように）
    persistShipTo();

    // 今のモード側の addressId（null なら新規）
    const addressId = currentSelectedId();

    const payload = {
      userId: uid,
      addressId: addressId, // nullなら新規
      label: ($("label").value || (shipMode==="gift" ? "贈り先" : "自宅")).trim(),
      is_default: $("setDefault").checked,
      name: $("name").value.trim(),
      phone: $("phone").value.trim(),
      postal: $("postal").value.trim(),
      prefecture: $("prefecture").value.trim(),
      city: $("city").value.trim(),
      address1: $("address1").value.trim(),
      address2: $("address2").value.trim(),
    };

    if(!payload.name || !payload.phone || !payload.postal ||
       !payload.prefecture || !payload.city || !payload.address1){
      alert("必須項目をすべて入力してください");
      return;
    }

    try{
      const r = await fetch("/api/address/set", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      const d = await r.json().catch(()=>({}));
      if(!r.ok || !d?.ok) throw new Error(d?.error || "save failed");

      const newId = Number(d.addressId) || null;
      if(newId){
        // ✅ 保存後は、今のモード側IDとして覚える
        setCurrentSelectedId(newId);

        // ✅ self の場合：デフォルト化したなら self はすぐデフォルトへ寄せる
        if(getShipMode() === "self"){
          selfSelectedId = newId;
          localStorage.setItem(KEY_SELF_ADDR_ID, String(newId));
        }
      }

      alert("お届け先を保存しました");

      // ✅ gift のときは confirm に ship=gift を付けて戻る（代引無効化のため）
      goReturnTo();
    }catch(e){
      console.error(e);
      alert("住所の保存に失敗しました");
    }
  };

  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

})();
</script>
</body>
</html>
