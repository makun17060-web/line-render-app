<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#111111" />
  <title>Scan（発送通知）</title>
  <style>
    :root{
      --bg:#0b0b0c;
      --card:#141416;
      --muted:#9aa0a6;
      --text:#f5f5f7;
      --danger:#ff4d4f;
      --ok:#35c759;
      --line:#2a2a2d;
      --btn:#1f1f22;
      --btn2:#2a2a2d;
      --accent:#4da3ff;

      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-left: env(safe-area-inset-left, 0px);
      --safe-right: env(safe-area-inset-right, 0px);

      /* Android Chromeの下アドレスバー対策 */
      --vh: 1dvh;
    }
    *{ box-sizing:border-box; }
    html,body{
      margin:0; padding:0;
      background:var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      overscroll-behavior: none;
    }
    body{
      min-height: calc(var(--vh) * 100);
      padding: calc(12px + var(--safe-top)) calc(12px + var(--safe-left)) calc(14px + var(--safe-bottom)) calc(12px + var(--safe-right));
    }

    .wrap{
      max-width: 920px;
      margin: 0 auto;
      display:flex;
      flex-direction: column;
      gap: 12px;
    }

    .header{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .title{
      font-size: 16px;
      font-weight: 700;
      letter-spacing: .3px;
    }
    .sub{
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 12px;
      box-shadow: 0 10px 22px rgba(0,0,0,.25);
    }

    .videoWrap{
      position: relative;
      border-radius: 16px;
      overflow:hidden;
      background:#000;
      border: 1px solid var(--line);
      height: clamp(280px, 52dvh, 560px);
    }
    video{
      width:100%;
      height:100%;
      object-fit: cover;
      background:#000;
    }

    .reticle{
      pointer-events:none;
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .reticle > div{
      width: min(76vw, 520px);
      height: min(38vh, 260px);
      border: 2px solid rgba(255,255,255,.65);
      border-radius: 14px;
      box-shadow: 0 0 0 9999px rgba(0,0,0,.25);
      position:relative;
    }
    .reticle > div:before, .reticle > div:after{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius: 14px;
      border: 2px solid rgba(77,163,255,.55);
      filter: drop-shadow(0 0 10px rgba(77,163,255,.25));
      opacity:.7;
    }

    .row{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .btn{
      appearance:none;
      border:1px solid var(--line);
      background: var(--btn);
      color: var(--text);
      padding: 14px 14px;
      border-radius: 14px;
      font-weight: 700;
      font-size: 14px;
      min-height: 48px;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(180deg, #2a6dff, #2a50ff);
      border-color: rgba(77,163,255,.35);
    }
    .btn.danger{
      background: #2a1212;
      border-color: rgba(255,77,79,.35);
      color: #ffd7d7;
    }
    .btn.ghost{
      background: transparent;
    }
    .btn:disabled{
      opacity:.45;
      cursor:not-allowed;
    }

    .input{
      width: 100%;
      padding: 14px 14px;
      border-radius: 14px;
      border:1px solid var(--line);
      background:#0f0f11;
      color: var(--text);
      font-size: 16px;
      outline: none;
      min-height: 48px;
    }
    .hint{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }
    .status{
      font-size: 12px;
      color: var(--muted);
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      align-items: center;
    }
    .pill{
      padding: 6px 10px;
      border-radius: 999px;
      background:#0f0f11;
      border:1px solid var(--line);
      color: var(--muted);
      font-size: 12px;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .pill.ok{ color: #caffd8; border-color: rgba(53,199,89,.35); }
    .pill.bad{ color: #ffd0d0; border-color: rgba(255,77,79,.35); }

    .grid2{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 760px){
      .grid2{
        grid-template-columns: 1.2fr .8fr;
        align-items: start;
      }
      .videoWrap{
        height: clamp(420px, 62dvh, 620px);
      }
    }

    .controls{
      display:flex;
      flex-direction: column;
      gap: 10px;
    }

    .log{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      background:#0f0f11;
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 10px;
      max-height: 260px;
      overflow:auto;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .toast{
      position: fixed;
      left: 12px;
      right: 12px;
      bottom: calc(12px + var(--safe-bottom));
      display:flex;
      justify-content:center;
      pointer-events:none;
      z-index: 9999;
    }
    .toast > div{
      pointer-events:auto;
      max-width: 920px;
      width: 100%;
      background: rgba(20,20,22,.96);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px 12px;
      box-shadow: 0 12px 28px rgba(0,0,0,.35);
      font-size: 13px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      opacity: 0;
      transform: translateY(10px);
      transition: .18s ease;
    }
    .toast.show > div{
      opacity: 1;
      transform: translateY(0);
    }
    .toast strong{ color: var(--text); }
    .toast .small{ color: var(--muted); font-size: 12px; }

    .sliderRow{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
    }
    input[type="range"]{
      width: 180px;
      accent-color: var(--accent);
    }
    details{
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 10px 12px;
      background:#0f0f11;
    }
    details summary{
      cursor:pointer;
      color: var(--text);
      font-weight: 700;
      list-style: none;
    }
    details summary::-webkit-details-marker{ display:none; }
    .kv{
      display:grid;
      grid-template-columns: 110px 1fr;
      gap: 8px 10px;
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
    }
    .kv code{ color: var(--text); }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <div>
        <div class="title">発送スキャン（追跡番号 → shipped → 即通知）</div>
        <div class="sub">QR/バーコードを読む → <code>/api/admin/ship/scan-and-notify</code> に送る</div>
      </div>
      <div class="status">
        <span id="camPill" class="pill">camera: idle</span>
        <span id="netPill" class="pill">api: -</span>
        <span id="zxPill" class="pill">zxing: -</span>
      </div>
    </div>

    <div class="grid2">
      <div class="card">
        <div class="videoWrap">
          <video id="video" playsinline muted></video>
          <div class="reticle"><div></div></div>
        </div>

        <div style="height:10px"></div>

        <div class="row">
          <button id="btnStart" class="btn primary" type="button">カメラ開始</button>
          <button id="btnStop" class="btn danger" type="button" disabled>停止</button>
          <button id="btnTorch" class="btn" type="button" disabled>ライト</button>
          <button id="btnSwitch" class="btn" type="button" disabled>カメラ切替</button>
        </div>

        <div style="height:8px"></div>

        <div class="sliderRow">
          <div class="hint">ズーム</div>
          <input id="zoom" type="range" min="1" max="1" step="0.1" value="1" disabled />
          <span id="zoomLabel" class="pill">x1.0</span>
          <span class="hint">※端末が対応している場合のみ</span>
        </div>

        <div style="height:8px"></div>
        <div class="hint">
          読み取りが弱い時は、<b>ライトON</b>＋<b>バーコードを水平</b>＋<b>距離を少し変える</b>が一番効きます。<br/>
          ビニール反射は厳しいので、<b>角度を少し付ける</b>と通ります。
        </div>

        <div style="height:10px"></div>
        <details>
          <summary>診断（読めない時）</summary>
          <div class="kv">
            <div>HTTPS</div><div><code id="diagHttps">-</code></div>
            <div>ZXing</div><div><code id="diagZxing">-</code></div>
            <div>UA</div><div><code id="diagUA">-</code></div>
            <div>Host</div><div><code id="diagHost">-</code></div>
          </div>
          <div class="hint" style="margin-top:8px;">
            ※ ZXing が <code>missing</code> の場合、CDNがブロック/不達です（ローカル配信に切替推奨）。
          </div>
        </details>
      </div>

      <div class="card controls">
        <div>
          <div style="font-weight:700; margin-bottom:6px;">管理トークン</div>
          <input id="token" class="input" type="password" placeholder="X-Admin-Token（必須）" autocomplete="off" />
          <div class="hint">サーバの <code>ADMIN_API_TOKEN</code> / <code>ADMIN_CODE</code> と同じ値</div>
        </div>

        <div>
          <div style="font-weight:700; margin-bottom:6px;">追跡番号（手入力もOK）</div>
          <input id="code" class="input" inputmode="numeric" placeholder="例：489518570015" />
          <div class="hint">数字以外は自動で除去して送ります（8〜16桁チェック）</div>
        </div>

        <div class="row">
          <button id="btnSend" class="btn primary" type="button">送信（通知）</button>
          <button id="btnClear" class="btn ghost" type="button">クリア</button>
        </div>

        <div class="hint">
          成功すると：<b>status='shipped'</b> に更新 → <b>LINE通知</b> → <b>shipped_notified_at</b> が入る（冪等）。
        </div>

        <div style="font-weight:700;">ログ</div>
        <div id="log" class="log"></div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"><div>
    <div>
      <strong id="toastTitle">-</strong><div class="small" id="toastMsg">-</div>
    </div>
    <button id="toastBtn" class="btn" type="button" style="min-height:40px; padding:10px 12px;">OK</button>
  </div></div>

  <!-- ZXing (Barcode/QR) -->
  <script src="https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/umd/index.min.js"></script>

  <script>
    // Android Chrome のアドレスバーで高さが変わる対策（100dvh補助）
    (function setVh(){
      const v = window.visualViewport;
      const h = v ? v.height : window.innerHeight;
      document.documentElement.style.setProperty('--vh', (h * 0.01) + 'px');
    })();
    window.addEventListener('resize', () => {
      const v = window.visualViewport;
      const h = v ? v.height : window.innerHeight;
      document.documentElement.style.setProperty('--vh', (h * 0.01) + 'px');
    });

    const $ = (id) => document.getElementById(id);

    const logEl = $("log");
    const video = $("video");

    const btnStart  = $("btnStart");
    const btnStop   = $("btnStop");
    const btnTorch  = $("btnTorch");
    const btnSwitch = $("btnSwitch");
    const btnSend   = $("btnSend");
    const btnClear  = $("btnClear");

    const tokenEl = $("token");
    const codeEl  = $("code");

    const camPill = $("camPill");
    const netPill = $("netPill");
    const zxPill  = $("zxPill");

    const zoomEl = $("zoom");
    const zoomLabel = $("zoomLabel");

    const toast = $("toast");
    const toastTitle = $("toastTitle");
    const toastMsg = $("toastMsg");
    const toastBtn = $("toastBtn");

    const diagHttps = $("diagHttps");
    const diagZxing = $("diagZxing");
    const diagUA = $("diagUA");
    const diagHost = $("diagHost");

    function log(...args){
      const line = args.map(x => (typeof x === 'string' ? x : JSON.stringify(x))).join(' ');
      const t = new Date();
      const ts = t.toLocaleString('sv-SE', { timeZone: 'Asia/Tokyo' }).replace('T',' ');
      logEl.textContent = `[${ts}] ${line}\n` + logEl.textContent;
    }

    function showToast(title, msg){
      toastTitle.textContent = title;
      toastMsg.textContent = msg || '';
      toast.classList.add('show');
    }
    toastBtn.addEventListener('click', () => toast.classList.remove('show'));

    function setCamStatus(text, ok=null){
      camPill.textContent = `camera: ${text}`;
      camPill.classList.remove('ok','bad');
      if(ok === true) camPill.classList.add('ok');
      if(ok === false) camPill.classList.add('bad');
    }
    function setNetStatus(text, ok=null){
      netPill.textContent = `api: ${text}`;
      netPill.classList.remove('ok','bad');
      if(ok === true) netPill.classList.add('ok');
      if(ok === false) netPill.classList.add('bad');
    }
    function setZxStatus(text, ok=null){
      zxPill.textContent = `zxing: ${text}`;
      zxPill.classList.remove('ok','bad');
      if(ok === true) zxPill.classList.add('ok');
      if(ok === false) zxPill.classList.add('bad');
    }

    // ====== Camera state ======
    let stream = null;
    let currentVideoTrack = null;
    let usingDeviceId = null;
    let deviceIds = [];
    let torchOn = false;

    let reader = null;
    let scanning = false;

    // クールダウンは分離（重要）
    let lastScanAt = 0;     // 読み取り暴発防止
    let lastApiAt  = 0;     // 二重送信防止
    let lastCode   = '';    // 同一コード連打防止
    let lastCodeAt = 0;

    function normalizeTracking(v){
      return String(v || '').replace(/\s+/g,'').replace(/\D/g,'');
    }
    function isValidTracking(v){
      return /^\d{8,16}$/.test(v);
    }

    async function listVideoDevices(){
      const devices = await navigator.mediaDevices.enumerateDevices();
      const cams = devices.filter(d => d.kind === 'videoinput');
      deviceIds = cams.map(c => c.deviceId).filter(Boolean);
      return cams;
    }

    // ZXingを「読めるように」する：tryHarder + 可能フォーマット絞り
    function buildReader(){
      // ZXingが無ければダメ
      if(typeof ZXing === 'undefined' || !ZXing.BrowserMultiFormatReader){
        return null;
      }

      // UMDで enum が取れない環境もあるので、存在チェックしてから使う
      try{
        const hasHints = ZXing.DecodeHintType && ZXing.BarcodeFormat;
        if(!hasHints){
          log('ZXing enums missing, use default reader');
          return new ZXing.BrowserMultiFormatReader(); // fallback
        }

        const hints = new Map();
        hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
        hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
          ZXing.BarcodeFormat.CODE_128,
          ZXing.BarcodeFormat.ITF,
          ZXing.BarcodeFormat.EAN_13,
          ZXing.BarcodeFormat.EAN_8,
          ZXing.BarcodeFormat.QR_CODE,
        ]);

        // 第二引数は timeBetweenScans（ms）
        return new ZXing.BrowserMultiFormatReader(hints, 500);
      }catch(e){
        log('buildReader failed -> fallback', e?.message || e);
        return new ZXing.BrowserMultiFormatReader();
      }
    }

    async function startCamera(preferredDeviceId=null){
      if(scanning) return;

      if(typeof ZXing === 'undefined' || !ZXing.BrowserMultiFormatReader){
        setZxStatus('missing', false);
        showToast('ZXingが読み込めていません', 'CDNがブロック/不達の可能性。ネット/社内Wi-Fi/広告ブロッカーを確認してください');
        log('ZXing missing');
        return;
      }

      if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
        showToast('この端末ではカメラが使えません', '別の端末/ブラウザで試してください');
        return;
      }

      setCamStatus('starting...', null);
      log('startCamera...');

      // 画質は高めを指定（端末が落とす場合もある）
      const baseConstraints = {
        audio: false,
        video: {
          facingMode: { ideal: "environment" },
          width:  { ideal: 1920 },
          height: { ideal: 1080 }
        }
      };
      if(preferredDeviceId){
        baseConstraints.video.deviceId = { exact: preferredDeviceId };
        delete baseConstraints.video.facingMode;
      }

      try{
        stream = await navigator.mediaDevices.getUserMedia(baseConstraints);
      }catch(e){
        // iOS/一部環境：deviceId exact が失敗することがある → fallback
        log('getUserMedia failed, fallback', e && e.name ? e.name : String(e));
        try{
          stream = await navigator.mediaDevices.getUserMedia({
            audio:false,
            video:{ facingMode:{ ideal:"environment" } }
          });
        }catch(e2){
          setCamStatus('permission denied', false);
          log('getUserMedia failed', e2 && e2.name ? e2.name : String(e2));
          showToast('カメラを許可してください', 'ブラウザの権限設定でカメラを「許可」にしてください');
          return;
        }
      }

      video.srcObject = stream;
      await video.play().catch(()=>{});

      const tracks = stream.getVideoTracks();
      currentVideoTrack = tracks[0] || null;

      // 現在の deviceId 推定（取れないこともある）
      try{
        const settings = currentVideoTrack ? currentVideoTrack.getSettings() : {};
        usingDeviceId = settings.deviceId || preferredDeviceId || null;
        log('camera settings', settings);
      }catch{}

      await refreshCapabilities();

      reader = buildReader();
      if(!reader){
        setZxStatus('missing', false);
        showToast('ZXingが使えません', '読み取りライブラリが初期化できませんでした');
        return;
      }

      scanning = true;
      lastScanAt = 0;
      lastApiAt  = 0;
      lastCode   = '';
      lastCodeAt = 0;

      btnStart.disabled = true;
      btnStop.disabled = false;

      btnSwitch.disabled = true;
      try{
        const cams = await listVideoDevices();
        if((cams || []).length >= 2){
          btnSwitch.disabled = false;
        }
      }catch{}

      setCamStatus('running', true);
      setZxStatus('ready', true);

      // decode loop（重要：errもログに出す）
      reader.decodeFromVideoElement(video, (result, err) => {
        if(!scanning) return;

        if(result){
          const raw = result.getText();
          const code = normalizeTracking(raw);
          if(!code) return;

          codeEl.value = code;
          log('scanned:', raw, '->', code);

          const now = Date.now();

          // スキャン暴発防止（1.2秒）
          if(now - lastScanAt < 1200) return;
          lastScanAt = now;

          // 同じコードを短時間で何度も拾うのを抑制（3秒）
          if(code === lastCode && (now - lastCodeAt) < 3000) return;
          lastCode = code;
          lastCodeAt = now;

          if(!isValidTracking(code)){
            showToast('読み取りはできたが桁が違う', `取得: ${code}（8〜16桁のみ送信）`);
            return;
          }

          // 自動送信
          sendScan(code).catch(()=>{});
          return;
        }

        if(err){
          const name = err.name || err.constructor?.name || '';
          // NotFoundException は「見つからない」なので無視（ログが埋まる）
          if(name !== 'NotFoundException'){
            log('decode err:', name, err.message || String(err));
          }
        }
      });
    }

    async function stopCamera(){
      scanning = false;
      try{ if(reader) reader.reset(); }catch{}
      reader = null;

      if(stream){
        for(const t of stream.getTracks()){
          try{ t.stop(); }catch{}
        }
      }
      stream = null;
      currentVideoTrack = null;
      usingDeviceId = null;
      torchOn = false;

      btnStart.disabled = false;
      btnStop.disabled = true;
      btnTorch.disabled = true;
      btnSwitch.disabled = true;
      zoomEl.disabled = true;
      setCamStatus('stopped', null);
      log('camera stopped');
    }

    async function refreshCapabilities(){
      btnTorch.disabled = true;
      zoomEl.disabled = true;
      zoomEl.min = 1; zoomEl.max = 1; zoomEl.value = 1;
      zoomLabel.textContent = 'x1.0';

      if(!currentVideoTrack) return;

      try{
        const caps = currentVideoTrack.getCapabilities ? currentVideoTrack.getCapabilities() : {};
        const settings = currentVideoTrack.getSettings ? currentVideoTrack.getSettings() : {};
        log('capabilities', caps);

        if(caps && 'torch' in caps){
          btnTorch.disabled = false;
        }

        if(caps && caps.zoom){
          zoomEl.disabled = false;
          zoomEl.min = caps.zoom.min || 1;
          zoomEl.max = caps.zoom.max || 1;
          zoomEl.step = caps.zoom.step || 0.1;

          const z = settings.zoom || 1;
          zoomEl.value = z;
          zoomLabel.textContent = `x${Number(z).toFixed(1)}`;
        }
      }catch(e){
        log('refreshCapabilities failed', e?.message || e);
      }
    }

    async function toggleTorch(){
      if(!currentVideoTrack) return;
      try{
        const caps = currentVideoTrack.getCapabilities ? currentVideoTrack.getCapabilities() : {};
        if(!caps || !('torch' in caps)){
          showToast('ライト非対応', 'この端末はtorch制御に対応していません');
          return;
        }
        torchOn = !torchOn;
        await currentVideoTrack.applyConstraints({ advanced: [{ torch: torchOn }] });
        btnTorch.textContent = torchOn ? 'ライトON' : 'ライト';
        log('torch', torchOn ? 'on' : 'off');
      }catch(e){
        log('torch failed', e?.message || e);
        showToast('ライト切替失敗', '端末の制限で制御できない場合があります');
      }
    }

    async function switchCamera(){
      try{
        const cams = await listVideoDevices();
        if((cams || []).length < 2){
          showToast('カメラが1つしかありません', '');
          return;
        }
        const idx = deviceIds.indexOf(usingDeviceId);
        const nextId = deviceIds[(idx >= 0 ? idx+1 : 0) % deviceIds.length];
        log('switch camera', usingDeviceId, '->', nextId);
        await stopCamera();
        await startCamera(nextId);
      }catch(e){
        log('switchCamera failed', e?.message || e);
        showToast('カメラ切替失敗', 'いったん停止してから試してください');
      }
    }

    async function setZoom(z){
      if(!currentVideoTrack) return;
      try{
        const val = Number(z);
        if(!Number.isFinite(val)) return;
        await currentVideoTrack.applyConstraints({ advanced: [{ zoom: val }] });
        zoomLabel.textContent = `x${val.toFixed(1)}`;
      }catch(e){
        log('zoom failed', e?.message || e);
      }
    }

    // ====== API ======
    async function sendScan(code){
      const token = String(tokenEl.value || '').trim();
      if(!token){
        setNetStatus('token required', false);
        showToast('トークンが必要', 'X-Admin-Token を入力してください');
        return;
      }

      const tracking_no = normalizeTracking(codeEl.value || code);
      if(!isValidTracking(tracking_no)){
        setNetStatus('invalid tracking', false);
        showToast('追跡番号が不正', '8〜16桁の数字のみ送信できます');
        return;
      }

      // 二重送信防止（API側）
      const now = Date.now();
      if(now - lastApiAt < 800) return;
      lastApiAt = now;

      setNetStatus('sending...', null);
      log('POST /api/admin/ship/scan-and-notify', tracking_no);

      try{
        const r = await fetch('/api/admin/ship/scan-and-notify', {
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'X-Admin-Token': token
          },
          body: JSON.stringify({ tracking_no })
        });

        // JSONが返らない（HTML 500など）でも落ちないようにする
        const text = await r.text();
        let j = null;
        try{ j = text ? JSON.parse(text) : null; }catch{ j = { raw: text }; }

        if(!r.ok){
          setNetStatus(`error ${r.status}`, false);
          log('api error', r.status, j || '(no json)');

          const msg =
            (j && j.error === 'order_not_found') ? 'DBにこの追跡番号の注文がありません' :
            (j && j.error === 'tracking_no_duplicated') ? '同じ追跡番号が複数注文に入っています（要修正）' :
            (j && j.error === 'tracking_no_invalid') ? '追跡番号の形式が違います' :
            'サーバエラー';

          showToast('送信失敗', msg);
          return;
        }

        if(j && j.already_notified){
          setNetStatus('already notified', true);
          log('already notified', j);
          showToast('通知済み', `注文ID: ${j.orderId} はすでに発送通知済み`);
        }else{
          setNetStatus('sent', true);
          log('sent ok', j);
          showToast('OK', `発送通知しました（注文ID: ${j.orderId}）`);
        }

        codeEl.select();
      }catch(e){
        setNetStatus('network error', false);
        log('fetch failed', e?.message || e);
        showToast('通信失敗', 'ネットワーク or トークンを確認してください');
      }
    }

    // ====== UI events ======
    btnStart.addEventListener('click', () => startCamera());
    btnStop.addEventListener('click',  () => stopCamera());
    btnTorch.addEventListener('click', () => toggleTorch());
    btnSwitch.addEventListener('click', () => switchCamera());

    btnSend.addEventListener('click', () => sendScan(codeEl.value));
    btnClear.addEventListener('click', () => {
      codeEl.value = '';
      codeEl.focus();
      setNetStatus('-', null);
    });

    zoomEl.addEventListener('input', (e) => setZoom(e.target.value));

    codeEl.addEventListener('keydown', (e) => {
      if(e.key === 'Enter'){
        e.preventDefault();
        sendScan(codeEl.value);
      }
    });

    // ====== 初期ログ & 診断 ======
    log('scan.html ready');
    setCamStatus('idle', null);
    setNetStatus('-', null);

    const zxOk = (typeof ZXing !== 'undefined' && !!ZXing.BrowserMultiFormatReader);
    log('ZXing loaded?', typeof ZXing, zxOk ? 'ok' : 'missing');
    setZxStatus(zxOk ? 'ok' : 'missing', zxOk);

    diagHttps.textContent = (location.protocol === 'https:' || location.hostname === 'localhost') ? 'OK' : 'NG';
    diagZxing.textContent = zxOk ? 'ok' : 'missing';
    diagUA.textContent = navigator.userAgent;
    diagHost.textContent = location.host;

    if(location.protocol !== 'https:' && location.hostname !== 'localhost'){
      showToast('注意', 'カメラはHTTPS必須です（localhost除く）');
    }
  </script>
</body>
</html>