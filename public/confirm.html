<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>注文内容の確認</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root{
      --bg:#f6f7f9;--card:#fff;--text:#111827;--muted:#6b7280;--line:#e5e7eb;
      --pri:#0b3a53;--pri2:#123b66;--danger:#b91c1c;
      --radius:14px;--shadow:0 1px 3px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--text)
    }
    .wrap{max-width:860px;margin:0 auto;padding:14px 14px 26px}
    h1{margin:0 0 6px;font-size:18px}
    .muted{color:var(--muted);font-size:13px;line-height:1.5}
    .err{color:var(--danger);font-weight:900;white-space:pre-line}

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:12px;
      margin-top:12px;
      box-shadow:var(--shadow)
    }

    .row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      margin:0;
      padding:6px 0;
      font-size:14px
    }

    /* 氏名 */
    .nameRow{
      display:block;
      padding:10px 12px 12px;
      border-top:1px solid var(--line);
      margin-top:6px;
      background:#f8fafc;
      border-radius:12px;
    }
    .nameRow .k{
      color:var(--muted);
      font-size:12px;
      margin-bottom:4px;
    }
    .nameRow .v{
      font-weight:1000;
      font-size:18px;
      line-height:1.25;
      word-break:break-word;
    }

    #addrText{
      white-space:pre-line;
      font-weight:700;
      font-size:14px;
      line-height:1.55;
      margin-top:8px;
    }

    /* 商品 */
    .items{margin-top:10px;border-top:1px solid var(--line)}
    .item{
      display:grid;
      grid-template-columns:1fr auto;
      gap:6px 10px;
      padding:12px 0;
      border-bottom:1px dashed var(--line);
      font-size:14px
    }
    .item:last-child{border-bottom:none}
    .item .name{font-weight:800}
    .item .qty{grid-column:1/2;color:var(--muted);font-size:13px}
    .item .price{
      grid-column:2/3;
      grid-row:1/3;
      align-self:center;
      font-weight:900;
      white-space:nowrap
    }

    /* 支払い方法ボタン */
    .pay{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:12px;
    }
    .payBtn{
      border:1px solid var(--line);
      background:#fff;
      border-radius:14px;
      padding:14px 10px;
      font-size:14px;
      font-weight:900;
      cursor:pointer;
      box-shadow:var(--shadow);
      color:var(--text);
    }
    .payBtn.active{
      background:var(--pri2);
      color:#fff;
      border-color:var(--pri2);
    }
    .payBtn:active{
      transform:translateY(1px);
    }

    .btn{
      width:100%;
      border:none;
      border-radius:14px;
      padding:12px 14px;
      font-weight:1000;
      cursor:pointer;
      margin-top:10px
    }
    .btnPrimary{background:var(--pri2);color:#fff}
    .btnGhost{background:#fff;color:#111827;border:1px solid var(--line)}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .trialNotice{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #fecaca;
      background:#fff5f5;
      color:#991b1b;
      font-weight:900;
      font-size:13px;
      line-height:1.55;
      display:none;
    }
  </style>
</head>

<body>
<div class="wrap">
  <h1 id="pageTitle">注文内容の確認</h1>
  <div class="muted" id="status">読み込み中…</div>

  <div class="trialNotice" id="trialNotice">
    ※お試しセットは <b>ご自宅配送のみ</b> です（ギフト配送はできません）
  </div>

  <!-- お届け先 -->
  <div class="card">
    <div class="muted">お届け先</div>

    <div class="nameRow">
      <div class="k">お名前</div>
      <div class="v" id="addrName">—</div>
    </div>

    <div id="addrText">—</div>

    <div class="muted" style="margin-top:8px">
      ※変更は「戻る（住所入力へ）」から行えます。
    </div>
  </div>

  <!-- 商品＆金額 -->
  <div class="card">
    <div class="muted">ご注文商品</div>
    <div class="items" id="items"></div>

    <div class="row"><div>小計</div><div id="subtotal">—</div></div>
    <div class="row"><div>送料（見積）</div><div id="shipping">—</div></div>

    <div class="row" style="border-top:2px solid var(--line);padding-top:10px">
      <div style="font-weight:1000">合計（クレジット）</div>
      <div style="font-weight:1000;font-size:18px" id="totalCard">—</div>
    </div>
    <div class="row">
      <div style="font-weight:1000">合計（代引）</div>
      <div style="font-weight:1000;font-size:18px" id="totalCod">—</div>
    </div>

    <!-- 支払い方法 -->
    <div class="pay">
      <button type="button" class="payBtn active" data-method="card">
        クレジット（Stripe）
      </button>
      <button type="button" class="payBtn" data-method="cod">
        代引き（現金）
      </button>
    </div>

    <button id="nextBtn" class="btn btnPrimary" type="button">次へ進む</button>
    <button id="backBtn" class="btn btnGhost" type="button">戻る（住所入力へ）</button>

    <div class="muted" style="margin-top:8px">
      ※送料は見積り表示です（確定時に再計算されます）。
    </div>
  </div>
</div>

<script>
(async function(){
  "use strict";

  const LIFF_ID_ORDER = "2008406620-G5j1gjzM";
  const KEY_UID = "isoya_userId";
  const KEY_LAST_QUOTE = "isoya_last_quote";

  const qs = new URLSearchParams(location.search);
  const mode = (qs.get("mode") || "").trim();

  const isTrial = (mode === "trial" || mode === "fukubako");
  const trialNotice = document.getElementById("trialNotice");
  const pageTitle = document.getElementById("pageTitle");
  if(isTrial){
    pageTitle.textContent = "お試しセット｜注文内容の確認";
    document.title = pageTitle.textContent;
    trialNotice.style.display = "block";
  }

  const KEY_CART =
    (mode === "original") ? "isoya_cart_original"
  : (mode === "fukubako") ? "isoya_cart_fukubako"
  : "isoya_cart";

  const RETURN_TO_THIS =
    (mode === "fukubako") ? "/confirm.html?mode=fukubako"
  : (mode === "original") ? "/confirm-original.html"
  : "/confirm.html";

  const NEXT_CONFIRM_CARD =
    (mode === "fukubako") ? "/pay-card.html?mode=fukubako"
  : (mode === "original") ? "/pay-card.html?mode=original"
  : "/pay-card.html";

  // ✅ 注意：public/ をURLに付けないのが基本（Express static の想定）
  const NEXT_CONFIRM_COD =
    (mode === "fukubako") ? "/confirm_cod.html?mode=fukubako"
  : (mode === "original") ? "/confirm_cod.html?mode=original"
  : "/confirm_cod.html";

  const status = document.getElementById("status");
  const addrNameEl = document.getElementById("addrName");
  const addrTextEl = document.getElementById("addrText");
  const itemsEl = document.getElementById("items");
  const subtotalEl = document.getElementById("subtotal");
  const shippingEl = document.getElementById("shipping");
  const totalCardEl = document.getElementById("totalCard");
  const totalCodEl = document.getElementById("totalCod");
  const nextBtn = document.getElementById("nextBtn");
  const backBtn = document.getElementById("backBtn");

  const yen = n => (Number(n)||0).toLocaleString("ja-JP") + "円";
  const loadJson = k => { try { return JSON.parse(localStorage.getItem(k)||""); } catch { return null; } };

  let selectedPayMethod = "card";

  document.querySelectorAll(".payBtn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll(".payBtn").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      selectedPayMethod = btn.dataset.method;
    });
  });

  try{
    status.textContent = "確認中…";

    await liff.init({ liffId: LIFF_ID_ORDER });
    if(!liff.isLoggedIn()) throw new Error("ログインできません");

    const prof = await liff.getProfile();
    const uid = prof.userId;
    localStorage.setItem(KEY_UID, uid);

    const cart = loadJson(KEY_CART) || { items: [] };
    const items = cart.items || [];

    const addr = await (await fetch(`/api/address/get?userId=${uid}`)).json();
    addrNameEl.textContent = addr?.address?.name || "（未入力）";
    addrTextEl.textContent =
      `〒${addr.address.postal} ${addr.address.prefecture}${addr.address.city}${addr.address.address1} ${addr.address.address2}\nTEL: ${addr.address.phone}`;

    const products = (await (await fetch("/api/products")).json()).products;
    let subtotal = 0;
    itemsEl.innerHTML = "";

    items.forEach(it=>{
      const p = products.find(x=>x.id===it.id);
      if(!p) return;
      const line = p.price * it.qty;
      subtotal += line;
      itemsEl.innerHTML += `
        <div class="item">
          <div class="name">${p.name}</div>
          <div class="price">${yen(line)}</div>
          <div class="qty">× ${it.qty} 点</div>
        </div>`;
    });

    subtotalEl.textContent = yen(subtotal);

    const quote = await (await fetch("/api/order/quote",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({ uid, checkout:{ items } })
    })).json();

    shippingEl.textContent = yen(quote.shippingFee);

    const amount_yen = subtotal + quote.shippingFee; // ✅ Stripe用の「円」合計
    totalCardEl.textContent = yen(amount_yen);
    totalCodEl.textContent = yen(quote.totalCod);

    // ✅ ここが今回の修正：pay-card.html が読む amount_yen を last_quote に保存
    localStorage.setItem(KEY_LAST_QUOTE, JSON.stringify({
      ...quote,
      uid,
      mode,
      subtotal,
      amount_yen
    }));

    status.textContent = "内容をご確認ください。";

    backBtn.onclick = ()=>{
      location.href = `/cod-register.html?returnTo=${encodeURIComponent(RETURN_TO_THIS)}&mode=${encodeURIComponent(mode||"")}&liff.hback=2`;
    };

    nextBtn.onclick = ()=>{
      nextBtn.disabled = true;
      const next = (selectedPayMethod === "cod") ? NEXT_CONFIRM_COD : NEXT_CONFIRM_CARD;
      location.href = next;
    };

  }catch(e){
    status.textContent = "読み込みに失敗しました";
    status.classList.add("err");
    status.textContent += "\n" + (e?.message || String(e));
  }
})();
</script>
</body>
</html>
