<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>セグメント配信 管理画面</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, sans-serif;
      padding: 16px;
    }
    h1 {
      font-size: 20px;
      margin-bottom: 8px;
    }
    h2 {
      margin-top: 24px;
      font-size: 18px;
      border-bottom: 1px solid #ccc;
      padding-bottom: 4px;
    }
    .section {
      margin-top: 12px;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .row {
      margin: 4px 0;
    }
    button {
      margin: 2px 0;
    }
    textarea {
      width: 100%;
      box-sizing: border-box;
    }
    #log {
      margin-top: 12px;
      max-height: 200px;
      overflow: auto;
      font-size: 12px;
      background: #f5f5f5;
      padding: 4px;
      white-space: pre-wrap;
    }
    #userIdsPreview {
      font-size: 11px;
      white-space: pre-wrap;
      background: #fafafa;
      border: 1px solid #ddd;
      padding: 4px;
      max-height: 150px;
      overflow: auto;
    }
  </style>
</head>
<body>
  <h1>セグメント配信 管理画面</h1>

  <!-- 接続・トークン -->
  <div class="section">
    <div class="row">
      接続トークン（URLの ?code= または ?token= でも可）:
      <input type="text" id="tokenInput" style="width:250px;" />
      <button id="saveTokenBtn">保存</button>
    </div>
    <div class="row">
      <button id="pingBtn">接続テスト</button>
      <span id="status"></span>
    </div>
  </div>

  <!-- セグメント条件 -->
  <h2>セグメント条件</h2>
  <div class="section">
    <div class="row">
      種別：
      <select id="segmentType">
        <option value="activeChatters">最近トークした人</option>
        <option value="addresses">住所登録者</option>
      </select>
      <button id="segmentPreviewBtn">対象を集計</button>
    </div>
    <div class="row">
      対象人数：<span id="segmentCount">0</span>人
      <button id="togglePreviewBtn">ID一覧を表示/非表示</button>
    </div>
    <div id="userIdsPreview" style="display:none;"></div>
  </div>

  <!-- テキスト配信 -->
  <h2>テキスト一斉配信</h2>
  <div class="section">
    <div class="row">
      メッセージ本文：<br />
      <textarea id="segmentMessage" rows="5" placeholder="ここに配信する文章を入力してください"></textarea>
    </div>
    <div class="row">
      <button id="segmentSendBtn">テキストを一斉配信</button>
    </div>
  </div>

  <div id="log"></div>

  <script>
    (function(){
      const $ = (id) => document.getElementById(id);
      const logEl = $("log");
      const STATUS = $("status");
      let currentSegmentUserIds = [];

      function log(msg) {
        const line = "[" + new Date().toLocaleString() + "] " + msg + "\\n";
        logEl.textContent = line + logEl.textContent;
      }

      // ===== トークン管理 =====
      function getTokenFromUrlOrStorage() {
        const params = new URLSearchParams(location.search);
        const fromUrl = params.get("code") || params.get("token") || "";
        if (fromUrl) {
          localStorage.setItem("adminToken", fromUrl);
          return fromUrl;
        }
        const saved = localStorage.getItem("adminToken") || "";
        return saved;
      }
      function getToken() {
        return $("tokenInput").value.trim();
      }

      // 初期化：URL or localStorage からトークン読み込み
      const initToken = getTokenFromUrlOrStorage();
      $("tokenInput").value = initToken;
      if (!initToken) {
        STATUS.textContent = "トークン未設定です。?code=ADMIN_CODE をURLにつけるか、上に入力してください。";
      }

      $("saveTokenBtn").addEventListener("click", () => {
        const t = getToken();
        if (!t) {
          alert("トークンを入力してください。");
          return;
        }
        localStorage.setItem("adminToken", t);
        STATUS.textContent = "トークンを保存しました。";
        log("トークン保存: " + t);
      });

      // 共通 fetch
      async function apiFetch(path, options = {}) {
        const token = getToken();
        if (!token) throw new Error("トークン未設定");
        const url = path + (path.includes("?") ? "&" : "?") + "token=" + encodeURIComponent(token);
        const opt = Object.assign({
          method: "GET",
          headers: { "Content-Type": "application/json" },
        }, options);
        const res = await fetch(url, opt);
        const data = await res.json().catch(() => ({}));
        if (!res.ok || data.ok === false) {
          throw new Error(data.error || (res.status + " error"));
        }
        return data;
      }

      // ===== 接続テスト =====
      $("pingBtn").addEventListener("click", async () => {
        try {
          STATUS.textContent = "接続テスト中...";
          const data = await apiFetch("/api/admin/ping");
          STATUS.textContent = "接続OK";
          log("接続テスト: " + JSON.stringify(data));
        } catch (e) {
          STATUS.textContent = "接続エラー: " + e.message;
          log("接続エラー: " + e.message);
          alert("接続に失敗しました: " + e.message + "\\nトークンやURLを確認してください。");
        }
      });

      // ===== セグメント集計 =====
      $("segmentPreviewBtn").addEventListener("click", async () => {
        try {
          const t = $("segmentType").value;
          const body = JSON.stringify({ type: t });
          const data = await apiFetch("/api/admin/segment/preview", {
            method: "POST",
            body
          });
          currentSegmentUserIds = data.userIds || [];
          $("segmentCount").textContent = currentSegmentUserIds.length;

          // 先頭何件かだけプレビュー表示
          const previewArea = $("userIdsPreview");
          const maxShow = 100;
          const slice = currentSegmentUserIds.slice(0, maxShow);
          let text = "";
          if (!slice.length) {
            text = "対象ユーザーがいません。";
          } else {
            text = slice.join("\\n");
            if (currentSegmentUserIds.length > maxShow) {
              text += "\\n... 他 " + (currentSegmentUserIds.length - maxShow) + " 件";
            }
          }
          previewArea.textContent = text;

          log("セグメント集計: " + t + " → " + currentSegmentUserIds.length + "人");
        } catch (e) {
          alert("セグメント集計エラー: " + e.message);
          log("セグメント集計エラー: " + e.message);
        }
      });

      // ID一覧の表示/非表示
      $("togglePreviewBtn").addEventListener("click", () => {
        const el = $("userIdsPreview");
        el.style.display = (el.style.display === "none" || !el.style.display) ? "block" : "none";
      });

      // ===== テキスト一斉配信 =====
      $("segmentSendBtn").addEventListener("click", async () => {
        try {
          if (!currentSegmentUserIds.length) {
            alert("まず「対象を集計」を押してください。");
            return;
          }
          const msg = $("segmentMessage").value.trim();
          if (!msg) {
            alert("メッセージ本文を入力してください。");
            return;
          }
          if (!confirm(currentSegmentUserIds.length + "人にテキストを配信します。よろしいですか？")) {
            return;
          }
          const body = JSON.stringify({ userIds: currentSegmentUserIds, message: msg });
          const data = await apiFetch("/api/admin/segment/send", {
            method: "POST",
            body
          });
          alert("配信リクエスト完了: 送信 " + data.sent + " / 失敗 " + data.failed);
          log("セグメント送信: " + JSON.stringify(data));
        } catch (e) {
          alert("配信エラー: " + e.message);
          log("配信エラー: " + e.message);
        }
      });

      // 初期ログ
      log("セグメント配信画面ロード完了");
    })();
  </script>
</body>
</html>

