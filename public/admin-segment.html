(async function(){
  const $ = (id)=>document.getElementById(id);
  const logEl = $("log");
  const log = (m)=>{
    const t = new Date().toLocaleString();
    logEl.textContent = `[${t}] ${m}\n` + logEl.textContent;
  };

  // タブ切替（そのまま）
  document.querySelectorAll(".tab").forEach(tab=>{
    tab.addEventListener("click", ()=>{
      document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
      tab.classList.add("active");
      const name = tab.dataset.tab;
      $("tab-seg").classList.toggle("hide", name!=="seg");
      $("tab-manual").classList.toggle("hide", name!=="manual");
    });
  });

  // メッセージ形式切替（セグメント）
  $("messageType").addEventListener("change", ()=>{
    const isFlex = $("messageType").value==="flex";
    $("textAreaWrap").classList.toggle("hide", isFlex);
    $("flexAreaWrap").classList.toggle("hide", !isFlex);
  });

  // メッセージ形式切替（手動）
  $("manualMessageType").addEventListener("change", ()=>{
    const isFlex = $("manualMessageType").value==="flex";
    $("manualTextWrap").classList.toggle("hide", isFlex);
    $("manualFlexWrap").classList.toggle("hide", !isFlex);
  });

  const api = (path)=>{
    const base = ($("apiBase").value||"").trim();
    return base ? (base.replace(/\/$/,"")+path) : path;
  };

  // ★あなたの server.js と一致するエンドポイント
  const ENDPOINTS = {
    preview:  "/api/admin/segment/preview",
    sendText: "/api/admin/segment/send",
    sendFlex: "/api/admin/segment/send-flex",
  };

  // server.js の requireAdmin が見る token をURLにつける
  const withToken = (path)=>{
    const tok = $("adminToken").value.trim();
    return api(path) + (path.includes("?") ? "&" : "?") + "token=" + encodeURIComponent(tok);
  };

  // server.js の type 名に合わせたマップ
  function uiSegmentToType(uiVal){
    switch(uiVal){
      case "all":           return "addresses";      // 全友だち的に一番近いのは addresses（住所登録者）
      case "text_senders":  return "textSenders";    // or activeChatters
      case "purchasers":    return "orders";
      case "reservations":  return "orders";         // 予約ログ単体typeは無いので注文者扱いに寄せる
      case "roulette_winners": return "survey";      // 抽選=アンケート経由なら survey
      default: return uiVal || "orders";
    }
  }

  // 日付→ server.js は date=YYYYMMDD を想定
  function ymdFromInput(dateStr){
    if(!dateStr) return "";
    return dateStr.replaceAll("-","");
  }

  // ===== 対象数プレビュー =====
  $("previewBtn").addEventListener("click", async ()=>{
    const adminToken = $("adminToken").value.trim();
    if(!adminToken){ alert("管理トークンを入力してください"); return; }

    const type = uiSegmentToType($("segmentType").value);

    const payload = {
      type,
      limit: 50000
    };

    // date指定がある場合のみ付与（server.js仕様）
    const from = ymdFromInput($("fromDate").value);
    const to   = ymdFromInput($("toDate").value);
    // あなたの preview は「単日(date)」だけ対応。
    // 期間が入ってたら「fromDateを代表日」として扱う。
    if(from) payload.date = from;

    log("preview start: " + JSON.stringify(payload));

    try{
      const res = await fetch(withToken(ENDPOINTS.preview),{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify(payload)
      });
      const data = await res.json().catch(()=>null);

      if(!res.ok || !data?.ok){
        $("previewResult").innerHTML = `対象数：<span class="ng">取得失敗</span>`;
        log("preview NG: " + res.status + " " + JSON.stringify(data));
        alert("対象数プレビューに失敗しました。");
        return;
      }

      const count = data.total ?? (data.userIds?.length ?? "?");
      $("previewResult").innerHTML = `対象数：<span class="ok">${count}人</span>`;
      log("preview OK: " + JSON.stringify({type:data.type, total:count}));
    }catch(e){
      log("preview ERR: " + e);
      alert("通信エラー。URL/Render起動状態を確認してください。");
    }
  });

  // ===== セグメント配信 =====
  $("sendBtn").addEventListener("click", ()=>sendSegment(false));
  $("dryRunBtn").addEventListener("click", ()=>sendSegment(true));

  async function sendSegment(dryRun){
    const adminToken = $("adminToken").value.trim();
    if(!adminToken){ alert("管理トークンを入力してください"); return; }

    const type = uiSegmentToType($("segmentType").value);
    const payloadPreview = { type, limit: 50000 };
    const from = ymdFromInput($("fromDate").value);
    if(from) payloadPreview.date = from;

    // まず preview して対象IDを取得
    log("send step1 preview: " + JSON.stringify(payloadPreview));
    let preview;
    try{
      const pres = await fetch(withToken(ENDPOINTS.preview),{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify(payloadPreview)
      });
      preview = await pres.json().catch(()=>null);
      if(!pres.ok || !preview?.ok) throw new Error("preview_failed");
    }catch(e){
      log("send preview ERR: " + e);
      alert("対象抽出に失敗しました。");
      return;
    }

    const userIds = Array.isArray(preview.userIds) ? preview.userIds : [];
    if(userIds.length===0){
      alert("対象ユーザーが0人です。");
      return;
    }

    if(dryRun){
      log(`dry-run only. targets=${userIds.length}`);
      alert(`dry-run：対象 ${userIds.length}人（送信はしていません）`);
      return;
    }

    const messageType = $("messageType").value;

    // ===== テキスト送信 =====
    if(messageType==="text"){
      const text = $("textMessage").value.trim();
      if(!text){ alert("テキストを入力してください"); return; }

      const payloadSend = { userIds, message: text };
      log("send text start: " + JSON.stringify({targets:userIds.length}));

      try{
        const res = await fetch(withToken(ENDPOINTS.sendText),{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body:JSON.stringify(payloadSend)
        });
        const data = await res.json().catch(()=>null);
        if(!res.ok || !data?.ok){
          log("send text NG: " + res.status + " " + JSON.stringify(data));
          alert("テキスト配信に失敗しました。");
          return;
        }
        log("send text OK: " + JSON.stringify(data));
        alert(`送信OK！ 対象:${data.requested} / 送信:${data.sent}`);
      }catch(e){
        log("send text ERR: " + e);
        alert("通信エラー。");
      }
      return;
    }

    // ===== Flex送信 =====
    const raw = $("flexJson").value.trim();
    if(!raw){ alert("Flex JSONを入力してください"); return; }

    let flex;
    try{ flex = JSON.parse(raw); }catch{ alert("Flex JSONが不正です"); return; }

    // 期待形式：
    // {"type":"flex","altText":"...","contents":{...}}
    const altText = flex.altText || flex.alt || "お知らせ";
    const contents = flex.contents || flex.body || null;
    if(!contents){ alert("Flex JSONに contents が必要です"); return; }

    const payloadSendFlex = { userIds, altText, contents };

    log("send flex start: " + JSON.stringify({targets:userIds.length}));

    try{
      const res = await fetch(withToken(ENDPOINTS.sendFlex),{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify(payloadSendFlex)
      });
      const data = await res.json().catch(()=>null);
      if(!res.ok || !data?.ok){
        log("send flex NG: " + res.status + " " + JSON.stringify(data));
        alert("Flex配信に失敗しました。");
        return;
      }
      log("send flex OK: " + JSON.stringify(data));
      alert(`Flex送信OK！ 対象:${data.requested} / 送信:${data.sent}`);
    }catch(e){
      log("send flex ERR: " + e);
      alert("通信エラー。");
    }
  }

  log("admin-segment loaded. ENDPOINTS=" + JSON.stringify(ENDPOINTS));
})();
