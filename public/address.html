<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>住所登録</title>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root{
      --bg:#f6f7f9;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --primary:#0b3a53;
      --border:#e5e7eb;
      --radius:14px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{
      max-width:720px;
      margin:0 auto;
      padding:16px 14px 40px;
    }
    h1{ font-size:20px; margin:0 0 8px; }
    .lead{
      font-size:13px;
      color:var(--muted);
      margin-bottom:14px;
      line-height:1.6;
    }
    .card{
      background:var(--card);
      border-radius:var(--radius);
      padding:14px;
      box-shadow:0 1px 3px rgba(0,0,0,.08);
    }
    .field{ margin-bottom:10px; }
    label{
      display:block;
      font-size:13px;
      font-weight:700;
      margin-bottom:4px;
    }
    input, select{
      width:100%;
      padding:10px;
      font-size:15px;
      border-radius:10px;
      border:1px solid var(--border);
    }
    button{
      width:100%;
      padding:14px;
      margin-top:14px;
      font-size:16px;
      font-weight:700;
      border-radius:12px;
      border:none;
      background:var(--primary);
      color:#fff;
      cursor:pointer;
    }
    button:disabled{
      opacity:.6;
      cursor:not-allowed;
    }
    .status{
      margin-top:10px;
      font-size:13px;
      color:var(--muted);
      min-height:1.4em;
      white-space:pre-wrap;
    }
  </style>
</head>

<body>
<div class="wrap">
  <h1>住所登録</h1>
  <p class="lead">
    商品発送に必要な情報をご入力ください。
  </p>

  <div class="card">
    <div class="field">
      <label>お名前</label>
      <input id="name" placeholder="例）木村 太郎" />
    </div>

    <div class="field">
      <label>電話番号</label>
      <input id="phone" placeholder="09012345678" inputmode="tel" />
    </div>

    <div class="field">
      <label>郵便番号</label>
      <input id="postal" placeholder="1234567（ハイフン不要）" inputmode="numeric" />
    </div>

    <div class="field">
      <label>都道府県</label>
      <input id="prefecture" placeholder="例）愛知県" />
    </div>

    <div class="field">
      <label>市区町村・番地</label>
      <input id="address1" placeholder="例）豊橋市〇〇町1-2-3" />
    </div>

    <div class="field">
      <label>建物名・部屋番号（任意）</label>
      <input id="address2" placeholder="例）〇〇マンション101" />
    </div>

    <button id="saveBtn" disabled>住所を保存する</button>

    <div id="status" class="status"></div>
  </div>
</div>

<script>
(async function(){
  const $ = (id) => document.getElementById(id);
  const statusEl = $("status");
  const saveBtn = $("saveBtn");

  let userId = "";

  function setStatus(msg){ statusEl.textContent = msg || ""; }

  async function getLiffIdForAdd(){
    const res = await fetch("/api/liff/config?kind=add", { cache:"no-store" });
    const cfg = await res.json().catch(()=> ({}));
    if(!res.ok || !cfg.ok || !cfg.liffId) throw new Error("LIFF設定取得失敗");
    return cfg.liffId;
  }

  // ✅ 保存済み住所の自動読み込み（GET→ダメならPOST）
  async function loadExistingAddress(){
    try{
      // 1) GET /api/address/get?userId=...
      let r = await fetch(`/api/address/get?userId=${encodeURIComponent(userId)}`, { cache:"no-store" });
      let d = await r.json().catch(()=> ({}));

      // 2) サーバー実装が POST の場合もあるのでフォールバック
      if(!r.ok || !d.ok){
        r = await fetch("/api/address/get",{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ userId })
        });
        d = await r.json().catch(()=> ({}));
      }

      if(!r.ok || !d.ok || !d.address) return;

      const a = d.address;

      // 互換（pref / prefecture、zip / postal、address / address1 等）
      $("name").value       = a.name || "";
      $("phone").value      = a.phone || "";
      $("postal").value     = a.postal || a.zip || "";
      $("prefecture").value = a.prefecture || a.pref || "";
      $("address1").value   = a.address1 || a.address || "";
      $("address2").value   = a.address2 || "";

    }catch{
      // 読み出し失敗は無視（保存はできるようにする）
    }
  }

  try{
    const liffId = await getLiffIdForAdd();
    await liff.init({ liffId });

    if(!liff.isLoggedIn()){
      liff.login({ redirectUri: location.href });
      return;
    }

    const profile = await liff.getProfile();
    userId = profile.userId || "";
    if(!userId) throw new Error("userId取得失敗");

    // ✅ 初期化が終わったらボタン有効化（ログ表示なし）
    saveBtn.disabled = false;

    // ✅ ここで保存済み住所を自動表示
    await loadExistingAddress();

  }catch(e){
    setStatus(
      "初期化に失敗しました。\n" +
      "・LINEアプリ内（LIFF）で開いているか\n" +
      "・LIFF_ID_ADD が正しいか\n" +
      "を確認してください。"
    );
    return;
  }

  // 郵便番号 → 住所補完
  $("postal").addEventListener("blur", async ()=>{
    const zip = $("postal").value.trim();
    if(!/^\d{7}$/.test(zip)) return;
    try{
      const r = await fetch(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${zip}`);
      const d = await r.json();
      if(d.results && d.results[0]){
        $("prefecture").value = d.results[0].address1;
        $("address1").value = d.results[0].address2 + d.results[0].address3;
      }
    }catch{}
  });

  saveBtn.addEventListener("click", async ()=>{
    const payload = {
      userId,
      name: $("name").value.trim(),
      phone: $("phone").value.trim(),
      postal: $("postal").value.trim(),
      prefecture: $("prefecture").value.trim(),
      address1: $("address1").value.trim(),
      address2: $("address2").value.trim(),
    };

    if(!payload.name || !payload.phone || !payload.postal || !payload.prefecture || !payload.address1){
      setStatus("すべて入力してください");
      return;
    }

    setStatus("保存中…");
    saveBtn.disabled = true;

    try{
      const r = await fetch("/api/address/set",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify(payload)
      });
      const d = await r.json().catch(()=> ({}));
      if(!r.ok || !d.ok) throw new Error("save failed");

      // ✅ 保存後に即反映（次回だけじゃなくこの場でも整合を取る）
      await loadExistingAddress();

      setStatus("保存しました。画面を閉じます…");
      setTimeout(()=>{ try{ liff.closeWindow(); }catch{} }, 800);

    }catch{
      setStatus("保存に失敗しました。もう一度お試しください。");
      saveBtn.disabled = false;
    }
  });
})();
</script>

</body>
</html>
