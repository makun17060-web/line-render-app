<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Flex メッセージ管理</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --gap: 12px; }
    html,body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; }
    body { max-width: 920px; margin: 20px auto; padding: 0 16px; }
    h1 { font-size: 20px; margin: 0 0 8px; }
    h2 { font-size: 16px; margin: 24px 0 8px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin-top: var(--gap); }
    .row { display: grid; grid-template-columns: 1fr 2fr; gap: var(--gap); align-items: start; }
    .row > label { margin-top: 10px; font-size: 14px; color: #333; }
    input[type="text"], textarea { width: 100%; box-sizing: border-box; border: 1px solid #ccc; border-radius: 8px; padding: 10px; font-size: 14px; }
    textarea { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; min-height: 220px; }
    .help { font-size: 12px; color: #666; margin-top: 6px; white-space: pre-line; }
    .btns { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    button { padding: 10px 14px; border: 0; border-radius: 8px; cursor: pointer; }
    .primary { background: #06C755; color: #fff; font-weight: 600; }
    .secondary { background: #eee; }
    .danger { background: #e53935; color: #fff; }
    .ok { color: #0a7a3c; }
    .err { color: #b00020; white-space: pre-line; }
    .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--gap); }
    @media (max-width: 800px) { .row, .grid { grid-template-columns: 1fr; } }
    pre { background:#fafafa; border:1px solid #eee; border-radius:10px; padding:12px; overflow:auto; }
  </style>
</head>
<body>
  <h1>Flex メッセージ管理（管理者用）</h1>

  <div class="card">
    <div class="row">
      <label for="token">管理トークン（ADMIN_API_TOKEN）</label>
      <div>
        <input id="token" type="text" placeholder="Render の ADMIN_API_TOKEN を入力" />
        <div class="btns">
          <button class="secondary" id="pingBtn">接続テスト（/api/admin/ping）</button>
          <span id="pingResult" class="help"></span>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>配信モード</h2>
    <div class="grid">
      <div>
        <input type="radio" name="mode" id="modeBroadcast" value="broadcast" checked />
        <label for="modeBroadcast"><b>全体配信</b>（/api/admin/broadcast-flex）</label>
        <div class="help">フォロワー全員へ配信します。</div>
      </div>
      <div>
        <input type="radio" name="mode" id="modeSegment" value="segment" />
        <label for="modeSegment"><b>セグメント配信</b>（/api/admin/segment/send-flex）</label>
        <div class="help">指定した userId リストへ配信します（1行につき1 userId）。</div>
      </div>
    </div>

    <div id="segmentBox" style="display:none; margin-top:12px;">
      <label for="userIds"><b>ユーザーID一覧</b></label>
      <textarea id="userIds" placeholder="例：
Uxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Uyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy"></textarea>
      <div class="help">最大500件ごとにサーバー側で分割送信されます。</div>
    </div>
  </div>

  <div class="card">
    <h2>Flex コンテンツ</h2>
    <div class="row">
      <label for="altText">代替テキスト（altText）</label>
      <input id="altText" type="text" placeholder="通知等で表示される短い説明（必須、<= 400文字）" />
    </div>

    <div class="row" style="margin-top:12px;">
      <label for="contents">Flex JSON（bubble または carousel）</label>
      <textarea id="contents" placeholder='{
  "type": "bubble",
  "body": { "type": "box", "layout": "vertical",
    "contents": [
      { "type": "text", "text": "サンプル", "weight": "bold", "size": "lg" },
      { "type": "text", "text": "本文テキスト", "wrap": true }
    ]
  }
}'></textarea>
    </div>

    <div class="btns">
      <button class="secondary" id="tplSimple">テンプレ：シンプル告知</button>
      <button class="secondary" id="tplCarousel">テンプレ：2商品カルーセル</button>
      <button class="danger" id="clearBtn">クリア</button>
    </div>

    <div class="btns">
      <button class="primary" id="validateBtn">JSON 検証</button>
      <button class="primary" id="sendBtn">配信</button>
    </div>

    <div id="feedback" class="help"></div>
  </div>

  <div class="card">
    <h2>API 仕様メモ</h2>
    <pre>
POST /api/admin/broadcast-flex
Authorization: Bearer &lt;ADMIN_API_TOKEN&gt;
Body: { "altText": "...", "contents": { "type": "bubble|carousel", ... } }

POST /api/admin/segment/send-flex
Authorization: Bearer &lt;ADMIN_API_TOKEN&gt;
Body: {
  "userIds": ["Uxxx","Uyyy", ...],
  "altText": "...",
  "contents": { "type": "bubble|carousel", ... }
}
    </pre>
  </div>

  <script>
    const $ = (id)=>document.getElementById(id);
    const byName = (n)=>document.querySelector('input[name="'+n+'"]:checked');

    // モード切替
    function refreshMode(){
      const mode = byName("mode").value;
      $("segmentBox").style.display = (mode === "segment") ? "block" : "none";
    }
    document.querySelectorAll('input[name="mode"]').forEach(el => el.addEventListener('change', refreshMode));

    // テンプレ
    $("tplSimple").addEventListener("click", () => {
      $("altText").value = "お知らせ：本日限定セール";
      $("contents").value = JSON.stringify({
        type: "bubble",
        body: {
          type: "box", layout: "vertical", spacing: "md",
          contents: [
            { type: "text", text: "本日限定セール！", weight: "bold", size: "lg" },
            { type: "text", text: "人気の「松あかしゃ」「のりあかしゃ」が10%OFF。", wrap: true }
          ]
        }
      }, null, 2);
    });

    $("tplCarousel").addEventListener("click", () => {
      $("altText").value = "商品のお知らせ";
      $("contents").value = JSON.stringify({
        type: "carousel",
        contents: [
          {
            type: "bubble",
            body: { type: "box", layout: "vertical", spacing: "sm",
              contents: [
                { type: "text", text: "松あかしゃ", weight: "bold", size: "md" },
                { type: "text", text: "海老をたっぷり使用した高級えびせんべい", size: "sm", wrap: true }
              ]},
            footer: { type: "box", layout: "horizontal", contents: [
              { type: "button", style: "primary", action: { type: "message", label: "注文", text: "直接注文" } }
            ]}
          },
          {
            type: "bubble",
            body: { type: "box", layout: "vertical", spacing: "sm",
              contents: [
                { type: "text", text: "のりあかしゃ", weight: "bold", size: "md" },
                { type: "text", text: "海苔の風味豊かなえびせんべい", size: "sm", wrap: true }
              ]},
            footer: { type: "box", layout: "horizontal", contents: [
              { type: "button", style: "primary", action: { type: "message", label: "注文", text: "直接注文" } }
            ]}
          }
        ]
      }, null, 2);
    });

    $("clearBtn").addEventListener("click", () => {
      $("altText").value = "";
      $("contents").value = "";
      $("userIds").value = "";
      $("feedback").textContent = "";
    });

    // 検証
    $("validateBtn").addEventListener("click", () => {
      try {
        const obj = JSON.parse($("contents").value || "{}");
        if (!obj || (obj.type !== "bubble" && obj.type !== "carousel")) {
          throw new Error('contents.type は "bubble" または "carousel" である必要があります');
        }
        const alt = ($("altText").value || "").trim();
        if (!alt) throw new Error("altText は必須です");
        if (alt.length > 400) throw new Error("altText は400文字以内にしてください");
        $("feedback").className = "help ok";
        $("feedback").textContent = "✅ 検証OK";
      } catch (e) {
        $("feedback").className = "help err";
        $("feedback").textContent = "❌ " + (e.message || e);
      }
    });

    // 配信
    $("sendBtn").addEventListener("click", async () => {
      $("feedback").className = "help";
      $("feedback").textContent = "送信中...";

      const token = ($("token").value || "").trim();
      if (!token) { $("feedback").className = "help err"; $("feedback").textContent = "ADMIN_API_TOKEN を入力してください"; return; }

      let contents;
      try { contents = JSON.parse($("contents").value || "{}"); }
      catch (e) { $("feedback").className = "help err"; $("feedback").textContent = "JSON 解析に失敗しました"; return; }

      const altText = ($("altText").value || "").trim();
      if (!altText) { $("feedback").className = "help err"; $("feedback").textContent = "altText は必須です"; return; }

      const mode = byName("mode").value;

      let url, body;
      if (mode === "broadcast") {
        url = "/api/admin/broadcast-flex";
        body = { altText, contents };
      } else {
        url = "/api/admin/segment/send-flex";
        const ids = ($("userIds").value || "").split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
        if (ids.length === 0) { $("feedback").className = "help err"; $("feedback").textContent = "userId を1つ以上入力してください"; return; }
        body = { userIds: ids, altText, contents };
      }

      try {
        const r = await fetch(url, {
          method: "POST",
          headers: { "Authorization": "Bearer " + token, "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        const text = await r.text();
        $("feedback").className = r.ok ? "help ok" : "help err";
        $("feedback").textContent = (r.ok ? "✅ OK:\n" : "❌ NG:\n") + text;
      } catch (e) {
        $("feedback").className = "help err";
        $("feedback").textContent = "送信エラー: " + (e.message || e);
      }
    });

    // Ping
    $("pingBtn").addEventListener("click", async ()=>{
      const token = ($("token").value || "").trim();
      if (!token) { $("pingResult").textContent = "ADMIN_API_TOKEN を入力してください"; return; }
      $("pingResult").textContent = "確認中...";
      try{
        const r = await fetch("/api/admin/ping", { headers: { "Authorization": "Bearer " + token } });
        $("pingResult").textContent = r.ok ? "OK" : ("NG: HTTP " + r.status);
      }catch(e){
        $("pingResult").textContent = "エラー: " + (e.message || e);
      }
    });

    // 初期
    refreshMode();
  </script>
</body>
</html>
