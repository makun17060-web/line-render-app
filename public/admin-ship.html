<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>管理：発送通知・注文明細（タブ切替）</title>
<style>
  :root{ --bg:#f6f7f9; --card:#fff; --text:#111827; --muted:#6b7280; --line:#e5e7eb; --pri:#0b3a53; }
  body{ margin:0; font-family:system-ui,-apple-system,"Segoe UI",sans-serif; background:var(--bg); color:var(--text); }
  .wrap{ max-width:1180px; margin:0 auto; padding:14px; }
  h1{ margin:0 0 10px; font-size:18px; }
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .card{ background:var(--card); border:1px solid var(--line); border-radius:12px; padding:12px; margin:10px 0; }
  input,select,textarea{ padding:10px; border:1px solid var(--line); border-radius:10px; font-size:14px; background:#fff; }
  textarea{ width:100%; min-height:76px; }
  button{ padding:10px 12px; border:0; border-radius:10px; background:var(--pri); color:#fff; cursor:pointer; font-size:14px; }
  button.sub{ background:#334155; }
  button.ghost{ background:#fff; color:#111; border:1px solid var(--line); }
  button.danger{ background:#b91c1c; }
  table{ width:100%; border-collapse:collapse; }
  th,td{ text-align:left; border-top:1px solid var(--line); padding:10px; vertical-align:top; font-size:13px; }
  th{ color:#374151; font-weight:700; background:#fafafa; }
  .muted{ color:var(--muted); }
  .pill{ display:inline-block; padding:3px 8px; border-radius:999px; border:1px solid var(--line); font-size:12px; }
  .right{ text-align:right; white-space:nowrap; }
  .mono{ font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }

  /* Tabs */
  .tabs{ display:flex; gap:8px; align-items:center; }
  .tabbtn{
    padding:10px 12px; border-radius:999px; border:1px solid var(--line);
    background:#fff; color:#111; cursor:pointer; font-size:13px;
  }
  .tabbtn.active{ background:var(--pri); color:#fff; border-color:var(--pri); }
  .tabpanel{ display:none; }
  .tabpanel.active{ display:block; }

  /* Print panel */
  .printWrap{ max-width:860px; margin:0 auto; }
  .printHeader{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; }
  .printHeader h2{ margin:0; font-size:16px; }
  .box{ border:1px solid var(--line); border-radius:12px; padding:12px; margin:10px 0; background:#fff; }
  .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
  @media (max-width: 780px){ .grid2{ grid-template-columns:1fr; } }

  /* 印刷時は「印刷タブの中身だけ」出す */
  @media print{
    body{ background:#fff; }
    .noprint{ display:none !important; }
    .wrap{ padding:0; }
    /* tabのうち印刷タブだけ表示 */
    #tabShipPanel{ display:none !important; }
    #tabPrintPanel{ display:block !important; }
    .card, .box{ border:0; }
  }
</style>
</head>

<body>
  <div class="wrap">
    <div class="row noprint" style="justify-content:space-between;">
      <h1>管理：発送通知・注文明細（タブ切替）</h1>
      <div class="tabs">
        <button class="tabbtn active" id="tabShipBtn"  type="button">発送</button>
        <button class="tabbtn"        id="tabPrintBtn" type="button">注文明細（印刷）</button>
      </div>
    </div>

    <!-- 共通：上部設定 -->
    <div class="card noprint">
      <div class="row">
        <label class="muted">Admin Token</label>
        <input id="token" placeholder="ADMIN_API_TOKEN" style="min-width:320px" />
        <label class="muted">日付</label>
        <input id="date" placeholder="YYYYMMDD（空=最新500件）" />
        <button id="loadBtn" type="button">注文を読み込み</button>
        <span id="status" class="muted"></span>
      </div>
      <div class="muted" style="margin-top:8px; font-size:12px;">
        ※URLに <span class="mono">?token=xxxxx</span> を付けてもOK（例：/admin-ship.html?token=...）
      </div>
    </div>

    <!-- タブ①：発送 -->
    <div class="tabpanel active" id="tabShipPanel">
      <div class="card">
        <table>
          <thead>
            <tr>
              <th style="width:140px;">注文</th>
              <th>お届け先</th>
              <th>内容</th>
              <th style="width:270px;">発送（追跡番号など）</th>
              <th style="width:240px;">操作</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- タブ②：印刷 -->
    <div class="tabpanel" id="tabPrintPanel">
      <div class="card noprint">
        <div class="row">
          <label class="muted">印刷する注文ID</label>
          <input id="printOrderId" placeholder="例：123" style="min-width:180px" />
          <button id="loadOneBtn" type="button">この注文を表示</button>
          <button class="sub" id="printBtn" type="button">印刷</button>
          <span class="muted" id="printStatus"></span>
        </div>
        <div class="muted" style="margin-top:8px; font-size:12px;">
          ※発送タブの「印刷」ボタンでも自動でここに切り替わります
        </div>
      </div>

      <div class="printWrap" id="printArea">
        <div class="printHeader">
          <div>
            <h2>磯屋 注文明細（納品書/ピッキング）</h2>
            <div class="muted" id="printSub"></div>
          </div>
          <div class="noprint row" style="justify-content:flex-end;">
            <button class="ghost" type="button" id="backToShipBtn">発送へ戻る</button>
          </div>
        </div>

        <div class="box" id="addrBox">（注文を選択してください）</div>

        <div class="box">
          <table>
            <thead>
              <tr>
                <th>商品</th>
                <th class="right">単価</th>
                <th class="right">数量</th>
                <th class="right">小計</th>
              </tr>
            </thead>
            <tbody id="printItems"></tbody>
            <tfoot id="printSum"></tfoot>
          </table>
        </div>

        <div class="box">
          <div><b>発送メモ</b></div>
          <div class="muted" id="shipMemo">（未設定）</div>
        </div>
      </div>
    </div>
  </div>

<script>
  const $ = (id)=>document.getElementById(id);

  const tokenEl = $("token");
  const dateEl  = $("date");
  const tbody   = $("tbody");
  const status  = $("status");

  const tabShipBtn = $("tabShipBtn");
  const tabPrintBtn = $("tabPrintBtn");
  const tabShipPanel = $("tabShipPanel");
  const tabPrintPanel = $("tabPrintPanel");

  const printOrderIdEl = $("printOrderId");
  const loadOneBtn = $("loadOneBtn");
  const printBtn = $("printBtn");
  const printStatus = $("printStatus");
  const printSub = $("printSub");
  const addrBox = $("addrBox");
  const printItems = $("printItems");
  const printSum = $("printSum");
  const shipMemo = $("shipMemo");
  const backToShipBtn = $("backToShipBtn");

  // ---- helpers ----
  function yen(n){
    const x = Number(n||0);
    return x.toLocaleString("ja-JP") + "円";
  }
  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    })[c]);
  }
  function getToken(){
    const u = new URL(location.href);
    return (u.searchParams.get("token") || tokenEl.value || "").trim();
  }
  async function apiGet(path){
    const t = getToken();
    const url = new URL(path, location.origin);
    if (t) url.searchParams.set("token", t);
    const r = await fetch(url);
    if(!r.ok) throw new Error(await r.text());
    return await r.json();
  }
  async function apiPost(path, body){
    const t = getToken();
    const r = await fetch(path, {
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "x-admin-token": t
      },
      body: JSON.stringify(body||{})
    });
    if(!r.ok) throw new Error(await r.text());
    return await r.json();
  }

  function switchTab(tab){
    if(tab === "ship"){
      tabShipBtn.classList.add("active");
      tabPrintBtn.classList.remove("active");
      tabShipPanel.classList.add("active");
      tabPrintPanel.classList.remove("active");
    }else{
      tabShipBtn.classList.remove("active");
      tabPrintBtn.classList.add("active");
      tabShipPanel.classList.remove("active");
      tabPrintPanel.classList.add("active");
    }
  }

  tabShipBtn.addEventListener("click", ()=>switchTab("ship"));
  tabPrintBtn.addEventListener("click", ()=>switchTab("print"));
  backToShipBtn.addEventListener("click", ()=>switchTab("ship"));

  function itemText(items){
    return (items||[]).map(it=>{
      const v = it.volume ? `（${it.volume}）` : "";
      return `・${it.name}${v} × ${it.qty} / ${yen(it.price)}`;
    }).join("\n");
  }

  function renderRow(o){
    const id = o.orderNumber;
    const addr = o.address || {};
    const addrLine = [
      (addr.name||""),
      ("〒"+(addr.postal||"")+" "+(addr.prefecture||"")+ (addr.city||"") + (addr.address1||"") + " " + (addr.address2||"")).trim(),
      addr.phone ? "TEL:"+addr.phone : ""
    ].filter(Boolean).join("<br>");

    const items = (o.items||[]);
    const itemsHtml = `<div style="white-space:pre-wrap; line-height:1.45;">${escapeHtml(itemText(items))}</div>
      <div class="muted" style="margin-top:6px;">
        小計目安：${yen(o.subtotal)} / 送料：${yen(o.shipping)} ${o.codFee?` / 代引：${yen(o.codFee)}`:""}<br>
        <b>合計：${yen(o.finalTotal)}</b> <span class="pill">${o.payment==="card"?"カード":"代引"}</span>
      </div>`;

    return `
      <tr>
        <td>
          <div><b>#${id}</b></div>
          <div class="muted" style="margin-top:4px;">${new Date(o.ts).toLocaleString("ja-JP")}</div>
          <div class="muted mono" style="margin-top:4px; font-size:12px;">${escapeHtml(o.userId||"")}</div>
        </td>
        <td>${addrLine}</td>
        <td>${itemsHtml}</td>
        <td>
          <div class="row" style="gap:6px;">
            <select id="carrier_${id}">
              <option value="ヤマト運輸">ヤマト運輸</option>
              <option value="日本郵便">日本郵便</option>
              <option value="佐川急便">佐川急便</option>
              <option value="その他">その他</option>
            </select>
            <input id="tn_${id}" placeholder="追跡番号" style="min-width:160px;">
            <input id="note_${id}" placeholder="メモ（任意）" style="min-width:160px;">
          </div>
          <div class="muted" style="margin-top:6px; font-size:12px;">
            ※追跡番号を入れて「保存→発送通知」でOK
          </div>
        </td>
        <td class="right">
          <div class="row" style="justify-content:flex-end;">
            <button class="ghost" type="button" onclick="openPrintInTab(${id})">印刷</button>
            <button class="sub"   type="button" onclick="saveShip(${id})">保存</button>
            <button type="button" onclick="sendShip(${id})">発送通知</button>
          </div>
        </td>
      </tr>
    `;
  }

  async function loadOrders(){
    status.textContent = "読み込み中...";
    tbody.innerHTML = "";
    try{
      const date = (dateEl.value||"").trim();
      const data = await apiGet("/api/admin/orders" + (date?("?date="+encodeURIComponent(date)):""));
      const items = (data.items||[]);
      tbody.innerHTML = items.map(renderRow).join("");
      status.textContent = `表示：${items.length}件`;
    }catch(e){
      status.textContent = "エラー: " + (e.message||e);
      console.error(e);
    }
  }

  // ----- ship actions -----
  window.saveShip = async (orderId)=>{
    try{
      const carrier = ($("carrier_"+orderId).value||"").trim();
      const trackingNumber = ($("tn_"+orderId).value||"").trim();
      const shippedNote = ($("note_"+orderId).value||"").trim();
      await apiPost("/api/admin/orders/update-shipping", {
        orderId, carrier, trackingNumber, shippedNote, markShipped: true
      });
      alert("保存しました（発送済み）");
    }catch(e){
      alert("保存失敗: " + (e.message||e));
    }
  };

  window.sendShip = async (orderId)=>{
    try{
      const r = await apiPost("/api/admin/orders/send-shipped", { orderId });
      alert("発送通知を送信しました。\n\n" + (r.message||""));
    }catch(e){
      alert("発送通知失敗: " + (e.message||e));
    }
  };

  // ----- print tab -----
  async function loadOrderForPrint(orderId){
    printStatus.textContent = "読み込み中...";
    try{
      const data = await apiGet("/api/admin/orders/" + encodeURIComponent(String(orderId)));
      if(!data.ok) throw new Error("not ok");
      const o = data.order;

      printOrderIdEl.value = String(o.id);

      const created = new Date(o.created_at).toLocaleString("ja-JP");
      printSub.textContent =
        `注文ID #${o.id} / ${created} / 支払い：${o.payment_method==="card"?"カード":"代引"} / status: ${o.status||""}`;

      // orders.address は実装によって「文字列」なのでそのまま表示
      const name = o.name || "";
      const zip  = o.zip || "";
      const pref = o.pref || "";
      const addressStr = (typeof o.address === "string")
        ? o.address
        : (o.address ? JSON.stringify(o.address) : "");

      addrBox.innerHTML = `
        <div class="grid2">
          <div>
            <div class="muted">お届け先</div>
            <div style="margin-top:6px;"><b>${escapeHtml(name)}</b></div>
            <div style="margin-top:6px;">〒${escapeHtml(zip)} ${escapeHtml(pref)}</div>
            <div style="margin-top:6px; white-space:pre-wrap;">${escapeHtml(addressStr)}</div>
          </div>
          <div>
            <div class="muted">管理用</div>
            <div class="mono" style="margin-top:8px;">user_id: ${escapeHtml(o.user_id||"")}</div>
            <div class="mono" style="margin-top:6px;">order_id: ${escapeHtml(o.id||"")}</div>
          </div>
        </div>
      `;

      const items = Array.isArray(o.items) ? o.items : [];
      printItems.innerHTML = items.map(it=>{
        const nm = it.name + (it.volume ? `（${it.volume}）` : "");
        const price = Number(it.price||0);
        const qty = Number(it.qty||0);
        const line = price * qty;
        return `
          <tr>
            <td>${escapeHtml(nm)}</td>
            <td class="right">${yen(price)}</td>
            <td class="right">${qty}</td>
            <td class="right">${yen(line)}</td>
          </tr>
        `;
      }).join("");

      const shipFee = Number(o.shipping_fee||0);
      const total   = Number(o.total||0);
      const codFee = (o.payment_method==="cod") ? 330 : 0;
      const subTotal = total - shipFee - codFee;

      printSum.innerHTML = `
        <tr><td colspan="3" class="right"><b>商品合計</b></td><td class="right"><b>${yen(subTotal)}</b></td></tr>
        <tr><td colspan="3" class="right">送料</td><td class="right">${yen(shipFee)}</td></tr>
        ${o.payment_method==="cod" ? `<tr><td colspan="3" class="right">代引手数料</td><td class="right">${yen(330)}</td></tr>` : ``}
        <tr><td colspan="3" class="right"><b>合計</b></td><td class="right"><b>${yen(total)}</b></td></tr>
      `;

      const ship = [];
      if(o.carrier) ship.push("配送会社: " + o.carrier);
      if(o.tracking_number) ship.push("追跡番号: " + o.tracking_number);
      if(o.shipped_at) ship.push("発送日時: " + new Date(o.shipped_at).toLocaleString("ja-JP"));
      if(o.shipped_note) ship.push("メモ: " + o.shipped_note);
      shipMemo.textContent = ship.length ? ship.join(" / ") : "（未設定）";

      printStatus.textContent = "表示OK";
    }catch(e){
      printStatus.textContent = "エラー: " + (e.message||e);
      console.error(e);
    }
  }

  // 発送タブの「印刷」→ 印刷タブに切替＆表示
  window.openPrintInTab = async (orderId)=>{
    switchTab("print");
    await loadOrderForPrint(orderId);
  };

  loadOneBtn.addEventListener("click", ()=>{
    const id = (printOrderIdEl.value||"").trim();
    if(!id) return alert("注文IDを入れてください");
    loadOrderForPrint(id);
  });

  printBtn.addEventListener("click", ()=>{
    // 印刷時に印刷タブを表示している前提（CSSで印刷時は印刷タブのみ出る）
    switchTab("print");
    window.print();
  });

  $("loadBtn").addEventListener("click", loadOrders);

  // URL token 自動反映
  (function init(){
    const u = new URL(location.href);
    const t = (u.searchParams.get("token")||"").trim();
    if(t) tokenEl.value = t;

    // もし ?orderId=... が付いていたら印刷タブを初期表示
    const oid = (u.searchParams.get("orderId")||"").trim();
    if(oid){
      switchTab("print");
      printOrderIdEl.value = oid;
      loadOrderForPrint(oid);
    }
  })();
</script>
</body>
</html>
