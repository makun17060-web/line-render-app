<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>住所登録</title>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root{
      --bg:#f7f7f7; --card:#fff; --text:#111827; --muted:#6b7280;
      --pri:#0b3a53; --border:#e5e7eb; --radius:14px;
      --danger:#b91c1c;
    }
    body{
      margin:0; font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
      background:var(--bg); color:var(--text);
    }
    .wrap{ max-width:720px; margin:0 auto; padding:14px 14px 28px; }
    h1{ font-size:18px; margin:0 0 6px; }
    .muted{ font-size:13px; color:var(--muted); line-height:1.6; }

    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius:var(--radius); padding:14px; margin-top:12px;
    }
    label{ display:block; font-size:13px; font-weight:800; margin-top:10px; }
    input{
      width:100%; padding:10px; border-radius:10px;
      border:1px solid var(--border); font-size:15px;
    }
    .btn{
      width:100%; margin-top:14px; padding:14px;
      border-radius:14px; border:none;
      background:var(--pri); color:#fff;
      font-size:16px; font-weight:900;
    }
    .btnSub{
      background:#fff; color:var(--text);
      border:1px solid var(--border);
    }
    .debug{
      margin-top:12px; font-size:12px;
      white-space:pre-line;
      border:1px dashed var(--border);
      border-radius:12px; padding:10px;
      background:#fff;
    }
    .err{ color:var(--danger); font-weight:900; }
  </style>
</head>

<body>
<div class="wrap">
  <h1>住所登録</h1>
  <div class="muted">初回のみ入力してください。次回以降は自動で反映されます。</div>

  <div class="card">
    <label>お名前</label><input id="name">
    <label>電話番号</label><input id="phone">
    <label>郵便番号</label><input id="postal">
    <label>都道府県</label><input id="prefecture">
    <label>市区町村</label><input id="city">
    <label>番地</label><input id="address1">
    <label>建物名など（任意）</label><input id="address2">

    <button class="btn" id="saveBtn">保存</button>
    <button class="btn btnSub" id="cancelBtn">キャンセル</button>

    <div class="debug" id="debug">debug: init</div>
  </div>
</div>

<script>
(async function(){
  "use strict";

  const LIFF_ID_ADDRESS = "2008406620-4kyQVyqe";
  const KEY_UID = "isoya_userId";
  const API_BASE = location.origin;

  const qs = new URLSearchParams(location.search);
  const FROM_HOWTO = qs.get("from") === "howto";
  const RETURN_TO = qs.get("returnTo") || "";

  const $ = id => document.getElementById(id);
  const log = m => $("debug").textContent += "\n" + m;

  /* =========================
     LIFF 初期化
  ========================= */
  try{
    await liff.init({ liffId: LIFF_ID_ADDRESS });
    if(!liff.isLoggedIn()){
      liff.login({ redirectUri: location.href });
      return;
    }
    const prof = await liff.getProfile();
    if(prof?.userId){
      localStorage.setItem(KEY_UID, prof.userId);
      log("OK: userId=" + prof.userId);
    }
  }catch(e){
    $("debug").classList.add("err");
    log("ERR: LIFF init failed");
    return;
  }

  const uid = localStorage.getItem(KEY_UID) || "";

  /* =========================
     既存住所ロード
  ========================= */
  try{
    const r = await fetch(`${API_BASE}/api/address/get?userId=${encodeURIComponent(uid)}`);
    const d = await r.json();
    if(r.ok && d?.ok && d.address){
      Object.entries(d.address).forEach(([k,v])=>{
        if($(k)) $(k).value = v || "";
      });
      log("OK: address loaded");
    }
  }catch{
    log("INFO: no saved address");
  }

  /* =========================
     保存
  ========================= */
  $("saveBtn").onclick = async ()=>{
    const payload = {
      userId: uid,
      name: $("name").value.trim(),
      phone: $("phone").value.trim(),
      postal: $("postal").value.trim(),
      prefecture: $("prefecture").value.trim(),
      city: $("city").value.trim(),
      address1: $("address1").value.trim(),
      address2: $("address2").value.trim(),
    };

    if(!payload.name || !payload.phone || !payload.postal ||
       !payload.prefecture || !payload.city || !payload.address1){
      alert("必須項目をすべて入力してください");
      return;
    }

    try{
      const r = await fetch(`${API_BASE}/api/address/set`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      const d = await r.json();
      if(!r.ok || !d?.ok) throw new Error(d?.error || "save failed");

      alert("住所を保存しました");

      /* ===== 分岐 ===== */
      if(FROM_HOWTO){
        // howto → 保存したら終わり
        liff.closeWindow();
        return;
      }

      if(RETURN_TO){
        // 注文フロー → products に戻して confirm へ
        const url = `/products.html?from=address&next=${encodeURIComponent(RETURN_TO)}`;
        location.href = url;
        return;
      }

      // 保険（通常は来ない）
      liff.closeWindow();

    }catch(e){
      $("debug").classList.add("err");
      log("ERR: save failed " + e.message);
      alert("住所の保存に失敗しました");
    }
  };

  $("cancelBtn").onclick = ()=>{
    if(FROM_HOWTO){
      liff.closeWindow();
    }else{
      history.back();
    }
  };

})();
</script>
</body>
</html>
