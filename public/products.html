<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>商品一覧（購入）</title>

  <style>
    :root{
      --bg:#f7f7f7; --card:#fff; --text:#111827; --muted:#6b7280;
      --line:#e5e7eb; --primary:#0b3a53; --accent:#7a1f1f;
      --radius:14px;
    }
    body{
      margin:0; font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg); color:var(--text);
    }
    .wrap{ max-width:820px; margin:0 auto; padding:14px 14px 28px; }
    h1{ font-size:18px; margin:0 0 10px; }
    .lead{ font-size:13px; color:var(--muted); margin:0 0 12px; line-height:1.6; }

    .modeBar{ display:flex; gap:10px; margin:10px 0 14px; }
    .modeBtn{
      flex:1; padding:12px; border:0; border-radius:12px;
      font-weight:900; cursor:pointer;
      box-shadow:0 1px 3px rgba(0,0,0,.08);
      background:#fff;
    }
    .modeBtn.active{
      background:var(--primary); color:#fff;
    }

    .row{ display:flex; gap:12px; align-items:stretch; flex-wrap:wrap; }
    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:0 1px 3px rgba(0,0,0,.08);
      padding:12px;
      border:1px solid var(--line);
    }
    .products{ display:grid; grid-template-columns:repeat(2, minmax(0, 1fr)); gap:12px; }
    @media (max-width: 640px){ .products{ grid-template-columns:1fr; } }

    .pHead{ display:flex; gap:10px; }
    .pImg{
      width:72px; height:72px; border-radius:12px; background:#eef2f7;
      border:1px solid var(--line); overflow:hidden; flex:0 0 auto;
      display:flex; align-items:center; justify-content:center;
      font-size:11px; color:var(--muted);
    }
    .pImg img{ width:100%; height:100%; object-fit:cover; display:block; }
    .pInfo{ flex:1; min-width:0; }
    .pName{ font-weight:900; font-size:14px; margin:0 0 4px; }
    .pMeta{ font-size:12px; color:var(--muted); margin:0; }
    .pPrice{ font-weight:900; margin-top:6px; font-size:14px; color:#111; }

    .pActions{ display:flex; gap:8px; margin-top:10px; align-items:center; }
    .qty{
      width:78px; padding:10px; border-radius:10px; border:1px solid var(--line);
      font-size:15px;
    }
    .btn{
      flex:1;
      padding:11px 12px; border:0; border-radius:12px;
      font-weight:900; cursor:pointer;
      background:var(--accent); color:#fff;
    }
    .btn.secondary{ background:#111827; }
    .btn.ghost{ background:#fff; color:#111827; border:1px solid var(--line); }

    .bottomBar{
      position:sticky; bottom:0;
      background:rgba(247,247,247,.92);
      backdrop-filter: blur(6px);
      border-top:1px solid var(--line);
      padding:10px 0;
      margin-top:14px;
    }
    .bottomInner{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    .sum{
      font-size:13px; color:var(--muted); line-height:1.4;
    }
    .sum b{ color:#111; }
    .status{ font-size:12px; color:var(--muted); margin-top:8px; }
    .error{ color:#b91c1c; font-weight:800; }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>商品一覧</h1>
    <p class="lead">
      「あかしゃシリーズ」と「オリジナルセット」を <b>別ボタン</b> で切り替えられます。<br>
      ※商品データは <code>/api/products</code>（Disk上の products.json）から読み込みます。
    </p>

    <div class="modeBar">
      <button id="btnAkasha" class="modeBtn">あかしゃシリーズを購入</button>
      <button id="btnOriginal" class="modeBtn">オリジナルセットを購入</button>
    </div>

    <div id="productsWrap" class="products"></div>

    <div class="status" id="statusMsg"></div>

    <div class="bottomBar">
      <div class="bottomInner">
        <div class="sum">
          カート：<b id="sumItems">0</b>点 ／ 小計：<b id="sumSubtotal">0</b>円
          <div style="font-size:12px; color:#6b7280;">送料・代引き手数料は「注文確認」で計算</div>
        </div>
        <button id="goConfirm" class="btn secondary">注文確認へ</button>
      </div>
    </div>
  </div>

<script>
(function(){
  "use strict";

  const elWrap = document.getElementById("productsWrap");
  const elStatus = document.getElementById("statusMsg");
  const btnAkasha = document.getElementById("btnAkasha");
  const btnOriginal = document.getElementById("btnOriginal");
  const elSumItems = document.getElementById("sumItems");
  const elSumSubtotal = document.getElementById("sumSubtotal");
  const btnGoConfirm = document.getElementById("goConfirm");

  const CART_KEY = "isoya_cart_v1";

  function yen(n){
    const x = Number(n || 0);
    return x.toLocaleString("ja-JP");
  }

  function setStatus(msg, isErr=false){
    elStatus.innerHTML = isErr ? `<span class="error">${escapeHtml(msg)}</span>` : escapeHtml(msg || "");
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  function getMode(){
    return new URL(location.href).searchParams.get("mode") || "akasha";
  }
  function setMode(mode){
    const url = new URL(location.href);
    url.searchParams.set("mode", mode);
    history.replaceState(null, "", url.toString());
    renderModeButtons();
    loadAndRender();
  }
  function renderModeButtons(){
    const m = getMode();
    btnAkasha.classList.toggle("active", m === "akasha");
    btnOriginal.classList.toggle("active", m === "original");
  }

  btnAkasha.onclick = () => setMode("akasha");
  btnOriginal.onclick = () => setMode("original");

  function loadCart(){
    try{
      const raw = localStorage.getItem(CART_KEY);
      const obj = raw ? JSON.parse(raw) : { items: [] };
      if (!obj.items) obj.items = [];
      return obj;
    }catch{
      return { items: [] };
    }
  }
  function saveCart(cart){
    localStorage.setItem(CART_KEY, JSON.stringify(cart));
    renderCartSummary();
  }
  function addToCart(product, qty){
    qty = Math.max(1, Math.min(999, Number(qty||1)));
    const cart = loadCart();
    const idx = cart.items.findIndex(x => x.id === product.id);
    if (idx >= 0) cart.items[idx].qty += qty;
    else cart.items.push({ id: product.id, name: product.name, price: Number(product.price||0), qty });
    saveCart(cart);
  }
  function renderCartSummary(){
    const cart = loadCart();
    let items = 0, subtotal = 0;
    for (const it of cart.items){
      items += Number(it.qty||0);
      subtotal += Number(it.price||0) * Number(it.qty||0);
    }
    elSumItems.textContent = String(items);
    elSumSubtotal.textContent = yen(subtotal);
  }

  function inferCategory(p){
    // ✅ 推奨：products.json に category を入れる（akasha/original）
    if (p && p.category) return String(p.category);

    const id = String(p?.id || "").toLowerCase();
    const name = String(p?.name || "");

    // オリジナルセット判定（id/nameで推定）
    if (id.includes("original") || id.includes("orig") || name.includes("オリジナル")) return "original";

    // あかしゃ判定
    if (id.includes("akasha") || name.includes("あかしゃ")) return "akasha";

    // その他は “あかしゃ側” に寄せ（既存互換）
    return "akasha";
  }

  function filterByMode(products){
    const mode = getMode();
    if (mode === "original"){
      return products.filter(p => inferCategory(p) === "original");
    }
    return products.filter(p => inferCategory(p) === "akasha");
  }

  async function fetchProducts(){
    const res = await fetch("/api/products", { cache: "no-store" });
    if (!res.ok) throw new Error("products fetch failed: " + res.status);
    const data = await res.json();
    if (!Array.isArray(data)) throw new Error("products is not array");
    return data;
  }

  function productCard(p){
    const img = (p.image || "").trim();
    const volume = (p.volume || "").trim();
    const stock = (p.stock ?? "");
    const desc = (p.desc || "").trim();

    const div = document.createElement("div");
    div.className = "card";

    const imgHtml = img
      ? `<img src="${escapeHtml(img)}" alt="">`
      : `画像なし`;

    div.innerHTML = `
      <div class="pHead">
        <div class="pImg">${imgHtml}</div>
        <div class="pInfo">
          <div class="pName">${escapeHtml(p.name || "")}</div>
          <p class="pMeta">
            ${volume ? `内容量：${escapeHtml(volume)}<br>` : ""}
            ${stock !== "" ? `在庫：${escapeHtml(String(stock))}` : ""}
          </p>
          <div class="pPrice">¥${yen(p.price)}</div>
        </div>
      </div>
      ${desc ? `<div style="margin-top:8px; font-size:12px; color:#374151; line-height:1.5;">${escapeHtml(desc)}</div>` : ""}
      <div class="pActions">
        <input class="qty" type="number" min="1" step="1" value="1" inputmode="numeric" />
        <button class="btn">カートに入れる</button>
      </div>
    `;

    const qtyEl = div.querySelector(".qty");
    const btn = div.querySelector(".btn");
    btn.onclick = () => {
      const qty = Number(qtyEl.value || 1);
      addToCart(p, qty);
      setStatus(`「${p.name}」を ${qty} 個追加しました`);
    };
    return div;
  }

  async function loadAndRender(){
    try{
      setStatus("読み込み中…");
      elWrap.innerHTML = "";
      const all = await fetchProducts();
      const list = filterByMode(all);

      if (!list.length){
        const mode = getMode();
        elWrap.innerHTML = `<div class="card">このカテゴリ（${escapeHtml(mode)}）の商品がありません。<br>
        ※products.json に <code>category</code> を入れていない場合、判定がズレることがあります。</div>`;
        setStatus("");
        return;
      }

      for (const p of list){
        elWrap.appendChild(productCard(p));
      }

      const modeLabel = (getMode()==="original") ? "オリジナルセット" : "あかしゃシリーズ";
      setStatus(`${modeLabel} を表示中（${list.length}件）`);
    }catch(e){
      console.error(e);
      setStatus("商品データの取得に失敗しました（/api/products）。サーバー側とDiskの設定を確認してください。", true);
    }
  }

  btnGoConfirm.onclick = () => {
    // ✅ ここだけ、あなたの実際の確認ページに合わせて変更OK
    location.href = "/confirm.html";
  };

  // 初期化
  renderModeButtons();
  renderCartSummary();
  // modeが無いときは既定でakasha（URLにも反映）
  if (!new URL(location.href).searchParams.get("mode")){
    const url = new URL(location.href);
    url.searchParams.set("mode", "akasha");
    history.replaceState(null, "", url.toString());
  }
  loadAndRender();

})();
</script>
</body>
</html>
