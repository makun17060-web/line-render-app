<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>商品一覧</title>
  <style>
    :root{--bg:#f6f7f9;--card:#fff;--text:#111827;--muted:#6b7280;--line:#e5e7eb;--pri:#0b3a53;--pri2:#123b66;}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1040px;margin:0 auto;padding:14px 14px 96px}
    h1{margin:0 0 6px;font-size:18px} .muted{color:var(--muted);font-size:13px;line-height:1.5}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px;margin-top:12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.06)}
    .imgbox{height:160px;background:#eaecef} .imgbox img{width:100%;height:100%;object-fit:cover;display:block}
    .body{padding:12px} .name{font-weight:900;font-size:15px} .desc{margin-top:6px;color:var(--muted);font-size:12px;min-height:34px}
    .row{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-top:8px}
    .price{font-weight:900;color:var(--pri)} .badge{font-size:12px;border:1px solid var(--line);background:#fafafa;border-radius:999px;padding:2px 8px}
    .controls{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-top:10px}
    .qty{display:flex;align-items:center;gap:6px}
    .qty button{width:34px;height:34px;border-radius:10px;border:1px solid var(--line);background:#fff;font-size:18px;cursor:pointer}
    .qty input{width:56px;height:34px;border-radius:10px;border:1px solid var(--line);text-align:center}
    .btn{border:none;border-radius:12px;padding:10px 12px;font-weight:900;cursor:pointer}
    .btnAdd{background:var(--pri);color:#fff} .btnAdd:disabled{opacity:.55;cursor:not-allowed}
    .bar{position:fixed;left:0;right:0;bottom:0;border-top:1px solid var(--line);background:rgba(246,247,249,.92);backdrop-filter:blur(10px);padding:10px 12px}
    .bar .inner{max-width:1040px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;gap:10px}
    .btnGo{background:var(--pri2);color:#fff;padding:12px 14px;border-radius:14px}
    .btnClear{background:#fff;border:1px solid #fecaca;color:#b91c1c;padding:12px 14px;border-radius:14px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>商品一覧</h1>
    <div class="muted" id="status">読み込み中…</div>
    <div class="grid" id="grid"></div>
  </div>

  <div class="bar">
    <div class="inner">
      <div class="muted" id="sum">カート：0点 / 小計 0円</div>
      <div style="display:flex;gap:8px">
        <button class="btn btnClear" id="clearBtn" type="button">空にする</button>
        <button class="btn btnGo" id="nextBtn" type="button" disabled>注文内容を確認</button>
      </div>
    </div>
  </div>

<script>
(function(){
  "use strict";
  const KEY_CART="isoya_cart";
  const statusEl=document.getElementById("status");
  const gridEl=document.getElementById("grid");
  const sumEl=document.getElementById("sum");
  const clearBtn=document.getElementById("clearBtn");
  const nextBtn=document.getElementById("nextBtn");

  const yen=n=>(Number(n)||0).toLocaleString("ja-JP")+"円";
  const esc=s=>String(s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
  const loadCart=()=>{try{const v=JSON.parse(localStorage.getItem(KEY_CART)||""); if(v&&typeof v==="object") return v;}catch{} return {items:[]};};
  const saveCart=cart=>localStorage.setItem(KEY_CART,JSON.stringify(cart));
  const normItems=items=>{
    const map=new Map();
    for(const it of (items||[])){
      const id=String(it?.id||"").trim();
      const qty=Math.max(0,Math.floor(Number(it?.qty||0)));
      if(!id||qty<=0) continue;
      map.set(id,(map.get(id)||0)+qty);
    }
    return Array.from(map.entries()).map(([id,qty])=>({id,qty}));
  };

  let products=[];
  let cart=loadCart(); cart.items=normItems(cart.items);

  const qtyInCart=id => (cart.items.find(x=>x.id===id)?.qty)||0;
  const setQty=(id,qty)=>{
    qty=Math.max(0,Math.floor(Number(qty||0)));
    const i=cart.items.findIndex(x=>x.id===id);
    if(qty<=0){ if(i>=0) cart.items.splice(i,1); }
    else { if(i>=0) cart.items[i].qty=qty; else cart.items.push({id,qty}); }
    cart.items=normItems(cart.items); saveCart(cart); renderSum();
  };

  const renderSum=()=>{
    const byId=Object.fromEntries(products.map(p=>[p.id,p]));
    let subtotal=0,count=0;
    for(const it of cart.items){
      const p=byId[it.id]; if(!p) continue;
      subtotal += Number(p.price||0)*Number(it.qty||0);
      count += Number(it.qty||0);
    }
    sumEl.textContent=`カート：${count}点 / 小計 ${yen(subtotal)}`;
    nextBtn.disabled = (count<=0);
  };

  function card(p){
    const el=document.createElement("div");
    el.className="card";
    const img=String(p.image||"").trim();
    const stock=Number(p.stock||0);

    el.innerHTML=`
      <div class="imgbox">${img?`<img src="${img}" alt="">`:""}</div>
      <div class="body">
        <div class="name">${esc(p.name||"")}</div>
        <div class="desc">${esc(p.desc||"")}</div>
        <div class="row">
          <div class="price">${yen(p.price)}</div>
          <div class="badge">${p.volume?`内容量 ${esc(p.volume)}`:`在庫 ${stock}`}</div>
        </div>
        <div class="controls">
          <div class="qty">
            <button type="button" class="dec">−</button>
            <input class="q" type="number" min="1" step="1" value="1" inputmode="numeric">
            <button type="button" class="inc">＋</button>
          </div>
          <button type="button" class="btn btnAdd add">カートに追加</button>
        </div>
        <div class="muted" style="margin-top:8px">カート内：<b class="in">${qtyInCart(p.id)}</b> 個</div>
      </div>
    `;
    const im=el.querySelector("img");
    if(im) im.addEventListener("error",()=>im.remove()); // 404でも崩れない

    const q=el.querySelector(".q");
    const inEl=el.querySelector(".in");
    const addBtn=el.querySelector(".add");
    el.querySelector(".dec").onclick=()=>{ q.value=String(Math.max(1,Math.floor(Number(q.value||1))-1)); };
    el.querySelector(".inc").onclick=()=>{ q.value=String(Math.max(1,Math.floor(Number(q.value||1))+1)); };
    q.onchange=()=>{ q.value=String(Math.max(1,Math.floor(Number(q.value||1)))); };

    if(Number.isFinite(stock) && stock<=0){ addBtn.disabled=true; addBtn.textContent="在庫なし"; }

    addBtn.onclick=()=>{
      const add=Math.max(1,Math.floor(Number(q.value||1)));
      const next=qtyInCart(p.id)+add;
      if(Number.isFinite(stock) && stock>=0 && next>stock){
        alert(`在庫不足です（在庫 ${stock}）。個数を減らしてください。`);
        return;
      }
      setQty(p.id,next);
      inEl.textContent=String(qtyInCart(p.id));
    };
    return el;
  }

  async function main(){
    try{
      const res=await fetch("/api/products",{cache:"no-store"});
      const data=await res.json().catch(()=>({}));
      if(!res.ok || !data.ok) throw new Error(data?.error||("HTTP "+res.status));
      products = Array.isArray(data.products)?data.products:[];
      if(products.length===0){ statusEl.textContent="商品がありません（products.json確認）"; return; }
      statusEl.textContent="";
      gridEl.innerHTML="";
      products.forEach(p=>gridEl.appendChild(card(p)));
      renderSum();
    }catch(e){
      console.error(e);
      statusEl.innerHTML=`<span style="color:#b91c1c;font-weight:800">読み込み失敗：/api/products を確認してください</span>`;
    }
  }

  clearBtn.onclick=()=>{
    if(!confirm("カートを空にしますか？")) return;
    cart={items:[]}; saveCart(cart);
    document.querySelectorAll(".in").forEach(x=>x.textContent="0");
    renderSum();
  };
  nextBtn.onclick=()=>location.href="/confirm.html"; // ★必ずconfirmへ

  main();
})();
</script>
</body>
</html>
