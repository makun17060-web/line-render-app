<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>ç™ºé€ã‚¹ã‚­ãƒ£ãƒ³</title>

<style>
:root{
  --pad: 14px;
  --gap: 12px;
  --radius: 14px;
  --btnH: 64px;
  --font: 20px;
}

body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  background:#000;
  color:#fff;
}

/* ã‚«ãƒ¡ãƒ© */
#video{
  position:fixed;
  inset:0;
  width:100%;
  height:100%;
  object-fit:cover;
  background:#000;
}

/* ä¸‹ãƒ‘ãƒãƒ« */
.panel{
  position:fixed;
  left:0;
  right:0;
  bottom:0;
  padding: var(--pad);
  padding-bottom: calc(var(--pad) + env(safe-area-inset-bottom));
  background:rgba(0,0,0,0.72);
  backdrop-filter: blur(10px);
}

/* å…¥åŠ› */
input{
  width:100%;
  padding:16px;
  font-size:18px;
  border-radius:var(--radius);
  border:none;
  margin-bottom:var(--gap);
}

/* ãƒœã‚¿ãƒ³ */
button{
  width:100%;
  height:var(--btnH);
  font-size:var(--font);
  border:none;
  border-radius:var(--radius);
  margin-bottom:var(--gap);
  font-weight:800;
  touch-action: manipulation;
}

button:active{
  transform:scale(0.97);
}

.start{ background:#00c853; color:#fff; }
.stop{ background:#d50000; color:#fff; }
.send{ background:#2962ff; color:#fff; }

.status{
  text-align:center;
  font-size:14px;
}

/* ã‚¹ã‚­ãƒ£ãƒ³æ  */
.scan-box{
  position:fixed;
  top:20%;
  left:10%;
  width:80%;
  height:200px;
  border:3px solid rgba(255,255,255,0.6);
  border-radius:10px;
  pointer-events:none;
}
</style>
</head>

<body>

<video id="video" autoplay playsinline></video>
<div class="scan-box"></div>

<div class="panel">
  <input id="code" placeholder="ã‚¹ã‚­ãƒ£ãƒ³çµæœ / æ‰‹å…¥åŠ›">

  <button class="start" onclick="startCamera()">ğŸ“· ã‚«ãƒ¡ãƒ©é–‹å§‹</button>
  <button class="stop" onclick="stopCamera()">â–  åœæ­¢</button>
  <button class="send" onclick="send()">ğŸšš ç™ºé€ç¢ºå®šï¼†é€šçŸ¥</button>

  <div class="status" id="status">å¾…æ©Ÿä¸­</div>
</div>

<script src="https://unpkg.com/@zxing/library@latest"></script>

<script>
const video = document.getElementById("video");
const codeInput = document.getElementById("code");
const statusEl = document.getElementById("status");

let codeReader = null;
let active = false;

/* ===== ã‚«ãƒ¡ãƒ©é–‹å§‹ ===== */
async function startCamera(){
  try{
    statusEl.textContent = "ã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­...";

    codeReader = new ZXing.BrowserMultiFormatReader();

    await codeReader.decodeFromVideoDevice(
      null,
      video,
      (result, err) => {
        if(result && active){
          const text = result.getText();
          codeInput.value = text;
          statusEl.textContent = "èª­ã¿å–ã‚ŠæˆåŠŸï¼š" + text;

          vibrate();
          send(); // â˜…å³é€ä¿¡
        }
      }
    );

    active = true;
    statusEl.textContent = "ã‚¹ã‚­ãƒ£ãƒ³ä¸­...";
  }catch(e){
    console.error(e);
    statusEl.textContent = "ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—";
    alert("ã‚«ãƒ¡ãƒ©ã‚’è¨±å¯ã—ã¦ãã ã•ã„");
  }
}

/* ===== åœæ­¢ ===== */
function stopCamera(){
  if(codeReader){
    codeReader.reset();
    active = false;
    statusEl.textContent = "åœæ­¢ã—ã¾ã—ãŸ";
  }
}

/* ===== é€ä¿¡ ===== */
async function send(){
  const code = codeInput.value.trim();
  if(!code){
    alert("ã‚³ãƒ¼ãƒ‰ãŒç©º");
    return;
  }

  try{
    statusEl.textContent = "é€ä¿¡ä¸­...";

    const res = await fetch("/api/admin/ship/scan-and-notify", {
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "x-admin-token":"YOUR_ADMIN_TOKEN"
      },
      body: JSON.stringify({ tracking_no: code })
    });

    const data = await res.json();

    if(data.ok){
      statusEl.textContent = "ç™ºé€é€šçŸ¥OKï¼š" + code;
      codeInput.value = "";
      vibrate();
    }else{
      statusEl.textContent = "ã‚¨ãƒ©ãƒ¼ï¼š" + data.error;
    }

  }catch(e){
    console.error(e);
    statusEl.textContent = "é€šä¿¡ã‚¨ãƒ©ãƒ¼";
  }
}

/* ===== æŒ¯å‹• ===== */
function vibrate(){
  if(navigator.vibrate){
    navigator.vibrate(100);
  }
}
</script>

</body>
</html>