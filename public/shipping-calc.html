<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>送料計算（server参照）</title>
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",sans-serif;background:#f6f6f6;color:#222;margin:0;padding:14px}
    .wrap{max-width:980px;margin:0 auto}
    h1{font-size:18px;margin:0 0 10px}
    .card{background:#fff;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.08);padding:12px;margin:10px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    label{font-size:12px;color:#555}
    input,select,button,textarea{font:inherit}
    input,select{padding:8px;border:1px solid #ddd;border-radius:10px;min-width:220px;background:#fff}
    textarea{padding:8px;border:1px solid #ddd;border-radius:10px;width:100%;min-height:66px}
    button{padding:10px 12px;border:0;border-radius:10px;background:#2563eb;color:#fff;cursor:pointer}
    button.secondary{background:#e5e7eb;color:#111}
    button.danger{background:#ef4444}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    td{vertical-align:middle}
    .muted{color:#666;font-size:12px}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#f3f4f6;font-size:12px}
    .ok{color:#16a34a}
    .ng{color:#dc2626}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .right{margin-left:auto}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>送料計算（サーバー参照版）</h1>

    <div class="card">
      <div class="row" style="align-items:flex-end">
        <div>
          <label>都道府県（必須）</label><br/>
          <input id="pref" placeholder="例：愛知県" />
        </div>
        <div>
          <label>市区町村</label><br/>
          <input id="city" placeholder="例：名古屋市中区" />
        </div>
        <div style="flex:1;min-width:260px">
          <label>住所（番地など）</label><br/>
          <input id="addr1" placeholder="例：栄1-2-3" style="width:100%"/>
        </div>

        <div class="right">
          <button id="btnCalc">送料を計算</button>
        </div>
      </div>

      <div class="muted" style="margin-top:10px">
        ※このページは送料ロジックを持ちません。計算は <span class="mono">POST /api/shipping</span> の結果を表示します。<br/>
        ※「あかしゃ6種」「オリジナルセット」もサーバー側判定に従います。
      </div>
    </div>

    <div class="card">
      <div class="row" style="align-items:center">
        <div><b>商品（複数OK）</b> <span class="pill">あかしゃ6種＋オリジナルセット 追加済</span></div>
        <div class="right">
          <button class="secondary" id="btnAdd">＋ 行を追加</button>
        </div>
      </div>

      <table id="itemsTable">
        <tbody></tbody>
      </table>

      <div class="muted">
        ※商品IDが分からない場合は、名前だけでもOK（サーバー側が名前判定している場合に反映されます）
      </div>
    </div>

    <div class="card">
      <b>結果</b>
      <div id="result" style="margin-top:10px" class="mono muted">未計算</div>
    </div>

    <div class="card">
      <b>サーバー設定（/api/shipping/config）</b>
      <div id="serverConfig" class="mono muted" style="margin-top:10px">読み込み中...</div>
    </div>

    <div class="card">
      <b>デバッグ</b>
      <textarea id="debug" readonly></textarea>
    </div>
  </div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const tbody = $("itemsTable").querySelector("tbody");
  const debug = (msg, obj)=>{
    const t = new Date().toISOString();
    const line = obj ? `${t} ${msg}\n${JSON.stringify(obj,null,2)}\n\n` : `${t} ${msg}\n\n`;
    $("debug").value = line + $("debug").value;
  };

  // あかしゃ6種 + オリジナルセット（ページ側の「選択肢」用）
  // 送料計算はサーバー参照なので、ここはUIの利便性目的です
  const presetOptions = [
    { id:"", name:"（手入力）" },
    { id:"akasha-nori", name:"のりあかしゃ" },
    { id:"akasha-uzu", name:"うずあかしゃ" },
    { id:"akasha-shio", name:"潮あかしゃ" },
    { id:"akasha-goma", name:"ごまあかしゃ" },
    { id:"akasha-iso",  name:"いそあかしゃ" },
    { id:"akasha-matsu",name:"松あかしゃ" },
    { id:"original-set-2100", name:"磯屋オリジナルセット" }
  ];

  let productsIndex = {}; // id -> {id,name,price}
  let serverConfig = null;

  function rowHtml(initial){
    const optHtml = presetOptions.map(o=>`<option value="${escapeHtml(o.id)}">${escapeHtml(o.name)}</option>`).join("");
    return `
      <tr data-row="1">
        <td style="width:260px">
          <label>プリセット</label><br/>
          <select class="selPreset">${optHtml}</select>
        </td>
        <td style="width:260px">
          <label>商品ID（任意）</label><br/>
          <input class="inId" placeholder="例：original-set-2100" />
        </td>
        <td>
          <label>商品名（任意・名前判定用）</label><br/>
          <input class="inName" placeholder="例：のりあかしゃ / 磯屋オリジナルセット" style="width:100%"/>
        </td>
        <td style="width:140px">
          <label>数量</label><br/>
          <input class="inQty" type="number" min="1" step="1" value="1" style="min-width:120px" />
        </td>
        <td style="width:110px">
          <label>&nbsp;</label><br/>
          <button class="danger btnDel" type="button">削除</button>
        </td>
      </tr>
    `;
  }

  function addRow(prefill){
    tbody.insertAdjacentHTML("beforeend", rowHtml(prefill||{}));
    const tr = tbody.querySelector("tr:last-child");
    const sel = tr.querySelector(".selPreset");
    const inId = tr.querySelector(".inId");
    const inName = tr.querySelector(".inName");
    const inQty = tr.querySelector(".inQty");
    const btnDel = tr.querySelector(".btnDel");

    // 初期値（必要なら）
    if (prefill?.id) inId.value = prefill.id;
    if (prefill?.name) inName.value = prefill.name;
    if (prefill?.qty) inQty.value = prefill.qty;

    sel.addEventListener("change", ()=>{
      const pid = sel.value || "";
      if (!pid) return;
      // プリセットを選んだらID/名前を埋める（サーバー参照なのであくまで補助）
      const preset = presetOptions.find(x=>x.id===pid);
      if (preset){
        inId.value = preset.id || inId.value;
        inName.value = preset.name || inName.value;
      }
      // products.json に同じIDがあれば、より正確な名称に置換
      if (productsIndex[pid]?.name){
        inName.value = productsIndex[pid].name;
      }
    });

    btnDel.addEventListener("click", ()=>{
      tr.remove();
      if (!tbody.querySelector("tr")) addRow();
    });
  }

  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  async function loadProducts(){
    try{
      const r = await fetch("/api/products", { cache:"no-store" });
      const j = await r.json();
      if (j?.ok && Array.isArray(j.products)){
        productsIndex = {};
        j.products.forEach(p=>{
          if (p?.id) productsIndex[p.id] = { id:p.id, name:p.name||"", price:Number(p.price||0) };
        });
      }
      debug("loaded /api/products", {count:Object.keys(productsIndex).length});
    }catch(e){
      debug("load /api/products failed", {error:String(e)});
    }
  }

  async function loadShippingConfig(){
    try{
      const r = await fetch("/api/shipping/config", { cache:"no-store" });
      const j = await r.json();
      serverConfig = j?.config || null;
      $("serverConfig").textContent = serverConfig
        ? JSON.stringify(serverConfig, null, 2)
        : "設定が取得できませんでした。";
      debug("loaded /api/shipping/config", j);
    }catch(e){
      $("serverConfig").textContent = "読み込み失敗（/api/shipping/config）";
      debug("load /api/shipping/config failed", {error:String(e)});
    }
  }

  function collectItems(){
    const rows = Array.from(tbody.querySelectorAll("tr[data-row]"));
    const items = [];
    for (const tr of rows){
      const id = tr.querySelector(".inId").value.trim();
      const name = tr.querySelector(".inName").value.trim();
      const qty = Math.max(1, Number(tr.querySelector(".inQty").value || 1));

      // price は /api/shipping で itemsTotal に使われるだけなので、未指定なら 0 でOK
      const price = (id && productsIndex[id]) ? Number(productsIndex[id].price || 0) : 0;

      // サーバーの名前判定（正規表現）を効かせたいので、name はできるだけ入れる
      const finalName = name || (id && productsIndex[id]?.name) || id || "商品";

      items.push({ id: id || undefined, name: finalName, price, qty });
    }
    return items;
  }

  async function calc(){
    const prefecture = $("pref").value.trim();
    const city = $("city").value.trim();
    const address1 = $("addr1").value.trim();

    if (!prefecture){
      $("result").innerHTML = `<span class="ng">都道府県は必須です</span>`;
      return;
    }

    const items = collectItems();
    const body = {
      items,
      address: {
        prefecture,
        city,
        address1
      }
    };

    debug("POST /api/shipping", body);

    try{
      const r = await fetch("/api/shipping", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });
      const j = await r.json();
      debug("RESP /api/shipping", j);

      if (!j?.ok){
        $("result").innerHTML = `<span class="ng">計算失敗：</span>${escapeHtml(j?.error || "unknown")}`;
        return;
      }

      const html = [
        `region: ${escapeHtml(j.region || "")}`,
        `size: ${escapeHtml(j.size || "")}`,
        `shipping: ${Number(j.shipping||0).toLocaleString("ja-JP")}円`,
        `itemsTotal: ${Number(j.itemsTotal||0).toLocaleString("ja-JP")}円`,
        `finalTotal: ${Number(j.finalTotal||0).toLocaleString("ja-JP")}円`
      ].join("<br/>");

      $("result").innerHTML = `<span class="ok">OK</span><br/>` + html;
    }catch(e){
      debug("calc failed", {error:String(e)});
      $("result").innerHTML = `<span class="ng">通信エラー：</span>${escapeHtml(String(e))}`;
    }
  }

  // init
  $("btnAdd").addEventListener("click", ()=>addRow());
  $("btnCalc").addEventListener("click", calc);

  addRow({ id:"", name:"", qty:1 });
  loadProducts();
  loadShippingConfig();
})();
</script>
</body>
</html>
