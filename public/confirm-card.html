<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>クレジット決済の確認</title>

  <style>
    :root{
      --bg:#f6f7f9;--card:#fff;--text:#111827;--muted:#6b7280;--line:#e5e7eb;
      --pri:#123b66;--danger:#b91c1c;--shadow:0 1px 3px rgba(0,0,0,.06);--radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:820px;margin:0 auto;padding:14px 14px 26px}
    h1{margin:0 0 6px;font-size:18px}
    .muted{color:var(--muted);font-size:13px;line-height:1.5}
    .err{color:var(--danger);font-weight:900}

    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:12px;margin-top:12px;box-shadow:var(--shadow)}
    .items{margin-top:10px;border-top:1px solid var(--line)}
    .item{
      display:grid;grid-template-columns:1fr auto;
      gap:6px 10px;padding:12px 0;border-bottom:1px dashed var(--line);font-size:14px;
    }
    .item:last-child{border-bottom:none}
    .item .name{font-weight:800}
    .item .qty{grid-column:1/2;color:var(--muted);font-size:13px}
    .item .price{grid-column:2/3;grid-row:1/3;align-self:center;font-weight:900;white-space:nowrap}

    .row{display:flex;justify-content:space-between;gap:10px;margin:0;padding:6px 0;font-size:14px}
    .row.total{border-top:2px solid var(--line);margin-top:6px;padding-top:10px;font-size:16px;font-weight:900}

    .btns{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    button{flex:1;min-width:180px;border:none;border-radius:14px;padding:12px 14px;font-weight:900;cursor:pointer}
    #payBtn{background:var(--pri);color:#fff}
    #backBtn{background:#fff;border:1px solid var(--line);color:#111827}
    button:disabled{opacity:.55;cursor:not-allowed}
  </style>
</head>

<body>
  <div class="wrap">
    <h1>クレジット決済の確認</h1>
    <div class="muted" id="status">読み込み中…</div>

    <div class="card">
      <div class="muted">ご注文商品</div>
      <div class="items" id="items"></div>

      <div class="row"><div>小計</div><div id="subtotal">—</div></div>
      <div class="row"><div>送料</div><div id="shipping">—</div></div>
      <div class="row total"><div>合計（クレジット）</div><div id="totalCard">—</div></div>

      <div class="btns">
        <button id="backBtn" type="button">戻る</button>
        <button id="payBtn" type="button">Stripeで支払う</button>
      </div>

      <div class="muted" style="margin-top:8px">
        ※このあとStripeの決済画面へ移動します。
      </div>
    </div>
  </div>

<script>
(async function(){
  "use strict";

  const KEY_CARD = "isoya_card_checkout";
  const PATH_CONFIRM = "/public/confirm.html";

  const status = document.getElementById("status");
  const itemsEl = document.getElementById("items");
  const subtotalEl = document.getElementById("subtotal");
  const shippingEl = document.getElementById("shipping");
  const totalCardEl = document.getElementById("totalCard");
  const backBtn = document.getElementById("backBtn");
  const payBtn = document.getElementById("payBtn");

  const yen = n => (Number(n)||0).toLocaleString("ja-JP")+"円";

  function safeJson(key){
    try{ return JSON.parse(localStorage.getItem(key)||"null"); }catch{ return null; }
  }

  async function getProducts(){
    const r = await fetch("/api/products", { cache:"no-store" });
    const d = await r.json().catch(()=>({}));
    if(!r.ok || !d.ok) throw new Error(d?.error || ("HTTP "+r.status));
    return Array.isArray(d.products) ? d.products : [];
  }

  async function postJson(url, body){
    const r=await fetch(url,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });
    const d=await r.json().catch(()=>({}));
    if(!r.ok) throw new Error(d?.error || ("HTTP "+r.status));
    return d;
  }

  function renderItems(items, products){
    const byId = Object.fromEntries(products.map(p=>[p.id,p]));
    itemsEl.innerHTML = "";
    let subtotal = 0;

    for(const it of items){
      const p = byId[it.id];
      if(!p) continue;

      const qty = Number(it.qty||0);
      const line = Number(p.price||0) * qty;
      subtotal += line;

      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="name">${p.name || ""}${p.volume ? `（${p.volume}）` : ""}</div>
        <div class="price">${yen(line)}</div>
        <div class="qty">× ${qty} 点</div>
      `;
      itemsEl.appendChild(div);
    }

    return subtotal;
  }

  function setBusy(on){
    payBtn.disabled = on;
    payBtn.textContent = on ? "決済画面へ…" : "Stripeで支払う";
    payBtn.style.pointerEvents = on ? "none" : "auto";
  }

  // ---- start ----
  try{
    const payload = safeJson(KEY_CARD);
    if(!payload || !payload.uid || !Array.isArray(payload.items)){
      status.innerHTML = '<span class="err">決済情報がありません。確認画面へ戻ります。</span>';
      setTimeout(()=>location.replace(PATH_CONFIRM), 600);
      return;
    }

    const uid = String(payload.uid||"").trim();
    const items = (payload.items||[]).filter(x=>x?.id && Number(x.qty||0)>0);
    if(!uid || items.length===0){
      status.innerHTML = '<span class="err">決済情報が不正です。確認画面へ戻ります。</span>';
      setTimeout(()=>location.replace(PATH_CONFIRM), 600);
      return;
    }

    backBtn.onclick = ()=>location.href = PATH_CONFIRM;

    status.textContent = "金額を計算中…";
    subtotalEl.textContent = "計算中…";
    shippingEl.textContent = "計算中…";
    totalCardEl.textContent = "計算中…";

    const products = await getProducts();
    const subtotal = renderItems(items, products);
    subtotalEl.textContent = yen(subtotal);

    // 送料（見積り）：/api/order/quote を利用
    let shippingFee = 0;
    let size = "";
    try{
      const quote = await postJson("/api/order/quote", { uid, checkout:{ items } });
      shippingFee = Number(quote.shippingFee||0);
      size = String(quote.size||"");
      shippingEl.textContent = `${yen(shippingFee)}${size ? `（ヤマト ${size}サイズ）` : ""}`;
    }catch(e){
      console.error(e);
      shippingEl.textContent = "—（計算失敗）";
    }

    const totalCard = subtotal + shippingFee;
    totalCardEl.textContent = yen(totalCard);

    status.textContent = "内容をご確認ください。";

    payBtn.onclick = async ()=>{
      setBusy(true);
      try{
        const data = await postJson("/api/pay/stripe/create", { uid, checkout:{ items } });
        if(!data?.url) throw new Error("stripe_url_missing");
        location.href = data.url;
      }catch(e){
        console.error(e);
        alert("クレジット決済に進めませんでした: " + (e?.message||e));
        setBusy(false);
      }
    };

  }catch(e){
    console.error(e);
    status.innerHTML = '<span class="err">読み込みに失敗しました。</span>';
  }

})();
</script>
</body>
</html>
