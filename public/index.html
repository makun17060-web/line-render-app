<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ã”æ³¨æ–‡æ–¹æ³•é¸æŠ</title>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root{
      --bg:#f6f7f9; --card:#fff; --text:#111827; --muted:#6b7280; --line:#e5e7eb;
      --akasha:#0b3a53; --original:#7a1f1f; --store:#0a7b19;
      --shadow:0 1px 4px rgba(0,0,0,.08); --radius:16px;
      --danger:#b91c1c;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{ max-width:760px; margin:0 auto; padding:16px 14px 30px; }
    h1{ margin:0 0 6px; font-size:20px; }
    .muted{ color:var(--muted); font-size:13px; line-height:1.6; }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      margin-top:14px;
    }
    .btn{
      display:block; width:100%;
      padding:16px 14px;
      border-radius:14px;
      font-weight:900; font-size:16px;
      text-align:center; text-decoration:none;
      border:none; cursor:pointer;
      user-select:none;
    }
    .btnOriginal{ background:var(--original); color:#fff; }
    .btnAkasha{ background:var(--akasha); color:#fff; }
    .btnStore{ background:var(--store); color:#fff; }

    .note{ margin-top:10px; font-size:13px; color:#374151; }
    .sub{ margin-top:6px; font-size:12px; color:var(--muted); }
    .pill{
      display:inline-block; margin-top:8px;
      font-size:12px; padding:2px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fafafa; color:#374151;
    }
    .warn{ color:var(--danger); font-weight:900; }
    .small{ font-size:12px; color:var(--muted); margin-top:14px; }
    .hr{ height:1px; background:var(--line); margin:14px 0; }

    .badge{
      display:inline-block;
      font-size:12px;
      padding:3px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      margin-left:8px;
      vertical-align:middle;
    }
    .badgeStore{ border-color:#bbf7d0; background:#f0fdf4; color:#166534; font-weight:800; }
    .hidden{ display:none !important; }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>
      ã”æ³¨æ–‡ã¯ã“ã¡ã‚‰
      <span id="modeBadge" class="badge hidden"></span>
    </h1>
    <div class="muted" id="leadText">
      ã”å¸Œæœ›ã®å•†å“ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚
    </div>

    <!-- ğŸ ã‚ªãƒªã‚¸ãƒŠãƒ«ã‚»ãƒƒãƒˆ -->
    <div class="card" id="cardOriginal">
      <a class="btn btnOriginal" href="#" id="goOriginal">ğŸ ã‚ªãƒªã‚¸ãƒŠãƒ«ã‚»ãƒƒãƒˆã‚’è³¼å…¥</a>
      <div class="note">è©°ã‚åˆã‚ã›å•†å“ãƒ»è´ˆç­”å‘ã‘</div>
      <div class="sub">
        <span class="warn">â€» å˜å“ï¼ˆã‚ã‹ã—ã‚ƒã‚·ãƒªãƒ¼ã‚ºç­‰ï¼‰ã¨ã®æ··è¼‰ã¯ã§ãã¾ã›ã‚“</span>
      </div>
      <div class="pill">æ•°é‡ã§é€æ–™ã‚µã‚¤ã‚ºãŒå¤‰ã‚ã‚Šã¾ã™</div>
      <div class="small">
        é€æ–™ã‚µã‚¤ã‚ºï¼š1å€‹â†’80 / 2å€‹â†’100 / 3ï½4å€‹â†’120 / 5ï½6å€‹â†’140
      </div>
    </div>

    <!-- ğŸ˜ ã‚ã‹ã—ã‚ƒã‚·ãƒªãƒ¼ã‚º -->
    <div class="card" id="cardAkasha">
      <a class="btn btnAkasha" href="#" id="goAkasha">ğŸ˜ ã‚ã‹ã—ã‚ƒã‚·ãƒªãƒ¼ã‚ºã‚’è³¼å…¥</a>
      <div class="note">å˜å“ãƒ»çµ„ã¿åˆã‚ã›è‡ªç”±ï¼ˆæ··è¼‰OKï¼‰</div>
      <div class="sub">ä¹…åŠ©ã‚‚ã‚·ãƒªãƒ¼ã‚ºæ‰±ã„ã§åŒæ¢±ã§ãã¾ã™</div>
      <div class="pill">ã‚«ãƒ¼ãƒˆ â†’ ä½æ‰€å…¥åŠ› â†’ æ³¨æ–‡ç¢ºå®š</div>
    </div>

    <!-- ğŸ  åº—èˆ—å—å–ï¼ˆç¾é‡‘ï¼‰ -->
    <div class="card hidden" id="cardStore">
      <a class="btn btnStore" href="#" id="goStore">ğŸ  åº—èˆ—å—å–ï¼ˆç¾é‡‘ï¼‰ã§æ³¨æ–‡ã™ã‚‹</a>
      <div class="note">é€æ–™ãªã—ãƒ»ä½æ‰€å…¥åŠ›ãªã—ãƒ»åº—é ­ã§ç¾é‡‘æ‰•ã„</div>
      <div class="sub">åº—èˆ—ã§ã€ŒLINEæ³¨æ–‡ã§ã™ã€ã¨ãŠä¼ãˆãã ã•ã„</div>
      <div class="pill">ã‚«ãƒ¼ãƒˆ â†’ æ³¨æ–‡ç¢ºå®šï¼ˆç¾é‡‘ï¼‰</div>
    </div>

    <div class="hr"></div>

    <div class="small">
      â€» æœ¬ç”»é¢ã‹ã‚‰ã®é·ç§»ã¯ã™ã¹ã¦ <b>LIFFå…¬å¼URLï¼ˆliff.line.meï¼‰</b> ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚<br>
      LINEä»•æ§˜ã«æº–æ‹ ã—ã¦ã„ã‚‹ãŸã‚ã€400ã‚¨ãƒ©ãƒ¼ã‚’é¿ã‘ã‚„ã™ããªã‚Šã¾ã™ã€‚
    </div>
  </div>

<script>
(function(){
  "use strict";

  /**
   * âœ… è¿½è¨˜ï¼šèµ·å‹•ãƒ­ã‚°ã‚’ /api/liff/opened ã«é€ã‚‹
   * - LIFFå†…ã§é–‹ã‹ã‚ŒãŸæ™‚ã ã‘é€ã‚‹ï¼ˆé€šå¸¸ãƒ–ãƒ©ã‚¦ã‚¶ã¯é€ã‚‰ãªã„ï¼‰
   * - userId ã¯ token.sub â†’ profile.userId ã®é †ã§å–å¾—
   * - source ã« pathname + mode + liffId ã‚’å…¥ã‚Œã‚‹
   * - sessionStorage ã§åŒä¸€ç”»é¢ä¸­ã®äºŒé‡é€ä¿¡ã‚’æŠ‘æ­¢
   */

  // â–¼ã‚ãªãŸã® LIFF URLï¼ˆç¢ºå®šï¼‰
  const LIFF_URL_ORIGINAL = "https://liff.line.me/2008406620-Bd9Zo9od";
  const LIFF_URL_AKASHA   = "https://liff.line.me/2008406620-G5j1gjzM";

  // â–¼åº—èˆ—å—å–ç”¨ã® LIFF URLï¼ˆç¢ºå®šã«å·®ã—æ›¿ãˆæ¸ˆã¿ï¼‰
  const LIFF_URL_STORE    = "https://liff.line.me/2008406620-7tSkOcqd";

  /**
   * â–¼åˆ¤å®šã«ä½¿ã† LIFF_ID ç¾¤ï¼ˆã€Œã©ã‚Œã§é–‹ã‹ã‚Œã¦ã„ã‚‹ã‹ã€ã‚’ç‰¹å®šã™ã‚‹ï¼‰
   * â€» LIFF_ID_STORE ã¯å®ŸIDã«å·®ã—æ›¿ãˆã¦ãã ã•ã„
   */
  const LIFF_ID_ORIGINAL = "2008406620-Bd9Zo9od";
  const LIFF_ID_AKASHA   = "2008406620-G5j1gjzM";
  const LIFF_ID_STORE    = "2008406620-STORE_LIFF_ID_HERE"; // â˜…ã“ã“ã ã‘è¦ä¿®æ­£

  // UIè¦ç´ 
  const modeBadge = document.getElementById("modeBadge");
  const leadText  = document.getElementById("leadText");
  const cardStore = document.getElementById("cardStore");

  // ãƒœã‚¿ãƒ³
  const btnOriginal = document.getElementById("goOriginal");
  const btnAkasha   = document.getElementById("goAkasha");
  const btnStore    = document.getElementById("goStore");

  // ã‚¯ãƒªãƒƒã‚¯é·ç§»ï¼ˆå›ºå®šï¼‰
  btnOriginal.addEventListener("click", function(e){
    e.preventDefault();
    location.href = LIFF_URL_ORIGINAL;
  });
  btnAkasha.addEventListener("click", function(e){
    e.preventDefault();
    location.href = LIFF_URL_AKASHA;
  });
  btnStore.addEventListener("click", function(e){
    e.preventDefault();
    location.href = LIFF_URL_STORE;
  });

  function setModeUI(mode){
    // mode: "delivery" | "store" | "unknown"
    if(mode === "store"){
      cardStore.classList.remove("hidden");
      modeBadge.classList.remove("hidden");
      modeBadge.classList.add("badgeStore");
      modeBadge.textContent = "åº—èˆ—å—å–ãƒ¢ãƒ¼ãƒ‰";
      leadText.textContent = "åº—èˆ—å—å–ï¼ˆç¾é‡‘ï¼‰ã§ã®æ³¨æ–‡ã§ã™ã€‚å•†å“ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚";
    }else if(mode === "delivery"){
      modeBadge.classList.remove("hidden");
      modeBadge.textContent = "é…é€ãƒ¢ãƒ¼ãƒ‰";
      leadText.textContent = "ã”å¸Œæœ›ã®å•†å“ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚";
    }else{
      modeBadge.classList.add("hidden");
      leadText.textContent = "ã”å¸Œæœ›ã®å•†å“ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚";
    }
  }

  // âœ… LIFFã§èµ·å‹•ã•ã‚Œã¦ã„ã‚‹ã‹ & ã©ã® LIFF ã‹ ã‚’åˆ¤å®š
  async function detectModeByLiff(){
    if(typeof liff === "undefined" || !liff.init) return { mode:"unknown", liffId:null, inClient:false };

    const tryIds = [
      { id: LIFF_ID_STORE,    mode: "store" },
      { id: LIFF_ID_ORIGINAL, mode: "delivery" },
      { id: LIFF_ID_AKASHA,   mode: "delivery" },
    ];

    for(const x of tryIds){
      try{
        await liff.init({ liffId: x.id });
        // initæˆåŠŸï¼LIFFã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå†…ã®å¯èƒ½æ€§ãŒé«˜ã„
        const inClient = !!(liff.isInClient && liff.isInClient());
        return { mode: x.mode, liffId: x.id, inClient };
      }catch(e){
        // æ¬¡ã‚’è©¦ã™
      }
    }
    return { mode:"unknown", liffId:null, inClient:false };
  }

  // âœ… è¿½è¨˜ï¼šèµ·å‹•ãƒ­ã‚°ã‚’é€ã‚‹ï¼ˆLIFFå†…ã®ã¿ï¼‰
  async function postLiffOpenedOnce(meta){
    try{
      // äºŒé‡é€ä¿¡æŠ‘æ­¢ï¼ˆåŒä¸€ç”»é¢ä¸­ï¼‰
      const key = "liff_opened_sent:" + (meta?.liffId || "unknown") + ":" + location.pathname;
      if(sessionStorage.getItem(key)) return;
      sessionStorage.setItem(key, "1");

      // userId å–å¾—ï¼ˆtoken.sub â†’ profile.userIdï¼‰
      let userId = null;
      try{
        userId = liff.getDecodedIDToken?.()?.sub || null;
      }catch(_e){}

      if(!userId){
        try{
          const prof = await liff.getProfile();
          userId = prof?.userId || null;
        }catch(_e){}
      }

      // LIFFå¤–ã ã£ãŸã‚‰é€ã‚‰ãªã„ï¼ˆèª¤çˆ†é˜²æ­¢ï¼‰
      const inClient = !!meta?.inClient;
      if(!inClient) return;

      const payload = {
        userId: userId,
        source: [
          location.pathname,
          "mode=" + (meta?.mode || "unknown"),
          "liffId=" + (meta?.liffId || "unknown"),
        ].join("|"),
        debug: "index_open",
        ts: Date.now()
      };

      // åŒä¸€ãƒ‰ãƒ¡ã‚¤ãƒ³ã«POSTï¼ˆURLã‚ºãƒ¬äº‹æ•…ã‚’æ¸›ã‚‰ã™ï¼‰
      const res = await fetch("/api/liff/opened", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify(payload)
      });

      // å¤±æ•—æ™‚ã ã‘ãƒ­ã‚°ï¼ˆæ™®æ®µã¯é™ã‹ï¼‰
      if(!res.ok){
        const txt = await res.text().catch(()=> "");
        console.error("postLiffOpenedOnce failed", res.status, txt);
      }
    }catch(e){
      console.error("postLiffOpenedOnce error", e);
    }
  }

  (async()=>{
    const meta = await detectModeByLiff();
    setModeUI(meta.mode);

    // âœ… è¿½è¨˜ï¼šã“ã“ã§ã€Œèµ·å‹•ãƒ­ã‚°ã€ã‚’é€ã‚‹
    // ï¼ˆinClient=false ã®å ´åˆã¯é€ã‚‰ãªã„ï¼‰
    if(typeof liff !== "undefined" && liff && liff.init){
      await postLiffOpenedOnce(meta);
    }

    // åº—èˆ—å—å–ãƒ¢ãƒ¼ãƒ‰ãªã‚‰UIèª¿æ•´ãªã©ã¯ã“ã“ã§
    if(meta.mode === "store"){
      // document.getElementById("cardOriginal")?.classList.add("hidden");
      // document.getElementById("cardAkasha")?.classList.add("hidden");
    }
  })();

})();
</script>
</body>
</html>
