<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>注文管理 & セグメント配信</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; margin:0; padding:12px; background:#f5f5f5; color:#333; }
    h1 { margin:0 0 8px; font-size:20px; }
    .subtitle { font-size:12px; color:#666; margin-bottom:12px; }
    .top-bar { display:flex; flex-wrap:wrap; align-items:center; gap:8px; margin-bottom:12px; }
    .top-bar label { font-size:12px; color:#555; }
    input[type="text"], input[type="date"], textarea, select { font-size:13px; padding:4px 6px; border-radius:4px; border:1px solid #ccc; box-sizing:border-box; }
    textarea { width:100%; min-height:80px; resize:vertical; }
    button { cursor:pointer; }
    .btn { padding:6px 10px; border-radius:999px; border:none; font-size:13px; font-weight:600; }
    .btn-primary { background:#00b900; color:#fff; }
    .btn-secondary { background:#fff; border:1px solid #ccc; color:#333; }
    .btn-danger { background:#e53935; color:#fff; }
    .btn:disabled { opacity:.5; cursor:default; }
    .tabs { display:flex; gap:4px; margin-bottom:8px; border-bottom:1px solid #ddd; }
    .tab { padding:6px 10px; border-radius:6px 6px 0 0; font-size:13px; cursor:pointer; background:#eee; }
    .tab.active { background:#fff; border:1px solid #ddd; border-bottom-color:#fff; }
    .tab-content { background:#fff; border:1px solid #ddd; border-radius:0 6px 6px 6px; padding:10px; margin-bottom:16px; }
    .info { font-size:11px; color:#666; margin-top:4px; }
    .orders-table { width:100%; border-collapse:collapse; font-size:12px; }
    .orders-table th, .orders-table td { border:1px solid #ddd; padding:4px 6px; vertical-align:top; }
    .orders-table th { background:#fafafa; position:sticky; top:0; z-index:1; }
    .status-label { font-size:11px; padding:2px 6px; border-radius:999px; display:inline-block; }
    .status-new { background:#e3f2fd; color:#1565c0; }
    .status-notified { background:#e8f5e9; color:#2e7d32; }
    .status-failed { background:#ffebee; color:#c62828; }
    .small { font-size:11px; color:#555; }
    .muted { color:#888; }
    .mono { font-family:"SFMono-Regular",Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; font-size:11px; }
    .segment-row { display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:8px; }
    .segment-row label { font-size:12px; color:#555; }
    .segment-result { font-size:12px; background:#fafafa; border-radius:4px; padding:6px; border:1px solid #eee; max-height:150px; overflow:auto; white-space:pre-wrap; }
    .badge { display:inline-block; padding:2px 6px; border-radius:999px; font-size:10px; background:#eee; color:#555; }
    .badge-orders { background:#e3f2fd; color:#1565c0; }
    .badge-chat { background:#f3e5f5; color:#6a1b9a; }
    .badge-addr { background:#e8f5e9; color:#2e7d32; }
    .pill { display:inline-block; padding:2px 6px; border-radius:6px; background:#f2f2f2; font-size:11px; margin-top:4px; }
  </style>
</head>
<body>
  <h1>注文管理 & セグメント配信</h1>
  <div class="subtitle">手造りえびせんべい 磯屋 / 管理者専用ページ（URLをお客さまに共有しないでください）</div>

  <div class="top-bar">
    <label>
      管理トークン:
      <input type="text" id="adminToken" placeholder="ADMIN_API_TOKEN または ADMIN_CODE" size="26" />
    </label>
    <button class="btn btn-secondary" id="reloadBtn">注文を読み込み</button>
    <label>
      日付（JST）:
      <input type="date" id="dateFilter" />
    </label>
    <span class="info">※トークンはブラウザに保存されます（localStorage）。</span>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="orders">注文一覧・発送通知</div>
    <div class="tab" data-tab="segment">セグメント配信</div>
  </div>

  <div class="tab-content" id="tab-orders">
    <div class="small muted" id="ordersSummary">注文を読み込んでいません。</div>
    <div style="overflow:auto; max-height:70vh; margin-top:6px;">
      <table class="orders-table" id="ordersTable">
        <thead>
          <tr>
            <th>状態</th>
            <th>注文日時</th>
            <th>ユーザー</th>
            <th>内容</th>
            <th>金額</th>
            <th>住所</th>
            <th>伝票/発送通知</th>
          </tr>
        </thead>
        <tbody id="ordersTbody"></tbody>
      </table>
    </div>
    <div class="info">
      ・通知済み判定は <b>サーバー側の shipped_notified_at（または notified_kind）</b> があればそれを優先します。無い場合は従来どおりブラウザ内（localStorage）で判定します。<br/>
      ・伝票番号(tracking_no)が入っている注文は、発送通知メッセージに <b>追跡リンク</b> を自動で付けます。<br/>
    </div>
  </div>

  <div class="tab-content" id="tab-segment" style="display:none;">
    <div class="segment-row">
      <label>
        種別:
        <select id="segmentType">
          <option value="orders">注文者（ORDERSベース）</option>
          <option value="activeChatters">アクティブなトーク送信者</option>
          <option value="addresses">住所登録者</option>
        </select>
      </label>
      <label>
        日付（任意・JST）:
        <input type="date" id="segmentDate" />
      </label>
      <button class="btn btn-secondary" id="segmentPreviewBtn">対象をプレビュー</button>
    </div>
    <div class="segment-row">
      <span id="segmentSummary" class="small muted">まだプレビューしていません。</span>
    </div>
    <div class="segment-result mono" id="segmentResult"></div>

    <div style="margin-top:8px;">
      <label class="small">送信メッセージ（テキスト）：</label>
      <textarea id="segmentMessage" placeholder="例）磯屋です。〇月△日の久助入荷のご案内です…"></textarea>
      <div class="info">
        ・プレビューで取得したユーザーID一覧に、このメッセージが配信されます。<br/>
        ・LINEの仕様上、配信には多少の時間がかかる場合があります。
      </div>
      <button class="btn btn-primary" id="segmentSendBtn">この条件で配信する</button>
    </div>
  </div>

  <script>
    (function () {
      "use strict";

      const ADMIN_TOKEN_KEY = "iso-admin-token";
      const SHIP_STATE_KEY  = "iso-ship-state-v2"; // { orderKey: { status, ts, lastError } }
      const COD_FEE = 330;

      const adminTokenInput = document.getElementById("adminToken");
      const reloadBtn = document.getElementById("reloadBtn");
      const dateFilterInput = document.getElementById("dateFilter");

      const ordersSummaryEl = document.getElementById("ordersSummary");
      const ordersTbody = document.getElementById("ordersTbody");

      const tabs = document.querySelectorAll(".tab");
      const tabOrders = document.getElementById("tab-orders");
      const tabSegment = document.getElementById("tab-segment");

      const segmentTypeSelect = document.getElementById("segmentType");
      const segmentDateInput = document.getElementById("segmentDate");
      const segmentPreviewBtn = document.getElementById("segmentPreviewBtn");
      const segmentSummaryEl = document.getElementById("segmentSummary");
      const segmentResultEl = document.getElementById("segmentResult");
      const segmentMessageEl = document.getElementById("segmentMessage");
      const segmentSendBtn = document.getElementById("segmentSendBtn");

      const yen = (n) => Number(n || 0).toLocaleString("ja-JP") + "円";

      function loadAdminToken() { return localStorage.getItem(ADMIN_TOKEN_KEY) || ""; }
      function saveAdminToken(v) { localStorage.setItem(ADMIN_TOKEN_KEY, v || ""); }

      function loadShipState() {
        try { return JSON.parse(localStorage.getItem(SHIP_STATE_KEY) || "{}") || {}; }
        catch { return {}; }
      }
      function saveShipState(state) {
        try { localStorage.setItem(SHIP_STATE_KEY, JSON.stringify(state || {})); }
        catch (e) { console.warn("saveShipState error:", e); }
      }

      function getToken() { return (adminTokenInput.value || "").trim(); }

      async function apiFetch(path, options = {}) {
        const token = getToken();
        if (!token) {
          alert("管理トークンを入力してください。");
          throw new Error("no_admin_token");
        }

        const url =
          path +
          (path.includes("?") ? "&" : "?") +
          "token=" + encodeURIComponent(token) +
          "&_ts=" + Date.now();

        const res = await fetch(url, options);

        if (!res.ok) {
          const text = await res.text().catch(() => "");
          console.error("API error:", res.status, text);
          throw new Error("API error: " + res.status);
        }

        try {
          return await res.json();
        } catch (e) {
          const text = await res.text().catch(() => "");
          console.error("JSON parse failed:", e, text);
          return null;
        }
      }

      function formatYmd(ts) {
        if (!ts) return "";
        const d = new Date(ts);
        if (isNaN(d.getTime())) return String(ts);
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        const hh = String(d.getHours()).padStart(2, "0");
        const mi = String(d.getMinutes()).padStart(2, "0");
        return `${y}-${m}-${dd} ${hh}:${mi}`;
      }

      function escapeHtml(str) {
        return String(str || "")
          .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;").replace(/'/g, "&#39;");
      }

      function buildOrderKey(o, index) {
        // orders.id があるなら最強キー
        if (o.id != null) return "id:" + o.id;
        if (o.orderNumber != null) return "ord:" + o.orderNumber;
        const ts = o.ts || o.created_at || "";
        const uid = o.userId || o.lineUserId || "";
        if (ts && uid) return "ord:" + uid + ":" + ts;
        if (ts) return "ord:" + ts;
        return "idx:" + index;
      }

      function buildItemsArray(o) {
        const src = Array.isArray(o.items) ? o.items : (Array.isArray(o.itemsJson) ? o.itemsJson : []);
        if (Array.isArray(src) && src.length > 0) {
          return src.map((it) => {
            const name = it.name || it.id || "商品";
            let unitPrice = Number(it.price || 0);
            if (!unitPrice && /久助/.test(name)) unitPrice = 250;
            return { name, unitPrice, qty: Number(it.qty || 0) || 0 };
          });
        }
        if (o.productName || o.productId) {
          let name = o.productName || o.productId;
          let unitPrice = Number(o.price || o.unitPrice || 0);
          if (!unitPrice && /久助/.test(name)) unitPrice = 250;
          return [{ name, unitPrice, qty: Number(o.qty || 1) }];
        }
        return [];
      }

      function normalizeTotals(o) {
        const items = buildItemsArray(o);
        const itemsCalc = items.reduce((s, it) => s + (Number(it.unitPrice || 0) * Number(it.qty || 0)), 0);

        const shipping = Number(o.shipping_fee ?? o.shipping ?? 0);
        const totalDb  = Number(o.total ?? o.finalTotal ?? 0);

        const pm = String(o.payment_method ?? o.payment ?? "").toLowerCase();
        const codFee = (pm === "cod") ? COD_FEE : Number(o.codFee ?? 0);

        let itemsFromTotal = totalDb - shipping - codFee;
        if (!isFinite(itemsFromTotal)) itemsFromTotal = 0;

        let itemsTotal = itemsFromTotal > 0 ? itemsFromTotal : itemsCalc;
        const warn = (itemsCalc !== 0 && Math.abs(itemsTotal - itemsCalc) !== 0);

        return {
          itemsCalc,
          itemsTotal,
          shipping,
          codFee,
          finalTotal: (totalDb > 0 ? totalDb : (itemsTotal + shipping + codFee)),
          warn
        };
      }

      function orderItemsText(o) {
        const items = buildItemsArray(o);
        if (!items.length) return "（内容不明）";
        return items.map((it) => `・${it.name} x ${it.qty}`).join("\n");
      }

      function orderTotalText(o) {
        const t = normalizeTotals(o);
        const lines = [];
        lines.push(`商品合計：${yen(t.itemsTotal)}`);
        lines.push(`送料：${yen(t.shipping)}`);
        if (t.codFee) lines.push(`代引手数料：${yen(t.codFee)}`);
        lines.push(`合計：${yen(t.finalTotal)}`);
        if (t.warn) lines.push(`※警告：items再計算(${yen(t.itemsCalc)})と不一致`);
        return lines.join("\n");
      }

      function orderAddressText(o) {
        const a = o.address || null;
        if (a) {
          const name = a.name || (a.lastName || "") + (a.firstName || "");
          const tel = a.phone || a.tel || "";
          const zip = a.postal || a.zip || "";
          const line1 = (a.prefecture || a.pref || "") + (a.city || "") + (a.address1 || a.addr1 || "");
          const line2 = a.address2 || a.addr2 || "";
          return [zip ? `〒${zip}` : "", line1 || "", line2 || "", name ? `氏名：${name}` : "", tel ? `TEL：${tel}` : ""].filter(Boolean).join("\n");
        }
        const name = o.name || "";
        const tel = o.phone || "";
        const zip = o.zip || "";
        const pref = o.pref || "";
        const addr = o.address_text || o.addressLine || o.address || "";
        return [zip ? `〒${zip}` : "", (pref + addr) || "", name ? `氏名：${name}` : "", tel ? `TEL：${tel}` : ""].filter(Boolean).join("\n");
      }

      function getTracking(o) {
        const t = (o.tracking_no || o.trackingNo || o.slip_no || "").toString().trim();
        if (!t || t === "0") return "";
        return t;
      }

      function trackingLink(tracking) {
        if (!tracking) return "";
        // ヤマト追跡
        return "https://toi.kuronekoyamato.co.jp/cgi-bin/tneko?number=" + encodeURIComponent(tracking);
      }

      function isNotifiedServerSide(o) {
        // サーバーが返せるなら、これを最優先で使う
        // shipped_notified_at / notified_user_at / notified_kind のどれかがあれば「通知済み」扱い
        if (o.shipped_notified_at) return true;
        if (o.notified_user_at && String(o.notified_kind || "").includes("shipping")) return true;
        if (String(o.notified_kind || "") === "shipping_notice") return true;
        return false;
      }

      async function loadOrders() {
        ordersSummaryEl.textContent = "読み込み中…";
        ordersTbody.innerHTML = "";

        const dateFilter = (dateFilterInput.value || "").replace(/-/g, "");
        const params = [];
        if (dateFilter) params.push("date=" + encodeURIComponent(dateFilter));
        const path = "/api/admin/orders" + (params.length ? "?" + params.join("&") : "");

        let data;
        try {
          data = await apiFetch(path);
        } catch (e) {
          ordersSummaryEl.textContent = "読み込みエラー：" + e.message;
          console.error(e);
          return;
        }

        const items = Array.isArray(data && data.items) ? data.items : [];
        ordersSummaryEl.textContent = `取得件数：${items.length} 件`;

        const shipState = loadShipState();

        items.forEach((o, idx) => {
          const key = buildOrderKey(o, idx);

          // 通知済み判定：サーバー優先 → 無ければローカル
          const serverNotified = isNotifiedServerSide(o);
          const localState = shipState[key] || null;
          const notified = serverNotified || (localState && localState.status === "ok");

          const tr = document.createElement("tr");

          // 状態
          const tdStatus = document.createElement("td");
          const label = document.createElement("span");
          label.classList.add("status-label");
          if (!notified) { label.classList.add("status-new"); label.textContent = "未通知"; }
          else { label.classList.add("status-notified"); label.textContent = "通知済み"; }
          tdStatus.appendChild(label);

          if (!serverNotified && localState && localState.status === "failed" && localState.lastError) {
            const err = document.createElement("div");
            err.className = "small muted";
            err.textContent = localState.lastError;
            tdStatus.appendChild(err);
          }

          tr.appendChild(tdStatus);

          // 注文日時
          const tdTs = document.createElement("td");
          tdTs.textContent = formatYmd(o.ts || o.created_at);
          tr.appendChild(tdTs);

          // ユーザー
          const tdUser = document.createElement("td");
          const uid = o.userId || o.lineUserId || "";
          const addrObj = o.address || {};
          const name = addrObj.name || o.name || "";
          tdUser.innerHTML =
            (name ? `<div>${escapeHtml(name)}</div>` : "") +
            (uid ? `<div class="mono muted">${escapeHtml(uid)}</div>` : "");
          tr.appendChild(tdUser);

          // 内容
          const tdItems = document.createElement("td");
          tdItems.className = "small";
          tdItems.textContent = orderItemsText(o);
          tr.appendChild(tdItems);

          // 金額
          const tdTotal = document.createElement("td");
          tdTotal.className = "small";
          tdTotal.textContent = orderTotalText(o);
          tr.appendChild(tdTotal);

          // 住所
          const tdAddr = document.createElement("td");
          tdAddr.className = "small";
          tdAddr.textContent = orderAddressText(o);
          tr.appendChild(tdAddr);

          // 伝票/通知
          const tdNotify = document.createElement("td");

          // 伝票表示
          const tracking = getTracking(o);
          const trkDiv = document.createElement("div");
          trkDiv.className = "small";
          if (tracking) {
            const link = trackingLink(tracking);
            trkDiv.innerHTML =
              `<div class="pill">伝票：<span class="mono">${escapeHtml(tracking)}</span></div>` +
              `<div class="small"><a href="${escapeHtml(link)}" target="_blank" rel="noopener">追跡を開く</a></div>`;
          } else {
            trkDiv.innerHTML = `<div class="pill muted">伝票：未登録</div>`;
          }
          tdNotify.appendChild(trkDiv);

          // 明細印字（必要なら）
          const printBtn = document.createElement("button");
          printBtn.className = "btn btn-secondary";
          printBtn.textContent = "明細印字";
          printBtn.style.display = "block";
          printBtn.style.margin = "6px 0 4px";
          printBtn.addEventListener("click", () => printOrderDetail(o));
          tdNotify.appendChild(printBtn);

          // 発送通知ボタン
          const btn = document.createElement("button");
          btn.className = "btn btn-primary";
          btn.textContent = notified ? "通知済み" : "発送通知を送る";
          btn.disabled = notified;

          btn.addEventListener("click", async () => {
            const uidForNotify = o.lineUserId || o.userId || "";
            if (!uidForNotify) { alert("ユーザーIDが無いため、LINEに通知できません。"); return; }
            if (!confirm("この注文の発送通知を送信しますか？")) return;

            btn.disabled = true;
            btn.textContent = "送信中…";

            const itemsText = orderItemsText(o);
            const totalText = orderTotalText(o);

            const trackingNow = getTracking(o);
            const trackingBlock = trackingNow
              ? ("\n\n▼伝票番号\n" + trackingNow +
                 "\n追跡：" + trackingLink(trackingNow))
              : "\n\n※伝票番号が未登録です（必要なら後で追跡番号を追送してください）";

            const msg =
              "【発送のお知らせ】\n" +
              "手造りえびせんべい 磯屋です。\n\n" +
              "ご注文いただいた商品を、本日発送いたしました。\n\n" +
              "▼ご注文内容\n" + itemsText +
              "\n\n" + totalText +
              trackingBlock +
              "\n\n" +
              "商品到着まで今しばらくお待ちくださいませ。";

            try {
              // ここはあなたの既存APIに合わせてる
              await apiFetch("/api/admin/orders/notify-shipped", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  orderId: o.orderNumber,         // orders.id が入ってる前提
                  userId: uidForNotify,
                  orderKey: key,
                  message: msg,
                  tracking_no: trackingNow // サーバー側で使っても使わなくてもOK
                }),
              });

              // ローカルにも記録（サーバーが未対応でもUIが安定）
              const st = loadShipState();
              st[key] = { status: "ok", ts: new Date().toISOString() };
              saveShipState(st);

              btn.textContent = "通知済み";
              label.classList.remove("status-new", "status-failed");
              label.classList.add("status-notified");
              label.textContent = "通知済み";
            } catch (e) {
              console.error("notify shipped error:", e);
              alert("通知送信に失敗しました。サーバー側のAPI実装を確認してください。");

              const st = loadShipState();
              st[key] = { status: "failed", ts: new Date().toISOString(), lastError: e.message || String(e) };
              saveShipState(st);

              btn.disabled = false;
              btn.textContent = "再試行";
              label.classList.remove("status-new", "status-notified");
              label.classList.add("status-failed");
              label.textContent = "エラー";
            }
          });

          tdNotify.appendChild(btn);

          const keyDiv = document.createElement("div");
          keyDiv.className = "mono muted small";
          keyDiv.textContent = key + (o.id != null ? ` (id:${o.id})` : "");
          tdNotify.appendChild(keyDiv);

          tr.appendChild(tdNotify);
          ordersTbody.appendChild(tr);
        });
      }

      function printOrderDetail(o) {
        const w = window.open("", "_blank");
        if (!w) { alert("ポップアップがブロックされました。ブラウザの設定を確認してください。"); return; }

        const items = buildItemsArray(o);
        const t = normalizeTotals(o);

        const a = o.address || {};
        const name = a.name || o.name || "";
        const tel = a.phone || o.phone || "";
        const zip = a.postal || o.zip || "";
        const line1 = (a.prefecture || o.pref || "") + (a.city || "") + (a.address1 || o.address || "");
        const line2 = a.address2 || "";

        const pm = String(o.payment_method ?? o.payment ?? "").toLowerCase();
        const paymentText = pm === "cod" ? "代金引換" : (pm || "");

        const orderTs = formatYmd(o.ts || o.created_at);
        const orderNo = (o.orderNumber != null) ? String(o.orderNumber) : "";

        const itemRows = items.length ? items.map((it) => {
          const lineTotal = Number(it.unitPrice || 0) * Number(it.qty || 0);
          return `
            <tr>
              <td>${escapeHtml(it.name)}</td>
              <td class="num">${it.unitPrice ? yen(it.unitPrice) : ""}</td>
              <td class="num">${it.qty}</td>
              <td class="num">${lineTotal ? yen(lineTotal) : ""}</td>
            </tr>`;
        }).join("") : `
          <tr><td colspan="4" style="text-align:center;">商品情報がありません</td></tr>`;

        const shippingRow = (t.shipping || t.codFee) ? `
          <tr>
            <td colspan="3" class="label">送料・手数料</td>
            <td class="num">
              ${t.shipping ? "送料 " + yen(t.shipping) : ""}
              ${t.codFee ? "<br>代引手数料 " + yen(t.codFee) : ""}
            </td>
          </tr>` : "";

        const html = `
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>注文明細書 - 手造りえびせんべい 磯屋</title>
<style>
  body { font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; margin:20px; color:#333; }
  h1 { font-size:20px; margin:0 0 8px; }
  .shop-name { font-size:14px; margin-bottom:16px; }
  .header-row { display:flex; justify-content:space-between; gap:12px; align-items:flex-start; margin-bottom:12px; font-size:12px; }
  .order-info,.customer-info { width:50%; }
  .section-title { font-weight:700; border-bottom:2px solid #000; margin:0 0 6px; padding-bottom:2px; font-size:13px; }
  table { width:100%; border-collapse:collapse; font-size:12px; margin-top:8px; }
  th,td { border:1px solid #000; padding:5px 6px; }
  th { background:#f5f5f5; }
  td.num { text-align:right; }
  td.label { text-align:right; font-weight:700; }
  .totals { margin-top:10px; width:55%; margin-left:auto; }
  .note { margin-top:14px; font-size:11px; }
  @page { size:A4 portrait; margin:10mm 10mm 12mm 10mm; }
  @media print {
    body { margin:0; -webkit-print-color-adjust:exact; print-color-adjust:exact; }
    tr,td,th,.header-row { page-break-inside:avoid; }
  }
</style>
</head>
<body>
  <h1>注文明細書</h1>
  <div class="shop-name">手造りえびせんべい 磯屋</div>

  <div class="header-row">
    <div class="order-info">
      <div class="section-title">注文情報</div>
      <div>注文日時：${escapeHtml(orderTs)}</div>
      <div>注文番号：${escapeHtml(orderNo)}</div>
      <div>お支払い方法：${escapeHtml(paymentText)}</div>
    </div>
    <div class="customer-info">
      <div class="section-title">お客様情報</div>
      <div>${zip ? "〒" + escapeHtml(zip) : ""}</div>
      <div>${escapeHtml(line1)}</div>
      <div>${escapeHtml(line2)}</div>
      <div>${name ? "氏名：" + escapeHtml(name) : ""}</div>
      <div>${tel ? "TEL：" + escapeHtml(tel) : ""}</div>
    </div>
  </div>

  <div class="section-title">ご注文内容</div>
  <table>
    <thead>
      <tr>
        <th style="width:50%;">商品名</th>
        <th style="width:15%;">単価</th>
        <th style="width:10%;">数量</th>
        <th style="width:25%;">金額</th>
      </tr>
    </thead>
    <tbody>${itemRows}</tbody>
  </table>

  <table class="totals">
    <tbody>
      <tr><td class="label">商品合計</td><td class="num">${yen(t.itemsTotal)}</td></tr>
      ${shippingRow}
      <tr><td class="label">お支払合計</td><td class="num">${yen(t.finalTotal)}</td></tr>
    </tbody>
  </table>

  <div class="note">※この明細書はお客様へのお渡し用、またはお店での控えとしてご利用ください。</div>
</body>
</html>`;

        const doc = w.document;
        doc.open(); doc.write(html); doc.close();
        w.focus();
        w.onload = () => { w.print(); };
      }

      async function previewSegment() {
        const type = segmentTypeSelect.value;
        const date = (segmentDateInput.value || "").replace(/-/g, "");

        const body = { type };
        if (date) body.date = date;

        let badgeClass = "badge";
        let badgeLabel = "";
        if (type === "orders") { badgeClass += " badge-orders"; badgeLabel = "注文者"; }
        else if (type === "activeChatters") { badgeClass += " badge-chat"; badgeLabel = "アクティブトーク送信者"; }
        else if (type === "addresses") { badgeClass += " badge-addr"; badgeLabel = "住所登録者"; }

        segmentSummaryEl.textContent = "プレビュー中…";
        segmentResultEl.textContent = "";

        try {
          const res = await apiFetch("/api/admin/segment/preview", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });

          const ids = Array.isArray(res && res.userIds) ? res.userIds : [];
          const total = (res && (res.total ?? ids.length)) ?? ids.length;

          segmentSummaryEl.innerHTML = `<span class="${badgeClass}">${badgeLabel}</span> 対象ユーザー数：${total} 件`;

          const previewIds = ids.slice(0, 50);
          let text = "";
          if (previewIds.length === 0) text = "該当するユーザーがいませんでした。";
          else {
            text = "配信対象となるユーザーID（先頭50件）:\n\n" + previewIds.join("\n");
            if (ids.length > previewIds.length) text += `\n\n… 他 ${ids.length - previewIds.length} 件`;
          }
          segmentResultEl.textContent = text;

          window.__segmentLastResult = { type, date, userIds: ids };
        } catch (e) {
          console.error("segment preview error:", e);
          segmentSummaryEl.textContent = "プレビュー中にエラーが発生しました：" + e.message;
          segmentResultEl.textContent = "";
        }
      }

      async function sendSegment() {
        const last = window.__segmentLastResult;
        if (!last || !Array.isArray(last.userIds) || last.userIds.length === 0) { alert("先に「対象をプレビュー」でユーザーを取得してください。"); return; }
        const msg = (segmentMessageEl.value || "").trim();
        if (!msg) { alert("送信メッセージを入力してください。"); return; }
        if (!confirm(`この条件で ${last.userIds.length} 名にメッセージを送信しますか？`)) return;

        segmentSendBtn.disabled = true;
        segmentSendBtn.textContent = "送信中…";

        try {
          const res = await apiFetch("/api/admin/segment/send", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userIds: last.userIds, message: msg }),
          });
          const sent = (res && (res.sent ?? res.requested ?? 0)) ?? 0;
          alert(`セグメント配信をリクエストしました。\n送信件数（レスポンス）：${sent} 通`);
        } catch (e) {
          console.error("segment send error:", e);
          alert("セグメント配信APIでエラーが発生しました：" + e.message);
        } finally {
          segmentSendBtn.disabled = false;
          segmentSendBtn.textContent = "この条件で配信する";
        }
      }

      function setActiveTab(name) {
        tabs.forEach((tab) => tab.classList.toggle("active", tab.getAttribute("data-tab") === name));
        tabOrders.style.display = name === "orders" ? "block" : "none";
        tabSegment.style.display = name === "segment" ? "block" : "none";
      }

      document.addEventListener("DOMContentLoaded", () => {
        const t = loadAdminToken();
        if (t) adminTokenInput.value = t;

        adminTokenInput.addEventListener("change", () => saveAdminToken(adminTokenInput.value || ""));

        reloadBtn.addEventListener("click", loadOrders);
        dateFilterInput.addEventListener("change", loadOrders);

        const now = new Date();
        const y = now.getFullYear();
        const m = String(now.getMonth() + 1).padStart(2, "0");
        const d = String(now.getDate()).padStart(2, "0");
        dateFilterInput.value = `${y}-${m}-${d}`;

        if (t) loadOrders();
        else ordersSummaryEl.textContent = "管理トークンを入力して「注文を読み込み」を押してください。";

        tabs.forEach((tab) => tab.addEventListener("click", () => setActiveTab(tab.getAttribute("data-tab"))));
        segmentPreviewBtn.addEventListener("click", previewSegment);
        segmentSendBtn.addEventListener("click", sendSegment);
      });
    })();
  </script>
</body>
</html>
