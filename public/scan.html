<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>発送スキャン</title>

<style>
body {
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  background:#000;
  color:#fff;
}

/* カメラ全画面 */
#video {
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  object-fit:cover;
  background:#000;
}

/* 下部操作パネル */
.panel {
  position:fixed;
  bottom:0;
  left:0;
  width:100%;
  padding:12px;
  background:rgba(0,0,0,0.7);
  backdrop-filter:blur(10px);
}

/* 入力欄 */
input {
  width:100%;
  padding:14px;
  font-size:18px;
  border-radius:10px;
  border:none;
  margin-bottom:10px;
}

/* ボタン */
button {
  width:100%;
  padding:16px;
  font-size:18px;
  border:none;
  border-radius:10px;
  margin-bottom:8px;
  font-weight:bold;
}

/* 色分け */
.start { background:#00c853; color:#fff; }
.stop  { background:#d50000; color:#fff; }
.send  { background:#2962ff; color:#fff; }

/* 状態表示 */
.status {
  text-align:center;
  font-size:14px;
  margin-top:6px;
}
</style>
</head>

<body>

<video id="video" playsinline muted></video>

<div class="panel">
  <input id="tracking" placeholder="伝票番号（自動入力）">

  <button id="startBtn" class="start">カメラ開始</button>
  <button id="stopBtn" class="stop">停止</button>
  <button id="sendBtn" class="send">発送確定＆通知</button>

  <div id="status" class="status">待機中</div>
</div>

<script>
let stream = null;

function setStatus(msg){
  document.getElementById("status").innerText = msg;
}

// カメラ開始
async function startCamera(){
  try{
    stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:"environment" },
      audio:false
    });

    const video = document.getElementById("video");
    video.srcObject = stream;
    await video.play();

    setStatus("カメラ起動中");
  }catch(e){
    setStatus("カメラエラー：" + e.name);
  }
}

// 停止
function stopCamera(){
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
    stream=null;
    setStatus("停止");
  }
}

// 通知API
async function send(){
  const tracking = document.getElementById("tracking").value.trim();

  if(!tracking){
    setStatus("番号未入力");
    return;
  }

  setStatus("送信中…");

  try{
    const res = await fetch("/api/admin/ship/scan-and-notify",{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "X-Admin-Token": localStorage.getItem("token") || ""
      },
      body:JSON.stringify({ tracking_no:tracking })
    });

    const data = await res.json();

    if(data.already_notified){
      setStatus("通知済み");
    }else{
      setStatus("通知完了");
    }

  }catch(e){
    setStatus("エラー");
  }
}

// ボタン
document.getElementById("startBtn").onclick = startCamera;
document.getElementById("stopBtn").onclick = stopCamera;
document.getElementById("sendBtn").onclick = send;
</script>

</body>
</html>