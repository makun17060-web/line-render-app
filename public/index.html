<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ã”æ³¨æ–‡æ–¹æ³•é¸æŠ</title>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- âœ… LIFF_ID / LINK ã‚’1ã‹æ‰€ã«é›†ç´„ã—ãŸè¨­å®šï¼ˆpublic/liff-config.jsï¼‰ -->
  <script src="/liff-config.js"></script>

  <style>
    :root{
      --bg:#f6f7f9;
      --card:#fff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;

      --trial:#c2410c;     /* åˆã‚ã¦ã‚»ãƒƒãƒˆ */
      --original:#7a1f1f;  /* ã‚ªãƒªã‚¸ãƒŠãƒ« */
      --akasha:#0b3a53;    /* ã‚ã‹ã—ã‚ƒ */
      --store:#0a7b19;     /* åº—é ­ */

      --shadow:0 1px 4px rgba(0,0,0,.08);
      --radius:16px;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    .wrap{
      max-width:760px;
      margin:0 auto;
      padding:16px 14px 30px;
    }

    h1{
      margin:0 0 6px;
      font-size:20px;
      line-height:1.3;
    }

    .muted{
      color:var(--muted);
      font-size:13px;
      line-height:1.6;
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      margin-top:14px;
    }

    .btn{
      display:block;
      width:100%;
      padding:16px 14px;
      border-radius:14px;
      font-weight:900;
      font-size:16px;
      text-align:center;
      text-decoration:none;
      border:none;
      cursor:pointer;
      user-select:none;
    }

    .btnTrial{ background:var(--trial); color:#fff; }
    .btnOriginal{ background:var(--original); color:#fff; }
    .btnAkasha{ background:var(--akasha); color:#fff; }
    .btnStore{ background:var(--store); color:#fff; }

    /* âœ… è³¼å…¥è€…ã«ã¯åˆã‚ã¦ã‚»ãƒƒãƒˆã‚’ã€Œéè¡¨ç¤ºã€ã§ãã‚‹ */
    .hidden{ display:none !important; }

    .badge{
      display:inline-block;
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      margin-left:8px;
      color:var(--muted);
      vertical-align:middle;
      white-space:nowrap;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>
      ã”æ³¨æ–‡ã¯ã“ã¡ã‚‰
      <span class="badge" id="badge">åˆ¤å®šä¸­â€¦</span>
    </h1>
    <div class="muted" id="subtext">
      ã”å¸Œæœ›ã®å•†å“ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚
    </div>

    <!-- ğŸ†• åˆã‚ã¦ã‚»ãƒƒãƒˆ -->
    <div class="card" id="cardTrial">
      <a class="btn btnTrial" id="btnTrial" href="#">
        ğŸ†• åˆã‚ã¦ã®æ–¹é™å®šã‚»ãƒƒãƒˆ
      </a>
      <div class="muted" style="margin-top:8px;">
        â€»åˆå›é™å®šï¼ˆè³¼å…¥æ¸ˆã¿ã®æ–¹ã«ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ï¼‰
      </div>
    </div>

    <!-- ã‚ªãƒªã‚¸ãƒŠãƒ«ã‚»ãƒƒãƒˆ -->
    <div class="card">
      <a class="btn btnOriginal" id="btnOriginal" href="#">
        ğŸ ã‚ªãƒªã‚¸ãƒŠãƒ«ã‚»ãƒƒãƒˆ
      </a>
    </div>

    <!-- ã‚ã‹ã—ã‚ƒã‚·ãƒªãƒ¼ã‚º -->
    <div class="card">
      <a class="btn btnAkasha" id="btnAkasha" href="#">
        ğŸ˜ ã‚ã‹ã—ã‚ƒã‚·ãƒªãƒ¼ã‚º
      </a>
    </div>

    <!-- åº—é ­å—å– -->
    <div class="card">
      <a class="btn btnStore" id="btnStore" href="#">
        ğŸ  åº—é ­å—å–ï¼ˆç¾é‡‘ï¼‰
      </a>
    </div>
  </div>

<script>
(async function(){
  "use strict";

  // ===== è¨­å®š =====
  const LIFF_ID_MENU = window.LIFF_ID_MENU || "2008406620-8CWfgEKh"; // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  const VERSION = "index_v_20260227_env_switch";

  // ãƒªãƒ³ã‚¯ã¯ config ã‹ã‚‰ï¼ˆç„¡ã‘ã‚Œã°ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
  const LINK_TRIAL    = window.LIFF_LINK_TRIAL    || "https://liff.line.me/2008406620-yQFRswAu";
  const LINK_ORIGINAL = window.LIFF_LINK_ORIGINAL || "https://liff.line.me/2008406620-Bd9Zo9od";
  const LINK_AKASHA   = window.LIFF_LINK_AKASHA   || "https://liff.line.me/2008406620-G5j1gjzM";
  const LINK_STORE    = window.LIFF_LINK_STORE    || "https://liff.line.me/2008406620-7tSkOcqd";

  // è¦ç´ 
  const btnTrial    = document.getElementById("btnTrial");
  const btnOriginal = document.getElementById("btnOriginal");
  const btnAkasha   = document.getElementById("btnAkasha");
  const btnStore    = document.getElementById("btnStore");
  const cardTrial   = document.getElementById("cardTrial");
  const badge       = document.getElementById("badge");
  const subtext     = document.getElementById("subtext");

  // hrefåæ˜ ï¼ˆHTMLç›´æ›¸ãã—ãªã„ï¼‰
  if(btnTrial)    btnTrial.href    = LINK_TRIAL;
  if(btnOriginal) btnOriginal.href = LINK_ORIGINAL;
  if(btnAkasha)   btnAkasha.href   = LINK_AKASHA;
  if(btnStore)    btnStore.href    = LINK_STORE;

  // ===== ãƒ‡ãƒãƒƒã‚° =====
  const qs = new URLSearchParams(location.search);
  const DEBUG = qs.get("debug") === "1";
  const FORCE = qs.get("force") === "1"; // èµ·å‹•ãƒ­ã‚°å¼·åˆ¶
  const d = (msg) => { if (DEBUG) alert(msg); };

  const API_OPEN   = location.origin + "/api/liff/opened";
  const API_STATUS = location.origin + "/api/user/status";

  // ===== LIFF init =====
  try {
    await liff.init({ liffId: LIFF_ID_MENU });
  } catch (e) {
    if (badge) badge.textContent = "LIFFåˆæœŸåŒ–å¤±æ•—";
    d("init FAILED: " + (e?.message || String(e)));
    return;
  }

  // ===== login =====
  if (!liff.isLoggedIn()) {
    liff.login({ redirectUri: location.href });
    return;
  }

  // ===== userId =====
  let userId = null;
  try { userId = liff.getDecodedIDToken()?.sub || null; } catch(e){}
  if (!userId) {
    try { userId = (await liff.getProfile())?.userId || null; } catch(e){}
  }
  if (!userId) {
    if (badge) badge.textContent = "userIdä¸æ˜";
    d("userId missing");
    return;
  }

  // ===== èµ·å‹•ãƒ­ã‚°ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰=====
  const openKey = "liff_opened_sent:" + LIFF_ID_MENU + ":" + location.pathname;
  if (FORCE || !sessionStorage.getItem(openKey)) {
    sessionStorage.setItem(openKey, "1");
    const payload = {
      userId,
      source: `index|menu|${VERSION}|origin=${location.origin}`,
      ts: Date.now()
    };
    try {
      const res = await fetch(API_OPEN, {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (DEBUG) {
        const text = await res.text().catch(()=> "");
        d("OPEN LOG " + res.status + "\n" + text.slice(0,200));
      }
    } catch (e) {
      if (DEBUG) d("OPEN LOG error: " + (e?.message || String(e)));
    }
  }

  // ===== è³¼å…¥è€…åˆ¤å®š â†’ è¡¨ç¤ºåˆ‡æ›¿ï¼ˆENVã§åˆ¶å¾¡ï¼‰=====
  if (badge) badge.textContent = "åˆ¤å®šä¸­â€¦";

  let isBuyer = false;
  let showTrialAlways = false; // â† ã‚µãƒ¼ãƒã®ENVã§ON/OFF

  try {
    const res = await fetch(API_STATUS + "?userId=" + encodeURIComponent(userId), {
      method: "GET",
      headers: { "cache-control": "no-store" }
    });
    const json = await res.json().catch(()=>null);

    if (!res.ok || !json || json.ok !== true) {
      if (badge) badge.textContent = "åˆ¤å®šå¤±æ•—";
      if (DEBUG) d("STATUS failed: " + res.status + "\n" + JSON.stringify(json));
    } else {
      isBuyer = !!json.isBuyer;
      showTrialAlways = !!json.showTrialAlways; // â˜…ã“ã“ãŒENVé€£å‹•
      if (badge) badge.textContent = isBuyer ? "è³¼å…¥è€…" : "åˆå›";
    }
  } catch (e) {
    if (badge) badge.textContent = "åˆ¤å®šã‚¨ãƒ©ãƒ¼";
    if (DEBUG) d("STATUS error: " + (e?.message || String(e)));
  }

  // âœ… è³¼å…¥è€…ã«ã¯åˆã‚ã¦ã‚»ãƒƒãƒˆã‚’è¦‹ã›ãªã„ï¼ˆãŸã ã—ENVã§å¼·åˆ¶è¡¨ç¤ºã§ãã‚‹ï¼‰
  if (isBuyer && !showTrialAlways) {
    if (cardTrial) cardTrial.classList.add("hidden");
    if (subtext) subtext.textContent = "ã„ã¤ã‚‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚å•†å“ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚";
  } else {
    if (subtext) subtext.textContent = "ã”å¸Œæœ›ã®å•†å“ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚";
  }

  // âœ… ã‚¯ãƒªãƒƒã‚¯äº‹æ•…å¯¾ç­–ï¼ˆUIå´ï¼‰
  if (isBuyer && !showTrialAlways && btnTrial) {
    btnTrial.addEventListener("click", (e) => {
      e.preventDefault();
      alert("åˆã‚ã¦ã‚»ãƒƒãƒˆã¯åˆå›é™å®šã§ã™ã€‚\né€šå¸¸å•†å“ã‹ã‚‰ã”æ³¨æ–‡ãã ã•ã„ã€‚");
    });
  }

})();
</script>
</body>
</html>