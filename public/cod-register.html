<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>住所登録（LIFF）</title>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; margin:0; padding:12px; background:#f7f7f7; color:#333; }
    h1 { font-size:18px; margin:0 0 8px; }
    p.lead { font-size:13px; margin:0 0 12px; line-height:1.6; }
    .card { background:#fff; border-radius:10px; padding:12px; box-shadow:0 1px 3px rgba(0,0,0,0.08); margin-bottom:8px; }
    .field { margin-bottom:8px; }
    .label { font-size:12px; margin-bottom:2px; }
    input { width:100%; box-sizing:border-box; padding:8px; font-size:14px; border-radius:6px; border:1px solid #ccc; }
    .row { display:flex; gap:8px; }
    .row .field { flex:1; }
    .btn-row { display:flex; flex-direction:column; gap:8px; margin-top:8px; }
    .btn { padding:10px; border-radius:999px; border:none; font-size:14px; font-weight:600; width:100%; }
    .btn-primary { background:#00b900; color:#fff; }
    .btn-secondary { background:#fff; border:1px solid #ccc; color:#333; }
    #statusMsg { margin-top:8px; font-size:12px; color:#555; white-space:pre-line; }
    #statusMsg.err { color:#d00; }
    #statusMsg.ok  { color:#0a7b19; }
    .codeBox { margin-top:10px; padding:10px; background:#fff8e1; border:1px solid #ffe08a; border-radius:10px; font-size:14px; line-height:1.6; white-space:pre-line; }
    .codeBox strong { font-size:22px; letter-spacing:2px; display:inline-block; margin-top:4px; }
    small.note { display:block; margin-top:10px; font-size:11px; color:#777; line-height:1.6; }
  </style>
</head>

<body>
  <h1>住所登録</h1>
  <p class="lead">
    リッチメニュー（LIFF）から開く住所登録です。<br>
    保存後、会員コード（4桁）が表示されます。
  </p>

  <div class="card">
    <div class="field">
      <div class="label">郵便番号</div>
      <input id="postal" type="text" inputmode="numeric" placeholder="例）470-0000" />
    </div>
    <div class="field">
      <div class="label">都道府県</div>
      <input id="prefecture" type="text" placeholder="例）愛知県" />
    </div>
    <div class="field">
      <div class="label">市区町村</div>
      <input id="city" type="text" placeholder="例）知多郡武豊町" />
    </div>
    <div class="field">
      <div class="label">番地・建物名</div>
      <input id="address1" type="text" placeholder="例）字○○1-2-3" />
    </div>
    <div class="field">
      <div class="label">建物名・部屋番号など（任意）</div>
      <input id="address2" type="text" placeholder="任意" />
    </div>

    <div class="row">
      <div class="field">
        <div class="label">お名前</div>
        <input id="name" type="text" placeholder="例）磯屋 太郎" />
      </div>
      <div class="field">
        <div class="label">電話番号</div>
        <input id="phone" type="tel" placeholder="例）090-1234-5678" />
      </div>
    </div>

    <div id="codeBox" class="codeBox" style="display:none;"></div>
  </div>

  <div class="btn-row">
    <!-- ✅ form誤爆防止 -->
    <button id="saveBtn" type="button" class="btn btn-primary" disabled>住所を保存する</button>
    <button id="closeBtn" type="button" class="btn btn-secondary">この画面を閉じる</button>
  </div>

  <div id="statusMsg"></div>

  <small class="note">
    ※保存後に表示される「会員コード（4桁）」を控えてください。<br>
    ※LINEアプリ内（LIFF）で開いてください。
  </small>

  <script>
    (function () {
      "use strict";

      /**
       * ✅同一ドメインで配信しているなら API_BASE は "" のままでOK（CORSなし）
       * ✅別ドメインなら ?api=https://line-render-app-1.onrender.com を付ける
       */
      const qs = new URLSearchParams(location.search);
      const API_BASE_RAW = (qs.get("api") || "").trim().replace(/\/+$/, "");
      const API_BASE = API_BASE_RAW || "";

      // ✅ セグメント用：kind を URL で上書きできる（例: ?kind=address）
      const SEG_KIND = (qs.get("kind") || "order").trim().slice(0, 32);

      const statusEl = document.getElementById("statusMsg");
      const saveBtn  = document.getElementById("saveBtn");
      const closeBtn = document.getElementById("closeBtn");
      const codeBox  = document.getElementById("codeBox");

      let lineUserId = "";

      function apiUrl(p) {
        if (!p.startsWith("/")) p = "/" + p;
        return API_BASE ? (API_BASE + p) : p;
      }

      function setStatus(msg, kind) {
        statusEl.textContent = msg || "";
        statusEl.classList.remove("err", "ok");
        if (kind === "err") statusEl.classList.add("err");
        if (kind === "ok")  statusEl.classList.add("ok");
      }

      function getVal(id) { return (document.getElementById(id)?.value || "").trim(); }
      function setVal(id, v) { const el = document.getElementById(id); if (el) el.value = (v || "").toString(); }

      function buildAddressFromForm() {
        const postal   = getVal("postal");
        const prefecture = getVal("prefecture");
        const city     = getVal("city");
        const address1 = getVal("address1");
        const address2 = getVal("address2");
        const name     = getVal("name");
        const phone    = getVal("phone");

        if (!postal || !prefecture || !city || !address1 || !name || !phone) {
          setStatus("郵便番号・都道府県・市区町村・番地/建物・お名前・電話番号は必須です。", "err");
          return null;
        }
        return { postal, prefecture, city, address1, address2, name, phone };
      }

      async function fetchJson(url, opts) {
        const res = await fetch(url, opts);
        const data = await res.json().catch(() => ({}));
        return { res, data };
      }

      // ✅ セグメントログ送信（失敗しても止めない）
      async function logLiffOpen(userId) {
        if (!userId) return;
        try {
          const { res, data } = await fetchJson(apiUrl("/api/liff/open"), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userId, kind: SEG_KIND }),
          });
          if (!res.ok || !data?.ok) {
            console.warn("liff open log not ok:", res.status, data);
          } else {
            console.log("liff open logged:", userId, "kind=", SEG_KIND);
          }
        } catch (e) {
          console.warn("liff open log failed:", e);
        }
      }

      async function initLiff() {
        setStatus("LIFF 初期化中…", "");
        saveBtn.disabled = true;

        // リッチメニュー側は order を使う（電話用codと混ざりにくい）
        const { res: cfgRes, data: cfg } =
          await fetchJson(apiUrl("/api/liff/config?kind=order"), { cache: "no-store" });

        if (!cfgRes.ok || !cfg?.liffId) {
          throw new Error("LIFF ID 取得失敗（/api/liff/config?kind=order）");
        }

        await liff.init({ liffId: cfg.liffId });

        if (!liff.isLoggedIn()) {
          setStatus("LINEログインに移動します…", "");
          liff.login();
          return;
        }

        // userId取得
        try {
          const profile = await liff.getProfile();
          lineUserId = profile?.userId || "";
        } catch (e) {
          // まれに getProfile が落ちる場合の保険（IDトークンsub）
          const idt = liff.getDecodedIDToken?.();
          lineUserId = (idt && idt.sub) ? String(idt.sub) : "";
        }

        if (!lineUserId) {
          setStatus("userId取得に失敗しました。LINEアプリ内（LIFF）で開いているか確認してください。", "err");
          return;
        }

        // ✅ ここが追加：起動ログ（セグメント用）
        // 住所登録を開いたユーザーを liff_open_logs に貯める
        await logLiffOpen(lineUserId);

        setStatus(
          `userId取得OK（kind=${SEG_KIND}）。住所を入力して「住所を保存する」を押してください。`,
          "ok"
        );
        saveBtn.disabled = false;

        // 既存住所の読み込み（任意）
        try {
          const { data: me } =
            await fetchJson(apiUrl(`/api/liff/address/me?userId=${encodeURIComponent(lineUserId)}`), { cache: "no-store" });
          if (me?.ok && me?.address) {
            const a = me.address;
            setVal("postal", a.postal);
            setVal("prefecture", a.prefecture);
            setVal("city", a.city);
            setVal("address1", a.address1);
            setVal("address2", a.address2);
            setVal("name", a.name);
            setVal("phone", a.phone);
          }
        } catch {}
      }

      async function handleSave() {
        const addr = buildAddressFromForm();
        if (!addr) return;

        if (!lineUserId) {
          setStatus("LINE userId が取得できていません。", "err");
          return;
        }

        saveBtn.disabled = true;
        try {
          setStatus("住所を保存しています…", "");
          codeBox.style.display = "none";
          codeBox.textContent = "";

          const { res, data } = await fetchJson(apiUrl("/api/liff/address"), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userId: lineUserId, address: addr }),
          });

          console.log("SAVE RESPONSE:", res.status, data);

          // ✅ どのキーでも拾えるようにする
          const memberCode = (data && (data.memberCode || data.member_code || data.code || data.member))
            ? String(data.memberCode || data.member_code || data.code || data.member)
            : "";

          const addressCode = (data && (data.addressCode || data.address_code))
            ? String(data.addressCode || data.address_code)
            : "";

          if (!res.ok || !data?.ok || !memberCode) {
            setStatus(
              "住所の保存に失敗しました（コードが取得できません）。\n" +
              `status=${res.status}\n` +
              `response=${JSON.stringify(data)}`,
              "err"
            );
            return;
          }

          codeBox.style.display = "block";
          codeBox.innerHTML =
            `✅ 住所を保存しました。\n` +
            `会員コード：\n<strong>${memberCode}</strong>\n` +
            (addressCode ? `\n住所コード：${addressCode}\n` : "") +
            `\n（この数字を控えてください）`;

          codeBox.scrollIntoView({ behavior: "smooth", block: "start" });
          setStatus("保存完了。会員コードを控えてください。", "ok");
        } catch (e) {
          console.error("save failed:", e);
          setStatus(
            "通信に失敗しました。\n" +
            (e?.message || String(e)) + "\n\n" +
            "・同一ドメイン配信ならOK\n" +
            "・別ドメインなら URL に ?api=https://xxxx.onrender.com を付けてください",
            "err"
          );
        } finally {
          saveBtn.disabled = false;
        }
      }

      function handleClose() {
        try {
          if (window.liff && liff.isInClient()) liff.closeWindow();
          else window.close();
        } catch {
          setStatus("閉じられない場合は、戻るボタンで閉じてください。", "");
        }
      }

      document.addEventListener("DOMContentLoaded", async () => {
        closeBtn.addEventListener("click", (ev) => { ev.preventDefault(); handleClose(); });
        saveBtn.addEventListener("click", (ev) => { ev.preventDefault(); handleSave(); });

        try {
          await initLiff();
        } catch (e) {
          console.error("LIFF init error:", e);
          setStatus("初期化に失敗しました。\n" + (e?.message || String(e)), "err");
        }
      });
    })();
  </script>
</body>
</html>
