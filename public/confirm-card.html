<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>クレジット決済の確認</title>

  <style>
    :root{
      --bg:#f6f7f9;--card:#fff;--text:#111827;--muted:#6b7280;--line:#e5e7eb;
      --pri:#123b66;--danger:#b91c1c;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:820px;margin:0 auto;padding:14px 14px 26px}
    h1{margin:0 0 6px;font-size:18px}
    .muted{color:var(--muted);font-size:13px}
    .err{color:var(--danger);font-weight:900}

    .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px;margin-top:12px}
    .items{margin-top:10px;border-top:1px solid var(--line)}
    .item{
      display:grid;
      grid-template-columns:1fr auto;
      gap:6px 10px;
      padding:12px 0;
      border-bottom:1px dashed var(--line);
      font-size:14px;
    }
    .item:last-child{border-bottom:none}
    .item .name{font-weight:800}
    .item .qty{grid-column:1/2;color:var(--muted);font-size:13px}
    .item .price{grid-column:2/3;grid-row:1/3;align-self:center;font-weight:900}

    .row{display:flex;justify-content:space-between;padding:6px 0;font-size:14px}
    .row.total{border-top:2px solid var(--line);margin-top:6px;padding-top:10px;font-size:16px;font-weight:900}

    .btns{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    button{
      flex:1;min-width:180px;
      border:none;border-radius:14px;
      padding:12px 14px;font-weight:900;cursor:pointer
    }
    #payBtn{background:var(--pri);color:#fff}
    #backBtn{background:#fff;border:1px solid var(--line)}
    button:disabled{opacity:.6}
  </style>
</head>

<body>
<div class="wrap">
  <h1>クレジット決済の確認</h1>
  <div class="muted" id="status">読み込み中…</div>

  <div class="card">
    <div class="muted">ご注文商品</div>
    <div class="items" id="items"></div>

    <div class="row"><div>小計</div><div id="subtotal">—</div></div>
    <div class="row"><div>送料</div><div id="shipping">—</div></div>
    <div class="row total"><div>合計（クレジット）</div><div id="total">—</div></div>

    <div class="btns">
      <button id="backBtn" type="button">戻る</button>
      <button id="payBtn" type="button">Stripeで支払う</button>
    </div>
  </div>
</div>

<script>
(async function(){
  "use strict";

  const KEY = "isoya_card_checkout";
  const PATH_CONFIRM = "/public/confirm.html";

  const status = document.getElementById("status");
  const itemsEl = document.getElementById("items");
  const subtotalEl = document.getElementById("subtotal");
  const shippingEl = document.getElementById("shipping");
  const totalEl = document.getElementById("total");
  const payBtn = document.getElementById("payBtn");
  const backBtn = document.getElementById("backBtn");

  const yen = n => (Number(n)||0).toLocaleString("ja-JP")+"円";

  function load(){
    try{ return JSON.parse(localStorage.getItem(KEY)||"null"); }
    catch{ return null; }
  }

  async function post(url, body){
    const r = await fetch(url,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });
    const d = await r.json().catch(()=> ({}));
    return { ok:r.ok, status:r.status, data:d };
  }

  async function getProducts(){
    const r = await fetch("/api/products",{cache:"no-store"});
    const d = await r.json().catch(()=>({}));
    if(!r.ok || !d.ok) throw new Error(d.error || "products_error");
    return d.products;
  }

  function render(items, products){
    const map = Object.fromEntries(products.map(p=>[p.id,p]));
    itemsEl.innerHTML="";
    let subtotal = 0;

    for(const it of items){
      const p = map[it.id];
      if(!p) continue;
      const qty = Number(it.qty||0);
      const line = p.price * qty;
      subtotal += line;

      const div = document.createElement("div");
      div.className="item";
      div.innerHTML = `
        <div class="name">${p.name}${p.volume?`（${p.volume}）`:""}</div>
        <div class="price">${yen(line)}</div>
        <div class="qty">× ${qty} 点</div>
      `;
      itemsEl.appendChild(div);
    }
    subtotalEl.textContent = yen(subtotal);
    return subtotal;
  }

  function busy(on){
    payBtn.disabled = on;
    payBtn.textContent = on ? "決済画面へ…" : "Stripeで支払う";
  }

  // ===== main =====
  try{
    const payload = load();
    if(!payload?.uid || !Array.isArray(payload.items)){
      status.innerHTML = '<span class="err">決済情報がありません</span>';
      setTimeout(()=>location.href=PATH_CONFIRM,600);
      return;
    }

    const uid = payload.uid;
    const items = payload.items.filter(i=>i?.id && i.qty>0);
    if(!items.length){
      status.innerHTML = '<span class="err">商品がありません</span>';
      return;
    }

    backBtn.onclick = ()=>location.href=PATH_CONFIRM;

    const products = await getProducts();
    const subtotal = render(items, products);

    // 送料見積り
    let shippingFee = 0;
    try{
      const q = await post("/api/order/quote",{ uid, checkout:{ items }});
      if(q.ok){
        shippingFee = Number(q.data.shippingFee||0);
        shippingEl.textContent = yen(shippingFee);
      }else{
        shippingEl.textContent = "—";
      }
    }catch{
      shippingEl.textContent = "—";
    }

    totalEl.textContent = yen(subtotal + shippingFee);
    status.textContent = "内容をご確認ください。";

    // Stripeへ
    payBtn.onclick = async ()=>{
      busy(true);
      try{
        const r = await post("/api/pay/stripe/create",{ uid, checkout:{ items }});
        if(!r.ok || !r.data?.url){
          throw new Error(r.data?.error || ("HTTP "+r.status));
        }
        location.href = r.data.url;
      }catch(e){
        alert("クレジット決済エラー:\n" + e.message);
        busy(false);
      }
    };

  }catch(e){
    console.error(e);
    status.innerHTML='<span class="err">読み込みに失敗しました</span>';
  }
})();
</script>
</body>
</html>
