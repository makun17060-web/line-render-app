<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LINE 管理画面（配信・ログ・在庫）</title>
  <style>
    :root { --bg:#0b1020; --card:#131a2e; --ink:#e6ebff; --sub:#9fb1ff; --muted:#7b88b8; --acc:#6aa3ff; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI",sans-serif;}
    header{padding:18px 20px;border-bottom:1px solid #1f2744;background:linear-gradient(180deg,#121a33,#0b1020);position:sticky;top:0;z-index:2}
    h1{margin:0;font-size:18px;letter-spacing:.5px}
    main{padding:22px;display:grid;gap:18px;grid-template-columns:repeat(auto-fit,minmax(360px,1fr));}
    .card{background:var(--card);border:1px solid #243057;border-radius:16px;padding:16px;box-shadow:0 10px 24px rgba(0,0,0,.18)}
    .card h2{margin:0 0 10px 0;font-size:16px;color:var(--sub)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0}
    input[type="text"],input[type="number"],textarea{background:#0f1630;color:var(--ink);border:1px solid #2a3760;border-radius:10px;padding:10px 12px;outline:none;width:100%}
    textarea{min-height:96px;resize:vertical}
    button{background:var(--acc);color:#06102b;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    button.secondary{background:#26345d;color:#cfe0ff;border:1px solid #3a4a7b}
    .muted{color:var(--muted);font-size:12px}
    code.inline{background:#0f1630;padding:2px 6px;border:1px solid #26345d;border-radius:6px}
    .pill{display:inline-block;background:#20305c;color:#cfe0ff;border:1px solid #35477b;padding:3px 8px;border-radius:999px;font-size:12px;margin-left:8px}
    pre{white-space:pre-wrap;word-break:break-all;background:#0f1630;color:#cfe0ff;border:1px solid #2a3760;border-radius:10px;padding:10px;max-height:360px;overflow:auto}
    .ok{color:#6ae07b}.ng{color:#ff7280}
    .label{font-size:12px;color:#9fb1ff;margin-bottom:2px}
  </style>
</head>
<body>
  <header>
    <h1>LINE 管理画面（リッチ配信 / セグメント / ログ）</h1>
    <div class="muted">このページは <code class="inline">/public/admin.html</code> です。サーバーの <code class="inline">ADMIN_API_TOKEN</code> を使って認証します。</div>
  </header>

  <main>
    <!-- 認証・状態 -->
    <section class="card">
      <h2>認証・状態</h2>
      <div class="row" style="width:100%">
        <div style="flex:1 1 320px">
          <div class="label">ADMIN_API_TOKEN</div>
          <input id="token" type="text" placeholder="ADMIN_API_TOKEN を貼り付け" />
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="btnSaveToken">保存</button>
          <button id="btnPing">Ping</button>
          <span id="pingRes" class="pill">未実行</span>
        </div>
      </div>
      <div class="row"><button id="btnHealth" class="secondary">/api/health を表示</button></div>
      <pre id="healthOut" hidden></pre>
      <div class="muted">※ Ping が OK にならないと、配信やログ取得が失敗します（Authorization: Bearer <code class="inline">ADMIN_API_TOKEN</code>）。</div>
    </section>

    <!-- 商品 → Flex 自動生成 -->
    <section class="card">
      <h2>商品一覧 → リッチメッセージ（Flex）自動生成</h2>
      <div class="row">
        <button id="btnLoadProducts">商品を読み込む（/api/admin/products）</button>
        <span id="prodCount" class="pill">0 件</span>
      </div>
      <div class="row" style="width:100%">
        <div style="flex:1 1 240px">
          <div class="label">一覧から隠すID（カンマ区切り）</div>
          <input id="hideIds" type="text" placeholder="例: kusuke-250">
        </div>
        <div style="flex:1 1 240px">
          <div class="label">altText（必須）</div>
          <input id="altText" type="text" placeholder="商品一覧">
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="btnBuildFlex">Flex 生成（プレビュー）</button>
          <button id="btnChunkOn" class="secondary">ページ分割 ON</button>
          <span id="chunkStatus" class="pill">OFF</span>
        </div>
      </div>
      <pre id="flexPreview" hidden></pre>

      <div class="row" style="width:100%">
        <div style="flex:1 1 100%">
          <div class="label">セグメント配信用 userId（カンマ区切り）。空なら broadcast</div>
          <input id="userIds" type="text" placeholder="例: Uxxxxxxxxx,Uyyyyyyyyy">
        </div>
      </div>
      <div class="row">
        <button id="btnActiveUsers">直近のアクティブユーザー取得（ユニーク）</button>
        <button id="btnFillToUserIds" class="secondary">userIds に自動入力</button>
        <span id="usersCount" class="pill">0 ユーザー</span>
      </div>
      <pre id="usersOut" hidden></pre>

      <div class="row">
        <button id="btnSendFlex">この Flex を配信</button>
        <span id="sendFlexRes" class="pill">未送信</span>
      </div>
      <div class="muted">※ セグメント送信は /api/admin/segment/send-flex、ブロードキャストは /api/admin/broadcast-flex を使用します。</div>
    </section>

    <!-- テキスト配信（Flexで送る簡易版） -->
    <section class="card">
      <h2>テキストを送る（簡易）</h2>
      <div class="row" style="width:100%">
        <textarea id="textMessage" placeholder="配信する本文（ブロードキャスト：userIds 空のとき）"></textarea>
      </div>
      <div class="row">
        <div style="flex:1 1 100%">
          <div class="label">userId（カンマ区切り）。空ならブロードキャスト</div>
          <input id="textUserIds" type="text" placeholder="例: Uxxxxxxxxx">
        </div>
      </div>
      <div class="row">
        <button id="btnSendText">送信</button>
        <span id="sendTextRes" class="pill">未送信</span>
      </div>
      <div class="muted">※ テキストは「テキスト入りの簡易Flex」として送ります（/api/admin/broadcast-flex または /api/admin/segment/send）。</div>
    </section>

    <!-- メッセージログ（tail 相当） -->
    <section class="card">
      <h2>メッセージログ（/data/messages.log の tail）</h2>
      <div class="row">
        <button id="btnLoadLog">最新200件を取得</button>
        <button id="btnAutoRefresh" class="secondary">10秒ごと更新</button>
        <span id="autoStatus" class="pill">OFF</span>
      </div>
      <pre id="logOut" hidden></pre>
      <div class="muted">※ ここは /api/admin/messages を叩いており、サーバー側で tail 相当を返しています。<br>※ 管理画面から送信したメッセージは Webhook を通らないため、<b>messages.log には出ません</b>（ユーザーが送った<small>/ボタンの postback</small>のみ記録）。</div>
    </section>
  </main>

  <script src="/public/admin.js"></script>
</body>
</html>
HTML
