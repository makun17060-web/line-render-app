<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>えびせん管理画面（画像管理＋セグメント配信）</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #f5f5f5;
    }
    h1 {
      margin-top: 0;
      font-size: 20px;
    }
    .card {
      background: #fff;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    label {
      display: block;
      font-size: 12px;
      margin-bottom: 4px;
    }
    input[type="text"],
    input[type="number"],
    textarea,
    select {
      width: 100%;
      max-width: 360px;
      padding: 6px 8px;
      font-size: 13px;
      box-sizing: border-box;
    }
    textarea {
      min-height: 60px;
    }
    button {
      padding: 6px 12px;
      font-size: 13px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      margin-right: 4px;
      margin-top: 4px;
    }
    button.primary { background: #1976d2; color:#fff; }
    button.danger  { background: #d32f2f; color:#fff; }

    #log {
      background: #111;
      color: #eee;
      font-family: monospace;
      font-size: 11px;
      padding: 8px;
      border-radius: 4px;
      max-height: 260px;
      overflow: auto;
      white-space: pre-wrap;
    }
    .log-ok { color: #8bc34a; }
    .log-err { color: #ff5252; }

    #imageList {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 8px;
    }
    .thumb-card {
      background:#fff;
      border-radius:8px;
      padding:6px;
      box-shadow:0 1px 2px rgba(0,0,0,0.1);
      display:flex;
      flex-direction:column;
      align-items:center;
      font-size:11px;
    }
    .thumb-card img {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius:4px;
      background:#eee;
    }
    .thumb-url {
      width:100%;
      font-size:10px;
      word-break: break-all;
      margin-top:4px;
    }
    .thumb-actions {
      margin-top:4px;
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      justify-content:center;
    }
    .prod-input {
      font-size:11px;
      padding:4px;
      max-width:160px;
    }

    .small-note {
      font-size:11px;
      color:#555;
    }
    .seg-row {
      margin-top:6px;
    }
    .seg-row label {
      font-weight:600;
    }
    #segResult {
      font-size:12px;
      margin-top:6px;
      white-space:pre-wrap;
      background:#fafafa;
      border-radius:4px;
      padding:6px;
      border:1px solid #ddd;
    }
  </style>
</head>
<body>
  <h1>えびせん管理画面（画像管理＋セグメント配信）</h1>

  <!-- 認証トークン -->
  <div class="card">
    <label>管理トークン（ADMIN_API_TOKEN または ADMIN_CODE）</label>
    <input type="text" id="token" placeholder="例: my-secret-token" />
    <div style="margin-top:4px;">
      <button class="primary" id="btnConn">接続テスト</button>
      <span id="connStatus" style="font-size:12px; margin-left:8px;"></span>
    </div>
    <div class="small-note" style="margin-top:4px;">
      URLに <code>?code=トークン</code> を付けて開くと、この入力欄に自動でセットされます。
    </div>
  </div>

  <!-- 画像アップロード -->
  <div class="card">
    <h2 style="font-size:16px; margin:0 0 8px;">画像アップロード</h2>
    <input type="file" id="fileInput" accept="image/*" />
    <button id="btnUpload" class="primary">アップロード</button>
    <div id="uploadInfo" style="font-size:12px; margin-top:4px;"></div>
    <div class="small-note" style="margin-top:4px;">
      アップロードされた画像は <code>/public/uploads/</code> 以下に保存されます。<br>
      Flex用は正方形（800×800〜1200×1200）推奨です。
    </div>
  </div>

  <!-- 画像一覧 & 商品に紐付け -->
  <div class="card">
    <h2 style="font-size:16px; margin:0 0 8px;">画像一覧 &gt; 商品に紐付け</h2>
    <div style="margin-bottom:4px;">
      <button id="btnReloadImages">画像一覧を読み込み</button>
      <button id="btnReloadProducts">商品一覧を読み込み</button>
    </div>
    <div id="imageList"></div>
    <div class="small-note" style="margin-top:4px;">
      各サムネイルの「商品に設定」から、LINEの「直接注文」で表示される商品画像を登録できます。
    </div>
  </div>

  <!-- ★ セグメント配信 -->
  <div class="card">
    <h2 style="font-size:16px; margin:0 0 8px;">セグメント配信（テキスト）</h2>
    <div class="small-note" style="margin-bottom:6px;">
      1. 条件を選んで「プレビュー」で対象人数を確認<br>
      2. 問題なければ「この条件で配信」で実際にテキストメッセージを送信します。
    </div>

    <div class="seg-row">
      <label for="segType">対象タイプ</label>
      <select id="segType">
        <option value="activeChatters">アクティブユーザー（メッセージ送信者）</option>
        <option value="orders">注文者</option>
        <option value="survey">アンケート回答者</option>
        <option value="addresses">住所登録済みユーザー</option>
      </select>
      <div class="small-note">
        「アクティブユーザー」は最近トークしてくれた人、「注文者」は注文ログから抽出されます。
      </div>
    </div>

    <div class="seg-row">
      <label for="segDate">対象日（任意・YYYYMMDD）</label>
      <input type="text" id="segDate" placeholder="例: 20251110（空なら全期間）">
    </div>

    <div class="seg-row">
      <label for="segLimit">最大ログ件数（任意）</label>
      <input type="number" id="segLimit" placeholder="例: 50000（空ならデフォルト）">
    </div>

    <!-- orders 用 -->
    <div class="seg-row seg-for-orders">
      <label for="segProductIds">商品ID（注文者フィルタ・カンマ区切り）</label>
      <input type="text" id="segProductIds" placeholder="例: kusuke-250,nori-square-300（空なら全商品）">
      <div class="small-note">
        商品IDは <code>products.json</code> の id（例: <code>kusuke-250</code>）です。
      </div>
    </div>
    <div class="seg-row seg-for-orders">
      <label for="segMethod">受取方法（orders専用・任意）</label>
      <select id="segMethod">
        <option value="">指定なし</option>
        <option value="pickup">店頭受取</option>
        <option value="delivery">宅配</option>
      </select>
    </div>
    <div class="seg-row seg-for-orders">
      <label for="segPayment">支払い方法（orders専用・任意）</label>
      <select id="segPayment">
        <option value="">指定なし</option>
        <option value="cash">現金（店頭）</option>
        <option value="cod">代引き</option>
        <option value="bank">銀行振込</option>
      </select>
    </div>

    <!-- survey 用 -->
    <div class="seg-row seg-for-survey">
      <label for="segQ1">Q1コード（アンケート専用・カンマ区切り）</label>
      <input type="text" id="segQ1" placeholder="例: a,b（空なら指定なし）">
    </div>
    <div class="seg-row seg-for-survey">
      <label for="segQ2">Q2コード（アンケート専用）</label>
      <input type="text" id="segQ2" placeholder="例: x,y">
    </div>
    <div class="seg-row seg-for-survey">
      <label for="segQ3">Q3コード（アンケート専用）</label>
      <input type="text" id="segQ3" placeholder="例: 1,2">
    </div>

    <div class="seg-row">
      <label for="segMessage">配信メッセージ本文</label>
      <textarea id="segMessage" placeholder="例: いつもご利用ありがとうございます。久助入荷のお知らせです。"></textarea>
    </div>

    <div class="seg-row">
      <button id="btnSegPreview">プレビュー（対象人数を確認）</button>
      <button id="btnSegSend" class="primary">この条件で配信</button>
    </div>

    <div id="segResult" class="small-note"></div>
  </div>

  <!-- ログ -->
  <div class="card">
    <h2 style="font-size:16px; margin:0 0 8px;">ログ</h2>
    <pre id="log"></pre>
  </div>

  <!-- ★ JS（admin.js不要・この中で完結） -->
  <script>
    // ロード確認
    alert("管理画面スクリプトが読み込まれました");

    (function(){
      const $  = (id) => document.getElementById(id);
      const logBox = $("log");
      const connStatus = $("connStatus");

      function log(msg, cls) {
        const line = document.createElement("div");
        line.textContent = "[" + new Date().toLocaleString() + "] " + msg;
        if (cls === "ok") line.classList.add("log-ok");
        if (cls === "err") line.classList.add("log-err");
        logBox.appendChild(line);
        logBox.scrollTop = logBox.scrollHeight;
      }

      function getToken() {
        return ($("token").value || "").trim();
      }

      // 共通 API ラッパ（?code=TOKEN を自動付与）
      async function api(path, options = {}) {
        const token = getToken();
        if (!token) {
          throw new Error("管理トークンを入力してください。");
        }
        const url = "/api" + path + (path.includes("?") ? "&" : "?") + "code=" + encodeURIComponent(token);
        const opts = Object.assign({ method:"GET" }, options);
        const res  = await fetch(url, opts);
        const text = await res.text();
        let json;
        try { json = JSON.parse(text); } catch(e) { json = { raw:text }; }
        log(opts.method + " " + url + " → " + res.status, res.ok ? "ok" : "err");
        log(JSON.stringify(json, null, 2));
        if (!res.ok || json.ok === false) {
          throw new Error(json.error || ("HTTP " + res.status));
        }
        return json;
      }

      // 接続テスト
      async function testConnection() {
        try {
          connStatus.textContent = "テスト中…";
          const r = await api("/admin/connection-test");
          if (r.ok) {
            connStatus.textContent = "接続OK";
            connStatus.style.color = "#2e7d32";
          } else {
            connStatus.textContent = "エラー";
            connStatus.style.color = "#c62828";
          }
        } catch(e) {
          connStatus.textContent = "エラー";
          connStatus.style.color = "#c62828";
          log("接続テストエラー: " + e.message, "err");
        }
      }

      // 画像アップロード
      async function uploadImage() {
        const fileInput = $("fileInput");
        if (!fileInput.files || fileInput.files.length === 0) {
          alert("画像ファイルを選択してください。");
          return;
        }
        const file = fileInput.files[0];
        const token = getToken();
        if (!token) {
          alert("管理トークンを入力してください。");
          return;
        }
        const url = "/api/admin/upload-image?code=" + encodeURIComponent(token);
        const formData = new FormData();
        formData.append("image", file);
        log("アップロード開始: " + file.name + " (" + file.size + " bytes)");

        try {
          const res = await fetch(url, { method:"POST", body: formData });
          const json = await res.json().catch(() => ({}));
          log("POST " + url + " → " + res.status, res.ok ? "ok" : "err");
          log(JSON.stringify(json, null, 2));

          if (!res.ok || json.ok === false) {
            throw new Error(json.error || ("HTTP " + res.status));
          }
          $("uploadInfo").textContent = "アップロード成功: " + json.url;
          $("uploadInfo").style.color = "#2e7d32";
          await loadImages();
        } catch(e) {
          $("uploadInfo").textContent = "アップロード失敗: " + e.message;
          $("uploadInfo").style.color = "#c62828";
          log("アップロードエラー: " + e.message, "err");
        }
      }

      // 商品一覧キャッシュ
      let productsCache = [];

      async function loadProducts() {
        try {
          const r = await api("/admin/products");
          productsCache = Array.isArray(r.items) ? r.items : [];
          log("商品一覧取得: " + productsCache.length + "件", "ok");
        } catch(e) {
          log("商品一覧取得エラー: " + e.message, "err");
        }
      }

      // 画像一覧表示
      async function loadImages() {
        const list = $("imageList");
        list.innerHTML = "読み込み中…";

        try {
          const r = await api("/admin/images");
          const items = r.items || [];
          list.innerHTML = "";
          if (items.length === 0) {
            list.textContent = "画像がありません。";
            return;
          }
          items.forEach(img => {
            const card = document.createElement("div");
            card.className = "thumb-card";

            const image = document.createElement("img");
            image.src = img.url;
            image.alt = img.name;

            const urlDiv = document.createElement("div");
            urlDiv.className = "thumb-url";
            urlDiv.textContent = img.url;

            const actions = document.createElement("div");
            actions.className = "thumb-actions";

            const select = document.createElement("select");
            select.className = "prod-input";
            const opt0 = document.createElement("option");
            opt0.value = "";
            opt0.textContent = "商品を選択";
            select.appendChild(opt0);
            productsCache.forEach(p => {
              const opt = document.createElement("option");
              opt.value = p.id;
              opt.textContent = p.name + " (" + p.id + ")";
              select.appendChild(opt);
            });

            const btnSet = document.createElement("button");
            btnSet.textContent = "商品に設定";
            btnSet.className = "primary";
            btnSet.addEventListener("click", async () => {
              const pid = select.value;
              if (!pid) {
                alert("商品を選択してください。");
                return;
              }
              try {
                const body = JSON.stringify({ productId: pid, imageUrl: img.url });
                await api("/admin/products/set-image", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body
                });
                log("画像設定完了: " + pid + " ← " + img.url, "ok");
                alert("商品「" + pid + "」に画像を設定しました。");
              } catch(e) {
                log("画像設定エラー: " + e.message, "err");
                alert("画像設定に失敗しました。");
              }
            });

            const btnDel = document.createElement("button");
            btnDel.textContent = "削除";
            btnDel.className = "danger";
            btnDel.addEventListener("click", async () => {
              if (!confirm("この画像を削除しますか？\n" + img.name)) return;
              try {
                const token = getToken();
                const url = "/api/admin/images/" + encodeURIComponent(img.name) +
                            "?code=" + encodeURIComponent(token);
                const res = await fetch(url, { method:"DELETE" });
                const json = await res.json().catch(() => ({}));
                log("DELETE " + url + " → " + res.status, res.ok ? "ok" : "err");
                log(JSON.stringify(json, null, 2));
                if (!res.ok || json.ok === false) throw new Error(json.error || ("HTTP " + res.status));
                await loadImages();
              } catch(e) {
                log("削除エラー: " + e.message, "err");
                alert("削除に失敗しました。");
              }
            });

            actions.appendChild(select);
            actions.appendChild(btnSet);
            actions.appendChild(btnDel);

            card.appendChild(image);
            card.appendChild(urlDiv);
            card.appendChild(actions);
            list.appendChild(card);
          });
        } catch(e) {
          list.textContent = "画像一覧の取得に失敗しました。";
          log("画像一覧エラー: " + e.message, "err");
        }
      }

      // ===== セグメント配信 UI 切り替え =====
      function updateSegmentVisibility() {
        const type = $("segType").value;
        const ordersRows = document.querySelectorAll(".seg-for-orders");
        const surveyRows = document.querySelectorAll(".seg-for-survey");
        ordersRows.forEach(el => { el.style.display = (type === "orders") ? "block" : "none"; });
        surveyRows.forEach(el => { el.style.display = (type === "survey") ? "block" : "none"; });
      }

      // 最後にプレビューした userIds を保持
      let lastSegmentUserIds = [];

      // セグメントプレビュー
      async function segmentPreview() {
        const type = $("segType").value;
        const msg  = ($("segMessage").value || "").trim();
        const payload = { type: type };

        const date = ($("segDate").value || "").trim();
        if (date) payload.date = date;

        const limitVal = parseInt(($("segLimit").value || "").trim(), 10);
        if (!isNaN(limitVal) && limitVal > 0) {
          payload.limit = limitVal;
        }

        if (type === "orders") {
          const pids = ($("segProductIds").value || "").trim();
          if (pids) {
            payload.productIds = pids.split(",").map(s => s.trim()).filter(Boolean);
          }
          const method = $("segMethod").value;
          const payment = $("segPayment").value;
          if (method)  payload.method  = method;
          if (payment) payload.payment = payment;
        }

        if (type === "survey") {
          const q1 = ($("segQ1").value || "").trim();
          const q2 = ($("segQ2").value || "").trim();
          const q3 = ($("segQ3").value || "").trim();
          if (q1) payload.q1codes = q1.split(",").map(s => s.trim()).filter(Boolean);
          if (q2) payload.q2codes = q2.split(",").map(s => s.trim()).filter(Boolean);
          if (q3) payload.q3codes = q3.split(",").map(s => s.trim()).filter(Boolean);
        }

        $("segResult").textContent = "プレビュー中…";

        try {
          const r = await api("/admin/segment/preview", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          lastSegmentUserIds = Array.isArray(r.userIds) ? r.userIds : [];
          let text = "";
          text += "タイプ: " + (r.type || type) + "\n";
          text += "対象ユーザー数: " + (r.total != null ? r.total : lastSegmentUserIds.length) + "人\n";
          if (msg) {
            text += "\n※ このメッセージを送信予定:\n" + msg + "\n";
          }
          const previewList = lastSegmentUserIds.slice(0, 20);
          if (previewList.length > 0) {
            text += "\nサンプル userId (最大20件):\n" + previewList.join("\n");
            if (lastSegmentUserIds.length > 20) {
              text += "\n…他 " + (lastSegmentUserIds.length - 20) + " 件";
            }
          }
          $("segResult").textContent = text;
        } catch(e) {
          $("segResult").textContent = "プレビューエラー: " + e.message;
          log("セグメントプレビューエラー: " + e.message, "err");
        }
      }

      // セグメント送信
      async function segmentSend() {
        const msg = ($("segMessage").value || "").trim();
        if (!msg) {
          alert("配信メッセージ本文を入力してください。");
          return;
        }
        if (!lastSegmentUserIds || lastSegmentUserIds.length === 0) {
          const ok = confirm("プレビューで対象を確認していません。\nそのまま配信しますか？");
          if (!ok) return;
        }
        const userIds = lastSegmentUserIds && lastSegmentUserIds.length > 0
          ? lastSegmentUserIds
          : null;

        let sendPayload;
        if (userIds) {
          sendPayload = { userIds: userIds, message: msg };
        } else {
          alert("先にプレビューで対象を確認してください。");
          return;
        }

        const ok2 = confirm("この条件で " + userIds.length + " 人にメッセージを送信しますか？");
        if (!ok2) return;

        $("segResult").textContent += "\n\n配信中…";

        try {
          const r = await api("/admin/segment/send", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(sendPayload)
          });
          let text = "配信結果:\n";
          text += "リクエスト人数: " + (r.requested != null ? r.requested : userIds.length) + "\n";
          text += "送信成功: " + (r.sent != null ? r.sent : "?") + "\n";
          text += "送信失敗: " + (r.failed != null ? r.failed : 0) + "\n";
          $("segResult").textContent += "\n" + text;
        } catch(e) {
          $("segResult").textContent += "\n配信エラー: " + e.message;
          log("セグメント配信エラー: " + e.message, "err");
        }
      }

      // 初期化
      window.addEventListener("load", () => {
        $("btnConn").addEventListener("click", testConnection);
        $("btnUpload").addEventListener("click", uploadImage);
        $("btnReloadImages").addEventListener("click", loadImages);
        $("btnReloadProducts").addEventListener("click", loadProducts);

        $("segType").addEventListener("change", updateSegmentVisibility);
        $("btnSegPreview").addEventListener("click", segmentPreview);
        $("btnSegSend").addEventListener("click", segmentSend);

        const params = new URLSearchParams(location.search);
        const qCode = params.get("code");
        if (qCode) {
          $("token").value = qCode;
          log("URLのcodeクエリをトークンにセットしました。");
        }

        updateSegmentVisibility();
        loadProducts().catch(()=>{});
      });
    })();
  </script>
</body>
</html>
