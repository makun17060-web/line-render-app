<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>管理画面（画像アップロード＆商品紐付け）</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 12px;
      background: #f5f5f5;
    }
    h1 {
      font-size: 20px;
      margin: 0 0 8px;
    }
    .section {
      background: #fff;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .row {
      margin-bottom: 8px;
    }
    button {
      padding: 6px 10px;
      margin-right: 4px;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: #fff;
      cursor: pointer;
    }
    button.primary {
      background: #1976d2;
      color: #fff;
      border-color: #1976d2;
    }
    button.danger {
      background: #d32f2f;
      color: #fff;
      border-color: #d32f2f;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    #status {
      font-size: 13px;
      color: #333;
    }
    #status.ok { color: #2e7d32; }
    #status.err { color: #d32f2f; }

    #imageList {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 8px;
      margin-top: 8px;
    }
    .thumb {
      background: #fafafa;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 4px;
      text-align: center;
      font-size: 11px;
    }
    .thumb img {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 4px;
      margin-bottom: 4px;
    }
    .thumb .name {
      word-break: break-all;
      margin-bottom: 4px;
    }
    .thumb button {
      width: 100%;
      font-size: 11px;
      padding: 4px;
    }

    #productSelect {
      min-width: 200px;
    }
    #productInfo {
      font-size: 12px;
      color: #555;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <h1>管理画面（画像アップロード & 商品サムネ設定）</h1>

  <div class="section">
    <div class="row">
      <div><strong>トークン状態：</strong> <span id="tokenStatus">確認中...</span></div>
      <div id="status"></div>
    </div>
    <div class="row">
      <button id="btnPing" class="primary">接続テスト</button>
    </div>
  </div>

  <div class="section">
    <h2 style="font-size:16px;margin-top:0;">① 商品を選択</h2>
    <div class="row">
      <button id="btnReloadProducts">商品一覧を読み込み</button>
    </div>
    <div class="row">
      <select id="productSelect">
        <option value="">（未選択）</option>
      </select>
    </div>
    <div id="productInfo"></div>
  </div>

  <div class="section">
    <h2 style="font-size:16px;margin-top:0;">② 画像をアップロード</h2>
    <div class="row">
      <input type="file" id="fileInput" accept="image/*" />
      <button id="btnUpload" class="primary">アップロード</button>
    </div>
    <div class="row" style="font-size:12px;color:#555;">
      アップロードされた画像は <code>/public/uploads/ファイル名</code> に保存されます。<br>
      Flex用のURLは <code>https://あなたのドメイン/public/uploads/ファイル名</code> になります。
    </div>
  </div>

  <div class="section">
    <h2 style="font-size:16px;margin-top:0;">③ アップロード済み画像一覧</h2>
    <div class="row">
      <button id="btnReloadImages">画像一覧を読み込み</button>
    </div>
    <div id="imageList"></div>
  </div>

  <script>
    // ====== トークン取得 ======
    const url = new URL(location.href);
    const ADMIN_TOKEN =
      url.searchParams.get("code") ||
      url.searchParams.get("token") ||
      "";

    const tokenStatusEl = document.getElementById("tokenStatus");
    if (!ADMIN_TOKEN) {
      tokenStatusEl.textContent = "URLに ?code=トークン が付いていません。";
      tokenStatusEl.style.color = "#d32f2f";
    } else {
      tokenStatusEl.textContent = "OK (URLから取得済み)";
      tokenStatusEl.style.color = "#2e7d32";
    }

    const statusEl = document.getElementById("status");

    function setStatus(msg, cls = "") {
      statusEl.textContent = msg;
      statusEl.className = cls;
      console.log("STATUS:", msg);
    }

    // ====== 共通 fetch（JSON 用） ======
    async function apiFetch(path, options = {}) {
      const base = location.origin;
      const u = new URL(path, base);

      // クエリに code が無ければ、自動で追加（サーバ側の ?code= 対応用）
      if (ADMIN_TOKEN && !u.searchParams.get("code")) {
        u.searchParams.set("code", ADMIN_TOKEN);
      }

      const headers = Object.assign(
        {},
        options.headers || {},
        ADMIN_TOKEN ? { Authorization: "Bearer " + ADMIN_TOKEN } : {}
      );

      const opt = Object.assign({}, options, { headers });

      const res = await fetch(u.toString(), opt);
      if (!res.ok) {
        const text = await res.text().catch(() => "");
        throw new Error("HTTP " + res.status + " " + text);
      }
      return res.json();
    }

    // ====== 共通 fetch（フォーム/ファイルアップロード用） ======
    async function apiFetchForm(path, formData) {
      const base = location.origin;
      const u = new URL(path, base);
      if (ADMIN_TOKEN && !u.searchParams.get("code")) {
        u.searchParams.set("code", ADMIN_TOKEN);
      }
      const headers = {};
      if (ADMIN_TOKEN) headers["Authorization"] = "Bearer " + ADMIN_TOKEN;
      const res = await fetch(u.toString(), {
        method: "POST",
        headers,
        body: formData
      });
      if (!res.ok) {
        const text = await res.text().catch(() => "");
        throw new Error("HTTP " + res.status + " " + text);
      }
      return res.json();
    }

    // ====== 接続テスト ======
    document.getElementById("btnPing").addEventListener("click", async () => {
      try {
        setStatus("接続テスト中...", "");
        const json = await apiFetch("/api/admin/connection-test");
        console.log("PING:", json);
        setStatus("接続OK: " + JSON.stringify(json), "ok");
        alert("接続テスト成功しました。");
      } catch (e) {
        console.error(e);
        setStatus("接続エラー: " + e.message, "err");
        alert("接続テストに失敗しました。\n" + e.message);
      }
    });

    // ====== 商品一覧読み込み ======
    const productSelect = document.getElementById("productSelect");
    const productInfo = document.getElementById("productInfo");
    let productMap = {};

    async function loadProducts() {
      try {
        setStatus("商品一覧取得中...", "");
        const json = await apiFetch("/api/admin/products");
        if (!json.ok) throw new Error(json.error || "products_error");

        productMap = {};
        productSelect.innerHTML = '<option value="">（未選択）</option>';

        json.items.forEach(p => {
          productMap[p.id] = p;
          const opt = document.createElement("option");
          opt.value = p.id;
          opt.textContent = `${p.name}（${p.id}）`;
          productSelect.appendChild(opt);
        });

        setStatus("商品一覧を読み込みました。", "ok");
      } catch (e) {
        console.error(e);
        setStatus("商品一覧取得エラー: " + e.message, "err");
      }
    }

    document.getElementById("btnReloadProducts").addEventListener("click", loadProducts);

    productSelect.addEventListener("change", () => {
      const pid = productSelect.value;
      if (!pid || !productMap[pid]) {
        productInfo.textContent = "";
        return;
      }
      const p = productMap[pid];
      let txt = `ID: ${p.id}\n名前: ${p.name}\n価格: ${p.price}円\n在庫: ${p.stock}個`;
      if (p.image) {
        txt += `\n画像URL: ${p.image}`;
      }
      productInfo.textContent = txt;
    });

    // ====== 画像一覧読み込み ======
    const imageList = document.getElementById("imageList");

    async function loadImages() {
      try {
        setStatus("画像一覧取得中...", "");
        const json = await apiFetch("/api/admin/images");
        if (!json.ok) throw new Error(json.error || "images_error");

        imageList.innerHTML = "";
        if (!json.items || json.items.length === 0) {
          imageList.textContent = "画像がありません。アップロードしてください。";
          setStatus("画像0件", "");
          return;
        }

        json.items.forEach(item => {
          const div = document.createElement("div");
          div.className = "thumb";

          const img = document.createElement("img");
          // 管理画面用は相対URLでOK
          img.src = item.url;
          img.alt = item.name;

          const nameDiv = document.createElement("div");
          nameDiv.className = "name";
          nameDiv.textContent = item.name;

          const btn = document.createElement("button");
          btn.textContent = "この画像を商品に設定";
          btn.addEventListener("click", () => {
            const pid = productSelect.value;
            if (!pid) {
              alert("先に上のセレクトボックスで商品を選択してください。");
              return;
            }
            const absUrl = location.origin + item.url; // ← ここが Flex用の完全URLになる
            linkImageToProduct(pid, absUrl);
          });

          div.appendChild(img);
          div.appendChild(nameDiv);
          div.appendChild(btn);
          imageList.appendChild(div);
        });

        setStatus("画像一覧を読み込みました。", "ok");
      } catch (e) {
        console.error(e);
        setStatus("画像一覧取得エラー: " + e.message, "err");
      }
    }

    document.getElementById("btnReloadImages").addEventListener("click", loadImages);

    // ====== 画像アップロード ======
    document.getElementById("btnUpload").addEventListener("click", async () => {
      const fileInput = document.getElementById("fileInput");
      const file = fileInput.files[0];
      if (!file) {
        alert("アップロードする画像ファイルを選択してください。");
        return;
      }
      try {
        setStatus("アップロード中...", "");
        const fd = new FormData();
        fd.append("image", file);
        const json = await apiFetchForm("/api/admin/upload-image", fd);
        console.log("UPLOAD:", json);
        if (!json.ok) throw new Error(json.error || "upload_error");
        setStatus("アップロード完了: " + json.file, "ok");
        alert("アップロードしました: " + json.url);
        fileInput.value = "";
        await loadImages();
      } catch (e) {
        console.error(e);
        setStatus("アップロードエラー: " + e.message, "err");
        alert("アップロードに失敗しました。\n" + e.message);
      }
    });

    // ====== 商品に画像URLを紐付け ======
    async function linkImageToProduct(productId, imageUrl) {
      try {
        setStatus("商品に画像を紐付け中...", "");
        const json = await apiFetch("/api/admin/products/set-image", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ productId, imageUrl })
        });
        console.log("SET-IMAGE:", json);
        if (!json.ok) throw new Error(json.error || "set_image_error");
        setStatus("画像を商品に紐付けました。", "ok");
        alert("画像URLを商品に設定しました。");
        await loadProducts(); // 情報更新
      } catch (e) {
        console.error(e);
        setStatus("紐付けエラー: " + e.message, "err");
        alert("画像紐付けに失敗しました。\n" + e.message);
      }
    }

    // ====== ページロード時の初期動作 ======
    window.addEventListener("load", () => {
      // 自動ではテストしない。まず商品一覧だけ読み込む。
      loadProducts().catch(console.error);
      loadImages().catch(console.error);
    });
  </script>
</body>
</html>
