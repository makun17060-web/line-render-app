<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>店舗受取（現金）｜商品一覧</title>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root{
      --bg:#f6f7f9; --card:#fff; --text:#111827; --muted:#6b7280;
      --line:#e5e7eb; --pri:#0a7b19; --danger:#b91c1c;
      --shadow:0 1px 3px rgba(0,0,0,.06); --radius:14px;
      --barH:120px;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:system-ui,-apple-system,"Segoe UI",sans-serif; background:var(--bg); color:var(--text); }

    .wrap{
      max-width:1040px; margin:0 auto;
      padding:14px 14px calc(var(--barH) + env(safe-area-inset-bottom) + 18px);
    }

    h1{ margin:0 0 6px; font-size:18px; }
    .muted{ color:var(--muted); font-size:13px; line-height:1.5; }
    .badge{
      font-size:12px; border:1px solid #bbf7d0; background:#f0fdf4;
      color:#166534; border-radius:999px; padding:2px 10px; font-weight:900;
      margin-left:8px;
    }

    .grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:12px; margin-top:12px; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); overflow:hidden; box-shadow:var(--shadow); }

    .imgbox{ height:200px; background:#fff; display:flex; align-items:center; justify-content:center; }
    .imgbox img{ max-width:100%; max-height:100%; object-fit:contain; display:block; }

    .body{ padding:12px; }
    .name{ font-weight:900; font-size:15px; }
    .desc{ margin-top:6px; color:var(--muted); font-size:12px; min-height:34px; }
    .row{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top:8px; }
    .price{ font-weight:900; color:var(--pri); }
    .badge2{ font-size:12px; border:1px solid var(--line); background:#fafafa; border-radius:999px; padding:2px 8px; }

    .controls{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top:10px; }
    .qty{ display:flex; align-items:center; gap:6px; }
    .qty button{
      width:34px; height:34px; border-radius:10px; border:1px solid var(--line);
      background:#fff; font-size:18px; cursor:pointer;
    }
    .qty input{
      width:56px; height:34px; border-radius:10px; border:1px solid var(--line);
      text-align:center; font-size:15px;
    }
    .btn{ border:none; border-radius:12px; padding:10px 12px; font-weight:900; cursor:pointer; }
    .btnAdd{ background:var(--pri); color:#fff; }
    .btnAdd:disabled{ opacity:.55; cursor:not-allowed; }

    /* bottom bar */
    .bar{
      position:fixed; left:0; right:0; bottom:0;
      border-top:1px solid var(--line);
      background:rgba(246,247,249,.92);
      backdrop-filter:blur(10px);
      padding:10px 12px;
      padding-bottom: calc(10px + env(safe-area-inset-bottom));
    }
    .bar .inner{
      max-width:1040px; margin:0 auto;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .bar .right{ display:flex; gap:8px; flex-wrap:wrap; }
    .btnClear{
      background:#fff; border:1px solid #fecaca; color:var(--danger);
      padding:12px 14px; border-radius:14px;
    }
    .btnNext{
      background:var(--pri); color:#fff;
      padding:12px 14px; border-radius:14px; min-width:260px;
    }
    .btnDisabled{ opacity:.55; pointer-events:none; }
    .danger{ color:var(--danger); font-weight:900; }
  </style>
</head>

<body>
<div class="wrap">
  <h1>商品一覧 <span class="badge">店舗受取（現金）</span></h1>
  <div class="muted" id="status">読み込み中…</div>
  <div class="grid" id="grid"></div>
</div>

<div class="bar">
  <div class="inner">
    <div class="muted" id="sum">カート：0点 / 小計 0円</div>
    <div class="right">
      <button class="btn btnClear" id="clearBtn">空にする</button>
      <button class="btn btnNext btnDisabled" id="nextBtn">注文内容確認へ</button>
    </div>
  </div>
</div>

<script>
(async function(){
  "use strict";

  const LIFF_ID_STORE = "2008406620-7tSkOcqd";
  const API_PRODUCTS = "/api/products";
  const CONFIRM_URL = "/public/store-confirm.html";

  const KEY_CART = "isoya_store_cart";
  const yen = n => (Number(n)||0).toLocaleString("ja-JP") + "円";
// ✅ 店頭価格上書き（久助だけ）
function storePrice(p){
  const id = String(p?.id || "");

  // 久助のIDに合わせてここを1行だけ調整
  if (id === "kusuke-250") return 250;
  // 例）IDが kusuke-340 の場合は ↓
  // if (id === "kusuke-340") return 250;

  return Number(p.price) || 0;
}

  // ✅ 画像URLを「products 側と同じように」幅広く許可しつつ、Disk側に寄せる
  function diskImageUrl(image){
    const v = String(image||"").trim();
    if(!v) return "";

    // /public/uploads/xxx
    if(v.startsWith("/public/uploads/")) return v;

    // /uploads/xxx -> /public/uploads/xxx
    if(v.startsWith("/uploads/")) return "/public" + v;

    // public/uploads/xxx
    if(v.startsWith("public/uploads/")) return "/" + v;

    // uploads/xxx
    if(v.startsWith("uploads/")) return "/public/" + v;

    // ファイル名だけ
    if(!v.includes("/")) return "/public/uploads/" + v;

    // 絶対URLも許可（pathnameを正規化）
    if(/^https?:\/\//i.test(v)){
      try{
        const u = new URL(v);

        if(u.pathname.startsWith("/public/uploads/")) return u.pathname;
        if(u.pathname.startsWith("/uploads/")) return "/public" + u.pathname;

        const m1 = u.pathname.match(/\/public\/uploads\/.+$/);
        if(m1) return m1[0];

        const m2 = u.pathname.match(/\/uploads\/.+$/);
        if(m2) return "/public" + m2[0];

        // 最後の手段：同一オリジンならそのまま使う（products側がこれで出てる場合がある）
        if(u.origin === location.origin) return u.href;

      }catch{}
    }

    // それ以外は、そのまま使う（productsで出てるなら出る可能性がある）
    return v;
  }

  function loadCart(){
    try{ return JSON.parse(localStorage.getItem(KEY_CART)) || { items:[] }; }
    catch{ return { items:[] }; }
  }
  function saveCart(c){ localStorage.setItem(KEY_CART, JSON.stringify(c)); }

  function syncBarHeight(){
    const h = document.querySelector(".bar")?.getBoundingClientRect().height || 0;
    if(h) document.documentElement.style.setProperty("--barH", Math.ceil(h)+"px");
  }

  let cart = loadCart();
  let products = [];

  const grid = document.getElementById("grid");
  const statusEl = document.getElementById("status");
  const sumEl = document.getElementById("sum");
  const clearBtn = document.getElementById("clearBtn");
  const nextBtn = document.getElementById("nextBtn");

  function renderSum(){
    let count=0, total=0;
    const map = Object.fromEntries(products.map(p=>[p.id,p]));
    for(const it of cart.items||[]){
      const p = map[it.id];
      if(!p) continue;
      count += it.qty;
      total += storePrice(p) * it.qty;

    }
    sumEl.textContent = `カート：${count}点 / 小計 ${yen(total)}`;
    nextBtn.classList.toggle("btnDisabled", count===0);
    syncBarHeight();
  }

  function addToCart(p, q){
    const ex = cart.items.find(x=>x.id===p.id);
    if(ex) ex.qty += q;
    else cart.items.push({ id:p.id, qty:q });
    saveCart(cart);
    renderSum();
  }

  function card(p){
    const el = document.createElement("div");
    el.className = "card";
    const img = diskImageUrl(p.image);
    const stock = Number(p.stock||0);

    el.innerHTML = `
      <div class="imgbox">${img?`<img src="${img}" alt="">`:""}</div>
      <div class="body">
        <div class="name">${p.name}</div>
        <div class="desc">${p.desc||""}</div>
        <div class="row">
<div class="price">${yen(storePrice(p))}</div>

          <span class="badge2">${p.volume||`在庫 ${stock}`}</span>
        </div>
        <div class="controls">
          <div class="qty">
            <button class="dec">−</button>
            <input class="q" type="number" value="1" min="1" inputmode="numeric">
            <button class="inc">＋</button>
          </div>
          <button class="btn btnAdd add">カートに追加</button>
        </div>
      </div>
    `;

    // ✅ 画像が404等なら、その画像だけ消して空白にする（レイアウト崩れ防止）
    const im = el.querySelector("img");
    if(im){
      im.addEventListener("error", ()=> im.remove());
    }

    const q = el.querySelector(".q");
    el.querySelector(".dec").onclick = ()=> q.value = String(Math.max(1, Math.floor(Number(q.value||1))-1));
    el.querySelector(".inc").onclick = ()=> q.value = String(Math.max(1, Math.floor(Number(q.value||1))+1));
    q.onchange = ()=> q.value = String(Math.max(1, Math.floor(Number(q.value||1))));

    const add = el.querySelector(".add");
    if(stock<=0){ add.disabled=true; add.textContent="在庫なし"; }
    add.onclick = ()=>{
      const addQty = Math.max(1, Math.floor(Number(q.value||1)));
      addToCart(p, addQty);
    };

    return el;
  }

  clearBtn.onclick = ()=>{
    if(!confirm("カートを空にしますか？")) return;
    cart = { items:[] };
    saveCart(cart);
    renderSum();
  };

  nextBtn.onclick = ()=>{
    if(nextBtn.classList.contains("btnDisabled")) return;
    location.href = CONFIRM_URL;
  };

  try{
    await liff.init({ liffId: LIFF_ID_STORE });
    if(!liff.isLoggedIn()){
      liff.login({ redirectUri: location.href });
      return;
    }
  }catch(e){
    statusEl.innerHTML='<span class="danger">LIFF初期化に失敗しました</span>';
    return;
  }

  // 初回計測
  syncBarHeight();
  window.addEventListener("resize", syncBarHeight);

  try{
    const r = await fetch(API_PRODUCTS,{ cache:"no-store" });
    const j = await r.json();
    const raw = Array.isArray(j) ? j : (j.products||[]);
    products = raw.map(p=>({
      id:String(p.id),
      name:String(p.name),
      price:Number(p.price),
      stock:Number(p.stock||0),
      volume:p.volume||"",
      desc:p.desc||"",
      image:p.image||""
    }));

    grid.innerHTML="";
    products.forEach(p=>grid.appendChild(card(p)));

    statusEl.textContent="";
    renderSum();
    syncBarHeight();
  }catch(e){
    statusEl.innerHTML='<span class="danger">商品取得に失敗しました</span>';
  }

})();
</script>
</body>
</html>
