<!-- public/shipping-calc.html  修正版“丸ごと版”
  ✅ 送料はDB（shipping_yamato_taxed）を必ず使う：strict:true を送る
  ✅ DBに該当送料が無い場合はエラー表示（SHIPPING_NOT_FOUND_IN_DB）
  ✅ API仕様（あなたの server.js）:
      POST /api/shipping/quote
      body: { pref, items:[{product_id, qty}], strict:true }
      res : { ok:true, region, size, shipping_fee, subtotal, total } など
-->
<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>送料・総額の目安（DB送料）</title>

<style>
  :root{
    --bg:#f7f7f7; --card:#fff; --text:#111827; --muted:#6b7280;
    --line:#e5e7eb; --pri:#0b3a53; --danger:#b91c1c;
    --radius:14px; --shadow:0 1px 3px rgba(0,0,0,.08);
  }
  *{ box-sizing:border-box; }
  body{
    margin:0; padding:16px;
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    background:var(--bg); color:var(--text);
  }
  .wrap{ max-width:760px; margin:0 auto; }
  h1{ font-size:20px; margin:0 0 8px; }
  .lead{ font-size:13px; color:var(--muted); line-height:1.6; margin:0 0 12px; }
  .card{
    background:var(--card); border:1px solid var(--line);
    border-radius:var(--radius); padding:14px; margin-bottom:12px;
    box-shadow:var(--shadow);
  }
  label{ font-size:13px; font-weight:900; display:block; margin:10px 0 6px; }
  select,input{
    width:100%; padding:11px 12px; font-size:15px;
    border-radius:12px; border:1px solid #d1d5db; outline:none;
    background:#fff;
  }
  select:focus,input:focus{ border-color:#9ca3af; box-shadow:0 0 0 3px rgba(156,163,175,.15); }
  .row{ display:flex; gap:10px; flex-wrap:wrap; }
  .col{ flex:1; min-width:220px; }
  button{
    width:100%;
    padding:13px 12px; font-size:16px; border-radius:14px;
    border:0; background:var(--pri); color:#fff; font-weight:900;
    cursor:pointer;
    box-shadow:0 6px 18px rgba(11,58,83,.18);
  }
  button:active{ transform:translateY(1px); box-shadow:0 3px 12px rgba(11,58,83,.16); }
  button:disabled{ opacity:.55; cursor:not-allowed; box-shadow:none; transform:none; }
  .result{ font-size:15px; line-height:1.8; }
  .big{ font-size:18px; font-weight:1000; }
  .hr{ height:1px; background:#eee; margin:10px 0; }
  .muted{ font-size:12px; color:var(--muted); }
  .err{ color:var(--danger); font-weight:900; }
  .okBadge{
    display:inline-block; padding:3px 10px; border-radius:999px;
    border:1px solid var(--line); background:#fafafa; font-size:12px; font-weight:900;
    color:#374151;
  }
  .foot{ font-size:12px; color:var(--muted); line-height:1.6; }
</style>
</head>

<body>
<div class="wrap">

  <h1>送料・総額の目安</h1>
  <p class="lead">
    送料は <strong>DB（shipping_yamato_taxed）</strong> から取得して計算します。<br>
    ※DBに該当が無い場合はエラー表示になります（フォールバックしません）。
  </p>

  <!-- お届け先 -->
  <div class="card">
    <label>お届け先（都道府県）</label>
    <select id="pref">
      <option value="">選択してください</option>
      <option>北海道</option><option>青森県</option><option>岩手県</option><option>宮城県</option>
      <option>秋田県</option><option>山形県</option><option>福島県</option>
      <option>茨城県</option><option>栃木県</option><option>群馬県</option><option>埼玉県</option>
      <option>千葉県</option><option>東京都</option><option>神奈川県</option>
      <option>新潟県</option><option>富山県</option><option>石川県</option><option>福井県</option>
      <option>長野県</option><option>岐阜県</option><option>静岡県</option><option>愛知県</option><option>三重県</option>
      <option>滋賀県</option><option>京都府</option><option>大阪府</option>
      <option>兵庫県</option><option>奈良県</option><option>和歌山県</option>
      <option>鳥取県</option><option>島根県</option><option>岡山県</option><option>広島県</option><option>山口県</option>
      <option>徳島県</option><option>香川県</option><option>愛媛県</option><option>高知県</option>
      <option>福岡県</option><option>佐賀県</option><option>長崎県</option><option>熊本県</option>
      <option>大分県</option><option>宮崎県</option><option>鹿児島県</option><option>沖縄県</option>
    </select>

    <div style="margin-top:10px">
      <span class="okBadge">DB送料モード</span>
      <span class="muted" style="margin-left:8px">strict=true（フォールバック無し）</span>
    </div>
  </div>

  <!-- 商品選択 -->
  <div class="card">
    <div class="row">
      <div class="col">
        <label>商品</label>
        <select id="productId">
          <option value="">選択してください</option>
          <option value="original-set">磯屋オリジナルセット</option>
          <option value="akasha">あかしゃシリーズ</option>
          <option value="kusuke">久助（われせん）</option>
        </select>
      </div>

      <div class="col">
        <label>数量</label>
        <input type="number" id="qty" min="1" step="1" value="1" inputmode="numeric" />
      </div>
    </div>

    <div class="foot" style="margin-top:10px">
      ※商品IDは server 側で変換されます（original-set / akasha / kusuke）。
    </div>
  </div>

  <div class="card">
    <button id="calcBtn" type="button">送料を計算する（DB）</button>
    <div class="muted" style="margin-top:8px">
      ※最終金額は注文確定時に再計算されます。
    </div>
  </div>

  <div class="card">
    <div id="result" class="result">―</div>
  </div>

</div>

<script>
(function(){
  "use strict";

  const $ = (id)=>document.getElementById(id);
  const prefEl = $("pref");
  const productEl = $("productId");
  const qtyEl = $("qty");
  const btn = $("calcBtn");
  const result = $("result");

  const yen = (n)=> (Number(n)||0).toLocaleString("ja-JP") + "円";

  function setBusy(b){
    btn.disabled = b;
    btn.textContent = b ? "計算中…" : "送料を計算する（DB）";
  }

  function showErr(msg){
    result.innerHTML = `<span class="err">${escapeHtml(msg || "送料を取得できませんでした。")}</span>`;
  }

  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  async function calc(){
    const pref = String(prefEl.value || "").trim();
    const productId = String(productEl.value || "").trim();
    const qty = Math.max(1, Math.floor(Number(qtyEl.value || 1)));

    qtyEl.value = String(qty);

    if(!pref || !productId){
      showErr("都道府県・商品・数量を正しく選択してください。");
      return;
    }

    // APIに渡す product_id（server側で最終IDへ変換される想定）
    const apiProductId = (productId === "kusuke") ? "kusuke" : productId;

    const items = [{ product_id: apiProductId, qty }];

    setBusy(true);
    result.textContent = "計算中…";

    try{
      const res = await fetch("/api/shipping/quote", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          pref,
          items,
          strict: true   // ✅ DB必須（フォールバック禁止）
        })
      });

      const d = await res.json().catch(()=> ({}));

      if(!res.ok || !d.ok){
        // DBに該当が無い場合など
        const msg =
          d?.error === "SHIPPING_NOT_FOUND_IN_DB"
            ? `DBに送料が見つかりません（region=${d.region || "?"}, size=${d.size || "?"}）`
            : (d?.error || `HTTP ${res.status}`);
        showErr(msg);
        return;
      }

      // 期待：{ ok:true, region, size, shipping_fee, subtotal, total }
      const region = d.region ?? "";
      const size = d.size ?? "";
      const shippingFee = Number(d.shipping_fee ?? d.shippingFee ?? 0);
      const subtotal = Number(d.subtotal ?? 0);
      const total = Number(d.total ?? (subtotal + shippingFee));

      result.innerHTML =
        `お届け先：<b>${escapeHtml(region)}</b><br>` +
        `サイズ：<b>${escapeHtml(size)}</b><br>` +
        `<div class="hr"></div>` +
        `小計：<b>${yen(subtotal)}</b><br>` +
        `送料（DB）：<b>${yen(shippingFee)}</b><br>` +
        `<div class="big">総額の目安：${yen(total)}</div>` +
        `<div class="muted">※DB（shipping_yamato_taxed）から取得</div>`;
    }catch(e){
      showErr("送料を取得できませんでした。サーバ/APIを確認してください。");
    }finally{
      setBusy(false);
    }
  }

  btn.addEventListener("click", calc);
})();
</script>

</body>
</html>
