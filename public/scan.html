<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ç™ºé€é€šçŸ¥ï¼ˆè²¼ã‚Šä»˜ã‘å°‚ç”¨ï¼‰</title>
  <style>
    :root { --bg:#0b0f14; --card:#121a23; --text:#eaf2ff; --muted:#9fb0c3; --ok:#45d483; --ng:#ff5d5d; --bd:#243244; }
    body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; background:var(--bg); color:var(--text); }
    .wrap { max-width:720px; margin:0 auto; padding:16px 14px 40px; }
    .card { background:var(--card); border:1px solid var(--bd); border-radius:16px; padding:14px; box-shadow: 0 8px 24px rgba(0,0,0,.35); }
    h1 { margin:6px 0 8px; font-size:18px; letter-spacing:.02em; }
    .hint { color:var(--muted); font-size:13px; line-height:1.5; margin:0 0 12px; }
    label { display:block; font-size:13px; color:var(--muted); margin:10px 0 6px; }
    input, button { width:100%; box-sizing:border-box; border-radius:14px; border:1px solid var(--bd); background:#0e1520; color:var(--text); padding:14px 12px; font-size:18px; outline:none; }
    input:focus { border-color:#3d5a7a; }
    .row { display:flex; gap:10px; }
    .row > * { flex:1; }
    button { background:#1b2a3a; cursor:pointer; font-weight:700; }
    button:active { transform: translateY(1px); }
    .btn-ok { background:#173225; border-color:#1f5a3a; }
    .btn-ng { background:#3a1b1b; border-color:#6a2b2b; }
    .small { font-size:12px; padding:10px 10px; border-radius:12px; }
    .log { margin-top:12px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; white-space:pre-wrap; background:#0a1018; border:1px solid var(--bd); border-radius:14px; padding:12px; color:#d7e6ff; min-height:84px; }
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; border:1px solid var(--bd); color:var(--muted); margin-left:6px; }
    .status-ok { color:var(--ok); border-color:rgba(69,212,131,.35); }
    .status-ng { color:var(--ng); border-color:rgba(255,93,93,.35); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ç™ºé€é€šçŸ¥ï¼ˆè²¼ã‚Šä»˜ã‘å°‚ç”¨ï¼‰ <span id="status" class="pill">å¾…æ©Ÿ</span></h1>
      <p class="hint">
        ãƒ»è¿½è·¡ç•ªå·ã‚’è²¼ã‚Šä»˜ã‘ãŸç¬é–“ã«é€ä¿¡ã—ã¾ã™ï¼ˆEnterã§ã‚‚OKï¼‰<br>
        ãƒ»æ•°å­—ä»¥å¤–ã¯è‡ªå‹•ã§æ¶ˆã—ã¾ã™<br>
        ãƒ»<b>8æ¡ã¯ãƒ¤ãƒãƒˆä¼ç¥¨ç•ªå·ã§ã¯ãªã„äº‹ãŒå¤šã„</b>ã®ã§å¼¾ãã¾ã™ï¼ˆ8ã€œ16æ¡ã®ç¯„å›²ãƒã‚§ãƒƒã‚¯ï¼‰
      </p>

      <label>Admin Tokenï¼ˆX-Admin-Tokenï¼‰</label>
      <input id="token" type="password" autocomplete="off" placeholder="ADMIN_API_TOKEN / ADMIN_CODE" />

      <label>è¿½è·¡ç•ªå·ï¼ˆè²¼ã‚Šä»˜ã‘ï¼‰</label>
      <input id="code" inputmode="numeric" autocomplete="off" placeholder="ã“ã“ã«è²¼ã‚Šä»˜ã‘ï¼ˆä¾‹: 12æ¡ï¼‰" />

      <div class="row" style="margin-top:10px">
        <button id="send" class="btn-ok">é€ä¿¡ï¼ˆEnterï¼‰</button>
        <button id="clear" class="small">ã‚¯ãƒªã‚¢</button>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="paste" class="small">ğŸ“‹ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰è²¼ã‚Šä»˜ã‘</button>
        <button id="ping" class="small">/api/ping</button>
      </div>

      <div id="log" class="log">ready</div>
    </div>
  </div>

<script>
(() => {
  const API = '/api/admin/ship/scan-and-notify';

  const $ = (id) => document.getElementById(id);
  const elToken = $('token');
  const elCode  = $('code');
  const elSend  = $('send');
  const elClear = $('clear');
  const elPaste = $('paste');
  const elPing  = $('ping');
  const elLog   = $('log');
  const elStatus= $('status');

  let busy = false;
  let lastSent = '';

  const setStatus = (text, ok=null) => {
    elStatus.textContent = text;
    elStatus.classList.remove('status-ok','status-ng');
    if (ok === true) elStatus.classList.add('status-ok');
    if (ok === false) elStatus.classList.add('status-ng');
  };
  const log = (s) => { elLog.textContent = String(s); };

  const normDigits = (s) => String(s || '').replace(/\s+/g,'').replace(/\D/g,'');

  async function postTracking(tracking) {
    const token = String(elToken.value || '').trim();
    if (!token) {
      setStatus('tokenæœªå…¥åŠ›', false);
      log('X-Admin-Token ã‚’å…¥ã‚Œã¦ãã ã•ã„');
      return;
    }

    const tracking_no = normDigits(tracking);
    if (!tracking_no) {
      setStatus('ç•ªå·ãªã—', false);
      log('è¿½è·¡ç•ªå·ãŒç©ºã§ã™');
      return;
    }

    // ã‚µãƒ¼ãƒå´ã¯ 8ã€œ16 æ¡è¨±å¯ã ãŒã€8æ¡ãŒèª¤èª­ã®æ¸©åºŠãªã‚‰ã“ã“ã§å¼·ã‚ã«å¼¾ãã®ã‚‚ã‚¢ãƒª
    // ã„ã£ãŸã‚“ã‚µãƒ¼ãƒä»•æ§˜ã«åˆã‚ã›ã¦ 8ã€œ16 æ¡
    if (!/^\d{8,16}$/.test(tracking_no)) {
      setStatus('æ¡æ•°NG', false);
      log(`æ¡æ•°ãŒå¤‰ã§ã™: ${tracking_no}ï¼ˆ8ã€œ16æ¡ã®ã¿ï¼‰`);
      return;
    }

    if (busy) return;
    busy = true;
    setStatus('é€ä¿¡ä¸­â€¦');
    elSend.disabled = true;

    try {
      const res = await fetch(API, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Admin-Token': token,
        },
        body: JSON.stringify({ tracking_no })
      });

      const txt = await res.text();
      let data = null;
      try { data = JSON.parse(txt); } catch { data = { raw: txt }; }

      if (!res.ok || data.ok === false) {
        setStatus('å¤±æ•—', false);
        log(`HTTP ${res.status}\n` + JSON.stringify(data, null, 2));
        return;
      }

      // æˆåŠŸ
      setStatus(data.already_notified ? 'é€šçŸ¥æ¸ˆã¿ï¼ˆå†é€ãªã—ï¼‰' : 'é€ä¿¡OK', true);
      lastSent = tracking_no;
      log(JSON.stringify(data, null, 2));

      // æ¬¡ã®è²¼ã‚Šä»˜ã‘ã«å‚™ãˆã¦é¸æŠçŠ¶æ…‹ã¸
      elCode.value = '';
      elCode.focus();

    } catch (e) {
      setStatus('é€šä¿¡ã‚¨ãƒ©ãƒ¼', false);
      log(String(e && e.stack ? e.stack : e));
    } finally {
      busy = false;
      elSend.disabled = false;
    }
  }

  // è²¼ã‚Šä»˜ã‘ãŸç¬é–“ã«é€ä¿¡ï¼ˆçˆ†é€Ÿï¼‰
  elCode.addEventListener('paste', async (ev) => {
    // pasteç›´å¾Œã¯ value ã«åæ˜ ã•ã‚Œãªã„ã®ã§å°‘ã—å¾…ã¤
    setTimeout(() => {
      const v = normDigits(elCode.value);
      elCode.value = v;
      if (v && v !== lastSent) postTracking(v);
    }, 0);
  });

  // å…¥åŠ›ä¸­ã‚‚æ•°å­—ã«å¯„ã›ã‚‹
  elCode.addEventListener('input', () => {
    const v = normDigits(elCode.value);
    if (elCode.value !== v) elCode.value = v;
  });

  // Enterã§é€ä¿¡
  elCode.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      postTracking(elCode.value);
    }
  });

  elSend.addEventListener('click', () => postTracking(elCode.value));

  elClear.addEventListener('click', () => {
    elCode.value = '';
    setStatus('å¾…æ©Ÿ');
    log('cleared');
    elCode.focus();
  });

  elPaste.addEventListener('click', async () => {
    try {
      const t = await navigator.clipboard.readText();
      const v = normDigits(t);
      elCode.value = v;
      if (v) postTracking(v);
    } catch (e) {
      setStatus('è²¼ã‚Šä»˜ã‘ä¸å¯', false);
      log('ãƒ–ãƒ©ã‚¦ã‚¶ãŒã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰èª­ã¿å–ã‚Šã‚’æ‹’å¦ã—ã¾ã—ãŸã€‚\næ‰‹å‹•ã§è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚');
    }
  });

  elPing.addEventListener('click', async () => {
    try {
      const res = await fetch('/api/ping');
      const j = await res.json().catch(()=>({}));
      setStatus('ping OK', true);
      log(JSON.stringify(j, null, 2));
    } catch (e) {
      setStatus('ping NG', false);
      log(String(e));
    }
  });

  // åˆæœŸãƒ•ã‚©ãƒ¼ã‚«ã‚¹
  elCode.focus();
})();
</script>
</body>
</html>