<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>æ³¨æ–‡å†…å®¹ã®ç¢ºèª</title>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root{
      --bg:#f6f7f9;--card:#fff;--text:#111827;--muted:#6b7280;--line:#e5e7eb;
      --pri:#0b3a53;--pri2:#123b66;--danger:#b91c1c;
      --shadow:0 1px 3px rgba(0,0,0,.06);--radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:860px;margin:0 auto;padding:14px 14px 26px}
    h1{margin:0 0 6px;font-size:18px}
    .muted{color:var(--muted);font-size:13px;line-height:1.5}
    .err{color:var(--danger);font-weight:900}
    .card{
      background:var(--card);border:1px solid var(--line);border-radius:var(--radius);
      padding:12px;margin-top:12px;box-shadow:var(--shadow)
    }
    #addrText{ white-space: pre-line; }

    .items{margin-top:10px;border-top:1px solid var(--line)}
    .item{
      display:grid; grid-template-columns: 1fr auto;
      gap:6px 10px; padding:12px 0;
      border-bottom:1px dashed var(--line); font-size:14px;
    }
    .item:last-child{border-bottom:none}
    .item .name{font-weight:800}
    .item .qty{grid-column:1 / 2;color:var(--muted);font-size:13px}
    .item .price{grid-column:2 / 3;grid-row:1 / 3;align-self:center;font-weight:900;white-space:nowrap}

    .row{display:flex;justify-content:space-between;gap:10px;margin:0;padding:6px 0;font-size:14px}

    /* æ”¯æ‰•ã„æ–¹æ³•ãƒ©ã‚¸ã‚ª */
    .paySelect{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .payPill{
      display:flex; align-items:center; gap:8px;
      padding:10px 12px; border-radius:999px;
      background:#fff; border:1px solid var(--line);
      box-shadow:var(--shadow);
      cursor:pointer; user-select:none;
      font-size:13px; font-weight:900;
    }
    .payPill input{ transform:scale(1.1); }
    .payPill[aria-disabled="true"]{ opacity:.55; cursor:not-allowed; }
    .payPill .sub{ font-weight:700; color:var(--muted); font-size:12px; }

    .payGrid{ display:grid; grid-template-columns:1fr; gap:12px; margin-top:10px; }
    @media (min-width:760px){
      .payGrid{ grid-template-columns:1fr 1fr; align-items:stretch; }
      .backWrap{ grid-column:1 / -1; }
    }

    .payCardTitle{ font-weight:1000; font-size:14px; margin:0 0 6px; }
    .payHint{ color:var(--muted); font-size:12px; line-height:1.5; margin-bottom:10px; }

    .miniRow{
      display:flex; justify-content:space-between; gap:10px;
      padding:6px 0; font-size:13px; border-top:1px dashed var(--line);
    }
    .miniRow:first-of-type{border-top:1px solid var(--line)}
    .payTotal{
      margin-top:10px; padding-top:10px; border-top:2px solid var(--line);
      display:flex; justify-content:space-between; align-items:baseline; gap:10px;
    }
    .payTotal .label{font-weight:900;font-size:13px;color:var(--muted)}
    .payTotal .price{font-weight:1000;font-size:18px;white-space:nowrap}

    .payBtn{
      width:100%;
      border:none; border-radius:14px;
      padding:12px 14px;
      font-weight:1000;
      cursor:pointer;
      margin-top:10px;
    }
    .payBtn:disabled{opacity:.55;cursor:not-allowed}

    .backWrap .payBtn{ background:#fff;border:1px solid var(--line);color:#111827; margin-top:0; }

    .inactive{ opacity:.55; filter:saturate(.85); }

    /* =========================
       ğŸ ã‚®ãƒ•ãƒˆUI
    ========================= */
    .giftCard{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:12px; margin-top:12px; box-shadow:var(--shadow); }
    .giftTop{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .giftTitle{ font-weight:1000; font-size:14px; display:flex; align-items:center; gap:8px; }
    .giftNote{ font-size:12px; color:var(--muted); margin-top:6px; line-height:1.45; }
    .giftBody{ margin-top:10px; display:none; }
    .giftBody.show{ display:block; }
    .giftGrid{ display:grid; grid-template-columns:1fr; gap:10px; margin-top:8px; }
    .giftRow{ display:grid; grid-template-columns:1fr; gap:6px; }
    .giftRow label{ font-size:12px; color:var(--muted); }
    .giftRow input, .giftRow textarea{
      width:100%;
      font-size:14px;
      padding:10px 10px;
      border:1px solid var(--line);
      border-radius:12px;
      background:#fff;
      box-sizing:border-box;
    }
    .giftRow textarea{ min-height:88px; resize:vertical; }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      font-size:12px; padding:6px 10px; border-radius:999px;
      background:#f3f4f6; color:#374151; border:1px solid var(--line);
      margin-right:6px; margin-top:6px;
    }
    .pillStrong{ background:#eef2ff; border-color:#c7d2fe; color:#3730a3; }
    .req{ color:var(--danger); font-weight:1000; margin-left:4px; }
    .giftHint{ font-size:12px; color:var(--muted); margin-top:4px; }
    .giftError{ display:none; margin-top:8px; font-size:12px; color:var(--danger); font-weight:900; }
    .twoCols{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width:520px){ .twoCols{ grid-template-columns:1fr; } }

    /* âœ… ãŠè©¦ã—ã‚»ãƒƒãƒˆå°‚ç”¨ï¼šè‡ªå®…ã®ã¿æ³¨æ„ */
    .trialNotice{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #fecaca;
      background:#fff5f5;
      color:#991b1b;
      font-weight:900;
      font-size:13px;
      line-height:1.55;
      display:none;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1 id="pageTitle">æ³¨æ–‡å†…å®¹ã®ç¢ºèª</h1>
    <div class="muted" id="status">èª­ã¿è¾¼ã¿ä¸­â€¦</div>

    <!-- âœ… ãŠè©¦ã—ã‚»ãƒƒãƒˆï¼šè‡ªå®…ã®ã¿ï¼ˆã‚®ãƒ•ãƒˆä¸å¯ï¼‰ -->
    <div class="trialNotice" id="trialHomeOnlyNotice">
      â€»ãŠè©¦ã—ã‚»ãƒƒãƒˆã¯ <b>ã”è‡ªå®…é…é€ã®ã¿</b> ã§ã™ï¼ˆã‚®ãƒ•ãƒˆé…é€ã¯ã§ãã¾ã›ã‚“ï¼‰
    </div>

    <div class="card">
      <div class="muted" id="addrLabel">ãŠå±Šã‘å…ˆ</div>
      <div id="addrText" style="margin-top:6px;font-weight:900">â€”</div>
      <div class="muted" style="margin-top:8px">
        â€»ä½æ‰€ã‚’ä¿®æ­£ã—ãŸã„å ´åˆã¯ã€Œæˆ»ã‚‹ã€ã§ä½æ‰€å…¥åŠ›ã¸æˆ»ã£ã¦ãã ã•ã„ã€‚
      </div>
    </div>

    <!-- =========================
       ğŸ ã‚®ãƒ•ãƒˆè¨­å®š
       â€»ãŸã ã—ã€ŒãŠè©¦ã—ã‚»ãƒƒãƒˆ(mode=fukubako/trial)ã€ã§ã¯éè¡¨ç¤ºï¼†ç„¡åŠ¹åŒ–
    ========================= -->
    <div class="giftCard" id="giftCard">
      <div class="giftTop">
        <div class="giftTitle">ğŸ ã‚®ãƒ•ãƒˆã¨ã—ã¦é€ã‚‹</div>

        <label style="display:flex; align-items:center; gap:8px; user-select:none;">
          <input type="checkbox" id="giftToggle" />
          <span style="font-size:13px;font-weight:1000">ã‚®ãƒ•ãƒˆ</span>
        </label>
      </div>

      <div class="giftNote">
        <span class="pill pillStrong">å•†å“ä»£é‡‘ã¯ã”æ³¨æ–‡è€…æ§˜ã®ã”è² æ‹…ã§ã™</span>
        <span class="pill">é‡‘é¡ã®ã‚ã‹ã‚‹æ›¸é¡ã¯åŒæ¢±ã—ã¾ã›ã‚“</span>
      </div>

      <div class="giftBody" id="giftBody">
        <div class="giftHint">ãŠå±Šã‘å…ˆï¼ˆè´ˆã‚Šå…ˆï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚â€»ã“ã®æ³¨æ–‡ã®ã¿ã«ä½¿ç”¨ã—ã¾ã™</div>

        <div class="giftGrid">
          <div class="giftRow">
            <label for="giftName">ãŠå±Šã‘å…ˆæ°å<span class="req">å¿…é ˆ</span></label>
            <input id="giftName" type="text" inputmode="text" autocomplete="name" placeholder="ä¾‹ï¼‰å±±ç”° å¤ªéƒ" />
          </div>

          <div class="twoCols">
            <div class="giftRow">
              <label for="giftZip">éƒµä¾¿ç•ªå·<span class="req">å¿…é ˆ</span></label>
              <input id="giftZip" type="text" inputmode="numeric" autocomplete="postal-code" placeholder="ä¾‹ï¼‰123-4567" />
              <div class="giftHint">ãƒã‚¤ãƒ•ãƒ³ã‚ã‚Š/ãªã—ã©ã¡ã‚‰ã§ã‚‚OK</div>
            </div>

            <div class="giftRow">
              <label for="giftTel">é›»è©±ç•ªå·<span class="req">å¿…é ˆ</span></label>
              <input id="giftTel" type="text" inputmode="tel" autocomplete="tel" placeholder="ä¾‹ï¼‰09012345678" />
              <div class="giftHint">é…é€ä¼ç¥¨ã«ä½¿ã„ã¾ã™</div>
            </div>
          </div>

          <div class="giftRow">
            <label for="giftAddr1">ä½æ‰€ï¼ˆéƒ½é“åºœçœŒãƒ»å¸‚åŒºç”ºæ‘ãƒ»ç•ªåœ°ï¼‰<span class="req">å¿…é ˆ</span></label>
            <input id="giftAddr1" type="text" autocomplete="street-address" placeholder="ä¾‹ï¼‰æ„›çŸ¥çœŒã€‡ã€‡å¸‚ã€‡ã€‡ç”º1-2-3" />
          </div>

          <div class="giftRow">
            <label for="giftAddr2">å»ºç‰©åãƒ»éƒ¨å±‹ç•ªå·ï¼ˆä»»æ„ï¼‰</label>
            <input id="giftAddr2" type="text" autocomplete="address-line2" placeholder="ä¾‹ï¼‰ã€‡ã€‡ãƒãƒ³ã‚·ãƒ§ãƒ³ 101" />
          </div>

          <div class="giftRow">
            <label for="giftMsg">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆä»»æ„ï¼‰</label>
            <textarea id="giftMsg" maxlength="120" placeholder="ä¾‹ï¼‰ãŠèª•ç”Ÿæ—¥ãŠã‚ã§ã¨ã†ï¼"></textarea>
            <div class="giftHint"><span id="giftMsgCount">0</span>/120</div>
          </div>
        </div>

        <div class="giftError" id="giftError"></div>
      </div>
    </div>
    <!-- ========================= -->

    <div class="card">
      <div class="muted">ã”æ³¨æ–‡å•†å“</div>
      <div class="items" id="items"></div>

      <div class="row"><div>å°è¨ˆ</div><div id="subtotal">0å††</div></div>
      <div class="row"><div>é€æ–™ï¼ˆè¦‹ç©ï¼‰</div><div id="shipping">â€”</div></div>

      <!-- æ”¯æ‰•ã„æ–¹æ³•ãƒ©ã‚¸ã‚ª -->
      <div class="paySelect" role="radiogroup" aria-label="æ”¯æ‰•ã„æ–¹æ³•">
        <label class="payPill" id="pillCard">
          <input type="radio" name="payMethod" id="payCard" value="card">
          <div>ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ<div class="sub">Stripeæ±ºæ¸ˆã¸</div></div>
        </label>

        <label class="payPill" id="pillCod">
          <input type="radio" name="payMethod" id="payCod" value="cod">
          <div>ä»£å¼•ã<div class="sub">é…é”å“¡ã¸ç¾é‡‘</div></div>
        </label>
      </div>

      <div class="payGrid">
        <!-- ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ -->
        <div class="card" id="cardPanel" style="margin-top:0">
          <div class="payCardTitle">ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã§ã®ãŠæ”¯æ‰•ã„</div>
          <div class="payHint">â€»ä»£å¼•æ‰‹æ•°æ–™ã¯ã‹ã‹ã‚Šã¾ã›ã‚“ã€‚Stripeæ±ºæ¸ˆç”»é¢ã¸é€²ã¿ã¾ã™ã€‚</div>

          <div class="miniRow"><div>å°è¨ˆ</div><div id="subtotal2">â€”</div></div>
          <div class="miniRow"><div>é€æ–™</div><div id="shipping2">â€”</div></div>

          <div class="payTotal">
            <div class="label">åˆè¨ˆï¼ˆã‚¯ãƒ¬ã‚¸ãƒƒãƒˆï¼‰</div>
            <div class="price" id="totalCard">â€”</div>
          </div>

          <button id="cardBtn" class="payBtn" style="background:var(--pri2);color:#fff" type="button">
            ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã§æ”¯æ‰•ã†
          </button>
        </div>

        <!-- ä»£å¼• -->
        <div class="card" id="codPanel" style="margin-top:0">
          <div class="payCardTitle">ä»£å¼•ãã§ã®ãŠæ”¯æ‰•ã„</div>
          <div class="payHint">â€»ä»£å¼•æ‰‹æ•°æ–™ãŒã‹ã‹ã‚Šã¾ã™ã€‚é…é”å“¡ã¸ç¾é‡‘ã§ãŠæ”¯æ‰•ã„ãã ã•ã„ã€‚</div>

          <div class="miniRow"><div>å°è¨ˆ</div><div id="subtotal3">â€”</div></div>
          <div class="miniRow"><div>é€æ–™</div><div id="shipping3">â€”</div></div>
          <div class="miniRow"><div>ä»£å¼•æ‰‹æ•°æ–™</div><div id="codFee">â€”</div></div>

          <div class="payTotal">
            <div class="label">åˆè¨ˆï¼ˆä»£å¼•ï¼‰</div>
            <div class="price" id="totalCod">â€”</div>
          </div>

          <button id="codBtn" class="payBtn" style="background:var(--pri);color:#fff" type="button">
            ä»£å¼•ãã§æ³¨æ–‡ç¢ºå®š
          </button>

          <div id="codDisabledNote" class="muted" style="margin-top:8px;display:none">
            â€»è´ˆã‚Šå…ˆã¸ã®é…é€ã§ã¯ã€ä»£å¼•ãã¯ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã›ã‚“ï¼ˆã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã®ã¿ï¼‰
          </div>
        </div>

        <!-- æˆ»ã‚‹ -->
        <div class="backWrap">
          <button id="backBtn" class="payBtn" type="button">æˆ»ã‚‹ï¼ˆä½æ‰€å…¥åŠ›ã¸ï¼‰</button>
          <div class="muted" style="margin-top:8px">
            â€»é€æ–™ã¯è¦‹ç©ã‚Šè¡¨ç¤ºã§ã™ï¼ˆç¢ºå®šæ™‚ã«å†è¨ˆç®—ã•ã‚Œã¾ã™ï¼‰ã€‚
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(async function(){
  "use strict";

  const LIFF_ID_ORDER = "2008406620-G5j1gjzM";
  const KEY_UID ="isoya_userId";

  const qs = new URLSearchParams(location.search);
  const mode = (qs.get("mode") || "").trim();

  // âœ… ãŠè©¦ã—ã‚»ãƒƒãƒˆåˆ¤å®šï¼ˆã‚ãªãŸã®é‹ç”¨ï¼šmode=fukubako ã‚’ãŠè©¦ã—æ‰±ã„ï¼‰
  const isTrial = (mode === "trial" || mode === "fukubako");

  // âœ… ã‚‚ã—URLã« ship=gift ãªã©ãŒæ¥ã¦ã‚‚ã€ãŠè©¦ã—ã‚»ãƒƒãƒˆã§ã¯è‡ªå®…ã«å¼·åˆ¶
  let shipQS = (qs.get("ship") || "").trim(); // "home" / "gift" / ""
  if (isTrial && (shipQS === "gift" || qs.get("gift") === "1")) {
    shipQS = "home";
    qs.set("ship", "home");
    qs.delete("gift");
    history.replaceState(null, "", location.pathname + "?" + qs.toString());
  }

  const KEY_CART =
    (mode === "original") ? "isoya_cart_original"
  : (mode === "fukubako") ? "isoya_cart_fukubako"
  : "isoya_cart";

  const backTo =
    (mode === "original") ? "/original-set.html"
  : (mode === "fukubako") ? "/fukubako.html"   /* â† ãŠè©¦ã—ã‚»ãƒƒãƒˆãƒšãƒ¼ã‚¸ã«ã—ã¦ã„ã‚‹ãªã‚‰ãã®ã¾ã¾ */
  : "/products.html";

  const RETURN_TO_THIS =
    (mode === "fukubako") ? "/confirm.html?mode=fukubako"
  : (mode === "original") ? "/confirm-original.html"
  : "/confirm.html";

  const status=document.getElementById("status");
  const addrText=document.getElementById("addrText");
  const itemsEl=document.getElementById("items");

  const subtotalEl=document.getElementById("subtotal");
  const shippingEl=document.getElementById("shipping");

  const subtotal2El=document.getElementById("subtotal2");
  const shipping2El=document.getElementById("shipping2");
  const totalCardEl=document.getElementById("totalCard");

  const subtotal3El=document.getElementById("subtotal3");
  const shipping3El=document.getElementById("shipping3");
  const codFeeEl=document.getElementById("codFee");
  const totalCodEl=document.getElementById("totalCod");

  const backBtn=document.getElementById("backBtn");
  const cardBtn=document.getElementById("cardBtn");
  const codBtn=document.getElementById("codBtn");

  const payCard=document.getElementById("payCard");
  const payCod=document.getElementById("payCod");
  const pillCard=document.getElementById("pillCard");
  const pillCod=document.getElementById("pillCod");
  const cardPanel=document.getElementById("cardPanel");
  const codPanel=document.getElementById("codPanel");

  // ğŸ
  const giftCard   = document.getElementById("giftCard");
  const giftToggle = document.getElementById("giftToggle");
  const giftBody   = document.getElementById("giftBody");
  const giftError  = document.getElementById("giftError");
  const giftMsg    = document.getElementById("giftMsg");
  const giftMsgCount = document.getElementById("giftMsgCount");

  // âœ… ãŠè©¦ã—å°‚ç”¨ï¼ˆè‡ªå®…ã®ã¿ï¼‰
  const trialHomeOnlyNotice = document.getElementById("trialHomeOnlyNotice");
  const pageTitle = document.getElementById("pageTitle");

  const yen=n=>(Number(n)||0).toLocaleString("ja-JP")+"å††";
  const loadJson=k=>{try{return JSON.parse(localStorage.getItem(k)||"");}catch{return null;}};

  function setBtnBusy(btn, busy, busyText, normalText){
    if(!btn) return;
    btn.disabled = !!busy;
    btn.style.pointerEvents = busy ? "none" : "auto";
    if (busyText && normalText) btn.textContent = busy ? busyText : normalText;
  }
  function safeSetText(el, txt){ if(el) el.textContent = txt; }

  async function postJson(url, body){
    const r=await fetch(url,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(body)
    });
    const d=await r.json().catch(()=>({}));
    if(!r.ok) throw new Error(d?.error || ("HTTP "+r.status));
    return d;
  }

  async function getAddress(userId){
    const r=await fetch(`/api/address/get?userId=${encodeURIComponent(userId)}`,{cache:"no-store"});
    const d=await r.json().catch(()=>({}));
    if(!r.ok) throw new Error(d?.error||("HTTP "+r.status));
    return d?.address || null;
  }

  async function getProducts(){
    const r=await fetch("/api/products",{cache:"no-store"});
    const d=await r.json().catch(()=>({}));
    if(!r.ok || !d.ok) throw new Error(d?.error||("HTTP "+r.status));
    return Array.isArray(d.products)?d.products:[];
  }

  function renderItems(cartItems, products){
    const byId=Object.fromEntries(products.map(p=>[p.id,p]));
    itemsEl.innerHTML="";
    let subtotal=0;

    for(const it of cartItems){
      const p=byId[it.id];
      if(!p) continue;
      const qty = Number(it.qty||0);
      const line=Number(p.price||0) * qty;
      subtotal += line;

      const div=document.createElement("div");
      div.className="item";
      div.innerHTML = `
        <div class="name">${p.name || ""}${p.volume ? `ï¼ˆ${p.volume}ï¼‰` : ""}</div>
        <div class="price">${yen(line)}</div>
        <div class="qty">Ã— ${qty} ç‚¹</div>
      `;
      itemsEl.appendChild(div);
    }

    safeSetText(subtotalEl, yen(subtotal));
    safeSetText(subtotal2El, yen(subtotal));
    safeSetText(subtotal3El, yen(subtotal));
    return subtotal;
  }

  async function ensureUserSoft(){
    const cached = (localStorage.getItem(KEY_UID) || "").trim();
    if(cached) return cached;
    try{
      await liff.init({ liffId: LIFF_ID_ORDER });
      if(liff.isLoggedIn()){
        const prof = await liff.getProfile();
        const uid = (prof?.userId||"").trim();
        if(uid) localStorage.setItem(KEY_UID, uid);
        return uid || null;
      }
      return null;
    }catch{
      return null;
    }
  }

  function applyQuoteToUI(quote){
    const shippingText = `${yen(quote.shippingFee)}ï¼ˆãƒ¤ãƒãƒˆ ${quote.size}ã‚µã‚¤ã‚ºï¼‰`;
    safeSetText(shippingEl, shippingText);

    safeSetText(shipping2El, shippingText);
    const totalCard = Number(quote.subtotal||0) + Number(quote.shippingFee||0);
    safeSetText(totalCardEl, yen(totalCard));

    safeSetText(shipping3El, shippingText);
    safeSetText(codFeeEl, yen(quote.codFee));
    safeSetText(totalCodEl, yen(quote.totalCod));
  }

  function applyPayMethodUI(method){
    const isCard = (method === "card");

    if(payCard) payCard.checked = isCard;
    if(payCod)  payCod.checked  = !isCard;

    if(cardPanel) cardPanel.classList.toggle("inactive", !isCard);
    if(codPanel)  codPanel.classList.toggle("inactive", isCard);

    if(cardBtn) cardBtn.disabled = !isCard;
    if(codBtn)  codBtn.disabled  = isCard;
  }

  function lockCodIfGift(isGift){
    const note = document.getElementById("codDisabledNote");

    if(isGift){
      if(payCod){ payCod.disabled = true; payCod.checked = false; }
      if(pillCod){ pillCod.setAttribute("aria-disabled","true"); }

      applyPayMethodUI("card");

      if(codBtn){
        codBtn.disabled = true;
        codBtn.textContent = "è´ˆã‚Šå…ˆã§ã¯ä»£å¼•ãä¸å¯";
        codBtn.style.opacity = ".55";
      }
      if(note) note.style.display = "block";
    }else{
      if(payCod){ payCod.disabled = false; }
      if(pillCod){ pillCod.removeAttribute("aria-disabled"); }

      if(codBtn){
        codBtn.textContent = "ä»£å¼•ãã§æ³¨æ–‡ç¢ºå®š";
        codBtn.style.opacity = "1";
      }
      if(note) note.style.display = "none";
    }
  }

  // =========================
  // ğŸ ã‚®ãƒ•ãƒˆï¼šUIã¨payload
  // =========================
  function showGiftError(text){
    if(!giftError) return;
    if(!text){
      giftError.style.display="none";
      giftError.textContent="";
      return;
    }
    giftError.style.display="block";
    giftError.textContent=text;
  }

  function setGiftUI(on){
    if(giftBody) giftBody.classList.toggle("show", !!on);
    showGiftError("");
  }

  function getGiftFields(){
    const $ = (id)=>document.getElementById(id);
    return {
      name:  ($("giftName")?.value || "").trim(),
      zip:   ($("giftZip")?.value || "").trim(),
      tel:   ($("giftTel")?.value || "").trim(),
      addr1: ($("giftAddr1")?.value || "").trim(),
      addr2: ($("giftAddr2")?.value || "").trim(),
      msg:   ($("giftMsg")?.value || "").trim(),
    };
  }

  function buildGiftPayloadOrThrow(){
    const isGift = !!giftToggle?.checked;
    if(!isGift) return { is_gift:false };

    const f = getGiftFields();
    const zip = f.zip.replace(/[^\d]/g,"");
    const tel = f.tel.replace(/[^\d]/g,"");

    if(!f.name){ showGiftError("ãŠå±Šã‘å…ˆæ°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); throw new Error("GIFT_VALIDATE_NAME"); }
    if(zip.length < 7){ showGiftError("éƒµä¾¿ç•ªå·ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ7æ¡ï¼‰"); throw new Error("GIFT_VALIDATE_ZIP"); }
    if(tel.length < 10){ showGiftError("é›»è©±ç•ªå·ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„"); throw new Error("GIFT_VALIDATE_TEL"); }
    if(!f.addr1){ showGiftError("ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); throw new Error("GIFT_VALIDATE_ADDR"); }

    showGiftError("");

    return {
      is_gift:true,
      gift_message: f.msg || null,
      ship_name: f.name,
      ship_zip: zip,
      ship_tel: tel,
      ship_addr1: f.addr1,
      ship_addr2: f.addr2 || null,
    };
  }

  // =========================
  // âœ… ãŠè©¦ã—ã‚»ãƒƒãƒˆã¯ã€Œè‡ªå®…ã®ã¿ã€å¼·åˆ¶
  // - ã‚®ãƒ•ãƒˆUIã‚’æ¶ˆã™
  // - ã‚®ãƒ•ãƒˆé–¢é€£çŠ¶æ…‹ã‚’å…¨ã¦OFF
  // =========================
  function enforceTrialHomeOnly(){
    if(!isTrial) return;

    // è¦‹å‡ºã—ãƒ»ã‚¿ã‚¤ãƒˆãƒ«
    if(pageTitle) pageTitle.textContent = "ãŠè©¦ã—ã‚»ãƒƒãƒˆï½œæ³¨æ–‡å†…å®¹ã®ç¢ºèª";
    document.title = "ãŠè©¦ã—ã‚»ãƒƒãƒˆï½œæ³¨æ–‡å†…å®¹ã®ç¢ºèª";

    // æ³¨æ„è¡¨ç¤º
    if(trialHomeOnlyNotice) trialHomeOnlyNotice.style.display = "block";

    // ã‚®ãƒ•ãƒˆUIã¯å®Œå…¨ã«ç„¡åŠ¹åŒ–ãƒ»éè¡¨ç¤º
    if(giftCard) giftCard.style.display = "none";
    if(giftToggle){
      giftToggle.checked = false;
      giftToggle.disabled = true;
    }
    setGiftUI(false);
    showGiftError("");

    // ä»£å¼•ãã¯è‡ªå®…ãªã®ã§OKï¼ˆã“ã“ã§ã¯ä½•ã‚‚ã—ãªã„ï¼‰
    // â€»ã‚‚ã—ã€ŒãŠè©¦ã—ã‚»ãƒƒãƒˆã¯ã‚¯ãƒ¬ã‚«ã®ã¿ã€ã«ã—ãŸã„å ´åˆã¯ã“ã“ã§CODã‚’æ®ºã›ã°OK
  }

  try{
    status.textContent="ç¢ºèªä¸­â€¦";

    // âœ… å…ˆã«ã€ŒãŠè©¦ã—ï¼è‡ªå®…ã®ã¿ã€ã‚’é©ç”¨ï¼ˆUIå´ã‚’å…ˆã«å›ºå®šï¼‰
    enforceTrialHomeOnly();

    const uid = await ensureUserSoft();
    if(!uid){
      status.innerHTML = '<span class="err">ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚ã„ã£ãŸã‚“å•†å“ãƒšãƒ¼ã‚¸ã‹ã‚‰é–‹ãç›´ã—ã¦ãã ã•ã„ã€‚</span>';
      setTimeout(()=>location.replace(backTo), 900);
      return;
    }

    const cart=loadJson(KEY_CART) || {items:[]};
    const items=(cart.items||[]).filter(x=>x?.id && Number(x.qty||0)>0);
    if(items.length===0){
      status.innerHTML='<span class="err">ã‚«ãƒ¼ãƒˆãŒç©ºã§ã™ã€‚å•†å“é¸æŠã«æˆ»ã‚Šã¾ã™ã€‚</span>';
      setTimeout(()=>location.replace(backTo), 700);
      return;
    }

    /* =========================================================
       âœ… confirm ç›´è¡Œã‚’é˜²ãã€å¿…ãšä¸€åº¦ cod-register ã‚’é€šã™
    ========================================================= */
    const stepped = (qs.get("addr_step") || "").trim();
    if (stepped !== "1") {
      const returnUrl = new URL(location.origin + RETURN_TO_THIS);
      returnUrl.searchParams.set("addr_step", "1");
      if (mode) returnUrl.searchParams.set("mode", mode);

      const returnPath = returnUrl.pathname + returnUrl.search;
      location.replace(
        `/cod-register.html?returnTo=${encodeURIComponent(returnPath)}&mode=${encodeURIComponent(mode||"")}&ship=home&liff.hback=2`
      );
      return;
    }
    /* ========================================================= */

    const addr=await getAddress(uid).catch(()=>null);
    if(!addr){
      location.replace(`/cod-register.html?returnTo=${encodeURIComponent(RETURN_TO_THIS)}&mode=${encodeURIComponent(mode||"")}&ship=home&liff.hback=2`);
      return;
    }

    // âœ… ã‚®ãƒ•ãƒˆåˆ¤å®šï¼šãŠè©¦ã—ã¯å¿…ãšfalse
    let isGift = false;

    if(!isTrial){
      // æ—§ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆé€šå¸¸ã®ã¿ï¼‰
      if (shipQS === "home") isGift = false;
      else if (shipQS === "gift" || (qs.get("gift") === "1")) isGift = true;
      else isGift = (addr.is_gift === true);
    }

    // ãŠå±Šã‘å…ˆè¡¨ç¤ºï¼ˆåŸºæœ¬ã¯DBä½æ‰€ï¼è‡ªå®…ï¼‰
    const nameLine = addr.name ? `${addr.name} æ§˜\n` : "";
    addrText.textContent =
      `${nameLine}ã€’${addr.postal||""} ${addr.prefecture||""}${addr.city||""}${addr.address1||""} ${addr.address2||""}`.trim();

    // ğŸ ã‚®ãƒ•ãƒˆUIåˆæœŸåŒ–ï¼ˆé€šå¸¸ã®ã¿ï¼‰
    if(!isTrial && giftToggle){
      giftToggle.checked = !!isGift;
      setGiftUI(!!isGift);
      lockCodIfGift(!!isGift);

      giftToggle.addEventListener("change", ()=>{
        const on = !!giftToggle.checked;
        setGiftUI(on);
        lockCodIfGift(on);

        if(!on){
          addrText.textContent =
            `${nameLine}ã€’${addr.postal||""} ${addr.prefecture||""}${addr.city||""}${addr.address1||""} ${addr.address2||""}`.trim();
        }
      });

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ–‡å­—æ•°
      if(giftMsg && giftMsgCount){
        giftMsg.addEventListener("input", ()=>giftMsgCount.textContent=String((giftMsg.value||"").length));
        giftMsgCount.textContent = String((giftMsg.value||"").length);
      }

      // ã‚®ãƒ•ãƒˆå…¥åŠ›ãŒåŸ‹ã¾ã£ãŸã‚‰è¡¨ç¤ºå·®ã—æ›¿ãˆï¼ˆè¦‹ãŸç›®ã ã‘ï¼‰
      const giftFieldsIds = ["giftName","giftZip","giftTel","giftAddr1","giftAddr2"];
      giftFieldsIds.forEach(id=>{
        const el=document.getElementById(id);
        if(el){
          el.addEventListener("blur", ()=>{
            if(!(giftToggle && giftToggle.checked)) return;
            const f = getGiftFields();
            const zip = f.zip.replace(/[^\d]/g,"");
            const name = f.name ? `${f.name} æ§˜\n` : "";
            if(f.addr1){
              addrText.textContent =
                `${name}ã€’${zip || ""} ${f.addr1} ${f.addr2 || ""}`.trim();
            }
          });
        }
      });
    }else{
      // ãŠè©¦ã—æ™‚ã¯å¿µã®ãŸã‚CODãƒãƒ¼ãƒˆã¯éš ã™ï¼ˆã‚®ãƒ•ãƒˆã§ã¯ãªã„ãŸã‚ï¼‰
      const note = document.getElementById("codDisabledNote");
      if(note) note.style.display = "none";
    }

    const products=await getProducts();
    const subtotal = renderItems(items, products);

    safeSetText(shippingEl, "è¨ˆç®—ä¸­â€¦");
    safeSetText(shipping2El, "è¨ˆç®—ä¸­â€¦");
    safeSetText(shipping3El, "è¨ˆç®—ä¸­â€¦");
    safeSetText(codFeeEl, "è¨ˆç®—ä¸­â€¦");
    safeSetText(totalCodEl, "è¨ˆç®—ä¸­â€¦");
    safeSetText(totalCardEl, "è¨ˆç®—ä¸­â€¦");

    // âœ… é€æ–™è¦‹ç©ã¯ã€Œè‡ªå®…ä½æ‰€ã€ã§OK
    const quote = await postJson("/api/order/quote", { uid, checkout:{ items } });
    quote.subtotal = quote.subtotal ?? subtotal;
    applyQuoteToUI(quote);

    applyPayMethodUI("card");
    // ã‚®ãƒ•ãƒˆãªã‚‰CODãƒ­ãƒƒã‚¯ï¼ˆé€šå¸¸ã®ã¿ï¼‰
    if(!isTrial) lockCodIfGift(!!(giftToggle && giftToggle.checked));
    else lockCodIfGift(false);

    if(pillCard){
      pillCard.addEventListener("click", ()=>{
        if(payCard && !payCard.disabled){
          payCard.checked = true;
          applyPayMethodUI("card");
        }
      });
    }
    if(pillCod){
      pillCod.addEventListener("click", ()=>{
        if(payCod && !payCod.disabled){
          payCod.checked = true;
          applyPayMethodUI("cod");
        }
      });
    }
    if(payCard) payCard.addEventListener("change", ()=>applyPayMethodUI("card"));
    if(payCod)  payCod.addEventListener("change", ()=>{
      if(payCod.disabled) return;
      applyPayMethodUI("cod");
    });

    status.textContent="å†…å®¹ã‚’ã”ç¢ºèªãã ã•ã„ã€‚";

    if(backBtn){
      backBtn.onclick = ()=>{
        // âœ… æˆ»ã‚‹ã¯ addr_step ã‚’ä»˜ã‘ãªã„ï¼ˆæ¬¡å›ã¾ãŸå¿…ãšä½æ‰€ç”»é¢ã‚’é€šã™ï¼‰
        location.href = `/cod-register.html?returnTo=${encodeURIComponent(RETURN_TO_THIS)}&mode=${encodeURIComponent(mode||"")}&ship=home&liff.hback=2`;
      };
    }

    if(cardBtn){
      cardBtn.onclick = async ()=>{
        if(!(payCard && payCard.checked)) return;

        // âœ… ãŠè©¦ã—ã‚»ãƒƒãƒˆã¯è‡ªå®…ã®ã¿ï¼šgift payloadã¯å¿…ãš false
        // âœ… é€šå¸¸ã®ã¿ã‚®ãƒ•ãƒˆãƒã‚§ãƒƒã‚¯
        let giftPayload = { is_gift:false };
        if(!isTrial){
          try{
            giftPayload = buildGiftPayloadOrThrow();
          }catch(e){
            return;
          }
        }

        setBtnBusy(cardBtn, true, "ç§»å‹•ä¸­â€¦", "ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã§æ”¯æ‰•ã†");
        try{
          const data = await postJson("/api/pay/stripe/create", {
            uid,
            checkout:{ items },
            ...giftPayload
          });
          if(!data?.url) throw new Error("stripe url missing");
          location.href = data.url;
        }catch(e){
          console.error(e);
          alert("ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆæ±ºæ¸ˆã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ: " + (e?.message||e));
          setBtnBusy(cardBtn, false, "ç§»å‹•ä¸­â€¦", "ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã§æ”¯æ‰•ã†");
        }
      };
    }

    if(codBtn){
      codBtn.onclick = async ()=>{
        if(!(payCod && payCod.checked)) return;

        // âœ… ãŠè©¦ã—ã‚»ãƒƒãƒˆï¼šè‡ªå®…ã®ã¿ãªã®ã§CODå¯ï¼ˆã“ã“ã¯é€šã™ï¼‰
        // âœ… é€šå¸¸ï¼šã‚®ãƒ•ãƒˆONãªã‚‰CODä¸å¯
        const isGiftNow = (!isTrial) && !!(giftToggle && giftToggle.checked);
        if(isGiftNow) return;

        setBtnBusy(codBtn, true, "ç¢ºå®šä¸­â€¦", "ä»£å¼•ãã§æ³¨æ–‡ç¢ºå®š");
        try{
          const data = await postJson("/api/order/cod/create", { uid, checkout:{ items } });
          localStorage.setItem(KEY_CART, JSON.stringify({ items: [] }));
          location.href = `/complete.html?method=cod&orderId=${encodeURIComponent(data.orderId||"")}`;
        }catch(e){
          console.error(e);
          alert("ä»£å¼•ãç¢ºå®šã«å¤±æ•—ã—ã¾ã—ãŸ: " + (e?.message||e));
          setBtnBusy(codBtn, false, "ç¢ºå®šä¸­â€¦", "ä»£å¼•ãã§æ³¨æ–‡ç¢ºå®š");
        }
      };
    }

  }catch(e){
    console.error(e);
    status.innerHTML='<span class="err">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆä½æ‰€API/å•†å“API/DBã‚’ç¢ºèªï¼‰</span>';
  }
})();
</script>
</body>
</html>
