<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ç¦ç®±ï¼ˆãŠæ¥½ã—ã¿ç®±ï¼‰</title>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root{
      --bg:#f6f7f9; --card:#fff; --text:#111827; --muted:#6b7280; --line:#e5e7eb;
      --pri:#7c3aed; --danger:#b91c1c; --shadow:0 1px 3px rgba(0,0,0,.06); --radius:14px;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:system-ui,-apple-system,"Segoe UI",sans-serif; background:var(--bg); color:var(--text); }
    .wrap{ max-width:860px; margin:0 auto; padding:14px 14px 28px; }
    .hero{ background:#fff; border:1px solid var(--line); border-radius:18px; padding:14px; box-shadow:var(--shadow); }
    h1{ margin:0 0 6px; font-size:20px; }
    .muted{ color:var(--muted); font-size:13px; line-height:1.6; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px; margin-top:12px; }
    .row{ display:flex; justify-content:space-between; gap:10px; align-items:center; }
    .price{ font-size:22px; font-weight:900; }
    .img{ width:100%; aspect-ratio:16/9; border:1px solid var(--line); border-radius:12px; background:#f1f5f9; overflow:hidden; display:flex; align-items:center; justify-content:center; }
    .img img{ width:100%; height:100%; object-fit:contain; background:#fff; }
    .qtyBox{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px; border:1px solid var(--line); border-radius:12px; background:#fafafa; margin-top:12px; }
    .stepper{ display:flex; align-items:center; gap:8px; }
    .btnIcon{ width:38px; height:38px; border-radius:10px; border:1px solid var(--line); background:#fff; cursor:pointer; font-size:18px; }
    .qty{ width:54px; height:38px; border-radius:10px; border:1px solid var(--line); text-align:center; font-size:14px; background:#fff; }
    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    button{ border:none; border-radius:14px; padding:12px 14px; font-weight:900; cursor:pointer; flex:1; min-width:180px; }
    #goBtn{ background:var(--pri); color:#fff; }
    #backBtn{ background:#fff; border:1px solid var(--line); color:#111827; }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    .err{ color:var(--danger); font-weight:900; font-size:12px; margin-top:10px; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="hero">
      <h1>ğŸ ç£¯å±‹ ç¦ç®±ï¼ˆãŠæ¥½ã—ã¿ç®±ï¼‰</h1>
      <div class="muted">
        ãƒ€ãƒ³ãƒœãƒ¼ãƒ«ç®±ã§ãŠå±Šã‘ã™ã‚‹ç¦è¢‹ä¼ç”»ã§ã™ã€‚<br>
        ä¸­èº«ã¯é–‹ã‘ã¦ã‹ã‚‰ã®ãŠæ¥½ã—ã¿ï¼ˆæ™‚æœŸãƒ»åœ¨åº«ã§å¤‰ã‚ã‚Šã¾ã™ï¼‰ã€‚
      </div>
    </div>

    <div class="card">
      <div class="muted">å•†å“</div>
      <div style="font-weight:900;font-size:16px;margin-top:6px" id="pName">èª­ã¿è¾¼ã¿ä¸­â€¦</div>

      <div class="img" id="imgWrap" style="margin-top:10px;">ç”»åƒãªã—</div>

      <div style="margin-top:10px" class="row">
        <div>
          <div class="muted">ä¾¡æ ¼ï¼ˆç¨è¾¼ï¼‰</div>
          <div class="price" id="pPrice">â€”</div>
        </div>
        <div style="text-align:right">
          <div class="muted">åœ¨åº«</div>
          <div style="font-weight:900" id="pStock">â€”</div>
        </div>
      </div>

      <div class="qtyBox">
        <div>
          <div style="font-weight:900">å€‹æ•°</div>
          <div class="muted">ç¢ºèªç”»é¢ã§é€æ–™ã‚’è¦‹ç©ã‚Šã—ã¾ã™</div>
        </div>
        <div class="stepper">
          <button class="btnIcon" id="minusBtn" aria-label="æ¸›ã‚‰ã™">âˆ’</button>
          <input class="qty" id="qtyInput" inputmode="numeric" value="1" />
          <button class="btnIcon" id="plusBtn" aria-label="å¢—ã‚„ã™">ï¼‹</button>
        </div>
      </div>

      <div class="btnRow">
        <button id="goBtn" type="button">æ³¨æ–‡å†…å®¹ã‚’ç¢ºèªã¸</button>
        <button id="backBtn" type="button">æˆ»ã‚‹</button>
      </div>

      <div id="err" class="err" style="display:none"></div>
    </div>
  </div>

<script>
(function(){
  "use strict";

  // âœ… confirm.html ã¨æƒãˆã‚‹
  const KEY_CART = "isoya_cart";

  // âœ… products.json å´ã®ç¦ç®±ID
  const FUKU_ID = "fukubako-2000";

  const el = (id)=>document.getElementById(id);
  const errEl = el("err");

  const yen = (n)=>(Number(n)||0).toLocaleString("ja-JP")+"å††";

  function showErr(msg){
    if(!msg){ errEl.style.display="none"; errEl.textContent=""; return; }
    errEl.style.display="block";
    errEl.textContent=msg;
  }

  function clampInt(v, min, max){
    let n = Math.floor(Number(String(v).replace(/[^\d]/g,"")));
    if(!Number.isFinite(n)) n = min;
    if(n < min) n = min;
    if(Number.isFinite(max) && n > max) n = max;
    return n;
  }

  function saveCartOnlyFuku(id, qty){
    // âœ… confirm.html ãŒæœŸå¾…ã™ã‚‹å½¢å¼ { items:[{id, qty}] }
    const cart = { items: [ { id, qty } ] };
    localStorage.setItem(KEY_CART, JSON.stringify(cart));
  }

  async function getProducts(){
    const r = await fetch("/api/products", { cache:"no-store" });
    const d = await r.json().catch(()=>({}));
    if(!r.ok || !d.ok) throw new Error(d?.error || ("HTTP " + r.status));
    return Array.isArray(d.products) ? d.products : [];
  }

  function render(p){
    el("pName").textContent = p.name || "ç¦ç®±";
    el("pPrice").textContent = yen(p.price);
    el("pStock").textContent = (typeof p.stock === "number") ? String(p.stock) : "â€”";

    const wrap = el("imgWrap");
    wrap.innerHTML = "";
    if(p.image && String(p.image).trim()){
      const img = document.createElement("img");
      img.alt = p.name || "ç¦ç®±";
      img.src = p.image;
      img.loading = "lazy";
      wrap.appendChild(img);
    }else{
      wrap.textContent = "ç”»åƒãªã—";
    }
  }

  (async ()=>{
    try{
      showErr("");

      const products = await getProducts();
      const p = products.find(x=>x && x.id === FUKU_ID);
      if(!p){
        showErr("ç¦ç®±ã®å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆproducts.json ã« fukubako-2000 ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ï¼‰");
        el("goBtn").disabled = true;
        return;
      }

      render(p);

      const stock = (typeof p.stock === "number") ? p.stock : Infinity;
      const qtyInput = el("qtyInput");

      function applyQty(next){
        const q = clampInt(next, 1, (Number.isFinite(stock) ? Math.max(stock,1) : Infinity));
        qtyInput.value = String(q);

        if(stock === 0){
          showErr("ãŸã ã„ã¾åœ¨åº«åˆ‡ã‚Œã§ã™");
          el("goBtn").disabled = true;
        }else{
          showErr("");
          el("goBtn").disabled = false;
        }
      }

      el("minusBtn").onclick = ()=>applyQty(Number(qtyInput.value) - 1);
      el("plusBtn").onclick  = ()=>applyQty(Number(qtyInput.value) + 1);
      qtyInput.onblur = ()=>applyQty(qtyInput.value);

      el("goBtn").onclick = ()=>{
        const q = clampInt(qtyInput.value, 1, (Number.isFinite(stock) ? Math.max(stock,1) : Infinity));
        if(stock === 0) return;

        // âœ… ç¦ç®±å°‚ç”¨ï¼šã‚«ãƒ¼ãƒˆã‚’ç¦ç®±ã ã‘ã«ã™ã‚‹ï¼ˆæ··è¼‰ã•ã›ãªã„ï¼‰
        saveCartOnlyFuku(FUKU_ID, q);

        // âœ… ã‚ãªãŸã® confirm.html ã¸
        location.href = "/confirm.html?from=fukubako";
      };

      el("backBtn").onclick = ()=>{
        // LIFFå†…ãªã‚‰é–‰ã˜ã‚‹ã€ãƒ–ãƒ©ã‚¦ã‚¶ãªã‚‰æˆ»ã‚‹
        try{
          if(window.liff && liff.isInClient()){
            liff.closeWindow();
            return;
          }
        }catch(e){}
        history.back();
      };

      applyQty(qtyInput.value);

    }catch(e){
      showErr("èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆ/api/products ã‚’ç¢ºèªï¼‰");
      el("goBtn").disabled = true;
    }
  })();

})();
</script>
</body>
</html>
