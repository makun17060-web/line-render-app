<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ç¦ç®±ï¼ˆãŠæ¥½ã—ã¿ç®±ï¼‰</title>

  <!-- LIFF SDKï¼ˆLIFFå†…ã§é–‹ãæƒ³å®šï¼‰ -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root{
      --bg:#f6f7f9; --card:#fff; --text:#111827; --muted:#6b7280;
      --line:#e5e7eb; --pri:#7a1f1f; --pri2:#0b3a53; --danger:#b91c1c;
      --shadow:0 1px 3px rgba(0,0,0,.06); --radius:14px;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:system-ui,-apple-system,"Segoe UI",sans-serif; background:var(--bg); color:var(--text); }
    .wrap{ max-width:860px; margin:0 auto; padding:14px 14px 28px; }
    .hero{
      background:linear-gradient(135deg, rgba(122,31,31,.10), rgba(11,58,83,.08));
      border:1px solid rgba(229,231,235,.8);
      border-radius:18px; padding:14px 14px;
      box-shadow:var(--shadow);
    }
    .title{ font-size:20px; margin:0 0 4px; font-weight:800; letter-spacing:.02em; }
    .sub{ font-size:12px; color:var(--muted); margin:0; line-height:1.6; }
    .badgeRow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .badge{
      font-size:12px; padding:6px 10px; border-radius:999px;
      background:#fff; border:1px solid var(--line); color:#374151;
    }

    .grid{ display:grid; grid-template-columns: 1fr; gap:12px; margin-top:12px; }
    @media(min-width:760px){ .grid{ grid-template-columns: 1.2fr .8fr; } }

    .card{
      background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
      box-shadow:var(--shadow); overflow:hidden;
    }
    .cardHead{ padding:14px; border-bottom:1px solid var(--line); }
    .cardHead h2{ margin:0; font-size:16px; }
    .cardBody{ padding:14px; }

    .img{
      width:100%; aspect-ratio: 16/9;
      background:#f1f5f9; border:1px solid var(--line);
      border-radius:12px; overflow:hidden;
      display:flex; align-items:center; justify-content:center;
      color:#64748b; font-size:12px;
    }
    .img img{ width:100%; height:100%; object-fit:contain; background:#fff; }

    .row{ display:flex; gap:10px; align-items:center; justify-content:space-between; }
    .price{ font-size:22px; font-weight:900; }
    .muted{ color:var(--muted); font-size:12px; }
    .desc{ margin:10px 0 0; font-size:13px; line-height:1.7; color:#374151; }
    .hr{ height:1px; background:var(--line); margin:12px 0; }

    .qtyBox{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px; border:1px solid var(--line); border-radius:12px; background:#fafafa;
    }
    .stepper{ display:flex; align-items:center; gap:8px; }
    .btnIcon{
      width:38px; height:38px; border-radius:10px;
      border:1px solid var(--line); background:#fff; cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      font-size:18px; user-select:none;
    }
    .qty{
      width:54px; height:38px; border-radius:10px; border:1px solid var(--line);
      text-align:center; font-size:14px; background:#fff;
    }

    .cta{
      position:sticky; bottom:0; left:0; right:0;
      padding:12px 0 0; margin-top:12px;
    }
    .ctaInner{
      background:rgba(246,247,249,.85);
      backdrop-filter: blur(8px);
      border-top:1px solid rgba(229,231,235,.9);
      padding:12px 0 14px;
    }
    .ctaRow{ display:flex; gap:10px; flex-wrap:wrap; }
    .btn{
      border:none; border-radius:14px; padding:12px 14px; cursor:pointer;
      font-weight:800; font-size:14px;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
    }
    .btnPri{ background:var(--pri); color:#fff; }
    .btnSub{ background:#fff; border:1px solid var(--line); color:#111827; }
    .btnPri:disabled{ opacity:.45; cursor:not-allowed; }
    .err{ color:var(--danger); font-size:12px; margin-top:8px; }
    .ok{ color:#0a7b19; font-size:12px; margin-top:8px; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="hero">
      <h1 class="title">ğŸ ç£¯å±‹ ç¦ç®±ï¼ˆãŠæ¥½ã—ã¿ç®±ï¼‰</h1>
      <p class="sub">
        ãƒ€ãƒ³ãƒœãƒ¼ãƒ«ç®±ã§ãŠå±Šã‘ã™ã‚‹ã€Œç¦è¢‹ã€ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã§ã™ã€‚<br>
        ä¸­èº«ã¯é–‹ã‘ã¦ã‹ã‚‰ã®ãŠæ¥½ã—ã¿ï¼ˆå†…å®¹ã¯æ™‚æœŸãƒ»åœ¨åº«ã§å¤‰ã‚ã‚Šã¾ã™ï¼‰ã€‚
      </p>
      <div class="badgeRow">
        <span class="badge">LINEé™å®š</span>
        <span class="badge">æ•°é‡é™å®š</span>
        <span class="badge">ãªããªã‚Šæ¬¡ç¬¬çµ‚äº†</span>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="cardHead">
          <h2 id="pName">èª­ã¿è¾¼ã¿ä¸­â€¦</h2>
        </div>
        <div class="cardBody">
          <div class="img" id="imgWrap">ç”»åƒãªã—</div>

          <div class="hr"></div>

          <div class="row">
            <div>
              <div class="muted">ä¾¡æ ¼ï¼ˆç¨è¾¼ï¼‰</div>
              <div class="price" id="pPrice">â€”</div>
            </div>
            <div style="text-align:right">
              <div class="muted">åœ¨åº«</div>
              <div style="font-weight:800" id="pStock">â€”</div>
            </div>
          </div>

          <p class="desc" id="pDesc">
            â€”
          </p>

          <div class="hr"></div>

          <div class="qtyBox">
            <div>
              <div style="font-weight:900">å€‹æ•°</div>
              <div class="muted">1å›ã®æ³¨æ–‡ã§ã¾ã¨ã‚ã¦è²·ãˆã¾ã™</div>
            </div>
            <div class="stepper">
              <button class="btnIcon" id="minusBtn" aria-label="æ¸›ã‚‰ã™">âˆ’</button>
              <input class="qty" id="qtyInput" inputmode="numeric" value="1" />
              <button class="btnIcon" id="plusBtn" aria-label="å¢—ã‚„ã™">ï¼‹</button>
            </div>
          </div>

          <div id="msg" class="muted" style="margin-top:10px;"></div>
          <div id="status" class="err" style="display:none;"></div>
        </div>
      </div>

      <div class="card">
        <div class="cardHead">
          <h2>ã”æ¡ˆå†…</h2>
        </div>
        <div class="cardBody">
          <ul style="margin:0; padding-left:18px; line-height:1.8; color:#374151; font-size:13px;">
            <li>ç®±ï¼ˆãƒ€ãƒ³ãƒœãƒ¼ãƒ«ï¼‰ã§ã®ãŠå±Šã‘ã§ã™ï¼ˆç¦è¢‹ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰ã€‚</li>
            <li>å†…å®¹ã¯å›ºå®šã§ã¯ãªãã€æ™‚æœŸãƒ»åœ¨åº«ã§å¤‰ã‚ã‚Šã¾ã™ã€‚</li>
            <li>ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼è¡¨ç¤ºãªã©ã¯åŒæ¢±ã®è¡¨ç¤ºã‚’ã”ç¢ºèªãã ã•ã„ã€‚</li>
          </ul>
          <div class="hr"></div>
          <div class="muted">
            â€»ã“ã®ãƒšãƒ¼ã‚¸ã¯ã€Œç¦ç®±ã ã‘ã€ã‚’é¸ã¹ã‚‹å°‚ç”¨ãƒšãƒ¼ã‚¸ã§ã™ã€‚
          </div>
        </div>
      </div>
    </div>

    <div class="cta">
      <div class="ctaInner">
        <div class="ctaRow">
          <button class="btn btnPri" id="goConfirmBtn">æ³¨æ–‡å†…å®¹ã‚’ç¢ºèª</button>
          <button class="btn btnSub" id="backBtn">æˆ»ã‚‹</button>
        </div>
        <div class="muted" id="totalLine" style="margin-top:8px;"></div>
      </div>
    </div>
  </div>

  <script>
    // ====== è¨­å®š ======
    const FUKU_ID = "fukubako-2000"; // products.json å´ã® id ã¨ä¸€è‡´ã•ã›ã‚‹
    const CART_KEY = "cart";         // æ—¢å­˜ã® confirm.html ãŒèª­ã‚€ã‚­ãƒ¼ã«åˆã‚ã›ã¦ãã ã•ã„
    const CONFIRM_URL = "/confirm.html"; // æ—¢å­˜ã®ç¢ºèªç”»é¢ã«åˆã‚ã›ã¦å¤‰æ›´OK

    // LIFF: åŒä¸€LIFFå†…ã§å‹•ãæƒ³å®šï¼ˆIDæŒ‡å®šãŒå¿…è¦ãªã‚‰ã“ã“ã‚’å·®ã—æ›¿ãˆï¼‰
    async function initLiffSafe(){
      try{
        if (!window.liff) return;
        // ã™ã§ã«LIFFå†…ãªã‚‰ init ä¸è¦ãªã“ã¨ã‚‚ã‚ã‚Šã¾ã™ï¼ˆç’°å¢ƒã«ã‚ˆã£ã¦OKï¼‰
        // å¿…è¦ãªã‚‰ â†“ ã‚’æœ‰åŠ¹åŒ–ã—ã¦ LIFF ID ã‚’å…¥ã‚Œã¦ãã ã•ã„
        // await liff.init({ liffId: "2008406620-xxxxxxxx" });
      }catch(e){
        // ã“ã“ã§ã¯é»™ã£ã¦é€²ã‚ã‚‹
      }
    }

    function yen(n){
      const x = Number(n || 0);
      return x.toLocaleString("ja-JP") + "å††";
    }

    function setStatus(msg, isError=true){
      const el = document.getElementById("status");
      if(!msg){
        el.style.display = "none";
        el.textContent = "";
        return;
      }
      el.style.display = "block";
      el.className = isError ? "err" : "ok";
      el.textContent = msg;
    }

    function clampQty(q, stock){
      q = Math.floor(Number(q || 1));
      if (!Number.isFinite(q) || q < 1) q = 1;
      if (Number.isFinite(stock) && stock >= 0) q = Math.min(q, Math.max(stock, 1));
      return q;
    }

    function loadCart(){
      try{
        const raw = localStorage.getItem(CART_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch(e){
        return [];
      }
    }

    function saveCart(items){
      try{
        localStorage.setItem(CART_KEY, JSON.stringify(items));
      }catch(e){
        // ä½•ã‚‚ã—ãªã„
      }
    }

    function upsertFukubakoToCart(product, qty){
      const cart = loadCart();
      const next = cart.filter(it => it && it.id !== product.id);
      next.push({
        id: product.id,
        name: product.name,
        price: product.price,
        qty: qty,
        image: product.image || ""
      });
      saveCart(next);
      return next;
    }

    async function fetchProducts(){
      const r = await fetch("/api/products", { cache: "no-store" });
      if(!r.ok) throw new Error("å•†å“æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
      return await r.json();
    }

    function pickFuku(products){
      if (Array.isArray(products)){
        return products.find(p => p && p.id === FUKU_ID) || null;
      }
      // ã‚‚ã— API ãŒ {products:[...]} å½¢å¼ãªã‚‰
      if (products && Array.isArray(products.products)){
        return products.products.find(p => p && p.id === FUKU_ID) || null;
      }
      return null;
    }

    function renderProduct(p){
      document.getElementById("pName").textContent = p.name || "ç¦ç®±";
      document.getElementById("pPrice").textContent = yen(p.price);
      document.getElementById("pDesc").textContent =
        (p.desc && String(p.desc).trim()) ? p.desc :
        "ä¸­èº«ã¯é–‹ã‘ã¦ã‹ã‚‰ã®ãŠæ¥½ã—ã¿ã€‚äººæ°—å•†å“ï¼‹ä¹…åŠ©ï¼‹åº—ä¸»ã‚»ãƒ¬ã‚¯ãƒˆãŒå…¥ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚";
      const stock = (typeof p.stock === "number") ? p.stock : null;
      document.getElementById("pStock").textContent = (stock === null) ? "â€”" : String(stock);

      const wrap = document.getElementById("imgWrap");
      wrap.innerHTML = "";
      if (p.image && String(p.image).trim()){
        const img = document.createElement("img");
        img.alt = p.name || "ç¦ç®±";
        img.src = p.image;
        img.loading = "lazy";
        wrap.appendChild(img);
      }else{
        wrap.textContent = "ç”»åƒãªã—";
      }

      const qtyInput = document.getElementById("qtyInput");
      const q = clampQty(qtyInput.value, stock === null ? Infinity : stock);
      qtyInput.value = String(q);
      updateTotalLine(p, q, stock);
    }

    function updateTotalLine(p, q, stock){
      const total = (Number(p.price||0) * Number(q||0));
      const stockText = (typeof stock === "number") ? `åœ¨åº« ${stock} å€‹` : "åœ¨åº« â€”";
      document.getElementById("totalLine").textContent = `å°è¨ˆï¼š${yen(total)}ï¼ˆ${stockText}ï¼‰`;
    }

    async function main(){
      await initLiffSafe();

      setStatus("");
      document.getElementById("msg").textContent = "";

      let product = null;
      try{
        const products = await fetchProducts();
        product = pickFuku(products);
        if(!product){
          setStatus("ç¦ç®±ã®å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆproducts.json ã« fukubako-2000 ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ï¼‰");
          document.getElementById("goConfirmBtn").disabled = true;
          return;
        }
        renderProduct(product);
      }catch(e){
        setStatus(e && e.message ? e.message : "èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ");
        document.getElementById("goConfirmBtn").disabled = true;
        return;
      }

      const qtyInput = document.getElementById("qtyInput");
      const minusBtn = document.getElementById("minusBtn");
      const plusBtn  = document.getElementById("plusBtn");
      const goBtn    = document.getElementById("goConfirmBtn");
      const backBtn  = document.getElementById("backBtn");

      const stock = (typeof product.stock === "number") ? product.stock : Infinity;

      function applyQty(nextQ){
        const q = clampQty(nextQ, stock);
        qtyInput.value = String(q);
        updateTotalLine(product, q, stock);

        if (stock === 0){
          setStatus("ãŸã ã„ã¾åœ¨åº«åˆ‡ã‚Œã§ã™");
          goBtn.disabled = true;
        } else {
          setStatus("");
          goBtn.disabled = false;
        }
      }

      minusBtn.addEventListener("click", ()=> applyQty(Number(qtyInput.value) - 1));
      plusBtn.addEventListener("click",  ()=> applyQty(Number(qtyInput.value) + 1));
      qtyInput.addEventListener("change", ()=> applyQty(qtyInput.value));
      qtyInput.addEventListener("input", ()=> {
        // å…¥åŠ›é€”ä¸­ã¯è»½ãæ•´å½¢ã ã‘
        const v = qtyInput.value.replace(/[^\d]/g,'');
        qtyInput.value = v || "";
      });
      qtyInput.addEventListener("blur", ()=> applyQty(qtyInput.value));

      goBtn.addEventListener("click", ()=>{
        const q = clampQty(qtyInput.value, stock);
        if (stock === 0) return;

        // ç¦ç®±ã ã‘ã‚’ã‚«ãƒ¼ãƒˆã«å…¥ã‚Œã‚‹ï¼ˆä»–å•†å“ã‚’æ®‹ã—ãŸã„å ´åˆã¯ã“ã“ã‚’å¤‰æ›´ï¼‰
        // ã€Œç¦ç®±å°‚ç”¨ã€ãªã®ã§ â€œç¦ç®±ã®ã¿â€ ã«ã—ãŸæ–¹ãŒãƒˆãƒ©ãƒ–ãƒ«ãŒå°‘ãªã„ã§ã™
        saveCart([]);
        upsertFukubakoToCart(product, q);

        location.href = CONFIRM_URL + "?from=fukubako";
      });

      backBtn.addEventListener("click", async ()=>{
        try{
          if (window.liff && liff.isInClient()){
            liff.closeWindow();
            return;
          }
        }catch(e){}
        history.back();
      });

      // åˆæœŸåœ¨åº«ãƒã‚§ãƒƒã‚¯
      applyQty(qtyInput.value);
    }

    main();
  </script>
</body>
</html>
