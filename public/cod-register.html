<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>お届け先住所の登録</title>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- ✅ LIFF_ID を1か所に集約（public/liff-config.js） -->
  <script src="/liff-config.js"></script>

  <style>
    :root{
      --bg:#f6f7f9;--card:#fff;--text:#111827;--muted:#6b7280;--line:#e5e7eb;
      --pri:#0b3a53;--danger:#b91c1c;
      --shadow:0 1px 3px rgba(0,0,0,.06);--radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:860px;margin:0 auto;padding:14px 14px 26px}
    h1{margin:0 0 6px;font-size:18px}
    .muted{color:var(--muted);font-size:13px;line-height:1.5}
    .err{color:var(--danger);font-weight:900;white-space:pre-line}

    .card{
      background:var(--card);border:1px solid var(--line);border-radius:var(--radius);
      padding:12px;margin-top:12px;box-shadow:var(--shadow)
    }

    .addrBox{
      border:1px solid var(--line);border-radius:14px;padding:10px;background:#fff;
      white-space:pre-line;font-size:13px;
    }

    .grid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
    @media(min-width:760px){ .grid{grid-template-columns:1fr 1fr} }

    label{font-size:12px;color:var(--muted);font-weight:900}
    input[type="text"], select{
      width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);
      font-size:14px;outline:none;background:#fff;
    }

    .btn{
      width:100%;border:none;border-radius:14px;padding:12px 14px;
      font-weight:1000;cursor:pointer;margin-top:10px;
      background:var(--pri);color:#fff;
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .btnSub{background:#fff;border:1px solid var(--line);color:#111827}
    .rowBtns{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
    @media(min-width:760px){ .rowBtns{grid-template-columns:1fr 1fr} }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>お届け先住所の登録</h1>
    <div class="muted" id="status">読み込み中…</div>

    <!-- 住所表示（登録済みの場合） -->
    <div class="card" id="viewCard" style="display:none">
      <div class="muted">登録済みのお届け先住所</div>
      <div class="addrBox" id="viewAddr" style="margin-top:10px"></div>

      <div class="rowBtns">
        <button class="btn" id="useBtn" type="button">この住所で進む</button>
        <button class="btn btnSub" id="editBtn" type="button">住所を編集する</button>
      </div>

      <div class="muted" style="margin-top:8px">
        ※ ご自宅以外にもお届けできます
      </div>
    </div>

    <!-- 住所フォーム（未登録 or 編集時） -->
    <div class="card" id="formCard" style="display:none">
      <div class="muted" id="formTitle">お届け先住所を入力</div>

      <div class="grid">
        <div>
          <label>お名前（お届け先）</label>
          <input id="name" type="text" autocomplete="name" placeholder="例）山田 太郎">
        </div>
        <div>
          <label>電話番号</label>
          <input id="phone" type="text" inputmode="tel" autocomplete="tel" placeholder="例）09012345678">
        </div>

        <div>
          <label>郵便番号</label>
          <input id="postal" type="text" inputmode="numeric" autocomplete="postal-code" placeholder="例）1234567">
        </div>

        <div>
          <label>都道府県</label>
          <input id="prefecture" type="text" autocomplete="address-level1" placeholder="例）愛知県">
        </div>

        <div>
          <label>市区町村</label>
          <input id="city" type="text" autocomplete="address-level2" placeholder="例）名古屋市中区">
        </div>

        <div>
          <label>番地</label>
          <input id="address1" type="text" autocomplete="street-address" placeholder="例）栄1-2-3">
        </div>

        <div style="grid-column:1/-1">
          <label>建物名・部屋番号（任意）</label>
          <input id="address2" type="text" autocomplete="address-line2" placeholder="例）磯屋マンション101">
        </div>

        <div style="grid-column:1/-1">
          <label>メモ（任意）</label>
          <input id="label" type="text" placeholder="例）自宅 / 会社 / 実家 など">
        </div>
      </div>

      <div class="rowBtns">
        <button class="btn" id="saveBtn" type="button">この住所を保存して進む</button>
        <button class="btn btnSub" id="cancelBtn" type="button">キャンセル</button>
      </div>
    </div>

    <div class="card">
      <div class="muted">戻る</div>
      <button class="btn btnSub" id="backBtn" type="button">商品選択に戻る</button>
    </div>
  </div>

<script>
(async function(){
  "use strict";

  const KEY_UID = "isoya_userId";

  const qs = new URLSearchParams(location.search);
  const mode = (qs.get("mode") || "").trim();
  const returnToRaw = (qs.get("returnTo") || "/confirm.html").trim();

  function pickLiffIdByMode(m){
    if(m === "original") return window.LIFF_ID_ORDER_ORIGINAL || window.LIFF_ID_COD || "2008406620-G5j1gjzM";
    if(m === "fukubako") return window.LIFF_ID_ORDER_TRIAL   || window.LIFF_ID_COD || "2008406620-G5j1gjzM";
    if(m === "trial")    return window.LIFF_ID_ORDER_TRIAL   || window.LIFF_ID_COD || "2008406620-G5j1gjzM";
    if(m === "store")    return window.LIFF_ID_ORDER_STORE   || window.LIFF_ID_COD || "2008406620-G5j1gjzM";
    return window.LIFF_ID_ORDER_AKASHA || window.LIFF_ID_COD || "2008406620-G5j1gjzM";
  }

  const LIFF_ID_THIS = pickLiffIdByMode(mode);

  const backTo =
    (mode === "original") ? "/original-set.html"
  : (mode === "fukubako") ? "/fukubako.html"
  : (mode === "trial") ? "/fukubako.html"
  : (mode === "store") ? "/omise.html"
  : "/products.html";

  const status = document.getElementById("status");

  const viewCard = document.getElementById("viewCard");
  const viewAddr = document.getElementById("viewAddr");
  const useBtn   = document.getElementById("useBtn");
  const editBtn  = document.getElementById("editBtn");

  const formCard  = document.getElementById("formCard");
  const formTitle = document.getElementById("formTitle");
  const saveBtn   = document.getElementById("saveBtn");
  const cancelBtn = document.getElementById("cancelBtn");

  const backBtn = document.getElementById("backBtn");

  const el = (id)=>document.getElementById(id);

  let currentAddr = null;

  function showView(){
    if(viewCard) viewCard.style.display = "block";
    if(formCard) formCard.style.display = "none";
  }
  function showForm(titleText){
    if(viewCard) viewCard.style.display = "none";
    if(formCard) formCard.style.display = "block";
    if(formTitle) formTitle.textContent = titleText || "お届け先住所を入力";
  }

  function toMsg(e){
    if(e == null) return "unknown error";
    if(typeof e === "string") return e;
    if(e instanceof Error) return e.message || String(e);
    try { return JSON.stringify(e); } catch { return String(e); }
  }
  function showErr(title, err){
    status.classList.add("err");
    status.textContent = `${title}\n${toMsg(err)}`;
  }

  async function postJson(url, body){
    const r = await fetch(url, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify(body)
    });
    const d = await r.json().catch(()=>({}));
    if(!r.ok) throw new Error(d?.error || ("HTTP "+r.status));
    return d;
  }

  async function getJson(url){
    const r = await fetch(url, { cache:"no-store" });
    const d = await r.json().catch(()=>({}));
    if(!r.ok) throw new Error(d?.error || ("HTTP "+r.status));
    return d;
  }

  // ✅ token expired 対策：失敗したら logout→login
  function isTokenExpiredError(e){
    const msg = (e?.message || String(e||"")).toLowerCase();
    return msg.includes("access token expired") || msg.includes("token expired");
  }
  function reloginHere(){
    try{ if(window.liff && typeof liff.logout==="function") liff.logout(); }catch(e){}
    setTimeout(()=>{
      try{ liff.login({ redirectUri: location.href }); }
      catch(e){ location.href = location.href; }
    }, 250);
  }

  // ✅ 住所画面は “確実にログイン” させる
  async function ensureUserHard(){
    const cached = (localStorage.getItem(KEY_UID) || "").trim();
    if(cached) return cached;

    await liff.init({ liffId: LIFF_ID_THIS });

    if(!liff.isLoggedIn()){
      liff.login({ redirectUri: location.href });
      return null;
    }

    try{
      let uid = null;
      try { uid = liff.getDecodedIDToken()?.sub || null; } catch(e){}
      if(!uid){
        uid = (await liff.getProfile())?.userId || null;
      }

      uid = (uid || "").trim();
      if(uid) localStorage.setItem(KEY_UID, uid);
      return uid || null;
    }catch(e){
      if(isTokenExpiredError(e)){
        status.textContent = "セッション更新中…（再ログインします）";
        reloginHere();
        return null;
      }
      throw e;
    }
  }

  function pickName(obj){
    const candidates = [
      obj?.name,
      obj?.full_name, obj?.fullName,
      obj?.recipient_name, obj?.recipientName,
      obj?.customer_name, obj?.customerName,
      obj?.receiver_name, obj?.receiverName,
      obj?.to_name, obj?.toName,
      obj?.addressee,
    ];
    const s = candidates.find(v => typeof v === "string" && v.trim());
    return (s || "").trim();
  }

  function normalizeAddr(a){
    const name = pickName(a);
    return {
      id: a?.id ?? a?.address_id ?? a?.addressId ?? null,
      name,
      phone: a?.phone ?? "",
      postal: a?.postal ?? a?.zip ?? "",
      prefecture: a?.prefecture ?? a?.pref ?? "",
      city: a?.city ?? "",
      address1: a?.address1 ?? a?.address ?? "",
      address2: a?.address2 ?? "",
      label: a?.label ?? "",
      is_default: a?.is_default === true
    };
  }

  const S = v => (v == null ? "" : String(v));
  function toAddrText(a){
    const nm = pickName(a) || S(a?.name);
    const nameLine = nm ? `${nm}\n` : "";
    const postal = S(a?.postal);
    const pref = S(a?.prefecture);
    const city = S(a?.city);
    const a1 = S(a?.address1);
    const a2 = S(a?.address2);
    const phone = a?.phone ? `\nTEL: ${S(a.phone)}` : "";
    const memo = a?.label ? `\n（${S(a.label)}）` : "";
    return `${nameLine}〒${postal} ${pref}${city}${a1} ${a2}${phone}${memo}`.trim();
  }

  function fillForm(a){
    el("name").value       = pickName(a) || "";
    el("phone").value      = a?.phone || "";
    el("postal").value     = a?.postal || "";
    el("prefecture").value = a?.prefecture || "";
    el("city").value       = a?.city || "";
    el("address1").value   = a?.address1 || "";
    el("address2").value   = a?.address2 || "";
    el("label").value      = a?.label || "";
  }

  function readForm(){
    const name = (el("name").value || "").replace(/[\r\n\t]+/g," ").trim();
    return {
      name,
      phone: (el("phone").value || "").trim(),
      postal: (el("postal").value || "").trim(),
      prefecture: (el("prefecture").value || "").trim(),
      city: (el("city").value || "").trim(),
      address1: (el("address1").value || "").trim(),
      address2: (el("address2").value || "").trim(),
      label: (el("label").value || "").trim(),

      // 互換用：どのカラムでも入るように別名も同梱
      full_name: name,
      recipient_name: name,
      customer_name: name,
      receiver_name: name,
      to_name: name
    };
  }

  // ✅ returnTo 復元 → confirmへ戻るURLを生成（画面には出さない）
  function getReturnToUrl(){
    const raw = (returnToRaw || "").trim();
    let decoded = "";
    try{ decoded = raw ? decodeURIComponent(raw) : ""; }catch(e){ decoded = raw; }
    const url = (decoded || "/confirm.html").trim();
    try{
      return new URL(url, location.origin).toString();
    }catch(e){
      return new URL("/confirm.html", location.origin).toString();
    }
  }

  function buildReturnUrl(){
    const u = new URL(getReturnToUrl());
    u.searchParams.set("addr_step", "1");
    if(mode) u.searchParams.set("mode", mode);
    return u.toString();
  }

  function openInternal(url){
    try{
      if(window.liff && typeof liff.isInClient==="function" && liff.isInClient()){
        liff.openWindow({ url, external:false });
        return;
      }
    }catch(e){}
    location.replace(url);
  }

  function goNext(){
    const url = buildReturnUrl();
    openInternal(url);
  }

  async function loadAddress(uid){
    // 1) list：default優先
    try{
      const d = await getJson(`/api/address/list?userId=${encodeURIComponent(uid)}`);
      const rows = Array.isArray(d?.addresses) ? d.addresses : (Array.isArray(d?.list) ? d.list : []);
      if(rows.length > 0){
        const addrs = rows.map(normalizeAddr);
        const chosen = addrs.find(x=>x.is_default) || addrs[0];
        return chosen || null;
      }
    }catch(e){}

    // 2) get：単一
    try{
      const d = await getJson(`/api/address/get?userId=${encodeURIComponent(uid)}`);
      const raw = d?.address || d?.addr || d?.data?.address || null;
      if(raw) return normalizeAddr(raw);
    }catch(e){}

    return null;
  }

  async function saveAddress(uid){
    const a = readForm();

    if(!a.name || !a.phone || !a.postal || !a.prefecture || !a.city || !a.address1){
      alert("お名前/電話番号/郵便番号/都道府県/市区町村/番地 は必須です。");
      return;
    }

    saveBtn.disabled = true;
    saveBtn.textContent = "保存中…";

    try{
      const payload = {
        userId: uid,
        id: currentAddr?.id || null,
        ...a,
        address: { id: currentAddr?.id || null, ...a }
      };

      await postJson("/api/address/set", payload);
      goNext();
    }catch(e){
      alert("住所の保存に失敗しました: " + toMsg(e));
      saveBtn.disabled = false;
      saveBtn.textContent = "この住所を保存して進む";
    }
  }

  try{
    const uid = await ensureUserHard();
    if(!uid){
      status.textContent = "LIFFログイン中…";
      return;
    }

    currentAddr = await loadAddress(uid);

    if(!currentAddr){
      status.textContent = "お届け先住所を登録してください。";
      fillForm(null);
      showForm("お届け先住所を入力");
      if(cancelBtn) cancelBtn.style.display = "none";
    }else{
      status.textContent = "お届け先住所は登録済みです。";
      viewAddr.textContent = toAddrText(currentAddr);
      showView();
      if(cancelBtn) cancelBtn.style.display = "";
    }

    if(useBtn) useBtn.onclick = ()=>goNext();

    if(editBtn) editBtn.onclick = ()=>{
      fillForm(currentAddr);
      showForm("お届け先住所を編集");
    };

    if(cancelBtn) cancelBtn.onclick = ()=>{
      if(currentAddr){
        viewAddr.textContent = toAddrText(currentAddr);
        showView();
      }else{
        showForm("お届け先住所を入力");
      }
    };

    if(saveBtn) saveBtn.onclick = ()=>saveAddress(uid);

    if(backBtn){
      backBtn.onclick = ()=>{
        const u = new URL(backTo, location.origin).toString();
        openInternal(u);
      };
    }

  }catch(e){
    showErr("読み込みに失敗しました（住所API/LIFF設定を確認）", e);
    setTimeout(()=>location.replace(backTo), 1200);
  }
})();
</script>
</body>
</html>
