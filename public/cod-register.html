<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>住所登録</title>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root{
      --bg:#f7f7f7; --card:#fff; --text:#111827; --muted:#6b7280;
      --pri:#0b3a53; --border:#e5e7eb; --radius:14px;
    }
    body{
      margin:0; font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
      background:var(--bg); color:var(--text);
    }
    .wrap{ max-width:720px; margin:0 auto; padding:14px 14px 28px; }
    h1{ font-size:18px; margin:0 0 6px; }
    .muted{ color:var(--muted); font-size:13px; }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:14px;
      margin-top:12px;
    }
    label{ font-size:13px; font-weight:700; display:block; margin-top:10px; }
    input{
      width:100%; padding:10px;
      border-radius:10px; border:1px solid var(--border);
      font-size:15px;
    }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .btn{
      margin-top:14px;
      width:100%; padding:14px;
      border-radius:14px; border:none;
      background:var(--pri); color:#fff;
      font-weight:900; font-size:16px;
      cursor:pointer;
    }
    .btnSub{
      background:#fff; color:var(--text);
      border:1px solid var(--border);
    }
  </style>
</head>

<body>
<div class="wrap">
  <h1>住所登録</h1>
  <div class="muted">初回のみ入力が必要です</div>

  <div class="card">
    <label>お名前</label>
    <input id="name">

    <label>電話番号</label>
    <input id="phone">

    <label>郵便番号</label>
    <input id="postal">

    <label>都道府県</label>
    <input id="prefecture">

    <label>市区町村</label>
    <input id="city">

    <label>番地</label>
    <input id="address1">

    <label>建物名など</label>
    <input id="address2">

    <button class="btn" id="saveBtn">保存する</button>
    <button class="btn btnSub" id="backBtn">戻る</button>
  </div>
</div>

<script>
(async function(){
  "use strict";

  /* ===== 住所登録用 LIFF（固定） ===== */
  const LIFF_ID = "2008406620-4kyQVyqe";

  const qs = new URLSearchParams(location.search);
  const returnTo = qs.get("returnTo");

  /* ===== LIFF init ===== */
  try{
    await liff.init({ liffId: LIFF_ID });

    if(!liff.isLoggedIn()){
      liff.login({ redirectUri: location.href });
      return;
    }
  }catch(e){
    alert("LIFF初期化に失敗しました（住所登録）");
    console.error(e);
    return;
  }

  const prof = await liff.getProfile();
  const userId = prof?.userId;
  if(!userId){
    alert("userIdを取得できませんでした");
    return;
  }

  /* ===== DOM ===== */
  const $ = id => document.getElementById(id);

  /* ===== 既存住所取得 ===== */
  try{
    const r = await fetch(`/api/address/get?userId=${encodeURIComponent(userId)}`);
    const d = await r.json();
    if(d.ok && d.address){
      const a = d.address;
      $("name").value = a.name || "";
      $("phone").value = a.phone || "";
      $("postal").value = a.postal || "";
      $("prefecture").value = a.prefecture || "";
      $("city").value = a.city || "";
      $("address1").value = a.address1 || "";
      $("address2").value = a.address2 || "";
    }
  }catch{}

  /* ===== 保存 ===== */
  $("saveBtn").onclick = async () => {
    const body = {
      userId,
      name: $("name").value.trim(),
      phone: $("phone").value.trim(),
      postal: $("postal").value.trim(),
      prefecture: $("prefecture").value.trim(),
      city: $("city").value.trim(),
      address1: $("address1").value.trim(),
      address2: $("address2").value.trim(),
    };

    const r = await fetch("/api/address/set", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });
    const d = await r.json().catch(()=>({}));

    if(!r.ok || !d.ok){
      alert("保存に失敗しました");
      return;
    }

    if(returnTo) location.href = returnTo;
    else liff.closeWindow();
  };

  $("backBtn").onclick = () => {
    if(returnTo) location.href = returnTo;
    else liff.closeWindow();
  };
})();
</script>
</body>
</html>
