<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>商品一覧（直接注文）</title>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",sans-serif;background:#f6f6f6;margin:0;padding:14px}
    .wrap{max-width:980px;margin:0 auto}
    h1{font-size:18px;margin-bottom:10px}
    .card{background:#fff;border-radius:12px;padding:12px;margin:10px 0}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
    .item{border:1px solid #eee;border-radius:12px;padding:10px}
    .img{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:10px}
    button{width:100%;margin-top:8px;padding:10px;border:0;border-radius:10px;background:#06c755;color:#fff}
    .muted{font-size:12px;color:#666}
  </style>
</head>

<body>
<div class="wrap">
  <h1>商品一覧（直接注文）</h1>

  <div class="card">
    <div id="status" class="muted">LIFF 初期化中…</div>
  </div>

  <div class="card">
    <div id="grid" class="grid"></div>
  </div>
</div>

<script>
(async () => {
  const status = (t) => document.getElementById("status").textContent = t;

  try {
    // ★ server-line.js から正しい LIFF_ID を取得
    const cfgRes = await fetch("/api/liff/config?kind=order");
    const cfg = await cfgRes.json();
const LIFF_ID ="2008406620-G5j1gjzM";
    await liff.init({ liffId: cfg.liffId });

    status(
      `LIFF OK / inClient=${liff.isInClient()} / OS=${liff.getOS()}`
    );

    if (!liff.isLoggedIn()) liff.login();

    // 商品一覧取得
    const res = await fetch("/api/products");
    const data = await res.json();

    const grid = document.getElementById("grid");
    grid.innerHTML = "";

    data.products.forEach(p => {
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <img class="img" src="${p.image || ''}">
        <div><b>${p.name}</b></div>
        <div>${p.price}円</div>
        <button onclick="sendDirect()">直接注文</button>
      `;
      grid.appendChild(div);
    });

    window.sendDirect = async () => {
      if (!liff.isInClient()) {
        alert("LINEアプリ内で開いてください");
        return;
      }
      await liff.sendMessages([{ type: "text", text: "直接注文" }]);
      liff.closeWindow();
    };

  } catch (e) {
    status("LIFF 初期化エラー: " + (e.message || e));
  }
})();
</script>
</body>
</html>
