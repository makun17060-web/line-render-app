<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>注文管理（発送通知・納品書印刷付き）</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #f5f5f5;
      color: #333;
    }
    h1 {
      margin: 0 0 8px;
      font-size: 20px;
    }
    .card {
      background: #fff;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }
    .row > div {
      flex: 1;
      min-width: 140px;
    }
    label {
      font-size: 12px;
      display: block;
      margin-bottom: 2px;
    }
    input[type="text"],
    input[type="number"] {
      width: 100%;
      box-sizing: border-box;
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 13px;
    }
    .btn {
      display: inline-block;
      padding: 6px 10px;
      font-size: 13px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
    }
    .btn-primary {
      background: #1976d2;
      color: #fff;
    }
    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }
    .btn-sm {
      font-size: 12px;
      padding: 4px 8px;
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: default;
    }
    #status {
      font-size: 12px;
      margin-top: 4px;
      min-height: 16px;
    }
    #status.err {
      color: #d32f2f;
    }
    #status.ok {
      color: #2e7d32;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 4px 6px;
      vertical-align: top;
    }
    th {
      background: #fafafa;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .table-wrap {
      max-height: 70vh;
      overflow: auto;
      border-radius: 8px;
      border: 1px solid #ddd;
      background: #fff;
    }
    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
    }
    .nowrap {
      white-space: nowrap;
    }
    .badge {
      display: inline-block;
      padding: 1px 4px;
      border-radius: 3px;
      font-size: 10px;
      background: #eee;
      margin-right: 4px;
    }
  </style>
</head>
<body>
  <h1>注文管理（Stripe / 直接注文 共通）</h1>

  <div class="card">
    <div class="row">
      <div>
        <label>管理APIトークン（ADMIN_API_TOKEN または ADMIN_CODE）</label>
        <input id="token" type="text" placeholder="例）abcdef123..." />
      </div>
      <div>
        <label>日付（任意・YYYYMMDD）</label>
        <input id="date" type="text" placeholder="例）20251210" />
      </div>
      <div>
        <label>最大件数</label>
        <input id="limit" type="number" value="200" min="1" max="5000" />
      </div>
    </div>
    <div class="row">
      <div>
        <button id="loadBtn" class="btn btn-primary">注文を読み込む</button>
      </div>
    </div>
    <div id="status"></div>
  </div>

  <div class="card">
    <div style="font-size: 12px; margin-bottom: 4px;">
      ※発送通知ボタンを押すと、その注文のLINEユーザーに「発送しました」メッセージを送信します。<br>
      ※ボタンを押した行は「通知済み」に変わり、2回目以降は押せません（再読み込みするとリセットされます）。<br>
      ※「納品書印刷」ボタンから、ロゴ入りの納品書をA4で印刷できます。
    </div>
  </div>

  <div class="table-wrap">
    <table id="ordersTable">
      <thead>
        <tr>
          <th>日時</th>
          <th>ユーザー</th>
          <th>内容</th>
          <th>金額</th>
          <th>住所</th>
          <th>受取/支払</th>
          <th>発送</th>
        </tr>
      </thead>
      <tbody id="ordersTbody">
        <tr><td colspan="7" style="text-align:center; padding:8px;">注文を読み込んでください</td></tr>
      </tbody>
    </table>
  </div>

  <script>
    (function () {
      "use strict";

      const tokenInput = document.getElementById("token");
      const dateInput  = document.getElementById("date");
      const limitInput = document.getElementById("limit");
      const loadBtn    = document.getElementById("loadBtn");
      const statusEl   = document.getElementById("status");
      const tbody      = document.getElementById("ordersTbody");

      function setStatus(msg, kind) {
        statusEl.textContent = msg || "";
        statusEl.classList.remove("err", "ok");
        if (kind === "err") statusEl.classList.add("err");
        if (kind === "ok")  statusEl.classList.add("ok");
      }

      function escapeHtml(str) {
        return String(str || "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function formatTs(ts) {
        if (!ts) return "";
        const d = new Date(ts);
        if (isNaN(d.getTime())) return ts;
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const da = String(d.getDate()).padStart(2, "0");
        const h = String(d.getHours()).padStart(2, "0");
        const mi = String(d.getMinutes()).padStart(2, "0");
        return `${y}/${m}/${da} ${h}:${mi}`;
      }

      // 金額計算を共通化（管理画面表示 / 納品書で使用）
      function calcAmounts(order) {
        const itemsTotal = Number(order.itemsTotal ?? order.subtotal ?? order.total ?? 0);
        const shipping   = Number(order.shipping ?? 0);
        const codFee     = Number(order.codFee ?? 0);
        const finalTotal = Number(order.finalTotal ?? order.total ?? (itemsTotal + shipping + codFee));
        return { itemsTotal, shipping, codFee, finalTotal };
      }

      // 商品明細を文字列配列に整形（管理画面表示 / 納品書で使用）
      function buildItemLines(order) {
        const lines = [];
        if (Array.isArray(order.items) && order.items.length > 0) {
          order.items.forEach((it) => {
            const name  = it.name || it.productName || it.id || "商品";
            const qty   = it.qty || it.quantity || 1;
            const price = Number(it.price || 0);
            const lineTotal = price * qty;
            lines.push({ name, qty, price, lineTotal });
          });
        } else {
          const name  = order.productName || order.productId || "商品";
          const qty   = order.qty || 1;
          const price = Number(order.price || 0);
          const lineTotal = price * qty;
          lines.push({ name, qty, price, lineTotal });
        }
        return lines;
      }

      function renderOrders(items) {
        tbody.innerHTML = "";
        if (!items || items.length === 0) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 7;
          td.style.textAlign = "center";
          td.style.padding = "8px";
          td.textContent = "該当する注文はありません。";
          tr.appendChild(td);
          tbody.appendChild(tr);
          return;
        }

        items.forEach((order, idx) => {
          const tr = document.createElement("tr");

          // 日時
          const tdTs = document.createElement("td");
          tdTs.className = "nowrap";
          tdTs.textContent = formatTs(order.ts || order.timestamp);
          tr.appendChild(tdTs);

          // ユーザー
          const tdUser = document.createElement("td");
          const uid = order.userId || order.lineUserId || "";
          const uname = order.lineUserName || "";
          tdUser.innerHTML =
            `<div class="mono">${escapeHtml(uid || "(不明)")}</div>` +
            (uname ? `<div>${escapeHtml(uname)}</div>` : "");
          tr.appendChild(tdUser);

          // 内容（商品一覧）
          const tdItems = document.createElement("td");
          const itemLines = buildItemLines(order);
          const linesStr = itemLines.map((it) => {
            return `・${it.name} x ${it.qty} = ${it.price.toLocaleString("ja-JP")}円`;
          });

          if (order.orderNumber) {
            linesStr.push(`注文番号：${order.orderNumber}`);
          }

          tdItems.innerHTML = linesStr.map(escapeHtml).join("<br>");
          tr.appendChild(tdItems);

          // 金額
          const tdAmount = document.createElement("td");
          const { itemsTotal, shipping, codFee, finalTotal } = calcAmounts(order);
          tdAmount.innerHTML =
            `商品：${itemsTotal.toLocaleString("ja-JP")}円<br>` +
            `送料：${shipping.toLocaleString("ja-JP")}円<br>` +
            `代引：${codFee.toLocaleString("ja-JP")}円<br>` +
            `<strong>合計：${finalTotal.toLocaleString("ja-JP")}円</strong>`;
          tr.appendChild(tdAmount);

          // 住所
          const tdAddr = document.createElement("td");
          const a = order.address || {};
          if (a && (a.postal || a.zip || a.prefecture || a.pref || a.address1 || a.addr1)) {
            const zip = a.postal || a.zip || "";
            const pref = a.prefecture || a.pref || "";
            const city = a.city || "";
            const addr1 = a.address1 || a.addr1 || "";
            const addr2 = a.address2 || a.addr2 || "";
            const name = (a.lastName || "") + (a.firstName || "") || a.name || "";
            const tel  = a.tel || a.phone || "";

            tdAddr.innerHTML =
              `${escapeHtml(zip)}<br>` +
              `${escapeHtml(pref + city + addr1)}<br>` +
              (addr2 ? `${escapeHtml(addr2)}<br>` : "") +
              (name ? `氏名：${escapeHtml(name)}<br>` : "") +
              (tel ? `TEL：${escapeHtml(tel)}` : "");
          } else {
            tdAddr.textContent = "（住所情報なし）";
          }
          tr.appendChild(tdAddr);

          // 受取/支払
          const tdMeta = document.createElement("td");
          const method  = order.method || "";
          const payment = order.payment || "";
          const region  = order.region || "";
          const tags = [];
          if (method) tags.push(`受取：${method}${region ? "（" + region + "）" : ""}`);
          if (payment) tags.push(`支払：${payment}`);
          if (order.source) tags.push(`src：${order.source}`);
          tdMeta.innerHTML = tags.map((t) => `<div class="badge">${escapeHtml(t)}</div>`).join("<br>");
          tr.appendChild(tdMeta);

          // 発送・印刷
          const tdNotify = document.createElement("td");

          // 発送通知ボタン
          const btn = document.createElement("button");
          btn.type = "button";
          btn.textContent = "発送通知";
          btn.className = "btn btn-sm btn-primary";
          btn.setAttribute("data-idx", String(idx));
          btn.setAttribute("data-user-id", uid);
          btn.setAttribute("data-product-name", (order.productName || (Array.isArray(order.items) && order.items[0]?.name) || ""));
          btn.setAttribute("data-order-number", order.orderNumber || "");
          btn.setAttribute("data-notified", "0"); // ★ 最初は未通知

          btn.addEventListener("click", () => {
            if (btn.disabled || btn.getAttribute("data-notified") === "1") return;
            const idxNum = Number(btn.getAttribute("data-idx") || "0");
            const userId = btn.getAttribute("data-user-id") || "";
            const productName = btn.getAttribute("data-product-name") || "";
            const orderNumber = btn.getAttribute("data-order-number") || "";

            onClickNotifyShipped(items[idxNum], { userId, productName, orderNumber }, btn);
          });

          tdNotify.appendChild(btn);

          // 納品書印刷ボタン
          const printBtn = document.createElement("button");
          printBtn.type = "button";
          printBtn.textContent = "納品書印刷";
          printBtn.className = "btn btn-sm btn-secondary";
          printBtn.style.display = "block";
          printBtn.style.marginTop = "4px";

          printBtn.addEventListener("click", () => {
            printInvoice(order);
          });

          tdNotify.appendChild(printBtn);

          tr.appendChild(tdNotify);
          tbody.appendChild(tr);
        });
      }

      async function loadOrders() {
        const token = (tokenInput.value || "").trim();
        if (!token) {
          setStatus("管理APIトークンを入力してください。", "err");
          return;
        }

        const date = (dateInput.value || "").trim();
        const limit = Number(limitInput.value || 200) || 200;

        let url = `/api/admin/orders?limit=${encodeURIComponent(limit)}`;
        if (date) {
          url += `&date=${encodeURIComponent(date)}`;
        }
        url += `&token=${encodeURIComponent(token)}`;

        try {
          setStatus("読み込み中です…", "");
          const res = await fetch(url);
          const data = await res.json().catch(() => ({}));
          if (!res.ok || !data.ok) {
            console.error("/api/admin/orders error:", data);
            setStatus("注文の取得に失敗しました。トークンやURLを確認してください。", "err");
            return;
          }
          const items = Array.isArray(data.items) ? data.items : [];
          setStatus(`注文を ${items.length} 件読み込みました。`, "ok");
          renderOrders(items);
        } catch (e) {
          console.error("loadOrders error:", e);
          setStatus("通信エラーで注文を取得できませんでした。", "err");
        }
      }

      async function onClickNotifyShipped(order, ctx, btn) {
        const token = (tokenInput.value || "").trim();
        if (!token) {
          setStatus("管理APIトークンを入力してください。", "err");
          return;
        }

        const userId      = ctx.userId      || order.userId || order.lineUserId || "";
        const productName = ctx.productName || order.productName || (Array.isArray(order.items) && order.items[0]?.name) || "";
        const orderNumber = ctx.orderNumber || order.orderNumber || "";

        if (!userId) {
          alert("ユーザーIDが不明なため、発送通知を送れません。");
          return;
        }

        if (!confirm(`この注文者（${userId}）に「発送しました」通知を送信しますか？`)) {
          return;
        }

        try {
          setStatus("発送通知を送信中です…", "");
          const res = await fetch("/api/admin/orders/notify-shipped", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${token}`,
            },
            body: JSON.stringify({
              userId,
              productName,
              orderNumber,
            }),
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok || !data.ok) {
            console.error("notify-shipped error:", data);
            setStatus("発送通知の送信に失敗しました。", "err");
            alert("発送通知の送信に失敗しました。");
            return;
          }

          btn.textContent = "通知済み";
          btn.disabled = true;
          btn.classList.remove("btn-primary");
          btn.classList.add("btn-secondary");
          btn.setAttribute("data-notified", "1");

          setStatus("発送通知を送信しました。", "ok");
        } catch (e) {
          console.error("notify-shipped error:", e);
          setStatus("通信エラーにより発送通知を送信できませんでした。", "err");
          alert("通信エラーにより発送通知を送信できませんでした。");
        }
      }

      // ★ 納品書専用レイアウト（ロゴ付き）印刷
      function printInvoice(order) {
        const ts  = formatTs(order.ts || order.timestamp);
        const no  = order.orderNumber || "";
        const uid = order.userId || order.lineUserId || "";
        const uname = order.lineUserName || "";

        const { itemsTotal, shipping, codFee, finalTotal } = calcAmounts(order);
        const itemLines = buildItemLines(order);

        const a = order.address || {};
        const postal = a.postal || a.zip || "";
        const pref   = a.prefecture || a.pref || "";
        const city   = a.city || "";
        const addr1  = a.address1 || a.addr1 || "";
        const addr2  = a.address2 || a.addr2 || "";
        const name   = (a.lastName || "") + (a.firstName || "") || a.name || "";
        const tel    = a.tel || a.phone || "";

        let methodText = "";
        if (order.method === "pickup") {
          methodText = "店頭受取（送料 0円）";
        } else if (order.method === "delivery") {
          methodText = `宅配（${order.region || ""}）`;
        } else {
          methodText = order.method || "";
        }

        let paymentText = "";
        if (order.payment === "cod") {
          paymentText = "代金引換";
        } else if (order.payment === "bank") {
          paymentText = "銀行振込";
        } else if (order.payment === "cash") {
          paymentText = "現金";
        } else {
          paymentText = order.payment || "";
        }

        const win = window.open("", "_blank");
        if (!win) {
          alert("ポップアップがブロックされました。ブラウザの設定を確認してください。");
          return;
        }

        // ここを書き換えれば店名・住所などを変更できます
        const shopName = "手造りえびせんべい 磯屋";
        const shopInfoLines = [
          "〒000-0000 ○○県○○市○○町0-0-0",
          "TEL: 000-000-0000",
          "営業時間: 10:00〜18:00（火曜定休）"
        ];

        const itemRowsHtml = itemLines.map((it) => {
          return `
            <tr>
              <td>${escapeHtml(it.name)}</td>
              <td class="num">${it.qty}</td>
              <td class="num">${it.price.toLocaleString("ja-JP")}円</td>
              <td class="num">${it.lineTotal.toLocaleString("ja-JP")}円</td>
            </tr>
          `;
        }).join("");

        const invoiceHtml = `
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>納品書</title>
  <style>
    @page {
      size: A4;
      margin: 15mm;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #333;
      margin: 0;
      padding: 0;
    }
    .invoice {
      width: 100%;
      box-sizing: border-box;
    }
    .invoice-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }
    .invoice-logo {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .invoice-logo img {
      height: 40px;
    }
    .invoice-logo-text {
      font-size: 20px;
      font-weight: bold;
    }
    .invoice-shop {
      text-align: right;
      font-size: 11px;
      line-height: 1.6;
    }
    .invoice-title {
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      margin: 12px 0 16px;
      letter-spacing: 0.2em;
    }
    .invoice-meta {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      margin-bottom: 8px;
    }
    .invoice-meta div {
      margin-bottom: 2px;
    }
    .address-block {
      border: 1px solid #000;
      padding: 8px 10px;
      font-size: 12px;
      margin-bottom: 16px;
    }
    .address-label {
      font-size: 11px;
      margin-bottom: 4px;
    }
    .address-main {
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 4px;
    }
    .address-sub {
      font-size: 13px;
    }
    .items-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-bottom: 12px;
    }
    .items-table th,
    .items-table td {
      border: 1px solid #000;
      padding: 4px 6px;
    }
    .items-table th {
      background: #f0f0f0;
    }
    .items-table .num {
      text-align: right;
      white-space: nowrap;
    }
    .amounts {
      width: 50%;
      margin-left: auto;
      font-size: 12px;
      border-collapse: collapse;
    }
    .amounts td {
      padding: 2px 4px;
    }
    .amounts .label {
      text-align: right;
      width: 50%;
    }
    .amounts .value {
      text-align: right;
      width: 50%;
      white-space: nowrap;
    }
    .amounts .total {
      font-weight: bold;
      border-top: 1px solid #000;
      padding-top: 4px;
      margin-top: 4px;
    }
    .footer-note {
      font-size: 11px;
      margin-top: 18px;
      border-top: 1px dashed #999;
      padding-top: 6px;
    }
  </style>
</head>
<body>
  <div class="invoice">
    <div class="invoice-header">
      <div class="invoice-logo">
        <!-- ロゴ画像のパスは環境に合わせて変更してください -->
        <img src="/public/logo-isoya.png" alt="磯屋ロゴ" onerror="this.style.display='none'">
        <div class="invoice-logo-text">${escapeHtml(shopName)}</div>
      </div>
      <div class="invoice-shop">
        ${shopInfoLines.map(l => escapeHtml(l)).join("<br>")}
      </div>
    </div>

    <div class="invoice-title">納　品　書</div>

    <div class="invoice-meta">
      <div>
        <div>ご注文日時：${escapeHtml(ts)}</div>
        ${no ? `<div>注文番号：${escapeHtml(no)}</div>` : ""}
      </div>
      <div style="text-align:right;">
        <div>お客様ID：${escapeHtml(uid || "(不明)")}</div>
        ${uname ? `<div>お名前（LINE）：${escapeHtml(uname)}</div>` : ""}
      </div>
    </div>

    <div class="address-block">
      <div class="address-label">お届け先</div>
      <div class="address-main">
        ${name ? escapeHtml(name) + " 様" : "（お名前未登録）"}
      </div>
      <div class="address-sub">
        ${postal ? "〒" + escapeHtml(postal) + "<br>" : ""}
        ${escapeHtml(pref + city + addr1)}${addr2 ? "<br>" + escapeHtml(addr2) : ""}<br>
        ${tel ? "TEL：" + escapeHtml(tel) : ""}
      </div>
    </div>

    <table class="items-table">
      <thead>
        <tr>
          <th>商品名</th>
          <th style="width:60px;">数量</th>
          <th style="width:80px;">単価</th>
          <th style="width:90px;">金額</th>
        </tr>
      </thead>
      <tbody>
        ${itemRowsHtml || `<tr><td colspan="4" style="text-align:center;">商品情報なし</td></tr>`}
      </tbody>
    </table>

    <table class="amounts">
      <tr>
        <td class="label">商品合計</td>
        <td class="value">${itemsTotal.toLocaleString("ja-JP")}円</td>
      </tr>
      <tr>
        <td class="label">送料</td>
        <td class="value">${shipping.toLocaleString("ja-JP")}円</td>
      </tr>
      <tr>
        <td class="label">代引き手数料</td>
        <td class="value">${codFee.toLocaleString("ja-JP")}円</td>
      </tr>
      <tr>
        <td class="label total">総合計</td>
        <td class="value total">${finalTotal.toLocaleString("ja-JP")}円</td>
      </tr>
    </table>

    <div class="footer-note">
      受取方法：${escapeHtml(methodText)}／お支払い：${escapeHtml(paymentText)}<br>
      本書はお客様控えとして大切に保管してください。
    </div>
  </div>

  <script>
    // 自動で印刷ダイアログを開く
    window.onload = function () {
      window.print();
    };
  </script>
</body>
</html>
        `;

        win.document.open();
        win.document.write(invoiceHtml);
        win.document.close();
      }

      loadBtn.addEventListener("click", (e) => {
        e.preventDefault();
        loadOrders();
      });
    })();
  </script>
</body>
</html>
