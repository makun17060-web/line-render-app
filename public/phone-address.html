<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>住所登録（電話注文・ミニアプリ共通）</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #f7f7f7;
    }
    h1 {
      font-size: 18px;
      margin: 0 0 8px;
    }
    p {
      margin: 0 0 8px;
      font-size: 13px;
      color: #444;
      white-space: pre-line;
    }
    form {
      background: #fff;
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.06);
      font-size: 14px;
    }
    .field {
      margin-bottom: 10px;
    }
    label {
      display: block;
      font-size: 12px;
      margin-bottom: 4px;
      color: #333;
    }
    input, select {
      width: 100%;
      box-sizing: border-box;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    button {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-primary {
      background: #00c300;
      color: #fff;
    }
    .btn-primary:disabled {
      opacity: 0.7;
      cursor: default;
    }
    .info {
      font-size: 12px;
      color: #555;
      margin-top: 6px;
    }
    .status {
      margin-top: 10px;
      font-size: 13px;
      white-space: pre-line;
    }
    .status.ok {
      color: #007700;
    }
    .status.err {
      color: #c00;
    }

    .user-id-row {
      margin-bottom: 10px;
      padding: 8px;
      border-radius: 4px;
      background: #fafafa;
      border: 1px dashed #ddd;
    }
    .user-id-row small {
      display: block;
      font-size: 11px;
      color: #666;
      margin-top: 2px;
    }
    .tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      background: #e5f6ff;
      color: #0369a1;
      font-size: 11px;
      margin-left: 4px;
    }
  </style>
  <!-- LIFF SDK（ミニアプリで使う） -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <header>
    <h1>住所登録</h1>
    <p>
電話の代引き注文・ミニアプリのどちらでも
共通で使えるお届け先住所を登録します。
    </p>
  </header>

  <!-- 通常ブラウザ用：手動で userId を入れたい場合に使う欄（LIFFでは自動で隠す） -->
  <div id="userIdRow" class="user-id-row" style="display:none;">
    <label for="userIdInput">
      ユーザーID（LINEの userId）<span class="tag">上級者向け</span>
    </label>
    <input id="userIdInput" type="text" placeholder="例：Uxxxxxxxxxxxxxxxxxxxx" />
    <small>
       通常は LINE アプリ内（ミニアプリ）から開くと自動取得されます。<br>
       PC などから登録する場合だけ、手動で userId を入れてください。
    </small>
  </div>

  <form id="addressForm">
    <div class="field">
      <label for="name">お名前</label>
      <input id="name" type="text" autocomplete="name" required />
    </div>

    <div class="field">
      <label for="phone">電話番号（ハイフンなし）</label>
      <input id="phone" type="tel" inputmode="numeric" pattern="[0-9]+" required />
      <div class="info">実際にお電話をかけてくださる番号を入力してください。</div>
    </div>

    <div class="field">
      <label for="postal">郵便番号（ハイフンなし）</label>
      <input id="postal" type="tel" inputmode="numeric" pattern="[0-9]*" />
    </div>

    <div class="field">
      <label for="prefecture">都道府県</label>
      <select id="prefecture" required>
        <option value="">選択してください</option>
        <option>北海道</option>
        <option>青森県</option>
        <option>岩手県</option>
        <option>宮城県</option>
        <option>秋田県</option>
        <option>山形県</option>
        <option>福島県</option>
        <option>茨城県</option>
        <option>栃木県</option>
        <option>群馬県</option>
        <option>埼玉県</option>
        <option>千葉県</option>
        <option>東京都</option>
        <option>神奈川県</option>
        <option>新潟県</option>
        <option>富山県</option>
        <option>石川県</option>
        <option>福井県</option>
        <option>山梨県</option>
        <option>長野県</option>
        <option>岐阜県</option>
        <option>静岡県</option>
        <option>愛知県</option>
        <option>三重県</option>
        <option>滋賀県</option>
        <option>京都府</option>
        <option>大阪府</option>
        <option>兵庫県</option>
        <option>奈良県</option>
        <option>和歌山県</option>
        <option>鳥取県</option>
        <option>島根県</option>
        <option>岡山県</option>
        <option>広島県</option>
        <option>山口県</option>
        <option>徳島県</option>
        <option>香川県</option>
        <option>愛媛県</option>
        <option>高知県</option>
        <option>福岡県</option>
        <option>佐賀県</option>
        <option>長崎県</option>
        <option>熊本県</option>
        <option>大分県</option>
        <option>宮崎県</option>
        <option>鹿児島県</option>
        <option>沖縄県</option>
      </select>
    </div>

    <div class="field">
      <label for="city">市区町村</label>
      <input id="city" type="text" required />
    </div>

    <div class="field">
      <label for="address1">番地・丁目など</label>
      <input id="address1" type="text" required />
    </div>

    <div class="field">
      <label for="address2">建物名・部屋番号（あれば）</label>
      <input id="address2" type="text" />
    </div>

    <button id="submitBtn" class="btn-primary" type="submit">
      この内容で住所を登録する
    </button>

    <div id="status" class="status"></div>
  </form>

  <script>
    let currentUserId = "";
    let liffInited = false;

    // 既存の住所を読み込む
    async function loadMyAddress(userId) {
      try {
        const res = await fetch("/api/liff/address/me?userId=" + encodeURIComponent(userId));
        const data = await res.json();
        if (!data.ok || !data.address) return;

        const a = data.address || {};
        document.getElementById("name").value      = a.name      || "";
        document.getElementById("phone").value     = a.phone     || "";
        document.getElementById("postal").value    = a.postal    || "";
        document.getElementById("prefecture").value= a.prefecture || "";
        document.getElementById("city").value      = a.city      || "";
        document.getElementById("address1").value  = a.address1  || "";
        document.getElementById("address2").value  = a.address2  || "";

        const status = document.getElementById("status");
        status.textContent = "以前登録された住所を読み込みました。内容を確認して、必要なら修正してください。";
        status.className = "status ok";
      } catch (e) {
        console.log("loadMyAddress error", e);
      }
    }

    // LIFF 初期化（ミニアプリ用）
    async function initLiffIfPossible() {
      try {
        // サーバーから LIFF ID を取得
        const res = await fetch("/api/liff/config");
        const cfg = await res.json();
        const liffId = (cfg && cfg.liffId) || "";
        if (!liffId || !window.liff) {
          // LIFF が使えない環境 → 通常ブラウザモード
          document.getElementById("userIdRow").style.display = "block";
          return;
        }

        await liff.init({ liffId });
        liffInited = true;

        if (!liff.isLoggedIn()) {
          // LINE アプリ外から開かれた場合など
          document.getElementById("userIdRow").style.display = "block";
          return;
        }

        const profile = await liff.getProfile();
        currentUserId = profile.userId;
        // userId 入力欄は不要なので隠す
        document.getElementById("userIdRow").style.display = "none";

        // 既存の住所を読み込み
        loadMyAddress(currentUserId);

        const status = document.getElementById("status");
        status.textContent = "LINE と連携しました。このアカウントの住所として登録されます。";
        status.className = "status ok";
      } catch (e) {
        console.log("LIFF init error", e);
        // 失敗した場合は通常ブラウザモードにしておく
        document.getElementById("userIdRow").style.display = "block";
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      // LIFF があれば初期化を試みる
      if (window.liff) {
        initLiffIfPossible();
      } else {
        // LIFF SDK 読み込み失敗時など
        document.getElementById("userIdRow").style.display = "block";
      }

      const form = document.getElementById("addressForm");
      const status = document.getElementById("status");
      const submitBtn = document.getElementById("submitBtn");

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        status.textContent = "";
        status.className = "status";

        // userId を決定（LIFF優先／なければ手動入力）
        const manualUserId = document.getElementById("userIdInput").value.trim();
        const userId = currentUserId || manualUserId;

        if (!userId) {
          status.textContent = "ユーザーIDが特定できません。LINE アプリ内から開くか、ユーザーIDを入力してください。";
          status.className = "status err";
          return;
        }

        const addr = {
          name:      document.getElementById("name").value.trim(),
          phone:     document.getElementById("phone").value.trim(),
          postal:    document.getElementById("postal").value.trim(),
          prefecture:document.getElementById("prefecture").value,
          city:      document.getElementById("city").value.trim(),
          address1:  document.getElementById("address1").value.trim(),
          address2:  document.getElementById("address2").value.trim(),
        };

        if (!addr.name || !addr.phone || !addr.prefecture || !addr.city || !addr.address1) {
          status.textContent = "必須項目が未入力です。お名前・電話番号・都道府県・市区町村・番地を入力してください。";
          status.className = "status err";
          return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = "送信中…";

        try {
          const resp = await fetch("/api/liff/address", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userId, address: addr }),
          });
          const data = await resp.json();

          if (!data.ok) {
            throw new Error(data.error || "保存に失敗しました");
          }

          status.textContent = "住所を登録しました。ありがとうございました。";
          status.className = "status ok";

          // ミニアプリからなら閉じてあげる
          if (liffInited && window.liff && liff.isInClient()) {
            setTimeout(() => {
              try { liff.closeWindow(); } catch (e) {}
            }, 1200);
          }
        } catch (err) {
          console.error("save error", err);
          status.textContent = "登録中にエラーが発生しました。時間をおいてもう一度お試しください。";
          status.className = "status err";
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = "この内容で住所を登録する";
        }
      });
    });
  </script>
</body>
</html>
