<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>代引き注文 完了</title>
  <style>
    :root{
      --bg:#f6f7f9; --card:#fff; --text:#111827; --muted:#6b7280; --line:#e5e7eb;
      --primary:#0b3a53; --shadow:0 1px 3px rgba(0,0,0,.08); --radius:14px;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; background:var(--bg); color:var(--text); }
    .wrap{ max-width:820px; margin:0 auto; padding:14px 14px 30px; }
    .card{ background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px; margin-bottom:12px; }
    h1{ font-size:18px; margin:0 0 8px; }
    .muted{ color:var(--muted); font-size:13px; line-height:1.6; }
    .row{ display:flex; justify-content:space-between; gap:10px; padding:8px 0; border-bottom:1px solid var(--line); }
    .row:last-child{ border-bottom:none; }
    .btn{
      width:100%; border:none; border-radius:12px; padding:12px 14px;
      background:var(--primary); color:#fff; font-weight:700; font-size:15px; cursor:pointer;
    }
    .btn2{
      width:100%; border:1px solid var(--line); border-radius:12px; padding:12px 14px;
      background:#fff; color:var(--text); font-weight:700; font-size:15px; cursor:pointer;
    }
    .items{ margin:8px 0 0; padding:0; list-style:none; }
    .items li{ padding:10px 0; border-bottom:1px solid var(--line); }
    .items li:last-child{ border-bottom:none; }
    .price{ font-variant-numeric: tabular-nums; }
    .pill{ display:inline-block; padding:3px 8px; border-radius:999px; background:#eef2ff; font-size:12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>代引き注文を受け付けました</h1>
      <div class="muted">
        ご注文ありがとうございます。<br>
        お支払いは <b>代引き</b> です。配達時にお支払いください。
      </div>
      <div style="margin-top:10px" class="row">
        <div>注文番号</div>
        <div class="price"><span id="orderId" class="pill">-</span></div>
      </div>
      <div class="muted" id="noteArea" style="margin-top:8px;"></div>
    </div>

    <div class="card">
      <div style="font-weight:800; margin-bottom:6px;">ご注文内容</div>
      <ul class="items" id="items"></ul>

      <div class="row"><div>商品合計</div><div class="price" id="sumItems">-</div></div>
      <div class="row"><div>送料</div><div class="price" id="sumShip">-</div></div>
      <div class="row"><div>代引き手数料</div><div class="price" id="sumCod">-</div></div>
      <div class="row" style="font-weight:900;"><div>合計</div><div class="price" id="sumTotal">-</div></div>
    </div>

    <div class="card">
      <div style="font-weight:800; margin-bottom:6px;">お届け先</div>
      <div class="muted" id="addr">-</div>
    </div>

    <button class="btn" id="toTop">商品一覧へ戻る</button>
    <div style="height:10px"></div>
    <button class="btn2" id="back">戻る</button>
  </div>

  <script>
    function yen(n){ return (Number(n||0)).toLocaleString("ja-JP") + "円"; }
    function safe(v){ return (v==null) ? "" : String(v); }

    const qs = new URLSearchParams(location.search);
    const orderId = qs.get("order_id") || "";

    document.getElementById("orderId").textContent = orderId || "-";

    // 最後の確定注文（confirm.js で保存したもの）
    let last = null;
    try { last = JSON.parse(localStorage.getItem("isoya_last_cod_order") || ""); } catch {}

    const itemsEl = document.getElementById("items");

    if (!last || !Array.isArray(last.items)) {
      document.getElementById("noteArea").textContent =
        "注文情報の表示に必要なデータが見つかりませんでした（端末側データが消えた可能性があります）。";
    } else {
      const items = last.items;
      let itemsSubtotal = 0;
      itemsEl.innerHTML = items.map(it => {
        const line = Number(it.price||0) * Number(it.qty||0);
        itemsSubtotal += line;
        const vol = it.volume ? ` <span class="pill">${safe(it.volume)}</span>` : "";
        return `<li>
          <div style="display:flex; justify-content:space-between; gap:12px;">
            <div><b>${safe(it.name)}</b>${vol}<div class="muted">数量：${safe(it.qty)}</div></div>
            <div class="price" style="white-space:nowrap;">${yen(line)}</div>
          </div>
        </li>`;
      }).join("");

      const shipping = Number(last.shipping||0);
      const codFee = Number(last.cod_fee||330);
      const total = itemsSubtotal + shipping + codFee;

      document.getElementById("sumItems").textContent = yen(itemsSubtotal);
      document.getElementById("sumShip").textContent  = yen(shipping);
      document.getElementById("sumCod").textContent   = yen(codFee);
      document.getElementById("sumTotal").textContent = yen(total);

      const a = last.address || {};
      const addrText = [
        a.postal ? `〒${safe(a.postal)}` : "",
        [a.prefecture, a.city, a.address1, a.address2].filter(Boolean).join(" "),
        a.name ? `宛名：${safe(a.name)}` : "",
        a.phone ? `TEL：${safe(a.phone)}` : ""
      ].filter(Boolean).join("<br>");

      document.getElementById("addr").innerHTML = addrText || "-";
    }

    document.getElementById("toTop").addEventListener("click", () => {
      location.href = "/products.html"; // あなたの一覧URLに合わせて変更OK
    });
    document.getElementById("back").addEventListener("click", () => history.back());
  </script>
</body>
</html>
