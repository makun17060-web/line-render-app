<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>注文内容の確認（オリジナルセット）</title>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root{
      --bg:#f6f7f9; --card:#fff; --text:#111827; --muted:#6b7280;
      --line:#e5e7eb; --pri:#7a1f1f; --danger:#b91c1c;
      --shadow:0 1px 3px rgba(0,0,0,.06); --radius:14px;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:system-ui,-apple-system,"Segoe UI",sans-serif; background:var(--bg); color:var(--text); }
    .wrap{ max-width:760px; margin:0 auto; padding:14px 14px 140px; }
    h1{ margin:0 0 6px; font-size:18px; }
    .muted{ color:var(--muted); font-size:13px; line-height:1.6; }

    .card{
      background:var(--card); border:1px solid var(--line);
      border-radius:var(--radius); box-shadow:var(--shadow);
      padding:14px; margin-top:12px;
    }
    .row{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .name{ font-weight:900; }
    .price{ font-weight:900; color:var(--pri); }
    .badge{
      font-size:12px; border:1px solid var(--line);
      background:#fafafa; border-radius:999px;
      padding:2px 8px; white-space:nowrap;
    }
    .total{
      font-size:18px; font-weight:900; color:var(--pri);
      text-align:right; margin-top:10px;
    }
    .warn{ color:var(--danger); font-weight:900; }

    .bar{
      position:fixed; left:0; right:0; bottom:0;
      border-top:1px solid var(--line);
      background:rgba(246,247,249,.92);
      backdrop-filter:blur(10px);
      padding:10px 12px;
    }
    .bar .inner{
      max-width:760px; margin:0 auto;
      display:flex; flex-wrap:wrap;
      justify-content:space-between; align-items:center; gap:10px;
    }
    .btn{
      border:none; border-radius:14px;
      padding:12px 14px; font-weight:900;
      cursor:pointer;
    }
    .btnBack{ background:#fff; border:1px solid var(--line); }
    .btnCod{ background:var(--pri); color:#fff; min-width:220px; }
    .btnCard{ background:#0b3a53; color:#fff; min-width:220px; }
    .btnDisabled{ opacity:.55; cursor:not-allowed; pointer-events:none; }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>注文内容の確認</h1>
    <div class="muted">オリジナルセット専用の確認画面です</div>

    <div class="card" id="itemCard"></div>

    <div class="card" id="addrCard">
      <div class="muted">配送先</div>
      <div id="addrBody" class="muted">読み込み中…</div>
    </div>

    <div class="card">
      <div class="row">
        <div>商品合計</div>
        <div id="sumItem">0円</div>
      </div>
      <div class="row">
        <div>送料（サイズ <span id="shipSize">-</span>）</div>
        <div id="sumShip">0円</div>
      </div>
      <div class="row">
        <div>代引き手数料</div>
        <div id="sumCod">330円</div>
      </div>
      <div class="total" id="sumTotal">合計 0円</div>
      <div class="muted" style="margin-top:8px">
        ※ オリジナルセットは「単品（あかしゃ等）との混載不可」です。
      </div>
    </div>
  </div>

  <div class="bar">
    <div class="inner">
      <button class="btn btnBack" id="backBtn" type="button">数量を変更</button>
      <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
        <button class="btn btnCod" id="codBtn" type="button">代引きで注文</button>
        <button class="btn btnCard" id="cardBtn" type="button">クレジットで支払う</button>
      </div>
    </div>
  </div>

<script>
(async function(){
  "use strict";

  const LIFF_ID_ORDER = "2008406620-Bd9Zo9od"; // オリジナル用LIFF
  const KEY_CART = "isoya_cart_original";
  const COD_FEE = 330;

  const yen = n => (Number(n)||0).toLocaleString("ja-JP") + "円";

  async function fetchJson(url, opts){
    const res = await fetch(url, opts);
    const text = await res.text();
    let data = {};
    try{ data = text ? JSON.parse(text) : {}; }catch{ data = { _raw:text }; }
    return { res, data, raw:text };
  }

  // LIFF
  await liff.init({ liffId: LIFF_ID_ORDER });
  if(!liff.isLoggedIn()){
    liff.login({ redirectUri: location.href });
    return;
  }
  const prof = await liff.getProfile();
  const userId = (prof?.userId || "").trim();

  // cart
  const cart = JSON.parse(localStorage.getItem(KEY_CART) || '{"items":[]}');
  const item = cart.items?.[0];
  if(!item){
    alert("カートが空です");
    location.href = "/original-set.html";
    return;
  }

  // 念のため「混載禁止」強制（1商品だけ）
  if(Array.isArray(cart.items) && cart.items.length !== 1){
    alert("オリジナルセットは単品との混載ができません。いったんカートを空にしてやり直してください。");
    location.href = "/original-set.html";
    return;
  }

  // products
  const { res: pr, data: pd } = await fetchJson("/api/products", { cache:"no-store" });
  if(!pr.ok || !pd?.ok) {
    alert("商品読み込みに失敗しました");
    location.href = "/original-set.html";
    return;
  }
  const product = (pd.products || []).find(p => p.id === item.id);
  if(!product){
    alert("商品情報が見つかりません");
    location.href = "/original-set.html";
    return;
  }

  // size rule (original set)
  function sizeByQty(q){
    q = Math.max(1, Math.floor(Number(q||1)));
    if(q === 1) return 80;
    if(q === 2) return 100;
    if(q <= 4) return 120;
    return 140;
  }
  const shipSize = sizeByQty(item.qty);

  // render item
  document.getElementById("itemCard").innerHTML = `
    <div class="row">
      <div class="name">${product.name || ""}</div>
      <span class="badge">${item.qty}個</span>
    </div>
    <div class="row">
      <div class="muted">単価</div>
      <div class="price">${yen(product.price)}</div>
    </div>
  `;

  const itemSum = Number(product.price||0) * Number(item.qty||0);
  document.getElementById("sumItem").textContent = yen(itemSum);
  document.getElementById("shipSize").textContent = shipSize;

  // address
  const addrBody = document.getElementById("addrBody");
  let addrOk = false;
  try{
    const u = `/api/address/get?userId=${encodeURIComponent(userId)}`;
    const { res: ar, data: ad } = await fetchJson(u, { cache:"no-store" });
    if(ar.ok && ad?.ok && ad?.address){
      const a = ad.address;
      addrOk = true;
      const postal = String(a.postal||"").replace(/[^\d]/g,"");
      const postalFmt = postal.length === 7 ? (postal.slice(0,3)+"-"+postal.slice(3)) : (a.postal||"");
      addrBody.className = "";
      addrBody.innerHTML = `
        ${a.name || ""}<br>
        〒${postalFmt}<br>
        ${(a.prefecture||"")}${(a.city||"")}${(a.address1||"")} ${(a.address2||"")}
      `;
    }else{
      addrBody.className = "warn";
      addrBody.textContent = "住所が未登録です（住所入力で登録してください）";
    }
  }catch(e){
    addrBody.className = "warn";
    addrBody.textContent = "住所の読み込みに失敗しました";
  }

  // quote (送料はサーバ計算を使う)
  let shipFee = 0;
  try{
    const checkout = { items: [{ id: item.id, qty: item.qty }] };
    const { res: qr, data: qd, raw } = await fetchJson("/api/order/quote", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ uid: userId, checkout })
    });
    if(!qr.ok || !qd?.ok) throw new Error(qd?.error || raw || ("HTTP "+qr.status));
    shipFee = Number(qd.shippingFee || 0);
    document.getElementById("sumShip").textContent = yen(shipFee);

    // 代引合計表示（カードは代引手数料なしだが、画面の「合計」は代引前提でOK）
    document.getElementById("sumCod").textContent = yen(COD_FEE);
    document.getElementById("sumTotal").textContent =
      "合計 " + yen(itemSum + shipFee + COD_FEE);
  }catch(e){
    // 送料が取れない時は0表示のまま
    document.getElementById("sumShip").textContent = yen(0);
    document.getElementById("sumTotal").textContent =
      "合計 " + yen(itemSum + 0 + COD_FEE);
  }

  // buttons
  const backBtn = document.getElementById("backBtn");
  const codBtn  = document.getElementById("codBtn");
  const cardBtn = document.getElementById("cardBtn");

  backBtn.onclick = ()=> location.href = "/original-set.html";

  function disableBoth(){
    codBtn.classList.add("btnDisabled");
    cardBtn.classList.add("btnDisabled");
  }
  function enableBoth(){
    codBtn.classList.remove("btnDisabled");
    cardBtn.classList.remove("btnDisabled");
  }

  // 代引き
  codBtn.onclick = async ()=>{
    if(!addrOk){
      alert("住所が未登録です。先に住所入力をしてください。");
      location.href = "/cod-register.html?returnTo=" + encodeURIComponent("/confirm-original.html");
      return;
    }
    disableBoth();
    try{
      const checkout = { items: [{ id: item.id, qty: item.qty }] };
      const { res, data, raw } = await fetchJson("/api/order/cod/create", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ uid: userId, checkout })
      });
      if(!res.ok || !data?.ok) throw new Error(data?.error || raw || ("HTTP "+res.status));
      alert("代引き注文を受け付けました。");
      localStorage.removeItem(KEY_CART);
      try{ liff.closeWindow(); }catch{}
    }catch(e){
      alert("代引き注文に失敗しました： " + (e?.message || e));
      enableBoth();
    }
  };

  // クレジット（Stripe Checkoutへ）
  cardBtn.onclick = async ()=>{
    if(!addrOk){
      alert("住所が未登録です。先に住所入力をしてください。");
      location.href = "/cod-register.html?returnTo=" + encodeURIComponent("/confirm-original.html");
      return;
    }
    disableBoth();
    try{
      const checkout = { items: [{ id: item.id, qty: item.qty }] };
      const { res, data, raw } = await fetchJson("/api/pay/stripe/create", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ uid: userId, checkout })
      });
      if(!res.ok || !data?.ok) throw new Error(data?.error || raw || ("HTTP "+res.status));
      if(!data.url) throw new Error("stripe url missing");
      // Stripe決済ページへ
      location.href = data.url;
    }catch(e){
      alert("クレジット決済に失敗しました： " + (e?.message || e));
      enableBoth();
    }
  };
})();
</script>
</body>
</html>
