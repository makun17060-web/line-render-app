<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ³¨æ–‡å†…å®¹ã®ç¢ºèª | æ‰‹é€ ã‚Šãˆã³ã›ã‚“ã¹ã„ ç£¯å±‹</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
      margin: 0;
      padding: 0;
      background: #fafafa;
    }
    header {
      background: #b22222;
      color: #fff;
      padding: 14px 16px;
      text-align: center;
      font-size: 18px;
    }
    .container {
      padding: 16px;
      max-width: 600px;
      margin: 0 auto;
    }
    h1 {
      font-size: 18px;
      margin-bottom: 12px;
    }
    .item {
      background: #fff;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .btn-main {
      display: block;
      width: 100%;
      padding: 14px;
      margin-top: 16px;
      border-radius: 6px;
      border: none;
      font-size: 16px;
      font-weight: bold;
      background: #b22222;
      color: #fff;
    }
    .btn-back {
      display: block;
      width: 100%;
      padding: 10px;
      margin-top: 12px;
      border-radius: 6px;
      text-align: center;
      text-decoration: none;
      font-size: 14px;
      background: #ffffff;
      border: 1px solid #b22222;
      color: #b22222;
      box-sizing: border-box;
    }
  </style>
</head>

<body>
<header>
  æ‰‹é€ ã‚Šãˆã³ã›ã‚“ã¹ã„ ç£¯å±‹<br>æ³¨æ–‡å†…å®¹ã®ç¢ºèª
</header>

<div class="container">
  <h1>ã”æ³¨æ–‡å†…å®¹</h1>

  <div id="orderList"></div>

  <h2 id="totalPrice" style="margin-top: 12px;"></h2>

  <!-- â–¼ ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆæ±ºæ¸ˆã¸é€²ã‚€ãƒœã‚¿ãƒ³ -->
  <button id="payButton" class="btn-main">ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã§æ”¯æ‰•ã†</button>

  <!-- â–¼ å•†å“é¸æŠã¸æˆ»ã‚‹ -->
  <a class="btn-back" href="products.html">å•†å“ä¸€è¦§ã«æˆ»ã‚‹</a>
</div>

<!-- â–¼ ã‚¤ãƒ—ã‚·ãƒ­ãƒ³æ±ºæ¸ˆãƒ•ã‚©ãƒ¼ãƒ  -->
<form id="payForm" action="https://secure.epsilon.jp/cgi-bin/order/receive_order3.cgi" method="POST">

  <!-- ï¼ˆå¿…é ˆï¼‰ã‚¤ãƒ—ã‚·ãƒ­ãƒ³å¥‘ç´„æƒ…å ± -->
  <input type="hidden" name="contract_code" value="YOUR_CONTRACT_CODE">
  <input type="hidden" name="user_id" value="YOUR_USER_ID">

  <!-- ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰å›ºå®š -->
  <input type="hidden" name="process_code" value="1">
  <input type="hidden" name="st_code" value="10000-0000-00000">

  <!-- å•†å“æƒ…å ±ï¼ˆJSã§ä»˜ä¸ï¼‰ -->
  <input type="hidden" name="item_code" id="pay_item_code">
  <input type="hidden" name="item_price" id="pay_item_price">
  <input type="hidden" name="item_quantity" id="pay_item_quantity">

  <!-- æ³¨æ–‡ç•ªå· -->
  <input type="hidden" name="order_number" id="pay_order_number">

  <!-- LINEãƒ¦ãƒ¼ã‚¶ãƒ¼ID -->
  <input type="hidden" name="memo1" id="pay_user_id">

  <!-- ğŸ”¥ æ±ºæ¸ˆæˆåŠŸ / å¤±æ•—ã®æˆ»ã‚Šå…ˆï¼ˆã“ã“ãŒè³ªå•ã®å ´æ‰€ã§ã™ï¼ï¼‰ -->
  <input type="hidden" name="success_url" value="https://line-render-app-1.onrender.com/public/confirm-success.html">
  <input type="hidden" name="failure_url" value="https://line-render-app-1.onrender.com/public/confirm-fail.html">

</form>

<script>
  const LIFF_ID = "YOUR_LIFF_ID_HERE";

  async function initLiff() {
    try {
      await liff.init({ liffId: LIFF_ID });
    } catch (e) {
      console.log("LIFF init error", e);
    }
  }
  initLiff();

  // æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’ sessionStorage ã‹ã‚‰å–å¾—
  const order = JSON.parse(sessionStorage.getItem("currentOrder") || "{}");
  const orderList = document.getElementById("orderList");
  const totalPriceEl = document.getElementById("totalPrice");

  let total = 0;
  order.items.forEach(item => {
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <strong>${item.name}</strong><br>
      å˜ä¾¡ï¼š${item.price}å†† Ã— ${item.qty}è¢‹<br>
      å°è¨ˆï¼š${item.price * item.qty}å††
    `;
    orderList.appendChild(div);
    total += item.price * item.qty;
  });

  totalPriceEl.textContent = "åˆè¨ˆé‡‘é¡ï¼š" + total + "å††";

  // â–¼ æ”¯æ‰•ã„ãƒœã‚¿ãƒ³å‡¦ç†
  document.getElementById("payButton").addEventListener("click", async () => {

    // å•†å“æƒ…å ±ï¼ˆ1å•†å“ãšã¤æ±ºæ¸ˆã™ã‚‹ç°¡æ˜“ç‰ˆï¼‰
    const item = order.items[0];
    document.getElementById("pay_item_code").value = item.id;
    document.getElementById("pay_item_price").value = item.price;
    document.getElementById("pay_item_quantity").value = item.qty;

    // æ³¨æ–‡ç•ªå·
    document.getElementById("pay_order_number").value = "ISOYA-" + Date.now();

    // LINEãƒ¦ãƒ¼ã‚¶ãƒ¼ID
    const profile = await liff.getProfile();
    document.getElementById("pay_user_id").value = profile.userId;

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ â†’ ã‚¤ãƒ—ã‚·ãƒ­ãƒ³æ±ºæ¸ˆãƒšãƒ¼ã‚¸ã¸
    document.getElementById("payForm").submit();
  });

</script>

</body>
</html>
