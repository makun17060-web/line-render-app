<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>商品一覧</title>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root{
      --bg:#f6f7f9; --card:#fff; --text:#111827; --muted:#6b7280;
      --line:#e5e7eb; --pri:#0b3a53; --pri2:#123b66;
      --danger:#b91c1c;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
      background:var(--bg); color:var(--text);
    }
    .wrap{max-width:1040px;margin:0 auto;padding:14px 14px 96px}
    h1{margin:0 0 6px;font-size:18px}
    .muted{color:var(--muted);font-size:13px;line-height:1.5}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px;margin-top:12px}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      box-shadow:0 1px 3px rgba(0,0,0,.06);
    }
    .imgbox{height:160px;background:#eaecef}
    .imgbox img{width:100%;height:100%;object-fit:cover;display:block}
    .body{padding:12px}
    .name{font-weight:900;font-size:15px}
    .desc{margin-top:6px;color:var(--muted);font-size:12px;min-height:34px}
    .row{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-top:8px}
    .price{font-weight:900;color:var(--pri)}
    .badge{font-size:12px;border:1px solid var(--line);background:#fafafa;border-radius:999px;padding:2px 8px}
    .controls{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-top:10px}
    .qty{display:flex;align-items:center;gap:6px}
    .qty button{
      width:34px;height:34px;border-radius:10px;
      border:1px solid var(--line);background:#fff;font-size:18px;
    }
    .qty input{
      width:56px;height:34px;border-radius:10px;
      border:1px solid var(--line);text-align:center;
    }
    .btn{border:none;border-radius:12px;padding:10px 12px;font-weight:900;cursor:pointer}
    .btnAdd{background:var(--pri);color:#fff}
    .btnAdd:disabled{opacity:.55}
    .bar{
      position:fixed;left:0;right:0;bottom:0;
      border-top:1px solid var(--line);
      background:rgba(246,247,249,.92);
      backdrop-filter:blur(10px);
      padding:10px 12px;
    }
    .bar .inner{
      max-width:1040px;margin:0 auto;
      display:flex;justify-content:space-between;align-items:center;gap:10px;
    }
    .btnGo{background:var(--pri2);color:#fff;padding:12px 14px;border-radius:14px}
    .btnClear{background:#fff;border:1px solid #fecaca;color:var(--danger);padding:12px 14px;border-radius:14px}
  </style>
</head>

<body>
<div class="wrap">
  <h1>商品一覧</h1>
  <div class="muted" id="status">読み込み中…</div>
  <div class="grid" id="grid"></div>
</div>

<div class="bar">
  <div class="inner">
    <div class="muted" id="sum">カート：0点 / 小計 0円</div>
    <div style="display:flex;gap:8px">
      <button class="btn btnClear" id="clearBtn" type="button">空にする</button>
      <button class="btn btnGo" id="nextBtn" type="button" disabled>注文内容を確認</button>
    </div>
  </div>
</div>

<script>
(async function(){
  "use strict";

  /* ===== 設定 ===== */
  const LIFF_ID = "YOUR_LIFF_ID"; // ★必ず差し替え
  const KEY_UID  = "isoya_userId";
  const KEY_CART = "isoya_cart";

  /* ===== LIFF 初期化（userIdを必ず保存）===== */
  try{
    await liff.init({ liffId: LIFF_ID });

    if(!liff.isLoggedIn()){
      liff.login({ redirectUri: location.href });
      return;
    }

    const prof = await liff.getProfile();
    const uid = (prof?.userId || "").trim();
    if(uid){
      localStorage.setItem(KEY_UID, uid);
      console.log("[products] userId saved:", uid);
    }else{
      alert("userIdを取得できませんでした");
    }
  }catch(e){
    console.error("LIFF init failed:", e);
    alert("LIFF初期化に失敗しました");
    return;
  }

  /* ===== DOM ===== */
  const statusEl=document.getElementById("status");
  const gridEl=document.getElementById("grid");
  const sumEl=document.getElementById("sum");
  const clearBtn=document.getElementById("clearBtn");
  const nextBtn=document.getElementById("nextBtn");

  const yen=n=>(Number(n)||0).toLocaleString("ja-JP")+"円";

  const loadCart=()=>{try{return JSON.parse(localStorage.getItem(KEY_CART)||"");}catch{return{items:[]}}};
  const saveCart=c=>localStorage.setItem(KEY_CART,JSON.stringify(c));

  let cart=loadCart(); if(!cart.items) cart.items=[];
  let products=[];

  function renderSum(){
    let subtotal=0,count=0;
    for(const it of cart.items){
      const p=products.find(x=>x.id===it.id);
      if(!p) continue;
      subtotal+=p.price*it.qty;
      count+=it.qty;
    }
    sumEl.textContent=`カート：${count}点 / 小計 ${yen(subtotal)}`;
    nextBtn.disabled=(count===0);
  }

  function card(p){
    const el=document.createElement("div");
    el.className="card";
    el.innerHTML=`
      <div class="imgbox">${p.image?`<img src="${p.image}">`:""}</div>
      <div class="body">
        <div class="name">${p.name}</div>
        <div class="desc">${p.desc||""}</div>
        <div class="row">
          <div class="price">${yen(p.price)}</div>
          <div class="badge">${p.volume||""}</div>
        </div>
        <div class="controls">
          <div class="qty">
            <button class="dec">−</button>
            <input class="q" type="number" value="1" min="1">
            <button class="inc">＋</button>
          </div>
          <button class="btn btnAdd">追加</button>
        </div>
      </div>
    `;

    const q=el.querySelector(".q");
    el.querySelector(".dec").onclick=()=>q.value=Math.max(1,q.value-1);
    el.querySelector(".inc").onclick=()=>q.value=Number(q.value)+1;

    el.querySelector(".btnAdd").onclick=()=>{
      const qty=Number(q.value)||1;
      const ex=cart.items.find(x=>x.id===p.id);
      if(ex) ex.qty+=qty;
      else cart.items.push({id:p.id,qty});
      saveCart(cart);
      renderSum();
    };

    const img=el.querySelector("img");
    if(img) img.onerror=()=>img.remove();

    return el;
  }

  try{
    const r=await fetch("/api/products",{cache:"no-store"});
    const d=await r.json();
    if(!d.ok) throw new Error("products api error");
    products=d.products;
    statusEl.textContent="";
    gridEl.innerHTML="";
    products.forEach(p=>gridEl.appendChild(card(p)));
    renderSum();
  }catch(e){
    console.error(e);
    statusEl.textContent="商品読み込みに失敗しました";
  }

  clearBtn.onclick=()=>{
    if(!confirm("カートを空にしますか？")) return;
    cart={items:[]}; saveCart(cart); renderSum();
  };

  nextBtn.onclick=()=>{
    location.href="/public/confirm.html"; // ★必ず confirm へ
  };

})();
</script>
</body>
</html>
