<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>宅配注文（クレジット決済） | 手造りえびせんべい 磯屋</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
      margin: 0;
      padding: 0;
      background: #fafafa;
      color: #333;
    }
    header {
      background: #b22222;
      color: #fff;
      padding: 14px 16px;
      text-align: center;
      font-size: 18px;
      line-height: 1.4;
    }
    .container {
      padding: 12px 16px 80px;
      max-width: 720px;
      margin: 0 auto;
    }
    h1 {
      font-size: 18px;
      margin: 12px 0 8px;
    }
    h2 {
      font-size: 16px;
      margin: 16px 0 8px;
    }
    .section {
      background: #fff;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .product-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }
    .product-row:last-child {
      border-bottom: none;
    }
    .product-info {
      flex: 1;
      min-width: 0;
    }
    .product-name {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
      word-break: break-all;
    }
    .product-price {
      font-size: 12px;
      color: #666;
    }
    .qty-box {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .qty-btn {
      width: 36px;
      height: 36px;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: #f8f8f8;
      font-size: 18px;
      line-height: 1;
      padding: 0;
    }
    .qty-value {
      min-width: 28px;
      text-align: center;
      font-size: 14px;
    }

    .field-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }
    .field {
      flex: 1;
      min-width: 120px;
    }
    .field label {
      display: block;
      font-size: 12px;
      margin-bottom: 2px;
    }
    .field input,
    .field select,
    .field textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    .field textarea {
      min-height: 60px;
      resize: vertical;
    }

    .radio-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 14px;
    }
    .radio-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .summary-line {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      margin-bottom: 4px;
    }
    .summary-line.total {
      font-weight: bold;
      font-size: 16px;
      margin-top: 4px;
    }

    .btn-main {
      display: block;
      width: 100%;
      padding: 14px;
      margin-top: 16px;
      border-radius: 6px;
      border: none;
      font-size: 16px;
      font-weight: bold;
      background: #b22222;
      color: #fff;
    }
    .btn-main:disabled {
      opacity: 0.6;
    }
    .notice {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
      line-height: 1.5;
    }
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      background: #eee;
      margin-left: 4px;
    }
    .error {
      color: #b22222;
      font-size: 12px;
      margin-top: 4px;
      white-space: pre-line;
    }
  </style>
</head>
<body>
<header>
  手造りえびせんべい 磯屋<br>
  宅配注文（クレジット決済）
</header>

<div class="container">
  <h1>1. 商品を選ぶ</h1>
  <div class="section" id="productSection">
    <div id="productList">読み込み中...</div>
    <div class="notice">
      ※ ミニアプリからの注文は、宅配＋クレジットカード決済専用です。<br>
      店頭受取や代引き・銀行振込は、これまで通りトーク画面からの「直接注文」をご利用ください。
    </div>
  </div>

  <h2>2. お届け先情報</h2>
  <div class="section">
    <div class="field-row">
      <div class="field">
        <label for="name">お名前（必須）</label>
        <input type="text" id="name" placeholder="例）磯屋 太郎" />
      </div>
    </div>
    <div class="field-row">
      <div class="field">
        <label for="phone">電話番号（必須・ハイフンなし）</label>
        <input type="tel" id="phone" placeholder="例）09012345678" />
      </div>
    </div>
    <div class="field-row">
      <div class="field" style="max-width: 160px;">
        <label for="postal">郵便番号（必須）</label>
        <input type="text" id="postal" placeholder="例）1234567" />
      </div>
      <div class="field">
        <label for="region">配送地域（必須・送料計算用）</label>
        <select id="region">
          <option value="">選択してください</option>
          <option value="北海道">北海道</option>
          <option value="東北">東北</option>
          <option value="関東">関東</option>
          <option value="中部">中部</option>
          <option value="近畿">近畿</option>
          <option value="中国">中国</option>
          <option value="四国">四国</option>
          <option value="九州">九州</option>
          <option value="沖縄">沖縄</option>
        </select>
      </div>
    </div>
    <div class="field-row">
      <div class="field">
        <label for="pref">都道府県（必須）</label>
        <input type="text" id="pref" placeholder="例）愛知県" />
      </div>
    </div>
    <div class="field-row">
      <div class="field">
        <label for="city">市区町村（必須）</label>
        <input type="text" id="city" placeholder="例）名古屋市中区" />
      </div>
    </div>
    <div class="field-row">
      <div class="field">
        <label for="addr1">町名・番地（必須）</label>
        <input type="text" id="addr1" placeholder="例）〇〇1-2-3" />
      </div>
    </div>
    <div class="field-row">
      <div class="field">
        <label for="addr2">建物名・部屋番号（任意）</label>
        <input type="text" id="addr2" placeholder="例）△△マンション101号室" />
      </div>
    </div>
  </div>

  <h2>3. お支払い方法</h2>
  <div class="section">
    <div class="radio-group">
      <div class="radio-item">
        <input type="radio" name="payment" id="paymentCredit" value="credit" checked />
        <label for="paymentCredit">クレジットカード決済<span class="badge">イプシロン</span></label>
      </div>
    </div>
    <div class="notice">
      ※ このミニアプリからはクレジットカード決済のみご利用いただけます。<br>
      代引き・銀行振込をご希望の場合は、LINEトーク画面から「直接注文」をお選びください。
    </div>
  </div>

  <h2>4. ご注文内容の確認</h2>
  <div class="section">
    <div class="summary-line">
      <span>商品小計</span>
      <span id="summarySubtotal">0円</span>
    </div>
    <div class="summary-line">
      <span>送料</span>
      <span id="summaryShipping">0円</span>
    </div>
    <div class="summary-line total">
      <span>お支払い合計</span>
      <span id="summaryTotal">0円</span>
    </div>
    <div class="notice">
      ※ 送料は地域ごとに異なります（例：中部 800円 など）。<br>
      宅配便の詳細は店舗からのご案内をご確認ください。
    </div>
  </div>

  <button class="btn-main" id="payButton">
    この内容でクレジット決済へ進む
  </button>
  <div id="errorArea" class="error"></div>

</div>

<script>
  // ★ここを本物の LIFF ID に変更してください
  const LIFF_ID = "2008406620-G5j1gjzM";

  // 送料テーブル（server.js と合わせる）
  const SHIPPING_BY_REGION = {
    "北海道": 1100,
    "東北": 900,
    "関東": 800,
    "中部": 800,
    "近畿": 900,
    "中国": 1000,
    "四国": 1000,
    "九州": 1100,
    "沖縄": 1400
  };

  const yen = (n) => (Number(n) || 0).toLocaleString("ja-JP") + "円";

  let products = [];
  let cart = {}; // { productId: qty }
  let lineUserId = "";
  let lineUserName = "";

  const productListEl = document.getElementById("productList");
  const subtotalEl = document.getElementById("summarySubtotal");
  const shippingEl = document.getElementById("summaryShipping");
  const totalEl = document.getElementById("summaryTotal");
  const errorArea = document.getElementById("errorArea");
  const payButton = document.getElementById("payButton");

  async function initLiff() {
    try {
      await liff.init({ liffId: LIFF_ID });
      // 必要ならログイン
      if (!liff.isLoggedIn()) {
        liff.login();
        return;
      }
      const profile = await liff.getProfile();
      lineUserId = profile.userId;
      lineUserName = profile.displayName || "LINEユーザー";
    } catch (e) {
      console.log("LIFF init error", e);
    }
  }

  async function loadProducts() {
    try {
      const res = await fetch("/api/products");
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || "products error");
      products = data.products || [];
      if (products.length === 0) {
        productListEl.textContent = "商品がありません。";
        return;
      }
      // 初期数量 0
      cart = {};
      products.forEach(p => { cart[p.id] = 0; });
      renderProducts();
      updateSummary();
    } catch (e) {
      console.error(e);
      productListEl.textContent = "商品一覧の読み込みに失敗しました。時間をおいて再度お試しください。";
    }
  }

  function renderProducts() {
    productListEl.innerHTML = "";
    products.forEach(p => {
      const row = document.createElement("div");
      row.className = "product-row";

      const info = document.createElement("div");
      info.className = "product-info";
      info.innerHTML = `
        <div class="product-name">${p.name}</div>
        <div class="product-price">
          単価：${yen(p.price)}　在庫：${p.stock ?? 0}袋
        </div>
      `;

      const qtyBox = document.createElement("div");
      qtyBox.className = "qty-box";

      const minusBtn = document.createElement("button");
      minusBtn.type = "button";
      minusBtn.className = "qty-btn";
      minusBtn.textContent = "−";

      const qtyValue = document.createElement("div");
      qtyValue.className = "qty-value";
      qtyValue.textContent = cart[p.id] || 0;

      const plusBtn = document.createElement("button");
      plusBtn.type = "button";
      plusBtn.className = "qty-btn";
      plusBtn.textContent = "+";

      minusBtn.addEventListener("click", () => {
        const current = cart[p.id] || 0;
        const next = Math.max(0, current - 1);
        cart[p.id] = next;
        qtyValue.textContent = next;
        updateSummary();
      });

      plusBtn.addEventListener("click", () => {
        const current = cart[p.id] || 0;
        const next = Math.min(current + 1, 99);
        cart[p.id] = next;
        qtyValue.textContent = next;
        updateSummary();
      });

      qtyBox.appendChild(minusBtn);
      qtyBox.appendChild(qtyValue);
      qtyBox.appendChild(plusBtn);

      row.appendChild(info);
      row.appendChild(qtyBox);
      productListEl.appendChild(row);
    });
  }

  function calcSubtotal() {
    let subtotal = 0;
    for (const p of products) {
      const qty = cart[p.id] || 0;
      subtotal += p.price * qty;
    }
    return subtotal;
  }

  function calcShipping() {
    const region = document.getElementById("region").value || "";
    if (!region) return 0;
    return SHIPPING_BY_REGION[region] || 0;
  }

  function updateSummary() {
    const subtotal = calcSubtotal();
    const shipping = calcShipping();
    const total = subtotal + shipping;
    subtotalEl.textContent = yen(subtotal);
    shippingEl.textContent = yen(shipping);
    totalEl.textContent = yen(total);
  }

  function getSelectedItems() {
    const items = [];
    for (const p of products) {
      const qty = cart[p.id] || 0;
      if (qty > 0) {
        items.push({
          id: p.id,
          name: p.name,
          price: p.price,
          qty
        });
      }
    }
    return items;
  }

  function validateForm() {
    const items = getSelectedItems();
    if (items.length === 0) {
      return "商品を1点以上お選びください。";
    }
    const name = document.getElementById("name").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const postal = document.getElementById("postal").value.trim();
    const region = document.getElementById("region").value.trim();
    const pref = document.getElementById("pref").value.trim();
    const city = document.getElementById("city").value.trim();
    const addr1 = document.getElementById("addr1").value.trim();

    const missing = [];
    if (!name) missing.push("・お名前");
    if (!phone) missing.push("・電話番号");
    if (!postal) missing.push("・郵便番号");
    if (!region) missing.push("・配送地域");
    if (!pref) missing.push("・都道府県");
    if (!city) missing.push("・市区町村");
    if (!addr1) missing.push("・町名・番地");

    if (missing.length > 0) {
      return "以下の必須項目を入力してください。\n" + missing.join("\n");
    }

    const subtotal = calcSubtotal();
    const shipping = calcShipping();
    const total = subtotal + shipping;
    if (total <= 0) {
      return "合計金額が0円です。数量や入力内容をご確認ください。";
    }

    return ""; // OK
  }

  async function handlePay() {
    errorArea.textContent = "";
    const err = validateForm();
    if (err) {
      errorArea.textContent = err;
      window.scrollTo({ top: 0, behavior: "smooth" });
      return;
    }

    const items = getSelectedItems();
    const subtotal = calcSubtotal();
    const shipping = calcShipping();
    const total = subtotal + shipping;

    const name = document.getElementById("name").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const postal = document.getElementById("postal").value.trim();
    const region = document.getElementById("region").value.trim();
    const pref = document.getElementById("pref").value.trim();
    const city = document.getElementById("city").value.trim();
    const addr1 = document.getElementById("addr1").value.trim();
    const addr2 = document.getElementById("addr2").value.trim();

    // LIFFプロフィール（念のため再取得トライ）
    try {
      if (!lineUserId) {
        const profile = await liff.getProfile();
        lineUserId = profile.userId;
        lineUserName = profile.displayName || "LINEユーザー";
      }
    } catch (e) {
      console.log("getProfile error", e);
    }

    payButton.disabled = true;
    payButton.textContent = "決済ページへ接続中...";

    try {
      // 1. 住所をサーバーに保存（/api/liff/address）
      try {
        await fetch("/api/liff/address", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            userId: lineUserId || "",
            name,
            phone,
            postal,
            prefecture: pref,
            city,
            address1: addr1,
            address2: addr2,
          }),
        });
      } catch (e) {
        console.log("address save error (continue):", e);
      }

      // 2. イプシロン決済開始（/api/pay-epsilon）
      const res = await fetch("/api/pay-epsilon", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          items,
          total: total,
          lineUserId: lineUserId,
          lineUserName: lineUserName
        }),
      });

      const data = await res.json();
      if (!data.ok || !data.redirectUrl) {
        throw new Error(data.error || "決済の開始に失敗しました。");
      }

      // 3. イプシロン決済画面へ遷移
      location.href = data.redirectUrl;

    } catch (e) {
      console.error(e);
      errorArea.textContent = e.message || "決済の開始に失敗しました。時間をおいて再度お試しください。";
      payButton.disabled = false;
      payButton.textContent = "この内容でクレジット決済へ進む";
    }
  }

  document.getElementById("region").addEventListener("change", updateSummary);
  payButton.addEventListener("click", handlePay);

  // 初期化
  (async () => {
    await initLiff();
    await loadProducts();
  })();
</script>
</body>
</html>
