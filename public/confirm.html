<script>
(async function(){
  "use strict";

  const LIFF_ID_ORDER = "2008406620-G5j1gjzM";
  const KEY_UID ="isoya_userId";

  // ✅ modeでカート切替（福箱は専用カート）
  const qs = new URLSearchParams(location.search);
  const mode = (qs.get("mode") || "").trim();

  const KEY_CART =
    (mode === "original") ? "isoya_cart_original"
  : (mode === "fukubako") ? "isoya_cart_fukubako"
  : "isoya_cart";

  const backTo =
    (mode === "original") ? "/original-set.html"
  : (mode === "fukubako") ? "/fukubako.html"
  : "/products.html";

  const RETURN_TO_THIS =
    (mode === "fukubako") ? "/confirm.html?mode=fukubako"
  : (mode === "original") ? "/confirm-original.html"
  : "/confirm.html";

  const status=document.getElementById("status");
  const addrText=document.getElementById("addrText");
  const itemsEl=document.getElementById("items");

  // （共通表示）
  const subtotalEl=document.getElementById("subtotal");
  const shippingEl=document.getElementById("shipping");

  // （分割表示がある場合に備えて）
  const subtotal2El=document.getElementById("subtotal2");
  const shipping2El=document.getElementById("shipping2");
  const totalCardEl=document.getElementById("totalCard");

  const subtotal3El=document.getElementById("subtotal3");
  const shipping3El=document.getElementById("shipping3");
  const codFeeEl=document.getElementById("codFee");
  const totalCodEl=document.getElementById("totalCod");

  const backBtn=document.getElementById("backBtn");
  const cardBtn=document.getElementById("cardBtn");
  const codBtn=document.getElementById("codBtn");

  const yen=n=>(Number(n)||0).toLocaleString("ja-JP")+"円";
  const loadJson=k=>{try{return JSON.parse(localStorage.getItem(k)||"");}catch{return null;}};

  // ✅ 押したボタンだけをbusy化（もう片方は触らない）
  function setBtnBusy(btn, busy, busyText, normalText){
    if(!btn) return;
    btn.disabled = !!busy;
    btn.style.pointerEvents = busy ? "none" : "auto";
    if (busyText && normalText) btn.textContent = busy ? busyText : normalText;
  }

  function safeSetText(el, txt){
    if(el) el.textContent = txt;
  }

  async function postJson(url, body){
    const r=await fetch(url,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(body)
    });
    const d=await r.json().catch(()=>({}));
    if(!r.ok) throw new Error(d?.error || ("HTTP "+r.status));
    return d;
  }

  async function getAddress(userId){
    const r=await fetch(`/api/address/get?userId=${encodeURIComponent(userId)}`,{cache:"no-store"});
    const d=await r.json().catch(()=>({}));
    if(!r.ok) throw new Error(d?.error||("HTTP "+r.status));
    return d?.address || null;
  }

  async function getProducts(){
    const r=await fetch("/api/products",{cache:"no-store"});
    const d=await r.json().catch(()=>({}));
    if(!r.ok || !d.ok) throw new Error(d?.error||("HTTP "+r.status));
    return Array.isArray(d.products)?d.products:[];
  }

  function renderItems(cartItems, products){
    const byId=Object.fromEntries(products.map(p=>[p.id,p]));
    itemsEl.innerHTML="";
    let subtotal=0;

    for(const it of cartItems){
      const p=byId[it.id];
      if(!p) continue;

      const qty = Number(it.qty||0);
      const line=Number(p.price||0) * qty;
      subtotal += line;

      const div=document.createElement("div");
      div.className="item";
      div.innerHTML = `
        <div class="name">${p.name || ""}${p.volume ? `（${p.volume}）` : ""}</div>
        <div class="price">${yen(line)}</div>
        <div class="qty">× ${qty} 点</div>
      `;
      itemsEl.appendChild(div);
    }

    // 共通小計
    safeSetText(subtotalEl, yen(subtotal));
    // 分割用小計
    safeSetText(subtotal2El, yen(subtotal));
    safeSetText(subtotal3El, yen(subtotal));

    return subtotal;
  }

  // ✅ confirmは LIFF失敗しても止めない（住所LIFF内でも動かす）
  async function ensureUserSoft(){
    const cached = (localStorage.getItem(KEY_UID) || "").trim();
    if(cached) return cached;

    try{
      await liff.init({ liffId: LIFF_ID_ORDER });
      if(liff.isLoggedIn()){
        const prof = await liff.getProfile();
        const uid = (prof?.userId||"").trim();
        if(uid) localStorage.setItem(KEY_UID, uid);
        return uid || null;
      }
      // ここで login には飛ばさない（別LIFF内だと事故ることがある）
      return null;
    }catch{
      return null;
    }
  }

  // ✅ 分割表示がある場合：両方に同じ送料を入れる（見積り）
  function applyQuoteToUI(quote){
    const shippingText = `${yen(quote.shippingFee)}（ヤマト ${quote.size}サイズ）`;

    // 共通
    safeSetText(shippingEl, shippingText);

    // クレジット（代引手数料なし）
    safeSetText(shipping2El, shippingText);
    if(totalCardEl){
      const totalCard = Number(quote.subtotal||0) + Number(quote.shippingFee||0);
      safeSetText(totalCardEl, yen(totalCard));
    }

    // 代引
    safeSetText(shipping3El, shippingText);
    safeSetText(codFeeEl, yen(quote.codFee));
    safeSetText(totalCodEl, yen(quote.totalCod));
  }

  try{
    status.textContent="確認中…";

    const uid = await ensureUserSoft();
    if(!uid){
      status.innerHTML = '<span class="err">ユーザー情報が取得できません。いったん商品ページから開き直してください。</span>';
      setTimeout(()=>location.replace(backTo), 900);
      return;
    }

    const cart=loadJson(KEY_CART) || {items:[]};
    const items=(cart.items||[]).filter(x=>x?.id && Number(x.qty||0)>0);

    if(items.length===0){
      status.innerHTML='<span class="err">カートが空です。商品選択に戻ります。</span>';
      setTimeout(()=>location.replace(backTo), 700);
      return;
    }

    // 住所が無ければ住所入力へ（mode維持・returnTo維持）
    const addr=await getAddress(uid).catch(()=>null);
    if(!addr){
      location.replace(`/cod-register.html?returnTo=${encodeURIComponent(RETURN_TO_THIS)}&mode=${encodeURIComponent(mode||"")}&liff.hback=2`);
      return;
    }

    const nameLine = addr.name ? `${addr.name} 様\n` : "";
    addrText.textContent =
      `${nameLine}〒${addr.postal||""} ${addr.prefecture||""}${addr.city||""}${addr.address1||""} ${addr.address2||""}`.trim();

    const products=await getProducts();
    const subtotal = renderItems(items, products);

    // 表示を一旦「計算中…」
    safeSetText(shippingEl, "計算中…");
    safeSetText(shipping2El, "計算中…");
    safeSetText(shipping3El, "計算中…");
    safeSetText(codFeeEl, "計算中…");
    safeSetText(totalCodEl, "計算中…");
    safeSetText(totalCardEl, "計算中…");

    const quote = await postJson("/api/order/quote", { uid, checkout:{ items } });
    // 念のため、quoteにsubtotalが無い場合はここで補完
    quote.subtotal = quote.subtotal ?? subtotal;

    applyQuoteToUI(quote);

    status.textContent="内容をご確認ください。";

    // 住所入力へ戻る（mode維持）
    if(backBtn){
      backBtn.onclick = ()=>{
        location.href = `/cod-register.html?returnTo=${encodeURIComponent(RETURN_TO_THIS)}&mode=${encodeURIComponent(mode||"")}&liff.hback=2`;
      };
    }

    // ✅ クレジット：Stripeへ（cardBtn だけbusy化）
    if(cardBtn){
      cardBtn.onclick = async ()=>{
        setBtnBusy(cardBtn, true, "移動中…", "クレジットで支払う");
        try{
          const data = await postJson("/api/pay/stripe/create", { uid, checkout:{ items } });
          if(!data?.url) throw new Error("stripe url missing");
          location.href = data.url;
        }catch(e){
          console.error(e);
          alert("クレジット決済の開始に失敗しました: " + (e?.message||e));
          setBtnBusy(cardBtn, false, "移動中…", "クレジットで支払う");
        }
      };
    }

    // ✅ 代引き：確定（codBtn だけbusy化）
    if(codBtn){
      codBtn.onclick = async ()=>{
        setBtnBusy(codBtn, true, "確定中…", "代引きで注文確定");
        try{
          const data = await postJson("/api/order/cod/create", { uid, checkout:{ items } });

          // ✅ このconfirmで使っているカートだけ空にする（福箱は福箱だけ）
          localStorage.setItem(KEY_CART, JSON.stringify({ items: [] }));

          location.href = `/complete.html?method=cod&orderId=${encodeURIComponent(data.orderId||"")}`;
        }catch(e){
          console.error(e);
          alert("代引き確定に失敗しました: " + (e?.message||e));
          setBtnBusy(codBtn, false, "確定中…", "代引きで注文確定");
        }
      };
    }

  }catch(e){
    console.error(e);
    status.innerHTML='<span class="err">読み込みに失敗しました（住所API/商品API/DBを確認）</span>';
  }
})();
</script>
