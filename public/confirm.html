<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>③ 最終確認 | 磯屋ミニアプリ</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="/public/common.js"></script>
<style>
  body{font-family:system-ui;margin:0;background:#fafafa;}
  header{background:#b22222;color:#fff;padding:14px;text-align:center;}
  .container{max-width:720px;margin:0 auto;padding:12px 16px 24px;}
  .card{background:#fff;border-radius:6px;padding:10px;box-shadow:0 1px 3px rgba(0,0,0,.08);}
  .line{display:flex;justify-content:space-between;border-bottom:1px dashed #eee;padding:4px 0;}
  .total{font-weight:bold;font-size:16px;margin-top:6px;border-top:1px solid #eee;padding-top:6px;}
  .btn-main{width:100%;padding:12px;border:none;border-radius:6px;background:#b22222;color:#fff;font-size:16px;font-weight:bold;margin-top:10px;}
  .btn-sub{width:100%;padding:10px;border:1px solid #b22222;border-radius:6px;background:#fff;color:#b22222;margin-top:8px;}
</style>
</head>
<body>
<header>③ 最終確認</header>
<div class="container">

  <div id="summary" class="card">読み込み中...</div>

  <button id="okBtn" class="btn-main">この内容で支払いへ進む</button>
  <button id="backBtn" class="btn-sub">← ② 住所入力へ戻る</button>
</div>

<script>
(async()=>{
  await initLiffAndProfile();

  let st = loadState();
  if(!Object.keys(st.cart).length){ location.href="/public/products.html"; return; }
  if(!st.address){ location.href="/public/address.html"; return; }

  const products = await fetchProducts();
  const ids = Object.keys(st.cart);

  let itemsTotal=0;
  const lines=[];

  ids.forEach(id=>{
    const p=products.find(x=>x.id===id);
    if(!p) return;
    const qty=st.cart[id];
    const sub=p.price*qty;
    itemsTotal+=sub;
    lines.push({name:p.name, qty, sub});
  });

  const shipFee = st.shipFee || 0;
  const grandTotal = itemsTotal + shipFee;

  saveState({ itemsTotal, grandTotal });

  const sumEl=document.getElementById("summary");
  sumEl.innerHTML = `
    <div style="font-weight:bold;margin-bottom:6px;">ご注文明細</div>
    ${lines.map(l=>`<div class="line"><span>${l.name} × ${l.qty}</span><span>${yen(l.sub)}</span></div>`).join("")}
    <div class="line"><span>商品合計</span><span>${yen(itemsTotal)}</span></div>
    <div class="line"><span>送料（${st.shipRegion}）</span><span>${yen(shipFee)}</span></div>
    <div class="total line"><span>お支払予定金額</span><span>${yen(grandTotal)}</span></div>

    <div style="font-size:12px;color:#666;margin-top:8px;">
      お届け先：${st.address.postal} ${st.address.prefecture}${st.address.city}${st.address.address1} ${st.address.address2||""}<br>
      氏名：${st.address.name} / TEL：${st.address.phone}
    </div>
  `;

  okBtn.onclick=()=>{
    saveState({ confirmed:true });
    location.href="/public/pay.html";
  };
  backBtn.onclick=()=>{
    saveState({ confirmed:false });
    location.href="/public/address.html";
  };
})();
</script>
</body>
</html>
