<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>お届け先の入力</title>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root{
      --bg:#f6f7f9;--card:#fff;--text:#111827;--muted:#6b7280;--line:#e5e7eb;
      --pri:#0b3a53;--pri2:#123b66;--danger:#b91c1c;
      --shadow:0 1px 3px rgba(0,0,0,.06);--radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:860px;margin:0 auto;padding:14px 14px 26px}
    h1{margin:0 0 6px;font-size:18px}
    .muted{color:var(--muted);font-size:13px;line-height:1.5}
    .err{color:var(--danger);font-weight:900}

    .card{
      background:var(--card);border:1px solid var(--line);border-radius:var(--radius);
      padding:12px;margin-top:12px;box-shadow:var(--shadow)
    }

    .pillRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .pill{
      display:flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:999px;
      background:#fff;border:1px solid var(--line);box-shadow:var(--shadow);
      cursor:pointer;user-select:none;font-size:13px;font-weight:900;
    }
    .pill input{transform:scale(1.1)}
    .pill[aria-disabled="true"]{opacity:.55;cursor:not-allowed}
    .pill .sub{font-weight:700;color:var(--muted);font-size:12px}

    .addrList{display:grid;gap:10px;margin-top:10px}
    .addrItem{
      border:1px solid var(--line);border-radius:14px;padding:10px;background:#fff;
      display:flex;gap:10px;align-items:flex-start;
    }
    .addrItem input{margin-top:3px;transform:scale(1.1)}
    .addrItem .txt{white-space:pre-line;font-size:13px}
    .addrItem .tagRow{margin-top:6px;display:flex;gap:8px;flex-wrap:wrap}
    .tag{font-size:11px;font-weight:900;padding:3px 8px;border-radius:999px;border:1px solid var(--line);color:#111827;background:#fff}
    .tag.gift{border-color:#f0c2c2;color:#8a1f1f}

    .grid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
    @media(min-width:760px){ .grid{grid-template-columns:1fr 1fr} }

    label{font-size:12px;color:var(--muted);font-weight:900}
    input[type="text"], select{
      width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);
      font-size:14px;outline:none;background:#fff;
    }

    .btn{
      width:100%;border:none;border-radius:14px;padding:12px 14px;
      font-weight:1000;cursor:pointer;margin-top:10px;
      background:var(--pri);color:#fff;
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .btnSub{background:#fff;border:1px solid var(--line);color:#111827}
    .rowBtns{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
    @media(min-width:760px){ .rowBtns{grid-template-columns:1fr 1fr} }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>お届け先の入力</h1>
    <div class="muted" id="status">読み込み中…</div>

    <div class="card">
      <div class="muted">配送先の種類</div>

      <!-- ship=home/gift をここで選ぶ（confirm側で代引可否に使える） -->
      <div class="pillRow" role="radiogroup" aria-label="配送先の種類">
        <label class="pill" id="pillHome">
          <input type="radio" name="shipTo" id="shipHome" value="home">
          <div>自宅配送<div class="sub">代引きOK</div></div>
        </label>

        <label class="pill" id="pillGift">
          <input type="radio" name="shipTo" id="shipGift" value="gift">
          <div>贈答用として送る<div class="sub">代引きNG（クレジットのみ）</div></div>
        </label>
      </div>

      <div class="muted" style="margin-top:8px">
       ※「贈答用として送る」を選ぶと、注文確認で代引きが自動で無効になります。
      </div>
    </div>

    <div class="card" id="listCard" style="display:none">
      <div class="muted">登録済みの住所</div>
      <div class="addrList" id="addrList"></div>
      <div class="muted" style="margin-top:8px">※住所を選んで「この住所で進む」を押してください。</div>
      <button class="btn btnSub" id="showFormBtn" type="button">新しい住所を入力する</button>
    </div>

    <div class="card" id="formCard" style="display:none">
      <div class="muted">住所を入力</div>

      <div class="grid">
        <div>
          <label>お名前</label>
          <input id="name" type="text" autocomplete="name" placeholder="例）山田 太郎">
        </div>
        <div>
          <label>電話番号</label>
          <input id="phone" type="text" inputmode="tel" autocomplete="tel" placeholder="例）09012345678">
        </div>

        <div>
          <label>郵便番号</label>
          <input id="postal" type="text" inputmode="numeric" autocomplete="postal-code" placeholder="例）1234567">
        </div>

        <div>
          <label>都道府県</label>
          <input id="prefecture" type="text" autocomplete="address-level1" placeholder="例）愛知県">
        </div>

        <div>
          <label>市区町村</label>
          <input id="city" type="text" autocomplete="address-level2" placeholder="例）名古屋市中区">
        </div>

        <div>
          <label>番地</label>
          <input id="address1" type="text" autocomplete="street-address" placeholder="例）栄1-2-3">
        </div>

        <div style="grid-column:1/-1">
          <label>建物名・部屋番号（任意）</label>
          <input id="address2" type="text" autocomplete="address-line2" placeholder="例）磯屋マンション101">
        </div>

        <div style="grid-column:1/-1">
          <label>ラベル（任意）</label>
          <input id="label" type="text" placeholder="例）自宅 / 実家 / 会社 など">
        </div>
      </div>

      <div class="rowBtns">
        <button class="btn" id="saveBtn" type="button">この住所を保存して進む</button>
        <button class="btn btnSub" id="cancelBtn" type="button">キャンセル（一覧へ）</button>
      </div>
    </div>

    <div class="card">
      <div class="muted">戻る</div>
      <button class="btn btnSub" id="backBtn" type="button">商品選択に戻る</button>
    </div>
  </div>

<script>
  /* ★一時対処：古いUIDを強制リセット（確認できたら削除） */
localStorage.removeItem("isoya_userId");
(async function(){
  "use strict";

  // ★あなたの cod-register 用 LIFF ID に置換（confirm と同じでも動きます）
  const LIFF_ID_COD  = "2008406620-G5j1gjzM";
  const KEY_UID      = "isoya_userId";

  // confirm が見ている想定（あなたの confirm と合わせる）
  const KEY_SHIP_TO  = "isoya_ship_to"; // "home" / "gift"

  const qs = new URLSearchParams(location.search);
  const mode = (qs.get("mode") || "").trim();

  // returnTo は confirm から渡される想定
  const returnToRaw = (qs.get("returnTo") || "/confirm.html").trim();

  // 商品ページに戻る先（mode対応）
  const backTo =
    (mode === "original") ? "/original-set.html"
  : (mode === "fukubako") ? "/fukubako.html"
  : "/products.html";

  const status = document.getElementById("status");

  const shipHome = document.getElementById("shipHome");
  const shipGift = document.getElementById("shipGift");
  const pillHome = document.getElementById("pillHome");
  const pillGift = document.getElementById("pillGift");

  const listCard = document.getElementById("listCard");
  const addrListEl = document.getElementById("addrList");
  const showFormBtn = document.getElementById("showFormBtn");

  const formCard = document.getElementById("formCard");
  const saveBtn = document.getElementById("saveBtn");
  const cancelBtn = document.getElementById("cancelBtn");

  const backBtn = document.getElementById("backBtn");

  const el = (id)=>document.getElementById(id);

  function setShipTo(v){
    localStorage.setItem(KEY_SHIP_TO, v);
    if (shipHome) shipHome.checked = (v === "home");
    if (shipGift) shipGift.checked = (v === "gift");
  }

  // 初期 ship_to
  const shipLS = (localStorage.getItem(KEY_SHIP_TO) || "").trim();
  const shipQS = (qs.get("ship") || "").trim(); // もし来てたらそれ優先
  const initialShip = (shipQS === "home" || shipQS === "gift") ? shipQS : (shipLS === "gift" ? "gift" : "home");
  setShipTo(initialShip);

  // pill クリックでも切替（LIFFでchangeが拾えない対策）
  if(pillHome) pillHome.addEventListener("click", ()=>{
    if(shipHome){ shipHome.checked = true; setShipTo("home"); }
  });
  if(pillGift) pillGift.addEventListener("click", ()=>{
    if(shipGift){ shipGift.checked = true; setShipTo("gift"); }
  });
  if(shipHome) shipHome.addEventListener("change", ()=>setShipTo("home"));
  if(shipGift) shipGift.addEventListener("change", ()=>setShipTo("gift"));

  const yen=n=>(Number(n)||0).toLocaleString("ja-JP")+"円";

  async function postJson(url, body){
    const r=await fetch(url,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(body)
    });
    const d=await r.json().catch(()=>({}));
    if(!r.ok) throw new Error(d?.error || ("HTTP "+r.status));
    return d;
  }

  async function getJson(url){
    const r=await fetch(url,{cache:"no-store"});
    const d=await r.json().catch(()=>({}));
    if(!r.ok) throw new Error(d?.error || ("HTTP "+r.status));
    return d;
  }

  async function ensureUserSoft(){
    const cached = (localStorage.getItem(KEY_UID) || "").trim();
    if(cached) return cached;

    try{
      await liff.init({ liffId: LIFF_ID_COD });
      if(liff.isLoggedIn()){
        const prof = await liff.getProfile();
        const uid = (prof?.userId||"").trim();
        if(uid) localStorage.setItem(KEY_UID, uid);
        return uid || null;
      }
      return null;
    }catch{
      return null;
    }
  }

  function toAddrText(a){
    const nameLine = a?.name ? `${a.name} 様\n` : "";
    const postal = a?.postal || a?.zip || "";
    const pref = a?.prefecture || a?.pref || "";
    const city = a?.city || "";
    const a1 = a?.address1 || a?.address || "";
    const a2 = a?.address2 || "";
    return `${nameLine}〒${postal} ${pref}${city}${a1} ${a2}`.trim();
  }

  function normalizeAddr(a){
    // list API / get API どっちでも同じように扱えるように整形
    return {
      id: a?.id ?? a?.address_id ?? a?.addressId ?? null,
      name: a?.name ?? "",
      phone: a?.phone ?? "",
      postal: a?.postal ?? a?.zip ?? "",
      prefecture: a?.prefecture ?? a?.pref ?? "",
      city: a?.city ?? "",
      address1: a?.address1 ?? a?.address ?? "",
      address2: a?.address2 ?? "",
      label: a?.label ?? "",
      is_gift: a?.is_gift === true,
      is_default: a?.is_default === true,
      kind: a?.kind ?? ""
    };
  }

  function buildReturnUrl(){
    // returnToRaw は "/confirm.html?mode=..." のようなパス想定
    // ship=home/gift を付ける。addr_step=1 は confirm 側が必要なら残す。
    const u = new URL(returnToRaw, location.origin);
    const ship = (localStorage.getItem(KEY_SHIP_TO) || "home").trim();
    u.searchParams.set("ship", ship);
    // confirm のゲートに合わせて残す（無いとconfirmがcod-registerへ戻す）
    u.searchParams.set("addr_step", "1");
    if (mode) u.searchParams.set("mode", mode);
    return u.pathname + u.search;
  }

  function goNext(){
    location.replace(buildReturnUrl());
  }

  function showList(){
    if(listCard) listCard.style.display = "block";
    if(formCard) formCard.style.display = "none";
  }

  function showForm(){
    if(listCard) listCard.style.display = "none";
    if(formCard) formCard.style.display = "block";
  }

  async function loadAddresses(uid){
    // 1) list があれば使う（複数住所）
    try{
      const d = await getJson(`/api/address/list?userId=${encodeURIComponent(uid)}`);
      const rows = Array.isArray(d?.addresses) ? d.addresses : (Array.isArray(d?.list) ? d.list : []);
      if(rows.length > 0) return rows.map(normalizeAddr);
    }catch(e){
      // list 無しなら fallback
    }

    // 2) get だけでも動く（単一住所）
    try{
      const d = await getJson(`/api/address/get?userId=${encodeURIComponent(uid)}`);
      if(d?.address) return [ normalizeAddr(d.address) ];
    }catch(e){
      // none
    }
    return [];
  }

  function renderAddressList(addrs, uid){
    addrListEl.innerHTML = "";

    if(!addrs || addrs.length === 0){
      status.innerHTML = '<span class="muted">住所が未登録です。下のフォームから入力してください。</span>';
      showForm();
      return;
    }

    status.textContent = "住所を選んでください。";

    // デフォルト候補：is_default > 先頭
    let selectedId = (addrs.find(a=>a.is_default)?.id ?? addrs[0].id) ?? null;

    addrs.forEach((a, idx)=>{
      const id = a.id ?? ("idx_"+idx);
      const wrap = document.createElement("div");
      wrap.className = "addrItem";

      const radio = document.createElement("input");
      radio.type = "radio";
      radio.name = "addrSel";
      radio.value = String(id);
      radio.checked = String(id) === String(selectedId);
      radio.addEventListener("change", ()=>{ selectedId = id; });

      const box = document.createElement("div");
      const txt = document.createElement("div");
      txt.className = "txt";
      txt.textContent = toAddrText(a);

      const tagRow = document.createElement("div");
      tagRow.className = "tagRow";
      if(a.label){
        const t=document.createElement("span"); t.className="tag"; t.textContent=a.label; tagRow.appendChild(t);
      }
      if(a.is_gift){
      const t=document.createElement("span"); t.className="tag gift"; t.textContent="贈答用"; tagRow.appendChild(t);

      }
      if(a.is_default){
        const t=document.createElement("span"); t.className="tag"; t.textContent="既定"; tagRow.appendChild(t);
      }

      const useBtn = document.createElement("button");
      useBtn.type = "button";
      useBtn.className = "btn";
      useBtn.textContent = "この住所で進む";
      useBtn.addEventListener("click", async ()=>{
        // 住所選択をサーバへ反映（既存APIに合わせて set を叩く）
        const chosen = addrs.find(x=>String(x.id)===String(selectedId)) || addrs[0];
        if(!chosen) return;

        // ship_to の選択が gift なら is_gift を true にして保存（confirm が DB の is_gift を見れる）
        const ship = (localStorage.getItem(KEY_SHIP_TO) || "home").trim();
        const isGift = (ship === "gift");

        try{
          useBtn.disabled = true;
          useBtn.textContent = "保存中…";

          await postJson("/api/address/set", {
            userId: uid,
            address: {
              id: chosen.id || null,
              name: chosen.name,
              phone: chosen.phone,
              postal: chosen.postal,
              prefecture: chosen.prefecture,
              city: chosen.city,
              address1: chosen.address1,
              address2: chosen.address2,
              label: chosen.label,
              is_gift: isGift
            }
          });

          goNext();
        }catch(e){
          alert("住所の保存に失敗しました: " + (e?.message||e));
          useBtn.disabled = false;
          useBtn.textContent = "この住所で進む";
        }
      });

      box.appendChild(txt);
      box.appendChild(tagRow);
      box.appendChild(useBtn);

      wrap.appendChild(radio);
      wrap.appendChild(box);
      addrListEl.appendChild(wrap);
    });

    showList();
  }

  async function saveNewAddress(uid){
    const ship = (localStorage.getItem(KEY_SHIP_TO) || "home").trim();
    const isGift = (ship === "gift");

    const a = {
      name: (el("name").value || "").trim(),
      phone: (el("phone").value || "").trim(),
      postal: (el("postal").value || "").trim(),
      prefecture: (el("prefecture").value || "").trim(),
      city: (el("city").value || "").trim(),
      address1: (el("address1").value || "").trim(),
      address2: (el("address2").value || "").trim(),
      label: (el("label").value || "").trim(),
      is_gift: isGift
    };

    // 最低限チェック
    if(!a.postal || !a.prefecture || !a.city || !a.address1){
      alert("郵便番号/都道府県/市区町村/番地 は必須です。");
      return;
    }

    saveBtn.disabled = true;
    saveBtn.textContent = "保存中…";
    try{
      await postJson("/api/address/set", { userId: uid, address: a });
      goNext();
    }catch(e){
      alert("住所の保存に失敗しました: " + (e?.message||e));
      saveBtn.disabled = false;
      saveBtn.textContent = "この住所を保存して進む";
    }
  }

  try{
    const uid = await ensureUserSoft();
    if(!uid){
      status.innerHTML = '<span class="err">ユーザー情報が取得できません。いったん商品ページから開き直してください。</span>';
      setTimeout(()=>location.replace(backTo), 900);
      return;
    }

    // 住所一覧ロード
    const addrs = await loadAddresses(uid);
    renderAddressList(addrs, uid);

    // ボタン類
    if(showFormBtn) showFormBtn.onclick = ()=>showForm();
    if(cancelBtn) cancelBtn.onclick = ()=>showList();
    if(saveBtn) saveBtn.onclick = ()=>saveNewAddress(uid);

    if(backBtn) backBtn.onclick = ()=>location.replace(backTo);

  }catch(e){
    status.innerHTML = '<span class="err">読み込みに失敗しました（住所API/DBを確認）</span>';
  }
})();
</script>
</body>
</html>
