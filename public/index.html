<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ã”æ³¨æ–‡æ–¹æ³•é¸æŠ</title>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root{
      --bg:#f6f7f9; --card:#fff; --text:#111827; --muted:#6b7280; --line:#e5e7eb;
      --akasha:#0b3a53; --original:#7a1f1f; --store:#0a7b19;
      --shadow:0 1px 4px rgba(0,0,0,.08); --radius:16px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{ max-width:760px; margin:0 auto; padding:16px 14px 30px; }
    h1{ margin:0 0 6px; font-size:20px; }
    .muted{ color:var(--muted); font-size:13px; line-height:1.6; }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      margin-top:14px;
    }
    .btn{
      display:block; width:100%;
      padding:16px 14px;
      border-radius:14px;
      font-weight:900; font-size:16px;
      text-align:center; text-decoration:none;
      border:none; cursor:pointer;
    }
    .btnOriginal{ background:var(--original); color:#fff; }
    .btnAkasha{ background:var(--akasha); color:#fff; }
    .btnStore{ background:var(--store); color:#fff; }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>ã”æ³¨æ–‡ã¯ã“ã¡ã‚‰</h1>
    <div class="muted">ã”å¸Œæœ›ã®å•†å“ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</div>

    <div class="card">
      <a class="btn btnOriginal" href="https://liff.line.me/2008406620-Bd9Zo9od">
        ğŸ ã‚ªãƒªã‚¸ãƒŠãƒ«ã‚»ãƒƒãƒˆ
      </a>
    </div>

    <div class="card">
      <a class="btn btnAkasha" href="https://liff.line.me/2008406620-G5j1gjzM">
        ğŸ˜ ã‚ã‹ã—ã‚ƒã‚·ãƒªãƒ¼ã‚º
      </a>
    </div>

    <div class="card">
      <a class="btn btnStore" href="https://liff.line.me/2008406620-7tSkOcqd">
        ğŸ  åº—é ­å—å–ï¼ˆç¾é‡‘ï¼‰
      </a>
    </div>
  </div>

<script>
(async function(){
  const qs = new URLSearchParams(location.search);
  const DEBUG = qs.get("debug") === "1";
  const FORCE = qs.get("force") === "1";
  const d = (msg)=> { if (DEBUG) alert(msg); };

  const LIFF_ID = "2008406620-8CWfgEKh";
  const API_URL = location.origin + "/api/liff/opened";
  const VERSION = "index_v_20260126_01";

  try {
    await liff.init({ liffId: LIFF_ID });
    d("init OK");
  } catch (e) {
    d("init FAILED: " + (e?.message || String(e)));
    return;
  }

  if (!liff.isLoggedIn()) {
    d("not logged in -> login()");
    liff.login({ redirectUri: location.href });
    return;
  }
  d("login OK");

  let userId = null;
  try { userId = liff.getDecodedIDToken()?.sub || null; } catch(e){}
  if (!userId) {
    try { userId = (await liff.getProfile())?.userId || null; } catch(e){}
  }
  if (!userId) {
    d("userId missing");
    return;
  }
  d("userId OK");

  // äºŒé‡é€ä¿¡é˜²æ­¢ï¼ˆforce=1 ã®æ™‚ã¯ç„¡è¦–ï¼‰
  const key = "liff_opened_sent";
  if (!FORCE && sessionStorage.getItem(key)) {
    d("already sent (sessionStorage) -> skip");
    return;
  }
  sessionStorage.setItem(key, "1");

  const payload = {
    userId,
    source: `index|order|${VERSION}|origin=${location.origin}`,
    ts: Date.now(),
    debug: DEBUG ? "debug=1" : ""
  };

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify(payload)
    });

    const text = await res.text().catch(()=> "");
    d("POST " + (res.ok ? "OK" : "NG") + " HTTP=" + res.status + "\n" + text.slice(0,200));
  } catch (e) {
    d("POST error: " + (e?.message || String(e)));
  }
})();
</script>

</body>
</html>
