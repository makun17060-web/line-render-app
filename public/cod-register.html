<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>住所登録</title>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root{
      --bg:#f7f7f7; --card:#fff; --text:#111827; --muted:#6b7280;
      --pri:#0b3a53; --border:#e5e7eb; --radius:14px;
      --danger:#b91c1c;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
      background:var(--bg); color:var(--text);
    }
    .wrap{ max-width:720px; margin:0 auto; padding:14px 14px 28px; }
    h1{ font-size:18px; margin:0 0 6px; }
    .lead{ font-size:13px; color:var(--muted); line-height:1.6; }
    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius:var(--radius); padding:14px; margin-top:12px;
    }
    label{ font-size:13px; font-weight:700; display:block; margin-top:10px; }
    input{
      width:100%; padding:10px; font-size:15px;
      border-radius:10px; border:1px solid var(--border);
    }
    button{
      margin-top:14px; width:100%; padding:14px;
      border-radius:14px; border:none; cursor:pointer;
      font-size:16px; font-weight:800;
    }
    .btnMain{ background:var(--pri); color:#fff; }
    .btnSub{ background:#fff; border:1px solid var(--border); }
    .debug{
      margin-top:12px; font-size:12px; white-space:pre-line;
      background:#fff; border:1px dashed var(--border);
      border-radius:12px; padding:10px;
    }
    .err{ color:var(--danger); font-weight:800; }
  </style>
</head>

<body>
<div class="wrap">
  <h1>住所登録</h1>
  <div class="lead" id="lead"></div>

  <div class="card">
    <label>お名前</label>
    <input id="name">

    <label>電話番号</label>
    <input id="phone">

    <label>郵便番号</label>
    <input id="postal">

    <label>都道府県</label>
    <input id="prefecture">

    <label>市区町村</label>
    <input id="city">

    <label>番地</label>
    <input id="address1">

    <label>建物名など（任意）</label>
    <input id="address2">

    <button id="saveBtn" class="btnMain">保存</button>
    <button id="backBtn" class="btnSub">戻る</button>

    <div id="debug" class="debug">debug: init…</div>
  </div>
</div>

<script>
(async()=>{
  "use strict";

  /* =============================
     設定
  ============================= */
  const LIFF_ID_ADDRESS = "2008406620-4kyQVyqe";
  const KEY_UID = "isoya_userId";

  /* =============================
     URLパラメータ
  ============================= */
  const qs = new URLSearchParams(location.search);
  const mode = (qs.get("mode") || "").trim(); // "howto" | "order" | ""
  const returnTo =
    (qs.get("returnTo") && qs.get("returnTo").startsWith("/"))
      ? qs.get("returnTo")
      : "/confirm.html";

  /* =============================
     DOM
  ============================= */
  const $ = id => document.getElementById(id);
  const log = m => $("debug").textContent += "\n" + m;

  $("lead").textContent =
    (mode === "howto")
      ? "住所を登録します（登録後はこの画面を閉じて完了します）"
      : "注文のために住所を入力してください";

  $("saveBtn").textContent =
    (mode === "howto") ? "保存して完了" : "保存して注文へ戻る";

  /* =============================
     LIFF初期化
  ============================= */
  try{
    await liff.init({ liffId: LIFF_ID_ADDRESS });
    if(!liff.isLoggedIn()){
      liff.login({ redirectUri: location.href });
      return;
    }
    const prof = await liff.getProfile();
    if(prof?.userId){
      localStorage.setItem(KEY_UID, prof.userId);
      log("OK userId");
    }
  }catch(e){
    $("debug").classList.add("err");
    log("LIFF init error");
    alert("初期化に失敗しました");
    return;
  }

  /* =============================
     既存住所取得
  ============================= */
  try{
    const uid = localStorage.getItem(KEY_UID);
    if(uid){
      const r = await fetch(`/api/address/get?userId=${encodeURIComponent(uid)}`, { cache:"no-store" });
      const d = await r.json();
      if(r.ok && d?.ok && d.address){
        for(const [k,v] of Object.entries(d.address)){
          if($(k)) $(k).value = v || "";
        }
        log("address loaded");
      }
    }
  }catch{}

  /* =============================
     戻る
  ============================= */
  $("backBtn").onclick = ()=>{
    // howto は閉じるだけ
    if(mode === "howto"){
      if(liff.isInClient()) liff.closeWindow();
      else history.back();
      return;
    }
    // 注文フローは confirm へ
    location.href = returnTo;
  };

  /* =============================
     保存
  ============================= */
  $("saveBtn").onclick = async ()=>{
    const payload = {
      userId: localStorage.getItem(KEY_UID) || "",
      name: $("name").value.trim(),
      phone: $("phone").value.trim(),
      postal: $("postal").value.trim(),
      prefecture: $("prefecture").value.trim(),
      city: $("city").value.trim(),
      address1: $("address1").value.trim(),
      address2: $("address2").value.trim(),
    };

    if(!payload.userId ||
       !payload.name || !payload.phone || !payload.postal ||
       !payload.prefecture || !payload.city || !payload.address1){
      alert("必須項目を入力してください");
      return;
    }

    try{
      const r = await fetch("/api/address/set", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      const d = await r.json();
      if(!r.ok || !d?.ok) throw new Error();

      alert("住所を保存しました");

      /* ===== 分岐ここが核心 ===== */

      // howto → 閉じて終わり
      if(mode === "howto"){
        if(liff.isInClient()) liff.closeWindow();
        else alert("この画面を閉じてください");
        return;
      }

      // 注文フロー → confirmへ
      location.href = returnTo;

    }catch{
      $("debug").classList.add("err");
      log("save error");
      alert("保存に失敗しました");
    }
  };

  log("READY mode=" + (mode || "order"));
})();
</script>
</body>
</html>
