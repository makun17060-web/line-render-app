<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#111111" />
  <title>Scan（発送通知）</title>
  <style>
    :root{--bg:#0b0b0c;--card:#141416;--muted:#9aa0a6;--text:#f5f5f7;--line:#2a2a2d;--btn:#1f1f22;--accent:#4da3ff;
      --safe-top: env(safe-area-inset-top, 0px);--safe-bottom: env(safe-area-inset-bottom, 0px);--vh: 1dvh;}
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif}
    body{min-height: calc(var(--vh) * 100); padding: calc(12px + var(--safe-top)) 12px calc(14px + var(--safe-bottom)) 12px;}
    .wrap{max-width:920px;margin:0 auto;display:flex;flex-direction:column;gap:12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:12px}
    .title{font-weight:800;font-size:16px}
    .videoWrap{position:relative;border-radius:16px;overflow:hidden;background:#000;border:1px solid var(--line);height: min(62dvh, 620px)}
    video{width:100%;height:100%;object-fit: cover}
    .reticle{position:absolute;inset:0;display:flex;align-items:center;justify-content:center}
    .reticle>div{width:min(82vw,640px);height:min(16vh,120px);border:2px solid rgba(255,255,255,.65);border-radius:14px;box-shadow:0 0 0 9999px rgba(0,0,0,.25)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{border:1px solid var(--line);background:var(--btn);color:var(--text);padding:14px;border-radius:14px;font-weight:800}
    .btn.primary{background:linear-gradient(180deg,#2a6dff,#2a50ff)}
    .input{width:100%;padding:14px;border-radius:14px;border:1px solid var(--line);background:#0f0f11;color:#fff}
    .log{font-size:12px;background:#0f0f11;border:1px solid var(--line);border-radius:14px;padding:10px;max-height:200px;overflow:auto}
  </style>
</head>
<body>
<div class="wrap">

  <div class="card">
    <div class="title">発送スキャン</div>
  </div>

  <div class="card">
    <div class="videoWrap">
      <video id="video" playsinline muted></video>
      <div class="reticle"><div></div></div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="btnStart" class="btn primary">カメラ開始</button>
      <button id="btnStop" class="btn">停止</button>
    </div>
  </div>

  <div class="card">
    <input id="code" class="input" placeholder="ここに入る" />
    <div id="log" class="log"></div>
  </div>

</div>

<script src="/vendor/zxing/library.min.js"></script>
<script src="/vendor/zxing/browser.min.js"></script>
<script>window.ZXing = window.ZXing || window.ZXingBrowser;</script>

<script>
const video = document.getElementById("video");
const logEl = document.getElementById("log");
const codeEl = document.getElementById("code");

let stream=null;
let detector=null;
let lastHit=0;

function log(...a){
  logEl.textContent = a.join(" ") + "\n" + logEl.textContent;
}

const norm = v => String(v||'').replace(/\D/g,'');
const valid = v => /^\d{8,16}$/.test(v);

// ✅ここが今回の本体
function hit(raw){
  const code = norm(raw);
  if(!code) return;

  const now = Date.now();
  if(now - lastHit < 800) return;
  lastHit = now;

  codeEl.value = code;

  const ok = valid(code);

  log(ok ? "HIT_OK" : "HIT_NG", raw, "→", code);

  try{
    if(navigator.vibrate){
      if(ok){
        navigator.vibrate([120,60,220]); // ✅成功：長い振動
      }else{
        navigator.vibrate(30); // NG：短い
      }
    }
  }catch{}
}

async function start(){
  stream = await navigator.mediaDevices.getUserMedia({
    video:{facingMode:"environment"}
  });
  video.srcObject = stream;
  await video.play();

  if("BarcodeDetector" in window){
    detector = new BarcodeDetector({
      formats:["code_128","ean_13","itf","qr_code"]
    });
  }

  loop();
}

async function loop(){
  if(detector){
    try{
      const res = await detector.detect(video);
      if(res.length){
        hit(res[0].rawValue);
      }
    }catch{}
  }
  requestAnimationFrame(loop);
}

function stop(){
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
  }
}

document.getElementById("btnStart").onclick = start;
document.getElementById("btnStop").onclick = stop;

</script>
</body>
</html>