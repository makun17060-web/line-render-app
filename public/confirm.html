// 住所保存（例）POST /api/address/save
app.post("/api/address/save", async (req, res) => {
  try {
    const b = req.body || {};
    const userId = String(b.userId || b.uid || "").trim();
    if (!userId) return res.status(400).json({ error: "userId required" });

    const name = String(b.name || "").trim(); // ✅これを保存
    const postal = String(b.postal || "").trim();
    const prefecture = String(b.prefecture || "").trim();
    const city = String(b.city || "").trim();
    const address1 = String(b.address1 || "").trim();
    const address2 = String(b.address2 || "").trim();
    const phone = String(b.phone || "").trim();

    await pool.query(
      `
      INSERT INTO public.addresses
        (user_id, name, postal, prefecture, city, address1, address2, phone, updated_at)
      VALUES
        ($1, $2, $3, $4, $5, $6, $7, $8, now())
      ON CONFLICT (user_id)
      DO UPDATE SET
        name = EXCLUDED.name,
        postal = EXCLUDED.postal,
        prefecture = EXCLUDED.prefecture,
        city = EXCLUDED.city,
        address1 = EXCLUDED.address1,
        address2 = EXCLUDED.address2,
        phone = EXCLUDED.phone,
        updated_at = now()
      `,
      [userId, name, postal, prefecture, city, address1, address2, phone]
    );

    return res.json({ ok: true });
  } catch (e) {
    console.error("[/api/address/save] error:", e);
    return res.status(500).json({ error: "address save failed" });
  }
});
