<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ã”æ³¨æ–‡æ–¹æ³•é¸æŠ</title>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root{
      --bg:#f6f7f9; --card:#fff; --text:#111827; --muted:#6b7280; --line:#e5e7eb;
      --akasha:#0b3a53; --original:#7a1f1f; --store:#0a7b19;
      --shadow:0 1px 4px rgba(0,0,0,.08); --radius:16px;
      --danger:#b91c1c;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{ max-width:760px; margin:0 auto; padding:16px 14px 30px; }
    h1{ margin:0 0 6px; font-size:20px; }
    .muted{ color:var(--muted); font-size:13px; line-height:1.6; }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow:var(--shadow);
      padding:16px;
      margin-top:14px;
    }
    .btn{
      display:block; width:100%;
      padding:16px 14px;
      border-radius:14px;
      font-weight:900; font-size:16px;
      text-align:center; text-decoration:none;
      border:none; cursor:pointer;
    }
    .btnOriginal{ background:var(--original); color:#fff; }
    .btnAkasha{ background:var(--akasha); color:#fff; }
    .btnStore{ background:var(--store); color:#fff; }

    .status{
      position:fixed; right:10px; bottom:10px;
      background:#111827; color:#fff;
      border-radius:12px; padding:10px 12px;
      font-size:12px; line-height:1.5;
      max-width:92vw;
      opacity:.92;
    }
    .ok{ color:#86efac; }
    .ng{ color:#fca5a5; }
    .warn{ color:#fde68a; }
  </style>
</head>

<body>
<div class="wrap">
  <h1>ã”æ³¨æ–‡ã¯ã“ã¡ã‚‰</h1>
  <div class="muted">ã”å¸Œæœ›ã®å•†å“ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</div>

  <div class="card">
    <a class="btn btnOriginal" href="https://liff.line.me/2008406620-Bd9Zo9od">
      ğŸ ã‚ªãƒªã‚¸ãƒŠãƒ«ã‚»ãƒƒãƒˆ
    </a>
  </div>

  <div class="card">
    <a class="btn btnAkasha" href="https://liff.line.me/2008406620-G5j1gjzM">
      ğŸ˜ ã‚ã‹ã—ã‚ƒã‚·ãƒªãƒ¼ã‚º
    </a>
  </div>

  <div class="card">
    <a class="btn btnStore" href="https://liff.line.me/2008406620-7tSkOcqd">
      ğŸ  åº—é ­å—å–ï¼ˆç¾é‡‘ï¼‰
    </a>
  </div>
</div>

<div id="status" class="status"></div>

<script>
(async function(){
  const status = document.getElementById("status");
  const log = (html)=> status.innerHTML += html + "<br>";

  log("<b>LIFFèµ·å‹•ãƒã‚§ãƒƒã‚¯</b>");
  log("URL: " + location.href);

  // â˜… é‡è¦ï¼šã“ã®ãƒšãƒ¼ã‚¸ã¯ã€Œå·¦ä¸Šã€ã§é–‹ã LIFF ã«å›ºå®š
  const FIXED_LIFF_ID = "2008406620-8CWfgEKh";

  try{
    await liff.init({ liffId: FIXED_LIFF_ID });
    log("liff.init: <span class='ok'>OK</span>");
  }catch(e){
    log("liff.init: <span class='ng'>FAILED</span>");
    log(String(e));
    return;
  }

  // ãƒ­ã‚°ã‚¤ãƒ³å¼·åˆ¶ï¼ˆå¤–éƒ¨æ‰±ã„ã§ã‚‚ userId ã‚’å–ã‚‹ï¼‰
  if(!liff.isLoggedIn()){
    log("login: <span class='warn'>æœªãƒ­ã‚°ã‚¤ãƒ³ â†’ login()</span>");
    liff.login({ redirectUri: location.href });
    return;
  }else{
    log("login: <span class='ok'>OK</span>");
  }

  // userId å–å¾—
  let userId = null;
  try{ userId = liff.getDecodedIDToken()?.sub || null; }catch(e){}
  if(!userId){
    try{ userId = (await liff.getProfile())?.userId || null; }catch(e){}
  }

  if(userId){
    log("userId: <span class='ok'>å–å¾—OK</span>");
  }else{
    log("userId: <span class='ng'>æœªå–å¾—</span>");
    return;
  }

  // èµ·å‹•ãƒ­ã‚°é€ä¿¡ï¼ˆ1å›ã ã‘ï¼‰
  const key = "opened_sent";
  if(!sessionStorage.getItem(key)){
    sessionStorage.setItem(key,"1");

    const res = await fetch("/api/liff/opened",{
      method:"POST",
      headers:{ "content-type":"application/json" },
      body: JSON.stringify({
        userId,
        source: "index|order",
        ts: Date.now()
      })
    });

    log("POST /api/liff/opened: " +
      (res.ok ? "<span class='ok'>OK</span>" : "<span class='ng'>NG</span>")
    );
  }else{
    log("POST /api/liff/opened: skip");
  }
})();
</script>
</body>
</html>
