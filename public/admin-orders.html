<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>注文者管理画面</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #f7f7f7;
      color: #333;
    }
    h1 {
      font-size: 20px;
      margin-bottom: 8px;
    }
    p {
      font-size: 13px;
      margin: 4px 0 10px;
    }
    .card {
      background: #fff;
      border-radius: 10px;
      padding: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      margin-bottom: 12px;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    label {
      font-size: 12px;
    }
    input[type="text"],
    input[type="password"],
    input[type="number"] {
      padding: 6px 8px;
      font-size: 13px;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    input.token-input {
      width: 260px;
      max-width: 100%;
    }
    button {
      padding: 6px 12px;
      border-radius: 999px;
      border: none;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-primary {
      background: #00b900;
      color: #fff;
    }
    .btn-secondary {
      background: #fff;
      color: #333;
      border: 1px solid #ccc;
    }
    .btn-danger {
      background: #d7263d;
      color: #fff;
    }
    .status {
      font-size: 12px;
      margin-top: 6px;
      white-space: pre-line;
    }
    .status.ok {
      color: #0a7b19;
    }
    .status.err {
      color: #d00;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 8px;
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
    }
    thead {
      background: #eee;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #eee;
      vertical-align: top;
    }
    th {
      text-align: left;
      white-space: nowrap;
    }
    tr:nth-child(even) td {
      background: #fafafa;
    }
    .nowrap {
      white-space: nowrap;
    }
    .small {
      font-size: 11px;
      color: #666;
    }
    .tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      background: #eee;
      margin-right: 4px;
    }
    .tag.method {
      background: #e3f2fd;
    }
    .tag.payment {
      background: #fff3cd;
    }
    .tag.source {
      background: #e8f5e9;
    }
    .btn-sm {
      font-size: 11px;
      padding: 4px 8px;
    }
  </style>
</head>
<body>
  <h1>注文者管理画面</h1>
  <p>オンライン注文・電話注文のログ（<code>orders.log</code>）を一覧し、注文者に「発送しました」通知を送るための画面です。</p>

  <div class="card">
    <div class="row">
      <div>
        <label>管理APIトークン（ADMIN_API_TOKEN / ADMIN_CODE）</label><br />
        <input id="tokenInput" class="token-input" type="text" placeholder="例）1234567890abcdef..." />
      </div>
      <div>
        <label>取得件数</label><br />
        <input id="limitInput" type="number" min="1" max="5000" value="200" style="width:80px;" />
      </div>
      <div style="margin-top: 18px;">
        <button id="loadBtn" class="btn-primary">注文一覧を読み込む</button>
        <button id="clearTokenBtn" class="btn-secondary">トークンをクリア</button>
      </div>
    </div>
    <div id="status" class="status"></div>
  </div>

  <div id="tableWrap"></div>

  <script>
    (function () {
      "use strict";

      const tokenInput      = document.getElementById("tokenInput");
      const limitInput      = document.getElementById("limitInput");
      const loadBtn         = document.getElementById("loadBtn");
      const clearTokenBtn   = document.getElementById("clearTokenBtn");
      const statusEl        = document.getElementById("status");
      const tableWrap       = document.getElementById("tableWrap");

      function setStatus(msg, kind) {
        statusEl.textContent = msg || "";
        statusEl.classList.remove("ok", "err");
        if (kind === "ok")  statusEl.classList.add("ok");
        if (kind === "err") statusEl.classList.add("err");
      }

      function loadToken() {
        const saved = localStorage.getItem("iso_admin_token") || "";
        if (saved) tokenInput.value = saved;
      }

      function saveToken() {
        const tok = (tokenInput.value || "").trim();
        if (tok) {
          localStorage.setItem("iso_admin_token", tok);
        }
      }

      function clearToken() {
        localStorage.removeItem("iso_admin_token");
        tokenInput.value = "";
        setStatus("保存していたトークンを削除しました。", "ok");
      }

      function formatDate(ts) {
        if (!ts) return "";
        try {
          const d = new Date(ts);
          if (!isFinite(d.getTime())) return ts;
          const y = d.getFullYear();
          const m = String(d.getMonth() + 1).padStart(2, "0");
          const day = String(d.getDate()).padStart(2, "0");
          const hh = String(d.getHours()).padStart(2, "0");
          const mm = String(d.getMinutes()).padStart(2, "0");
          return `${y}/${m}/${day} ${hh}:${mm}`;
        } catch {
          return ts;
        }
      }

      function escapeHtml(str) {
        return String(str || "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function buildTable(items) {
        if (!items || items.length === 0) {
          tableWrap.innerHTML = "<p>注文データが見つかりませんでした。</p>";
          return;
        }

        let html = "";
        html += "<table>";
        html += "<thead><tr>";
        html += "<th class='nowrap'>日時</th>";
        html += "<th class='nowrap'>ユーザーID</th>";
        html += "<th>注文内容</th>";
        html += "<th class='nowrap'>合計</th>";
        html += "<th class='nowrap'>区分</th>";
        html += "<th>住所情報</th>";
        html += "<th class='nowrap'>操作</th>";
        html += "</tr></thead><tbody>";

        items.forEach((it, idx) => {
          const ts     = formatDate(it.ts || "");
          const userId = it.userId || it.lineUserId || "";

          // 支払方法・受取方法・ソース
          const method  = it.method  || "";
          const payment = it.payment || (it.codFee ? "cod" : (it.source === "liff-stripe" ? "card" : ""));
          const source  = it.source  || (it.items ? "stripe" : "direct");

          // 注文内容
          let summary = "";
          if (Array.isArray(it.items) && it.items.length > 0) {
            summary = it.items.map(x => `${x.name || x.id || "商品"} x${x.qty || 1}`).join(" / ");
          } else {
            const name = it.productName || it.productId || "商品";
            const qty  = it.qty || 1;
            summary = `${name} x${qty}`;
          }

          // 合計金額
          const total = it.finalTotal ?? it.total ?? it.subtotal ?? 0;
          const shipping = it.shipping ?? 0;
          const codFee   = it.codFee ?? 0;

          // 住所
          const addr = it.address || {};
          const name = addr.name || ((addr.lastName || "") + (addr.firstName || ""));
          const tel  = addr.tel || addr.phone || "";
          const zip  = addr.zip || addr.postal || "";
          const fullAddr =
            (addr.prefecture || addr.pref || "") +
            (addr.city || "") +
            (addr.addr1 || addr.address1 || "") +
            (addr.addr2 ? " " + addr.addr2 : addr.address2 ? " " + addr.address2 : "");

          const productName = (it.productName || (Array.isArray(it.items) && it.items[0]?.name) || "");
          const orderNumber = it.orderNumber || "";

          html += "<tr>";
          html += `<td class="nowrap small">${escapeHtml(ts)}</td>`;
          html += `<td class="small">${escapeHtml(userId)}</td>`;
          html += `<td class="small">${escapeHtml(summary)}</td>`;
          html += `<td class="nowrap small">商品:${(it.itemsTotal ?? it.subtotal ?? 0).toLocaleString("ja-JP")}円<br>送料:${shipping.toLocaleString("ja-JP")}円<br>代引:${codFee.toLocaleString("ja-JP")}円<br><strong>合計:${total.toLocaleString("ja-JP")}円</strong></td>`;
          html += `<td class="small">
                     <span class="tag method">${escapeHtml(method || "-")}</span><br>
                     <span class="tag payment">${escapeHtml(payment || "-")}</span><br>
                     <span class="tag source">${escapeHtml(source)}</span>
                   </td>`;
          html += `<td class="small">
                     氏名：${escapeHtml(name || "-")}<br>
                     TEL：${escapeHtml(tel || "-")}<br>
                     〒${escapeHtml(zip || "-")}<br>
                     ${escapeHtml(fullAddr || "-")}
                   </td>`;
          html += `<td class="nowrap">
                     <button
                       class="btn-sm btn-primary"
                       data-idx="${idx}"
                       data-user-id="${escapeHtml(userId)}"
                       data-product-name="${escapeHtml(productName)}"
                       data-order-number="${escapeHtml(orderNumber)}"
                     >発送通知</button>
                   </td>`;
          html += "</tr>";
        });

        html += "</tbody></table>";
        tableWrap.innerHTML = html;

        // ボタンイベント
        tableWrap.querySelectorAll("button[data-user-id]").forEach(btn => {
          btn.addEventListener("click", () => {
            const idx         = Number(btn.getAttribute("data-idx") || "0");
            const userId      = btn.getAttribute("data-user-id") || "";
            const productName = btn.getAttribute("data-product-name") || "";
            const orderNumber = btn.getAttribute("data-order-number") || "";
            onClickNotifyShipped(items[idx], { userId, productName, orderNumber });
          });
        });
      }

      async function fetchOrders() {
        const token = (tokenInput.value || "").trim();
        const limit = Math.min(5000, Math.max(1, Number(limitInput.value) || 200));

        if (!token) {
          setStatus("管理APIトークンを入力してください。", "err");
          return;
        }

        saveToken();
        setStatus("注文一覧を取得中です…", "");

        try {
          const res = await fetch(`/api/admin/orders?limit=${encodeURIComponent(limit)}`, {
            headers: {
              "Authorization": `Bearer ${token}`,
            },
          });
          const data = await res.json();
          if (!res.ok || !data.ok) {
            console.error("/api/admin/orders error:", data);
            setStatus("注文一覧の取得に失敗しました。トークンや権限を確認してください。", "err");
            tableWrap.innerHTML = "";
            return;
          }

          const items = Array.isArray(data.items) ? data.items : [];
          setStatus(`注文データを ${items.length} 件読み込みました。`, "ok");
          buildTable(items);
        } catch (e) {
          console.error("fetchOrders error:", e);
          setStatus("通信エラーが発生しました。ネットワークをご確認ください。", "err");
          tableWrap.innerHTML = "";
        }
      }

      async function onClickNotifyShipped(order, ctx) {
        const token = (tokenInput.value || "").trim();
        if (!token) {
          setStatus("管理APIトークンを入力してください。", "err");
          return;
        }

        const userId      = ctx.userId      || order.userId || order.lineUserId || "";
        const productName = ctx.productName || order.productName || (Array.isArray(order.items) && order.items[0]?.name) || "";
        const orderNumber = ctx.orderNumber || order.orderNumber || "";

        if (!userId) {
          alert("ユーザーIDが不明なため、発送通知を送れません。");
          return;
        }

        if (!confirm(`この注文者（${userId}）に「発送しました」通知を送信しますか？`)) {
          return;
        }

        try {
          setStatus("発送通知を送信中です…", "");
          const res = await fetch("/api/admin/orders/notify-shipped", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${token}`,
            },
            body: JSON.stringify({
              userId,
              productName,
              orderNumber,
            }),
          });
          const data = await res.json();
          if (!res.ok || !data.ok) {
            console.error("notify-shipped error:", data);
            setStatus("発送通知の送信に失敗しました。", "err");
            alert("発送通知の送信に失敗しました。");
            return;
          }
          setStatus("発送通知を送信しました。", "ok");
        } catch (e) {
          console.error("notify-shipped error:", e);
          setStatus("通信エラーにより発送通知を送信できませんでした。", "err");
          alert("通信エラーにより発送通知を送信できませんでした。");
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        loadToken();
        loadBtn.addEventListener("click", fetchOrders);
        clearTokenBtn.addEventListener("click", clearToken);

        // Enterキーで読み込み
        tokenInput.addEventListener("keydown", (ev) => {
          if (ev.key === "Enter") {
            ev.preventDefault();
            fetchOrders();
          }
        });
      });
    })();
  </script>
</body>
</html>
