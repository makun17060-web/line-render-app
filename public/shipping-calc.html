<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>é€æ–™è¨ˆç®—ï¼ˆserver-lineå®Œå…¨ä¸€è‡´ï¼‰</title>
  <style>
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:#f7f7f7;margin:0;padding:14px}
    h1{font-size:20px;margin:0 0 10px}
    .card{background:#fff;border-radius:14px;padding:14px;box-shadow:0 1px 3px rgba(0,0,0,.08);margin-bottom:12px}
    label{font-weight:800;display:block;margin:10px 0 4px}
    select,input{width:100%;padding:10px;border-radius:10px;border:1px solid #ddd;font-size:15px}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px}
    th,td{padding:8px;border-bottom:1px solid #eee}
    th{text-align:left;background:#f1f5f9}
    .right{text-align:right;font-weight:800}
    .result{font-size:18px;font-weight:900;color:#0b3a53;text-align:right;margin-top:10px}
    .pill{display:inline-block;background:#eef2ff;color:#0b3a53;border-radius:999px;padding:6px 10px;font-weight:800;font-size:12px;margin-right:6px}
    .note{font-size:12px;color:#666;line-height:1.6}
    .err{background:#fff1f2;border:1px solid #fecdd3;color:#9f1239;border-radius:12px;padding:10px 12px;font-size:13px;line-height:1.6}
  </style>
</head>
<body>

<h1>ğŸ“¦ é€æ–™è¨ˆç®—ï¼ˆserver-lineå®Œå…¨ä¸€è‡´ï¼‰</h1>

<div class="card" id="errBox" style="display:none"></div>

<div class="card">
  <label>å•†å“</label>
  <select id="product"></select>

  <label>å€‹æ•°</label>
  <input type="number" id="qty" value="1" min="1">

  <label>é€ä»˜å…ˆåœ°åŸŸ</label>
  <select id="region"></select>
</div>

<div class="card">
  <div style="margin-bottom:6px">
    <span class="pill" id="sizePill">ã‚µã‚¤ã‚ºï¼š-</span>
    <span class="pill" id="regionPill">åœ°åŸŸï¼š-</span>
    <span class="pill" id="sourcePill">é€æ–™ï¼šèª­ã¿è¾¼ã¿ä¸­</span>
  </div>

  <table>
    <tr><th>å†…å®¹</th><th class="right">é‡‘é¡</th></tr>
    <tr><td>å•†å“åˆè¨ˆ</td><td class="right" id="itemTotal">-</td></tr>
    <tr><td>é€æ–™</td><td class="right" id="shippingFee">-</td></tr>
  </table>

  <div class="result">
    åˆè¨ˆï¼š<span id="grandTotal">-</span>
  </div>

  <p class="note">
    â€» é€æ–™è¡¨ãƒ»ã‚µã‚¤ã‚ºåˆ¤å®šã¯ <code>/api/shipping/config</code>ï¼ˆserver-line.jsï¼‰ã¨åŒã˜å†…å®¹ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚<br>
    â€» ç®±ã‚µã‚¤ã‚ºã¯ã€Œåˆè¨ˆå€‹æ•°ã€ã¨ã€Œã‚ªãƒªã‚¸ãƒŠãƒ«ã‚»ãƒƒãƒˆå€‹æ•°ã€ã‚’ä¸¡æ–¹è¦‹ã¦ã€å¤§ãã„æ–¹ã‚’æ¡ç”¨ã—ã¾ã™ï¼ˆserver-lineã¨åŒã˜ï¼‰ã€‚
  </p>
</div>

<script>
/* ======================
   å•†å“ï¼ˆã‚ãªãŸãŒæç¤ºã—ãŸã‚‚ã®ï¼‰
   â€»ä¾¡æ ¼ã¯è¡¨ç¤ºç”¨ã€‚é€æ–™ã¯ server ã®ãƒ­ã‚¸ãƒƒã‚¯ã«åˆã‚ã›ã‚‹
====================== */
const PRODUCTS = [
  { id:"kusuke-250", name:"ä¹…åŠ©ï¼ˆãˆã³ã›ã‚“ï¼‰", price:250 },
  { id:"nori-akasha-340", name:"ã®ã‚Šã‚ã‹ã—ã‚ƒ", price:340 },
  { id:"uzu-akasha-340", name:"ã†ãšã‚ã‹ã—ã‚ƒ", price:340 },
  { id:"shio-akasha-340", name:"æ½®ã‚ã‹ã—ã‚ƒ", price:340 },
  { id:"matsu-akasha-340", name:"æ¾ã‚ã‹ã—ã‚ƒ", price:340 },
  { id:"iso-akasha-340", name:"ç£¯ã‚ã‹ã—ã‚ƒ", price:340 },
  { id:"goma-akasha-340", name:"ã”ã¾ã‚ã‹ã—ã‚ƒ", price:340 },
  // serverå´ã¯ ORIGINAL_SET_PRODUCT_ID ãŒ "original-set-2100" ãªã®ã§ãã‚Œã«å¯„ã›ã‚‹
  { id:"original-set-2100", name:"ç£¯å±‹ã‚ªãƒªã‚¸ãƒŠãƒ«ã‚»ãƒƒãƒˆ", price:2100, isOriginalHint:true }
];

let CFG = null; // /api/shipping/config ã®ä¸­èº«

const productSel = document.getElementById("product");
const regionSel  = document.getElementById("region");
const qtyInput   = document.getElementById("qty");

PRODUCTS.forEach(p=>{
  const o=document.createElement("option");
  o.value=p.id;
  o.textContent=`${p.name}ï¼ˆ${p.price.toLocaleString()}å††ï¼‰`;
  productSel.appendChild(o);
});

productSel.onchange = calc;
regionSel.onchange  = calc;
qtyInput.oninput    = calc;

init();

async function init(){
  try {
    const res = await fetch("/api/shipping/config", { cache: "no-store" });
    const data = await res.json();
    if (!data.ok) throw new Error("config not ok");
    CFG = data.config;

    // åœ°åŸŸä¸€è¦§
    regionSel.innerHTML = "";
    (CFG.regions || []).forEach(r=>{
      const o=document.createElement("option");
      o.value=r; o.textContent=r;
      regionSel.appendChild(o);
    });

    document.getElementById("sourcePill").textContent = "é€æ–™ï¼šserver-line";
    calc();
  } catch (e) {
    showErr("é€æ–™è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚server-line.js ã« /api/shipping/config ã‚’è¿½åŠ ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    document.getElementById("sourcePill").textContent = "é€æ–™ï¼šèª­è¾¼å¤±æ•—";
  }
}

function showErr(msg){
  const box = document.getElementById("errBox");
  box.className = "err";
  box.style.display = "block";
  box.textContent = msg;
}

/* ======================
   ã“ã“ã‹ã‚‰ â€œserver-line.js ã¨åŒã˜åˆ¤å®šé–¢æ•°â€
====================== */
function sizeFromOriginalSetQty(qty){
  const q = Number(qty) || 0;
  if (q <= 0) return null;
  if (q === 1) return "80";
  if (q === 2) return "100";
  if (q <= 4) return "120";
  if (q <= 6) return "140";
  return "160";
}
// â€»server-lineã‚³ãƒ¡ãƒ³ãƒˆé€šã‚Šã€Œå€‹æ•°ã€ã§åˆ¤å®š
function sizeFromTotalQty(totalQty){
  const q = Number(totalQty) || 0;
  if (q <= 1) return "60";
  if (q === 2) return "80";
  if (q === 3) return "100";
  if (q <= 4) return "120";
  if (q <= 6) return "140";
  return "160";
}
function maxSize(a,b){
  const order = CFG.sizeOrder || ["60","80","100","120","140","160"];
  if (!a) return b;
  if (!b) return a;
  return order.indexOf(a) >= order.indexOf(b) ? a : b;
}
function calcYamatoShipping(region, size){
  if (!region) return 0;
  const table = (CFG.yamatoChubuTaxed || {})[String(size)] || null;
  if (!table) return 0;
  return Number(table[region] || 0);
}

// server-line ã¨åŒã˜ã€Œã‚ªãƒªã‚¸ãƒŠãƒ«ã‚»ãƒƒãƒˆåˆ¤å®šã€
// - id ãŒ ORIGINAL_SET_PRODUCT_ID ã¨ä¸€è‡´
// - ã‚‚ã—ãã¯ åå‰ãŒ /ç£¯å±‹.?ã‚ªãƒªã‚¸ãƒŠãƒ«ã‚»/ ã«ä¸€è‡´
function isOriginalItem(item){
  const id = String(item.id || "").trim();
  const name = String(item.name || "").trim();
  const byId = (id && CFG.originalSetProductId && id === String(CFG.originalSetProductId));
  const byName = /ç£¯å±‹.?ã‚ªãƒªã‚¸ãƒŠãƒ«ã‚»/.test(name);
  return byId || byName;
}

function calcShippingUnified(items, region){
  const totalQty = items.reduce((s,it)=>s + Number(it.qty||0), 0);
  const originalQty = items.reduce((s,it)=> s + (isOriginalItem(it) ? Number(it.qty||0) : 0), 0);

  const sizeA = sizeFromOriginalSetQty(originalQty);
  const sizeB = sizeFromTotalQty(totalQty);
  const size  = maxSize(sizeA, sizeB);

  const shipping = calcYamatoShipping(region, size);
  return { region, size, shipping, totalQty, originalQty };
}

/* ======================
   è¨ˆç®—è¡¨ç¤º
====================== */
function calc(){
  if (!CFG) return;

  const p = PRODUCTS.find(x=>x.id===productSel.value);
  const qty = Math.max(1, Number(qtyInput.value||1));
  const region = regionSel.value;

  const itemTotal = p.price * qty;

  // 1å•†å“ã ã‘ã®æƒ³å®šï¼ˆãƒšãƒ¼ã‚¸ç”¨é€”ã«åˆã‚ã›ã¦ï¼‰
  const items = [{ id: p.id, name: p.name, qty }];

  const r = calcShippingUnified(items, region);
  const grand = itemTotal + r.shipping;

  document.getElementById("sizePill").textContent = `ã‚µã‚¤ã‚ºï¼š${r.size}`;
  document.getElementById("regionPill").textContent = `åœ°åŸŸï¼š${r.region || "-"}`;
  document.getElementById("itemTotal").textContent = itemTotal.toLocaleString()+"å††";
  document.getElementById("shippingFee").textContent = r.shipping.toLocaleString()+"å††";
  document.getElementById("grandTotal").textContent = grand.toLocaleString()+"å††";
}
</script>

</body>
</html>
