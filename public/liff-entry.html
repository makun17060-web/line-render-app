<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>LIFF Entry</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
</head>
<body>
  <p id="status">LIFF 初期化中です…</p>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    // ★ ここに実際の LIFF ID を入れてください
    const LIFF_ID = "2008406620-4QJ06JLv"; // ← あなたの LIFF_ID_MINIAPP

    function resolveRedirectUrl(raw) {
      if (!raw) return null;

      try {
        // もし URL エンコードされていたらデコード
        const decoded = decodeURIComponent(raw);
        let redirect = decoded;

        // フル URL ではなく /public/... などのパスだけが来る想定
        // （万一フルURLが来ても、ドメインだけ置き換える）
        const origin = window.location.origin;

        if (redirect.startsWith("http://") || redirect.startsWith("https://")) {
          // 他ドメインには飛ばさないように、自分の origin に差し替え
          try {
            const u = new URL(redirect);
            redirect = origin + u.pathname + u.search + u.hash;
          } catch (e) {
            // URL としておかしければ products にフォールバック
            return origin + "/public/products.html";
          }
        } else {
          // /public/... のようなパスの場合
          if (!redirect.startsWith("/")) {
            redirect = "/" + redirect.replace(/^\.?\//, "");
          }
          redirect = origin + redirect;
        }
        return redirect;
      } catch (e) {
        console.error("resolveRedirectUrl error:", e);
        return null;
      }
    }

    async function main() {
      const statusEl = document.getElementById("status");
      statusEl.textContent = "LIFF 初期化中です…";

      try {
        await liff.init({ liffId: LIFF_ID });
        statusEl.textContent = "LIFF 初期化に成功しました。ページを遷移します…";

        const params = new URLSearchParams(window.location.search);
        const rawRedirect = params.get("redirect");

        // redirect が指定されていなければ、デフォルトは products.html
        let redirectUrl = resolveRedirectUrl(rawRedirect) ||
                          (window.location.origin + "/public/products.html");

        console.log("redirect ->", redirectUrl);

        // 履歴を残さずに遷移
        window.location.replace(redirectUrl);
      } catch (e) {
        console.error("liff.init error:", e);
        statusEl.textContent = "LIFF の初期化に失敗しました: " + (e.message || e);
      }
    }

    main();
  </script>
</body>
</html>
