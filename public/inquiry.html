<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>お問い合わせ</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",sans-serif;margin:0;background:#f6f6f6;color:#222}
    .wrap{max-width:720px;margin:0 auto;padding:14px}
    .card{background:#fff;border-radius:14px;padding:14px;box-shadow:0 2px 10px rgba(0,0,0,.06)}
    h1{font-size:18px;margin:0 0 6px}
    p{margin:0 0 10px;font-size:13px;line-height:1.6;color:#555}
    textarea{
      width:100%; min-height:160px; resize:vertical;
      border:1px solid #ddd; border-radius:12px;
      padding:12px; font-size:16px; line-height:1.6;
      outline:none; background:#fff;
    }
    textarea:focus{border-color:#06c755; box-shadow:0 0 0 3px rgba(6,199,85,.15)}
    .row{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap}
    button{
      border:0; border-radius:12px; padding:12px 14px;
      font-size:15px; cursor:pointer;
    }
    .primary{background:#06c755;color:#fff;flex:1}
    .ghost{background:#eee;color:#333}
    .note{margin-top:10px;font-size:12px;color:#666}
    .toast{margin-top:10px;font-size:13px;padding:10px 12px;border-radius:12px;display:none}
    .ok{background:#e7f8ee;color:#126b34}
    .ng{background:#ffecec;color:#9b1c1c}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>お問い合わせ</h1>
      <p>こちらに内容をご入力ください。送信するとトークに送られます。</p>

      <textarea id="msg" placeholder="例：◯◯の在庫はありますか？ いつ発送できますか？"></textarea>

      <div class="row">
        <button id="send" class="primary">送信</button>
        <button id="close" class="ghost" type="button">閉じる</button>
      </div>

      <div id="toast" class="toast"></div>
      <div class="note">※送信後にトークへ戻ります。</div>
    </div>
  </div>

<script>
(async () => {
  const msgEl = document.getElementById("msg");
  const sendBtn = document.getElementById("send");
  const closeBtn = document.getElementById("close");
  const toast = document.getElementById("toast");

  const LIFF_ID = "2008406620-LUJ3dURd"; // ← ★ここだけ入れてください

  const show = (text, type="ok") => {
    toast.style.display = "block";
    toast.className = "toast " + (type === "ok" ? "ok" : "ng");
    toast.textContent = text;
  };

  // キーボードを開きやすくする（※端末/設定で100%ではない）
  const focusInput = () => {
    try { msgEl.focus({ preventScroll: true }); } catch { try { msgEl.focus(); } catch {} }
    // iOS対策の“もう一押し”
    setTimeout(() => { try { msgEl.focus({ preventScroll: true }); } catch { try { msgEl.focus(); } catch {} } }, 250);
  };

  // LIFF初期化
  try {
    await liff.init({ liffId: LIFF_ID });

    // 外部ブラウザで開かれた場合はログイン誘導（LIFFの仕様）
    if (!liff.isLoggedIn()) liff.login();
  } catch (e) {
    show("LIFF初期化に失敗しました。LIFF_IDを確認してください。", "ng");
    console.error(e);
    focusInput();
    return;
  }

  // 初期表示で入力にフォーカス
  focusInput();

  // Enter送信（スマホの改行と被るのでCtrl/Meta+Enterにするのが安全だが、希望あれば変更可）
  msgEl.addEventListener("keydown", (ev) => {
    if ((ev.ctrlKey || ev.metaKey) && ev.key === "Enter") {
      ev.preventDefault();
      sendBtn.click();
    }
  });

  closeBtn.addEventListener("click", () => {
    if (liff.isInClient()) liff.closeWindow();
    else history.back();
  });

  sendBtn.addEventListener("click", async () => {
    const text = (msgEl.value || "").trim();
    if (!text) return show("本文が空です。入力してください。", "ng");

    // 送る文面（ボット側で「問い合わせ」判定と被らないように先頭を変える）
    const payload = "【問い合わせ】\n" + text;

    sendBtn.disabled = true;
    try {
      await liff.sendMessages([{ type: "text", text: payload }]);
      show("送信しました。トークへ戻ります…", "ok");

      // 少し待ってから閉じる（体感安定）
      setTimeout(() => {
        if (liff.isInClient()) liff.closeWindow();
        else location.href = "https://line.me/R/";
      }, 700);
    } catch (e) {
      console.error(e);
      show("送信に失敗しました。LINEアプリ内で開いているか確認してください。", "ng");
      sendBtn.disabled = false;
      focusInput();
    }
  });
})();
</script>
</body>
</html>
