<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>住所入力</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
:root{
  --bg:#f7f7f7; --card:#fff; --text:#111827; --muted:#6b7280;
  --pri:#0b3a53; --border:#e5e7eb; --radius:14px;
}
body{ margin:0; font-family:system-ui,-apple-system,"Segoe UI",sans-serif; background:var(--bg); }
.wrap{ max-width:720px; margin:0 auto; padding:14px; }
.card{ background:#fff; border:1px solid var(--border); border-radius:14px; padding:14px; margin-top:12px; }
.addrItem{ border:1px solid var(--border); border-radius:12px; padding:10px; cursor:pointer; margin-top:6px; }
.addrItem.active{ outline:2px solid var(--pri); }
.btn{ width:100%; padding:14px; margin-top:14px; background:var(--pri); color:#fff; border:none; border-radius:14px; font-weight:900; }
.btnSub{ background:#fff; color:#111; border:1px solid var(--border); }
input{ width:100%; padding:10px; border-radius:10px; border:1px solid var(--border); margin-top:6px; }
</style>
</head>

<body>
<div class="wrap">
<h1>住所入力</h1>

<div class="card">
  <label><input type="radio" name="shipMode" value="self" checked> 自宅に送る</label>
  <label><input type="radio" name="shipMode" value="gift"> ギフトで送る</label>

  <div id="addrList"></div>
</div>

<div class="card">
  <input id="label" placeholder="自宅 / 贈り先">
  <input id="name" placeholder="名前">
  <input id="phone" placeholder="電話">
  <input id="postal" placeholder="郵便番号">
  <input id="prefecture" placeholder="都道府県">
  <input id="city" placeholder="市区町村">
  <input id="address1" placeholder="番地">
  <input id="address2" placeholder="建物名">

  <label><input type="checkbox" id="setDefault"> この住所を自宅にする</label>

  <button id="saveBtn" class="btn">保存して次へ</button>
  <button onclick="history.back()" class="btn btnSub">戻る</button>
</div>
</div>

<script>
const KEY_SELF="isoya_selfaddr", KEY_GIFT="isoya_giftaddr";
let addressBook=[], selfId=null, giftId=null;

function shipMode(){
  return document.querySelector("input[name=shipMode]:checked").value;
}

async function load(){
  const uid=localStorage.getItem("isoya_userId");
  const r=await fetch("/api/address/list?userId="+uid);
  const j=await r.json();
  addressBook=j.addresses||[];
  selfId=Number(localStorage.getItem(KEY_SELF)||0)||null;
  giftId=Number(localStorage.getItem(KEY_GIFT)||0)||null;
  render();
  autoSelect();
}

function autoSelect(){
  if(shipMode()==="self"){
    const def=addressBook.find(a=>a.is_default)||addressBook[0];
    if(def){ selfId=def.id; fill(def); }
  }else{
    const g=addressBook.find(a=>a.id===giftId)||addressBook.find(a=>!a.is_default)||addressBook[0];
    if(g){ giftId=g.id; fill(g); }
  }
}

function render(){
  const list=document.getElementById("addrList");
  list.innerHTML="";
  const sid=shipMode()==="self"?selfId:giftId;
  for(const a of addressBook){
    const d=document.createElement("div");
    d.className="addrItem"+(a.id===sid?" active":"");
    d.textContent=(a.label||"住所")+" "+a.name+" "+a.prefecture+a.city;
    d.onclick=()=>{
      if(shipMode()==="self"){ selfId=a.id; localStorage.setItem(KEY_SELF,a.id); }
      else{ giftId=a.id; localStorage.setItem(KEY_GIFT,a.id); }
      fill(a);
      render();
    };
    list.appendChild(d);
  }
}

function fill(a){
  label.value=a.label||"";
  name.value=a.name||"";
  phone.value=a.phone||"";
  postal.value=a.postal||"";
  prefecture.value=a.prefecture||"";
  city.value=a.city||"";
  address1.value=a.address1||"";
  address2.value=a.address2||"";
  setDefault.checked=!!a.is_default;
}

saveBtn.onclick=async ()=>{
  const id=shipMode()==="self"?selfId:giftId;
  const payload={
    userId:localStorage.getItem("isoya_userId"),
    addressId:id,
    label:label.value,
    name:name.value, phone:phone.value, postal:postal.value,
    prefecture:prefecture.value, city:city.value, address1:address1.value, address2:address2.value,
    is_default:setDefault.checked
  };
  const r=await fetch("/api/address/set",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
  const j=await r.json();
  if(!j.ok){ alert("保存失敗"); return; }
  location.href="/confirm.html"+(shipMode()==="gift"?"?ship=gift":"");
};

document.querySelectorAll("input[name=shipMode]").forEach(r=>r.onchange=()=>{ autoSelect(); render(); });

load();
</script>
</body>
</html>
