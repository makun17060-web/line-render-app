<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>磯屋 管理：セグメント配信（LIFF起動者）</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --txt:#111827; --muted:#6b7280;
      --line:#e5e7eb; --pri:#2563eb; --pri2:#1d4ed8; --danger:#dc2626;
      --ok:#16a34a;
    }
    body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    header{padding:14px 16px;border-bottom:1px solid var(--line);background:#fff;position:sticky;top:0;z-index:10}
    header h1{margin:0;font-size:16px}
    header p{margin:6px 0 0;color:var(--muted);font-size:12px}
    .wrap{max-width:1100px;margin:0 auto;padding:14px 16px 28px}
    .grid{display:grid;grid-template-columns:360px 1fr;gap:12px}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr} }
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:12px}
    .card h2{margin:0 0 10px;font-size:14px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input, textarea, select{
      width:100%; box-sizing:border-box; border:1px solid var(--line); border-radius:10px;
      padding:10px 10px; background:#fff; font-size:14px; outline:none;
    }
    textarea{min-height:130px;resize:vertical}
    .btn{
      border:1px solid var(--line); background:#fff; color:var(--txt);
      padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:600; font-size:13px;
    }
    .btn:hover{filter:brightness(.98)}
    .btn.pri{background:var(--pri);border-color:var(--pri);color:#fff}
    .btn.pri:hover{background:var(--pri2);border-color:var(--pri2)}
    .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
    .pill{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--line);padding:6px 10px;border-radius:999px;font-size:12px;color:var(--muted);background:#fff}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .small{font-size:12px;color:var(--muted)}
    .status{padding:10px;border-radius:10px;background:#0b1220;color:#e5e7eb;font-size:12px;white-space:pre-wrap}
    .ok{color:var(--ok)}
    .ng{color:#fca5a5}
    .list{
      border:1px solid var(--line);border-radius:10px;background:#fff;
      max-height:320px;overflow:auto;padding:8px
    }
    .list .item{padding:6px 8px;border-bottom:1px dashed var(--line);font-size:12px}
    .list .item:last-child{border-bottom:none}
    .rightTop{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .hint{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;padding:10px;border-radius:10px;font-size:12px;line-height:1.6}
    .k{display:inline-block;background:#f3f4f6;border:1px solid var(--line);padding:2px 8px;border-radius:999px;font-size:12px}
  </style>
</head>
<body>
<header>
  <h1>磯屋 管理：セグメント配信（LIFF起動者）</h1>
  <p>API: <span class="mono">GET /api/admin/segment/liff-open</span> / <span class="mono">POST /api/admin/push/segment</span></p>
</header>

<div class="wrap">
  <div class="grid">
    <!-- left -->
    <section class="card">
      <h2>認証</h2>
      <div class="row" style="gap:10px">
        <div style="flex:1;min-width:220px">
          <label>管理トークン（Bearer / token / code どれでもOK）</label>
          <input id="token" type="password" placeholder="ADMIN_API_TOKEN または ADMIN_CODE" />
          <div class="small">保存先：ブラウザ（localStorage）</div>
        </div>
        <div style="width:140px">
          <label>&nbsp;</label>
          <button class="btn" id="saveToken">保存</button>
        </div>
      </div>

      <div style="height:10px"></div>

      <h2>対象（LIFF起動者）</h2>
      <div class="row">
        <div style="width:140px">
          <label>過去何日分</label>
          <input id="days" type="number" value="30" min="1" max="365" />
        </div>
        <div style="flex:1;min-width:220px">
          <label>kind（今は all 固定運用）</label>
          <input id="kind" type="text" value="all" disabled />
          <div class="small">※ server側で kind は <span class="k">all</span> に統一される想定</div>
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="row">
        <button class="btn pri" id="load">セグメント取得</button>
        <button class="btn" id="copy">userIdをコピー</button>
        <button class="btn danger" id="clear">表示クリア</button>
      </div>

      <div style="height:10px"></div>
      <div class="hint">
        送信対象は <b>友だち追加済み</b> かつ <b>ブロックしていない</b> ユーザーのみ届きます。<br/>
        Push失敗は「ブロック/未友だち/ID無効」等でも起きます（failedに出ます）。
      </div>
    </section>

    <!-- right -->
    <section class="card">
      <div class="rightTop">
        <h2 style="margin:0">結果</h2>
        <div class="pill">件数：<span id="count" class="mono">0</span></div>
      </div>

      <div style="height:10px"></div>

      <div class="row" style="align-items:flex-start">
        <div style="flex:1;min-width:320px">
          <label>userId一覧</label>
          <div class="list" id="list"></div>
        </div>
        <div style="flex:1;min-width:320px">
          <label>一斉配信（text）</label>
          <textarea id="message" placeholder="例：年末の特別セールのお知らせ…"></textarea>
          <div class="row" style="margin-top:8px">
            <button class="btn pri" id="send">このセグメントへ一斉Push</button>
            <span class="small">（daysの条件で送信）</span>
          </div>

          <div style="height:10px"></div>
          <label>ステータス</label>
          <div class="status mono" id="status">ready.</div>
        </div>
      </div>
    </section>
  </div>
</div>

<script>
  const $ = (id) => document.getElementById(id);

  const STORAGE_KEY = "iso_admin_token_segment";
  function getToken() { return (localStorage.getItem(STORAGE_KEY) || "").trim(); }
  function setToken(t) { localStorage.setItem(STORAGE_KEY, (t||"").trim()); }

  function authHeaders(){
    const tok = ($("token").value || "").trim() || getToken();
    const h = { "Content-Type":"application/json" };
    if (tok) h["Authorization"] = "Bearer " + tok;
    return h;
  }

  function setStatus(msg, isOk=true){
    const el = $("status");
    const prefix = isOk ? "✅ " : "❌ ";
    el.textContent = prefix + msg;
    el.className = "status mono " + (isOk ? "ok" : "ng");
  }

  let currentIds = [];

  function renderList(ids){
    const list = $("list");
    list.innerHTML = "";
    $("count").textContent = String(ids.length);
    if (!ids.length){
      list.innerHTML = '<div class="item" style="color:#6b7280">（まだありません）</div>';
      return;
    }
    for (const uid of ids){
      const div = document.createElement("div");
      div.className = "item mono";
      div.textContent = uid;
      list.appendChild(div);
    }
  }

  async function loadSegment(){
    const days = Math.min(365, Math.max(1, Number($("days").value || 30)));
    try{
      setStatus("セグメント取得中...");
      const url = `/api/admin/segment/liff-open?days=${encodeURIComponent(days)}`;
      const r = await fetch(url, { headers: authHeaders() });
      const j = await r.json().catch(()=>null);
      if (!r.ok){
        throw new Error(j?.error || `HTTP ${r.status}`);
      }
      currentIds = Array.isArray(j?.items) ? j.items : [];
      renderList(currentIds);
      setStatus(`取得OK：${currentIds.length}件（days=${days}）`);
    }catch(e){
      setStatus(`取得失敗：${e.message || e}`, false);
    }
  }

  async function pushSegment(){
    const days = Math.min(365, Math.max(1, Number($("days").value || 30)));
    const text = ($("message").value || "").trim();
    if (!text){
      setStatus("メッセージを入力してください。", false);
      return;
    }
    try{
      setStatus("一斉Push実行中...");
      const body = { days, message: { type:"text", text } };
      const r = await fetch("/api/admin/push/segment", {
        method:"POST",
        headers: authHeaders(),
        body: JSON.stringify(body)
      });
      const j = await r.json().catch(()=>null);
      if (!r.ok){
        throw new Error(j?.error || `HTTP ${r.status}`);
      }
      setStatus(`送信完了：target=${j.target} pushed=${j.pushed} failed=${j.failed}`);
    }catch(e){
      setStatus(`送信失敗：${e.message || e}`, false);
    }
  }

  $("saveToken").addEventListener("click", () => {
    const t = ($("token").value || "").trim();
    if (!t){
      setStatus("空のため保存できません。", false);
      return;
    }
    setToken(t);
    setStatus("トークン保存OK");
  });

  $("load").addEventListener("click", loadSegment);

  $("copy").addEventListener("click", async () => {
    try{
      const text = currentIds.join("\n");
      await navigator.clipboard.writeText(text);
      setStatus(`コピーOK：${currentIds.length}件`);
    }catch{
      setStatus("コピー失敗（ブラウザ権限/HTTPSを確認）", false);
    }
  });

  $("clear").addEventListener("click", () => {
    currentIds = [];
    renderList(currentIds);
    setStatus("クリアしました");
  });

  $("send").addEventListener("click", pushSegment);

  // init
  $("token").value = getToken();
  renderList([]);
</script>
</body>
</html>
