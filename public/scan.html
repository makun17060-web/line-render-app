<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç™ºé€ã‚¹ã‚­ãƒ£ãƒ³</title>

<style>
body{
  margin:0;
  background:#000;
  color:#fff;
  font-family:sans-serif;
}

/* ã‚«ãƒ¡ãƒ© */
#video{
  position:fixed;
  inset:0;
  width:100%;
  height:100%;
  object-fit:cover;
}

/* ä¸Šéƒ¨ãƒ‘ãƒãƒ«ï¼ˆã“ã“ãŒãƒã‚¤ãƒ³ãƒˆğŸ”¥ï¼‰ */
.panel{
  position:fixed;
  top:0;
  left:0;
  width:100%;
  padding:10px;
  background:rgba(0,0,0,0.7);
}

/* å…¥åŠ› */
input{
  width:100%;
  padding:12px;
  font-size:16px;
  border-radius:8px;
  border:none;
  margin-bottom:8px;
}

/* ãƒœã‚¿ãƒ³ */
button{
  width:100%;
  padding:16px;
  font-size:18px;
  border:none;
  border-radius:10px;
  margin-bottom:8px;
  font-weight:bold;
}

.start{ background:#00c853; }
.stop{ background:#d50000; }
.send{ background:#2962ff; }

.status{
  text-align:center;
  font-size:14px;
}
</style>
</head>

<body>

<video id="video" autoplay playsinline></video>

<div class="panel">
  <input id="code" placeholder="ä¼ç¥¨ç•ªå·">

  <button class="start" onclick="startCamera()">ğŸ“· ã‚«ãƒ¡ãƒ©</button>
  <button class="send" onclick="send()">ğŸšš ç¢ºå®š</button>
  <button class="stop" onclick="stopCamera()">åœæ­¢</button>

  <div class="status" id="status">å¾…æ©Ÿä¸­</div>
</div>

<script src="https://unpkg.com/@zxing/library@latest"></script>

<script>
let reader = null;
let active = false;

function setStatus(t){
  document.getElementById("status").innerText = t;
}

async function startCamera(){
  try{
    reader = new ZXing.BrowserMultiFormatReader();

    await reader.decodeFromVideoDevice(null, "video", (res)=>{
      if(res && active){
        const code = res.getText();
        document.getElementById("code").value = code;
        setStatus("èª­å–ï¼š" + code);
        send(); // è‡ªå‹•é€ä¿¡ğŸ”¥
      }
    });

    active = true;
    setStatus("ã‚¹ã‚­ãƒ£ãƒ³ä¸­");
  }catch(e){
    alert("ã‚«ãƒ¡ãƒ©è¨±å¯ã—ã¦ãã ã•ã„");
  }
}

function stopCamera(){
  if(reader){
    reader.reset();
    active = false;
    setStatus("åœæ­¢");
  }
}

async function send(){
  const code = document.getElementById("code").value.trim();
  if(!code) return;

  setStatus("é€ä¿¡ä¸­");

  try{
    const res = await fetch("/api/admin/ship/scan-and-notify",{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "x-admin-token":"YOUR_ADMIN_TOKEN"
      },
      body: JSON.stringify({ tracking_no: code })
    });

    const data = await res.json();

    if(data.ok){
      setStatus("å®Œäº†");
      document.getElementById("code").value="";
    }else{
      setStatus("ã‚¨ãƒ©ãƒ¼");
    }
  }catch(e){
    setStatus("é€šä¿¡ã‚¨ãƒ©ãƒ¼");
  }
}
</script>

</body>
</html>