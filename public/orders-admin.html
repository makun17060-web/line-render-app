<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>注文管理・印刷用明細（えびせん）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, sans-serif;
      padding: 16px;
      font-size: 14px;
    }
    h1 {
      font-size: 20px;
      margin-bottom: 8px;
    }
    h2 {
      margin-top: 24px;
      font-size: 18px;
      border-bottom: 1px solid #ccc;
      padding-bottom: 4px;
    }
    .section {
      margin-top: 12px;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #fafafa;
    }
    .row {
      margin: 4px 0;
    }
    label {
      margin-right: 8px;
    }
    input[type="text"],
    input[type="date"],
    select {
      padding: 2px 4px;
      font-size: 13px;
    }
    button {
      margin: 2px;
      padding: 4px 8px;
      font-size: 13px;
      cursor: pointer;
    }
    #status {
      margin-left: 8px;
      font-weight: bold;
      font-size: 12px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 13px;
      margin-top: 4px;
      background: #fff;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 4px;
      text-align: left;
    }
    th {
      background: #eee;
      white-space: nowrap;
    }
    tbody tr:nth-child(even) {
      background: #f9f9f9;
    }
    .btn-print {
      font-size: 12px;
    }

    #log {
      margin-top: 12px;
      max-height: 180px;
      overflow: auto;
      font-size: 11px;
      background: #f5f5f5;
      padding: 4px;
      white-space: pre-wrap;
    }

    /* 印刷エリア */
    #printArea {
      display: none;  /* 通常は非表示 */
      margin-top: 20px;
      padding: 16px;
      max-width: 600px;
      border: 1px solid #ccc;
      background: #fff;
      font-size: 13px;
    }
    #printHeader {
      text-align: center;
      margin-bottom: 12px;
      border-bottom: 1px solid #000;
      padding-bottom: 8px;
    }
    #printHeader h2 {
      margin: 0;
      font-size: 18px;
    }
    #printHeader .sub {
      font-size: 11px;
      margin-top: 4px;
    }
    #printBody {
      margin-top: 8px;
    }
    #printBody table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 8px;
    }
    #printBody th, #printBody td {
      border: 1px solid #000;
      padding: 4px;
    }
    #printFooter {
      margin-top: 12px;
      font-size: 11px;
    }

    /* 印刷時のスタイル */
    @media print {
      body * {
        visibility: hidden;
      }
      #printArea, #printArea * {
        visibility: visible;
      }
      #printArea {
        position: absolute;
        inset: 0;
        margin: 0 auto;
        border: none;
      }
    }
  </style>
</head>
<body>
  <h1>注文管理・印刷用明細</h1>

  <div class="section">
    <div class="row">
      接続トークン（?code= / ?token= でも可）:
      <input type="text" id="tokenInput" style="width:220px;" />
      <button id="saveTokenBtn">保存</button>
      <button id="pingBtn">接続テスト</button>
      <span id="status"></span>
    </div>
    <div class="row">
      <label>対象日：
        <input type="date" id="dateInput" />
      </label>
      <label>件数上限：
        <input type="text" id="limitInput" value="200" style="width:60px;" />
      </label>
      <button id="loadOrdersBtn">注文を読み込み</button>
      <span id="countInfo"></span>
    </div>
  </div>

  <h2>注文一覧</h2>
  <div class="section">
    <table id="ordersTable">
      <thead>
        <tr>
          <th>時刻</th>
          <th>商品名</th>
          <th>数量</th>
          <th>単価</th>
          <th>小計</th>
          <th>送料</th>
          <th>代引</th>
          <th>合計</th>
          <th>受取</th>
          <th>支払</th>
          <th>印刷</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- 印刷用エリア -->
  <div id="printArea">
    <div id="printHeader">
      <h2>ご注文明細書</h2>
      <div class="sub">えびせんべいショップ</div>
      <div class="sub" id="printDate"></div>
    </div>
    <div id="printBody">
      <div id="printCustomer"></div>

      <table>
        <thead>
          <tr>
            <th style="width:55%;">商品名</th>
            <th style="width:15%;">数量</th>
            <th style="width:15%;">単価</th>
            <th style="width:15%;">金額</th>
          </tr>
        </thead>
        <tbody id="printItems"></tbody>
      </table>

      <div id="printSummary"></div>
    </div>
    <div id="printFooter">
      ※本明細書はLINE注文システムから自動作成されています。<br />
      ご不明な点がございましたら店舗までお問い合わせください。
    </div>
  </div>

  <div id="log"></div>

  <script>
    (function(){
      const $ = (id) => document.getElementById(id);
      const logEl = $("log");
      const STATUS = $("status");
      const ordersTableBody = $("ordersTable").querySelector("tbody");
      const countInfo = $("countInfo");
      let currentOrders = [];

      function log(msg) {
        const line = "[" + new Date().toLocaleString() + "] " + msg + "\\n";
        logEl.textContent = line + logEl.textContent;
      }

      // ===== トークン取得 =====
      function getTokenFromUrlOrStorage() {
        const params = new URLSearchParams(location.search);
        const fromUrl = params.get("code") || params.get("token") || "";
        if (fromUrl) {
          localStorage.setItem("adminToken", fromUrl);
          return fromUrl;
        }
        const saved = localStorage.getItem("adminToken") || "";
        return saved;
      }
      function getToken() {
        return $("tokenInput").value.trim();
      }

      // 初期トークン設定
      const initToken = getTokenFromUrlOrStorage();
      $("tokenInput").value = initToken;
      if (!initToken) {
        STATUS.textContent = "トークン未設定です。URLに ?code=ADMIN_CODE を付けるか、上に入力してください。";
      }

      $("saveTokenBtn").addEventListener("click", () => {
        const t = getToken();
        if (!t) {
          alert("トークンを入力してください。");
          return;
        }
        localStorage.setItem("adminToken", t);
        STATUS.textContent = "トークンを保存しました。";
        log("トークン保存: " + t);
      });

      // ===== 共通 fetch =====
      async function apiFetch(path, options = {}) {
        const token = getToken();
        if (!token) throw new Error("トークン未設定");
        const url = path + (path.includes("?") ? "&" : "?") + "token=" + encodeURIComponent(token);
        const opt = Object.assign({
          method: "GET",
          headers: { "Content-Type": "application/json" }
        }, options);
        const res = await fetch(url, opt);
        const data = await res.json().catch(() => ({}));
        if (!res.ok || data.ok === false) {
          throw new Error(data.error || (res.status + " error"));
        }
        return data;
      }

      // ===== 接続テスト =====
      $("pingBtn").addEventListener("click", async () => {
        try {
          STATUS.textContent = "接続テスト中...";
          const data = await apiFetch("/api/admin/ping");
          STATUS.textContent = "接続OK";
          log("接続テスト: " + JSON.stringify(data));
        } catch (e) {
          STATUS.textContent = "接続エラー: " + e.message;
          log("接続エラー: " + e.message);
          alert("接続に失敗しました: " + e.message + "\\nトークンやURLを確認してください。");
        }
      });

      // ===== 注文読み込み =====
      async function loadOrders() {
        try {
          const limitStr = $("limitInput").value.trim() || "200";
          const limit = Math.min(5000, Math.max(1, Number(limitStr) || 200));

          let query = "/api/admin/orders?limit=" + encodeURIComponent(limit);

          const dateStr = $("dateInput").value; // 例: 2025-11-14
          if (dateStr) {
            const ymd = dateStr.replace(/-/g, ""); // 20251114
            query += "&date=" + encodeURIComponent(ymd);
          }

          const data = await apiFetch(query);
          const items = data.items || [];
          currentOrders = items;
          renderOrders(items);
          countInfo.textContent = items.length + "件";
          log("注文読み込み: " + items.length + "件");
        } catch (e) {
          alert("注文読み込みエラー: " + e.message);
          log("注文読み込みエラー: " + e.message);
        }
      }

      function formatYen(n) {
        const num = Number(n || 0);
        return num.toLocaleString("ja-JP") + "円";
      }

      function formatTs(ts) {
        if (!ts) return "";
        const d = new Date(ts);
        if (isNaN(d.getTime())) return ts;
        const y = d.getFullYear();
        const m = ("0" + (d.getMonth()+1)).slice(-2);
        const day = ("0" + d.getDate()).slice(-2);
        const hh = ("0" + d.getHours()).slice(-2);
        const mm = ("0" + d.getMinutes()).slice(-2);
        return y + "/" + m + "/" + day + " " + hh + ":" + mm;
      }

      function renderOrders(items) {
        ordersTableBody.innerHTML = "";
        if (!items.length) return;
        items.forEach((o, idx) => {
          const tr = document.createElement("tr");

          // 時刻
          const tdTs = document.createElement("td");
          tdTs.textContent = formatTs(o.ts);
          tr.appendChild(tdTs);

          // 商品名
          const tdName = document.createElement("td");
          tdName.textContent = o.productName || o.productId || "";
          tr.appendChild(tdName);

          // 数量
          const tdQty = document.createElement("td");
          tdQty.textContent = o.qty ?? "";
          tr.appendChild(tdQty);

          // 単価
          const tdPrice = document.createElement("td");
          tdPrice.textContent = formatYen(o.price);
          tr.appendChild(tdPrice);

          // 小計
          const tdSub = document.createElement("td");
          tdSub.textContent = formatYen(o.subtotal);
          tr.appendChild(tdSub);

          // 送料
          const tdShip = document.createElement("td");
          tdShip.textContent = formatYen(o.shipping);
          tr.appendChild(tdShip);

          // 代引
          const tdCod = document.createElement("td");
          tdCod.textContent = formatYen(o.codFee);
          tr.appendChild(tdCod);

          // 合計
          const tdTotal = document.createElement("td");
          tdTotal.textContent = formatYen(o.total);
          tr.appendChild(tdTotal);

          // 受取
          const tdMethod = document.createElement("td");
          tdMethod.textContent = o.method === "pickup" ? "店頭" : (o.method === "delivery" ? "宅配" : (o.method || ""));
          tr.appendChild(tdMethod);

          // 支払
          const tdPay = document.createElement("td");
          let payText = o.payment || "";
          if (o.payment === "cod") payText = "代金引換";
          if (o.payment === "bank") payText = "銀行振込";
          if (o.payment === "cash") payText = "現金";
          tdPay.textContent = payText;
          tr.appendChild(tdPay);

          // 印刷ボタン
          const tdBtn = document.createElement("td");
          const btn = document.createElement("button");
          btn.textContent = "印刷";
          btn.className = "btn-print";
          btn.addEventListener("click", () => {
            showPrint(o);
            window.print();
          });
          tdBtn.appendChild(btn);
          tr.appendChild(tdBtn);

          ordersTableBody.appendChild(tr);
        });
      }

      $("loadOrdersBtn").addEventListener("click", loadOrders);

      // ===== 印刷用エリアにセット =====
      function showPrint(order) {
        // 日付
        $("printDate").textContent = "発行日：" + formatTs(order.ts);

        // お客様情報
        const addr = order.address || null;
        const lines = [];

        lines.push("お客様： " + (addr?.name || ""));
        if (addr) {
          const addrLine = [
            addr.postal ? "〒" + addr.postal : "",
            (addr.prefecture || "") + (addr.city || "") + (addr.address1 || ""),
            addr.address2 || ""
          ].filter(Boolean).join(" ");
          if (addrLine.trim()) lines.push("ご住所： " + addrLine);
          if (addr.phone) lines.push("電話： " + addr.phone);
        }
        lines.push("");
        lines.push("受取方法： " + (order.method === "pickup" ? "店頭受取" : "宅配 (" + (order.region || "") + ")"));
        let payText = order.payment || "";
        if (order.payment === "cod") payText = "代金引換";
        if (order.payment === "bank") payText = "銀行振込";
        if (order.payment === "cash") payText = "現金";
        lines.push("お支払い方法： " + payText);

        $("printCustomer").textContent = lines.join("\\n");

        // 商品行（今回は1商品だけなので1行）
        const tb = $("printItems");
        tb.innerHTML = "";
        const tr = document.createElement("tr");
        const td1 = document.createElement("td");
        const td2 = document.createElement("td");
        const td3 = document.createElement("td");
        const td4 = document.createElement("td");
        td1.textContent = order.productName || order.productId || "";
        td2.textContent = order.qty ?? "";
        td3.textContent = formatYen(order.price);
        td4.textContent = formatYen(order.subtotal);
        tr.appendChild(td1);
        tr.appendChild(td2);
        tr.appendChild(td3);
        tr.appendChild(td4);
        tb.appendChild(tr);

        // 合計欄
        const summary = [];
        summary.push("小計： " + formatYen(order.subtotal));
        summary.push("送料： " + formatYen(order.shipping));
        summary.push("代引き手数料： " + formatYen(order.codFee));
        summary.push("合計： " + formatYen(order.total));
        $("printSummary").innerHTML = "<div style='margin-top:8px;'>" +
          summary.map(s => "<div>" + s + "</div>").join("") +
          "</div>";

        // 印刷エリアを一時的に表示
        $("printArea").style.display = "block";
      }

      // 初期：トークンがあれば当日の日付をセット
      (function initDate() {
        const today = new Date();
        const y = today.getFullYear();
        const m = ("0" + (today.getMonth()+1)).slice(-2);
        const d = ("0" + today.getDate()).slice(-2);
        $("dateInput").value = y + "-" + m + "-" + d;
      })();

      if (initToken) {
        // トークンがある場合、自動で当日の注文読み込み
        loadOrders().catch(() => {});
      }
    })();
  </script>
</body>
</html>
