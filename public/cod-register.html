<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>電話注文用 住所登録</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 12px;
      background: #f7f7f7;
      color: #333;
    }
    h1 {
      font-size: 18px;
      margin: 0 0 8px;
    }
    p.lead {
      font-size: 13px;
      margin: 0 0 12px;
      line-height: 1.6;
    }
    .card {
      background: #fff;
      border-radius: 10px;
      padding: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      margin-bottom: 8px;
    }
    .field {
      margin-bottom: 8px;
    }
    .label {
      font-size: 12px;
      margin-bottom: 2px;
    }
    input {
      width: 100%;
      box-sizing: border-box;
      padding: 8px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .row {
      display: flex;
      gap: 8px;
    }
    .row .field {
      flex: 1;
    }
    .btn-row {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
    }
    .btn {
      padding: 10px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      width: 100%;
    }
    .btn-primary {
      background: #00b900;
      color: #fff;
    }
    .btn-secondary {
      background: #fff;
      border: 1px solid #ccc;
      color: #333;
    }
    #statusMsg {
      margin-top: 8px;
      font-size: 11px;
      color: #555;
      white-space: pre-line;
    }
    #statusMsg.err {
      color: #d00;
    }
    #statusMsg.ok {
      color: #0a7b19;
    }
    small.note {
      display: block;
      margin-top: 10px;
      font-size: 11px;
      color: #777;
      line-height: 1.6;
    }
  </style>
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h1>電話注文用 住所登録</h1>
  <p class="lead">
    電話で「代引き注文」をされる際の<br>
    お届け先情報を登録する画面です。
  </p>

  <div class="card">
    <div class="field">
      <div class="label">郵便番号</div>
      <input id="postal" type="text" inputmode="numeric" placeholder="例）470-0000" />
    </div>
    <div class="field">
      <div class="label">都道府県</div>
      <input id="prefecture" type="text" placeholder="例）愛知県" />
    </div>
    <div class="field">
      <div class="label">市区町村</div>
      <input id="city" type="text" placeholder="例）知多郡武豊町" />
    </div>
    <div class="field">
      <div class="label">番地・建物名</div>
      <input id="address1" type="text" placeholder="例）字○○1-2-3" />
    </div>
    <div class="field">
      <div class="label">建物名・部屋番号など（任意）</div>
      <input id="address2" type="text" placeholder="任意" />
    </div>
    <div class="row">
      <div class="field">
        <div class="label">お名前</div>
        <input id="name" type="text" placeholder="例）磯屋 太郎" />
      </div>
      <div class="field">
        <div class="label">電話番号</div>
        <input id="phone" type="tel" placeholder="例）090-1234-5678" />
      </div>
    </div>
  </div>

  <div class="btn-row">
    <button id="saveBtn" class="btn btn-primary">住所を保存する</button>
    <button id="closeBtn" class="btn btn-secondary">この画面を閉じる</button>
  </div>

  <div id="statusMsg"></div>

  <small class="note">
    ※電話注文の際は、案内にしたがって会員番号やお名前を入力してください。<br>
    ※会員コード機能と連携している場合は、別途ご案内のコードをお使いください。
  </small>

  <script>
    (function () {
      "use strict";

      let currentUserId = "";
      const statusEl = document.getElementById("statusMsg");
      const saveBtn   = document.getElementById("saveBtn");
      const closeBtn  = document.getElementById("closeBtn");

      function setStatus(msg, kind) {
        if (!statusEl) return;
        statusEl.textContent = msg || "";
        statusEl.classList.remove("err", "ok");
        if (kind === "err") statusEl.classList.add("err");
        if (kind === "ok")  statusEl.classList.add("ok");
      }

      function getVal(id) {
        return (document.getElementById(id)?.value || "").trim();
      }

      function fillFormFromAddress(a) {
        if (!a) return;
        if (a.postal)     document.getElementById("postal").value     = a.postal;
        if (a.prefecture) document.getElementById("prefecture").value = a.prefecture;
        if (a.city)       document.getElementById("city").value       = a.city;
        if (a.address1)   document.getElementById("address1").value   = a.address1;
        if (a.address2)   document.getElementById("address2").value   = a.address2;
        if (a.name)       document.getElementById("name").value       = a.name;
        if (a.phone)      document.getElementById("phone").value      = a.phone;
      }

      function buildAddressFromForm() {
        const postal   = getVal("postal");
        const pref     = getVal("prefecture");
        const city     = getVal("city");
        const address1 = getVal("address1");
        const address2 = getVal("address2");
        const name     = getVal("name");
        const phone    = getVal("phone");

        if (!postal || !pref || !city || !address1 || !name || !phone) {
          setStatus(
            "郵便番号・都道府県・市区町村・番地/建物・お名前・電話番号は必須です。",
            "err"
          );
          return null;
        }

        return {
          postal,
          prefecture: pref,
          city,
          address1,
          address2,
          name,
          phone,
        };
      }

      async function initLiff() {
        try {
          setStatus("初期化中です…", "");

          // ★ server.js 側の /api/liff/config?kind=cod を同一ホストで呼ぶ
          const cfgRes = await fetch("/api/liff/config?kind=cod");
          const cfg = await cfgRes.json().catch(() => null);
          console.log("LIFF CONFIG RESPONSE:", cfg);

          if (!cfg || !cfg.liffId) {
            setStatus("LIFF設定が取得できませんでした。時間をおいて再度お試しください。", "err");
            return;
          }

          await liff.init({ liffId: cfg.liffId });

          if (!liff.isLoggedIn()) {
            liff.login();
            return;
          }

          const prof = await liff.getProfile();
          currentUserId = prof.userId || "";
          if (!currentUserId) {
            setStatus("LINEユーザー情報が取得できませんでした。", "err");
            return;
          }

          // 既に登録済みの住所があれば読み込み（server.js の /api/liff/address/me）
          try {
            const meRes = await fetch(
              "/api/liff/address/me?userId=" + encodeURIComponent(currentUserId)
            );
            const me = await meRes.json().catch(() => null);
            console.log("/api/liff/address/me:", me);
            if (me && me.ok && me.address) {
              fillFormFromAddress(me.address);
              setStatus("登録済みの住所を読み込みました。必要に応じて修正して保存してください。", "ok");
            } else {
              setStatus("電話注文で使うお届け先を入力して「住所を保存する」を押してください。", "");
            }
          } catch (e) {
            console.warn("/api/liff/address/me error:", e);
            setStatus("電話注文で使うお届け先を入力して「住所を保存する」を押してください。", "");
          }
        } catch (e) {
          console.error("LIFF init error:", e);
          setStatus("初期化中にエラーが発生しました。時間をおいて再度お試しください。", "err");
        }
      }

      async function handleSave() {
        if (!currentUserId) {
          setStatus("LINEユーザー情報が取得できていません。画面を閉じてもう一度お試しください。", "err");
          return;
        }

        const addr = buildAddressFromForm();
        if (!addr) return;

        try {
          saveBtn.disabled = true;
          setStatus("住所を保存しています…", "");

          // server.js 側の /api/liff/address へ保存
          const res = await fetch("/api/liff/address", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              userId: currentUserId,
              address: addr,
            }),
          });

          const data = await res.json().catch(() => ({}));
          console.log("/api/liff/address response:", data);

          if (!res.ok || !data.ok) {
            setStatus("住所の保存に失敗しました。時間をおいてもう一度お試しください。", "err");
            saveBtn.disabled = false;
            return;
          }

          setStatus(
            "住所を保存しました。\n電話の代引き注文でもこの住所が使われます。\nこの画面は閉じても大丈夫です。",
            "ok"
          );

          // 可能なら LIFF ウィンドウを閉じる
          try {
            if (window.liff && typeof liff.closeWindow === "function") {
              setTimeout(() => liff.closeWindow(), 1200);
            }
          } catch (e) {
            console.warn("liff.closeWindow error:", e);
          }
        } catch (e) {
          console.error("/api/liff/address error:", e);
          setStatus("通信エラーで住所を保存できませんでした。電波状況をご確認ください。", "err");
          saveBtn.disabled = false;
        }
      }

      async function handleClose() {
        try {
          if (window.liff && typeof liff.closeWindow === "function") {
            liff.closeWindow();
          } else {
            window.close();
          }
        } catch (e) {
          console.warn("close error:", e);
          setStatus("画面が自動で閉じられない場合は、右上の「×」や戻るボタンで閉じてください。", "");
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        if (window.liff) {
          initLiff();
        } else {
          setStatus("LIFF SDK が読み込めませんでした。ネットワーク状況をご確認ください。", "err");
        }

        saveBtn.addEventListener("click", (ev) => {
          ev.preventDefault();
          handleSave();
        });
        closeBtn.addEventListener("click", (ev) => {
          ev.preventDefault();
          handleClose();
        });
      });
    })();
  </script>
</body>
</html>
