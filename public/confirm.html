<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>注文確認</title>
  <style>
    :root{
      --bg:#f6f7f9; --card:#fff; --text:#111827; --muted:#6b7280;
      --border:#e5e7eb; --primary:#0b3a53; --primary2:#123b66;
      --danger:#b91c1c; --ok:#065f46; --shadow:0 1px 3px rgba(0,0,0,.08);
      --radius:14px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg); color:var(--text);
    }
    .wrap{ max-width:960px; margin:0 auto; padding:14px 14px 28px; }
    h1{ font-size:20px; margin:0 0 10px; }
    .lead{ font-size:13px; color:var(--muted); margin:0 0 12px; line-height:1.7; }
    .grid{ display:grid; grid-template-columns:repeat(12,1fr); gap:12px; }
    .card{
      grid-column: span 12;
      background:var(--card); border:1px solid var(--border);
      border-radius:var(--radius); box-shadow:var(--shadow);
      padding:14px;
    }
    @media (min-width:900px){
      .left{ grid-column: span 7; }
      .right{ grid-column: span 5; }
    }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .muted{ color:var(--muted); }
    .status{
      margin:10px 0 0;
      font-size:13px; font-weight:800;
      color:var(--danger);
      display:none;
    }
    .status.ok{ color:var(--ok); }
    .items{ margin-top:10px; display:flex; flex-direction:column; gap:10px; }
    .item{
      display:flex; gap:12px; align-items:flex-start;
      border:1px solid var(--border); border-radius:12px; padding:10px;
    }
    .thumb{
      width:64px; height:64px; border-radius:10px; overflow:hidden;
      border:1px solid var(--border); background:#f0f2f5;
      display:flex; align-items:center; justify-content:center; flex:0 0 auto;
    }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .name{ font-weight:900; margin:0 0 2px; }
    .sub{ font-size:12px; color:var(--muted); margin:0; line-height:1.6; }
    .price{ margin-left:auto; text-align:right; font-weight:900; white-space:nowrap; }
    .field{ margin-top:10px; }
    label{ display:block; font-size:12px; font-weight:900; margin:0 0 6px; color:#374151; }
    input, select, textarea{
      width:100%;
      padding:11px 12px;
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
      font-size:14px;
    }
    textarea{ min-height:76px; resize:vertical; }
    .seg{ display:flex; gap:10px; flex-wrap:wrap; }
    .seg button{
      flex:1 1 180px;
      padding:12px 14px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-weight:900;
      cursor:pointer;
      box-shadow:var(--shadow);
    }
    .seg button.active{
      background:var(--primary);
      color:#fff;
      border-color:transparent;
    }
    .sumline{ display:flex; justify-content:space-between; gap:10px; margin:8px 0; font-size:14px; }
    .sumline strong{ font-weight:900; }
    .divider{ height:1px; background:var(--border); margin:10px 0; }
    .btn{
      width:100%;
      padding:14px 16px;
      border-radius:14px;
      border:1px solid transparent;
      font-weight:900;
      font-size:15px;
      cursor:pointer;
      box-shadow:var(--shadow);
    }
    .btn.primary{ background:var(--primary); color:#fff; }
    .btn.dark{ background:#111827; color:#fff; }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }
    .mini{ font-size:12px; color:var(--muted); line-height:1.6; margin-top:8px; }
    .back{
      display:inline-flex; align-items:center; gap:8px;
      text-decoration:none; color:var(--primary);
      font-weight:900; font-size:13px;
    }
    code{ background:#eef2ff; padding:2px 6px; border-radius:8px; }
  </style>
</head>

<body>
<div class="wrap">
  <a class="back" href="/public/products.html">← 商品一覧へ戻る</a>
  <h1>注文確認</h1>
  <p class="lead">
    カート内容・お届け先を確認し、<b>カード決済（Stripe）</b>または<b>代引き</b>で確定します。<br>
    送料は <code>/api/shipping/quote</code> があればサーバー計算を優先し、無ければ画面内の簡易表で計算します。
  </p>

  <div id="status" class="status"></div>

  <div class="grid">
    <div class="card left">
      <div class="row" style="justify-content:space-between;">
        <div style="font-weight:900;">ご注文内容</div>
        <div class="muted" style="font-size:12px;">在庫・価格は <code>/api/products</code> の最新を反映</div>
      </div>

      <div id="items" class="items"></div>

      <div class="divider"></div>

      <div style="font-weight:900; margin-bottom:8px;">受け取り方法</div>
      <div class="seg">
        <button id="btnDelivery" type="button" class="active">宅配（代引・カード）</button>
        <button id="btnPickup" type="button">店頭受取（無料）</button>
      </div>

      <div id="addressBox" style="margin-top:12px;">
        <div class="field">
          <label>お名前</label>
          <input id="name" placeholder="例）木村 太郎" autocomplete="name" />
        </div>

        <div class="field">
          <label>電話番号</label>
          <input id="phone" placeholder="例）09012345678" autocomplete="tel" inputmode="tel" />
        </div>

        <div class="field">
          <label>郵便番号</label>
          <input id="postal" placeholder="例）4703502（ハイフン無しOK）" autocomplete="postal-code" inputmode="numeric" />
        </div>

        <div class="field">
          <label>都道府県</label>
          <select id="pref">
            <option value="">選択してください</option>
            <option>北海道</option><option>青森県</option><option>岩手県</option><option>宮城県</option><option>秋田県</option><option>山形県</option><option>福島県</option>
            <option>茨城県</option><option>栃木県</option><option>群馬県</option><option>埼玉県</option><option>千葉県</option><option>東京都</option><option>神奈川県</option>
            <option>新潟県</option><option>富山県</option><option>石川県</option><option>福井県</option><option>山梨県</option><option>長野県</option><option>岐阜県</option><option>静岡県</option><option>愛知県</option>
            <option>三重県</option><option>滋賀県</option><option>京都府</option><option>大阪府</option><option>兵庫県</option><option>奈良県</option><option>和歌山県</option>
            <option>鳥取県</option><option>島根県</option><option>岡山県</option><option>広島県</option><option>山口県</option>
            <option>徳島県</option><option>香川県</option><option>愛媛県</option><option>高知県</option>
            <option>福岡県</option><option>佐賀県</option><option>長崎県</option><option>熊本県</option><option>大分県</option><option>宮崎県</option><option>鹿児島県</option>
            <option>沖縄県</option>
          </select>
        </div>

        <div class="field">
          <label>住所</label>
          <textarea id="address" placeholder="例）知多郡南知多町豊浜 清水谷◯◯"></textarea>
        </div>

        <div class="field">
          <label>備考（任意）</label>
          <textarea id="note" placeholder="例）不在時は玄関前にお願いします"></textarea>
        </div>

        <div class="mini">
          ※ LIFF で住所DBと連携している場合は、この画面を「住所自動入力」にも拡張できます（必要なら言ってください）。
        </div>
      </div>

      <div id="pickupBox" style="display:none; margin-top:12px;">
        <div class="field">
          <label>店頭受取：お名前</label>
          <input id="pickupName" placeholder="例）木村 太郎" autocomplete="name" />
        </div>
        <div class="field">
          <label>店頭受取：電話番号</label>
          <input id="pickupPhone" placeholder="例）09012345678" autocomplete="tel" inputmode="tel" />
        </div>
        <div class="mini">
          店頭受取は送料・代引手数料はかかりません。<br>
          受け取り日時の予約が必要なら、備考欄など追加できます。
        </div>
      </div>
    </div>

    <div class="card right">
      <div style="font-weight:900;">お支払い</div>

      <div class="divider"></div>

      <div class="sumline"><span class="muted">点数</span><strong id="sumItems">0</strong></div>
      <div class="sumline"><span class="muted">小計</span><strong id="sumSubtotal">0円</strong></div>
      <div class="sumline"><span class="muted">送料</span><strong id="sumShipping">0円</strong></div>
      <div class="sumline"><span class="muted">代引手数料</span><strong id="sumCod">0円</strong></div>

      <div class="divider"></div>

      <div class="sumline" style="font-size:16px;">
        <span>合計</span><strong id="sumTotal">0円</strong>
      </div>

      <div style="margin-top:12px;">
        <button id="btnCard" class="btn primary" type="button">カードで支払う（Stripe）</button>
        <div class="mini">カード決済は Stripe Checkout に移動します。</div>
      </div>

      <div style="margin-top:10px;">
        <button id="btnCod" class="btn dark" type="button">代引きで確定</button>
        <div class="mini">代引きは確定後、注文番号を表示します。</div>
      </div>

      <div class="divider"></div>

      <div class="mini">
        <b>Webhookで確実にDB反映</b>はサーバー側の実装です：<br>
        Stripeの決済完了は「戻りURL」ではなく <code>webhook</code> でDBを更新してください。<br>
        （サーバー側の丸ごと実装も次に出せます）
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  "use strict";

  // ====== 設定（サーバーに合わせて変更OK） ======
  const API_PRODUCTS = "/api/products";

  // 送料見積（あるならこれを優先）
  // 推奨レスポンス例:
  // { ok:true, shipping_fee: 880, size: "80", cod_fee:330, note:"..." }
  const API_SHIPPING_QUOTE = "/api/shipping/quote";

  // Stripe Checkout セッション作成（あなたのサーバーに合わせる）
  // 推奨: POST /api/checkout/stripe -> { ok:true, url:"https://checkout.stripe.com/..." }
  const API_STRIPE_CREATE = "/api/checkout/stripe";

  // 代引き注文作成（あなたのサーバーに合わせる）
  // 推奨: POST /api/orders/cod -> { ok:true, order_id:"..." }
  const API_COD_CREATE = "/api/orders/cod";

  const COD_FEE_DEFAULT = 330;

  // ====== DOM ======
  const statusEl = document.getElementById("status");
  const itemsEl = document.getElementById("items");
  const sumItemsEl = document.getElementById("sumItems");
  const sumSubtotalEl = document.getElementById("sumSubtotal");
  const sumShippingEl = document.getElementById("sumShipping");
  const sumCodEl = document.getElementById("sumCod");
  const sumTotalEl = document.getElementById("sumTotal");
  const btnCard = document.getElementById("btnCard");
  const btnCod = document.getElementById("btnCod");

  const btnDelivery = document.getElementById("btnDelivery");
  const btnPickup = document.getElementById("btnPickup");
  const addressBox = document.getElementById("addressBox");
  const pickupBox = document.getElementById("pickupBox");

  const nameEl = document.getElementById("name");
  const phoneEl = document.getElementById("phone");
  const postalEl = document.getElementById("postal");
  const prefEl = document.getElementById("pref");
  const addressEl = document.getElementById("address");
  const noteEl = document.getElementById("note");

  const pickupNameEl = document.getElementById("pickupName");
  const pickupPhoneEl = document.getElementById("pickupPhone");

  // ====== 状態 ======
  let mode = "delivery"; // "delivery" | "pickup"
  let allProducts = [];
  let cart = loadCart(); // {id:qty}
  let quote = { shipping_fee:0, cod_fee:0, size:null, note:null };

  // ====== Utils ======
  const yen = (n) => (Number(n||0)).toLocaleString("ja-JP") + "円";
  const esc = (s) => String(s ?? "").replace(/[&<>"']/g, c => (
    {"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[c]
  ));

  function showStatus(msg, ok=false){
    if(!msg){
      statusEl.style.display="none";
      statusEl.textContent="";
      statusEl.classList.remove("ok");
      return;
    }
    statusEl.style.display="block";
    statusEl.textContent=msg;
    statusEl.classList.toggle("ok", !!ok);
  }

  function loadCart(){
    // products.html から来る想定：localStorage isoya_cart_v1
    // 念のため sessionStorage isoya_checkout_v1 も吸う（cart形式ならそれ優先）
    try{
      const ss = sessionStorage.getItem("isoya_checkout_v1");
      if(ss){
        const obj = JSON.parse(ss);
        // cart map の場合
        if(obj && typeof obj === "object" && !Array.isArray(obj) && !obj.items){
          return obj;
        }
        // payload.items の場合
        if(obj && Array.isArray(obj.items)){
          const m = {};
          for(const it of obj.items){
            if(it?.id) m[it.id] = Number(it.qty||0);
          }
          return m;
        }
      }
    }catch{}

    try{
      const raw = localStorage.getItem("isoya_cart_v1");
      if(!raw) return {};
      const obj = JSON.parse(raw);
      return (obj && typeof obj === "object") ? obj : {};
    }catch{
      return {};
    }
  }

  function saveCart(){
    try{ localStorage.setItem("isoya_cart_v1", JSON.stringify(cart)); }catch{}
  }

  function getItemsExpanded(){
    const out = [];
    for(const [id, qty] of Object.entries(cart)){
      const p = allProducts.find(x => x.id === id);
      if(!p) continue;
      const q = Math.max(0, Math.floor(Number(qty||0)));
      if(q <= 0) continue;
      out.push({
        id,
        name: p.name || id,
        price: Number(p.price||0),
        qty: q,
        image: p.image || "",
        volume: p.volume || "",
        desc: p.desc || "",
        stock: (p.stock ?? null),
      });
    }
    return out;
  }

  function subtotal(){
    return getItemsExpanded().reduce((s,it)=> s + it.price * it.qty, 0);
  }

  function countItems(){
    return Object.values(cart).reduce((a,b)=> a + Number(b||0), 0);
  }

  function updateSummary(){
    const itemsN = countItems();
    const sub = subtotal();
    const shipping = Number(quote.shipping_fee||0);
    const cod = (mode==="delivery") ? Number(quote.cod_fee||0) : 0;
    const total = sub + shipping + cod;

    sumItemsEl.textContent = String(itemsN);
    sumSubtotalEl.textContent = yen(sub);
    sumShippingEl.textContent = yen(shipping);
    sumCodEl.textContent = yen(cod);
    sumTotalEl.textContent = yen(total);

    const hasItems = itemsN > 0;
    btnCard.disabled = !hasItems;
    btnCod.disabled = !hasItems;
  }

  function renderItems(){
    const list = getItemsExpanded();
    if(list.length === 0){
      itemsEl.innerHTML = `<div class="muted" style="font-weight:800;">カートが空です。商品一覧から選んでください。</div>`;
      updateSummary();
      return;
    }
    itemsEl.innerHTML = list.map(it => `
      <div class="item">
        <div class="thumb">${it.image ? `<img src="${esc(it.image)}" alt="">` : `<span class="muted" style="font-weight:900;font-size:11px;">NO IMAGE</span>`}</div>
        <div style="flex:1; min-width:0;">
          <div class="name">${esc(it.name)}</div>
          <p class="sub">
            ${it.desc ? esc(it.desc) : ""}
            ${it.desc && it.volume ? "<br>" : ""}
            ${it.volume ? "内容量：" + esc(it.volume) : ""}
          </p>
          <p class="sub">数量：<b>${it.qty}</b></p>
        </div>
        <div class="price">${yen(it.price)}<div class="muted" style="font-size:12px;font-weight:800;">× ${it.qty}</div></div>
      </div>
    `).join("");
    updateSummary();
  }

  function setMode(next){
    mode = next;
    btnDelivery.classList.toggle("active", mode==="delivery");
    btnPickup.classList.toggle("active", mode==="pickup");
    addressBox.style.display = (mode==="delivery") ? "" : "none";
    pickupBox.style.display = (mode==="pickup") ? "" : "none";
    // modeにより代引手数料も変わるので更新
    updateSummary();
    // 宅配へ戻したら再見積もり
    if(mode==="delivery") scheduleQuote();
  }

  function validateCustomer(){
    if(countItems() <= 0) return "カートが空です。";

    if(mode==="pickup"){
      if(!pickupNameEl.value.trim()) return "店頭受取：お名前を入力してください。";
      if(!pickupPhoneEl.value.trim()) return "店頭受取：電話番号を入力してください。";
      return "";
    }

    // delivery
    if(!nameEl.value.trim()) return "お名前を入力してください。";
    if(!phoneEl.value.trim()) return "電話番号を入力してください。";
    if(!postalEl.value.trim()) return "郵便番号を入力してください。";
    if(!prefEl.value.trim()) return "都道府県を選択してください。";
    if(!addressEl.value.trim()) return "住所を入力してください。";
    return "";
  }

  // ====== 送料見積 ======
  let quoteTimer = null;

  function scheduleQuote(){
    clearTimeout(quoteTimer);
    quoteTimer = setTimeout(calcQuote, 350);
  }

  function normalizePostal(s){
    return String(s||"").replace(/[^\d]/g,"").slice(0,7);
  }

  function buildQuotePayload(){
    const items = getItemsExpanded().map(it => ({ id: it.id, qty: it.qty }));
    return {
      items,
      mode,
      customer: (mode==="pickup")
        ? { name: pickupNameEl.value.trim(), phone: pickupPhoneEl.value.trim() }
        : {
            name: nameEl.value.trim(),
            phone: phoneEl.value.trim(),
            postal: normalizePostal(postalEl.value),
            pref: prefEl.value.trim(),
            address: addressEl.value.trim(),
            note: noteEl.value.trim(),
          }
    };
  }

  function fallbackShippingSimple(){
    // ※ サーバーに /api/shipping/quote が無い場合の「最低限」計算
    // ここは必要ならあなたのヤマト表に置き換え可能
    const pref = prefEl.value.trim();
    if(!pref) return 0;

    // ざっくりゾーン（例）
    const HOKKAIDO = ["北海道"];
    const OKINAWA = ["沖縄県"];
    const TOHOKU = ["青森県","岩手県","宮城県","秋田県","山形県","福島県"];
    const KANTO = ["茨城県","栃木県","群馬県","埼玉県","千葉県","東京都","神奈川県"];
    const CHUBU = ["新潟県","富山県","石川県","福井県","山梨県","長野県","岐阜県","静岡県","愛知県"];
    const KINKI = ["三重県","滋賀県","京都府","大阪府","兵庫県","奈良県","和歌山県"];
    const CHUGOKU = ["鳥取県","島根県","岡山県","広島県","山口県"];
    const SHIKOKU = ["徳島県","香川県","愛媛県","高知県"];
    const KYUSHU = ["福岡県","佐賀県","長崎県","熊本県","大分県","宮崎県","鹿児島県"];

    // サイズは server 側が正ですが、fallback は 80固定にします
    if(HOKKAIDO.includes(pref)) return 1400;
    if(OKINAWA.includes(pref)) return 1700;
    if(TOHOKU.includes(pref)) return 1100;
    if(KANTO.includes(pref)) return 1000;
    if(CHUBU.includes(pref)) return 900;
    if(KINKI.includes(pref)) return 950;
    if(CHUGOKU.includes(pref)) return 1050;
    if(SHIKOKU.includes(pref)) return 1100;
    if(KYUSHU.includes(pref)) return 1200;
    return 1000;
  }

  async function calcQuote(){
    if(mode !== "delivery"){
      quote = { shipping_fee:0, cod_fee:0, size:null, note:null };
      updateSummary();
      return;
    }

    const payload = buildQuotePayload();

    // 入力が揃ってないときは0表示のまま
    if(!payload.customer.postal || !payload.customer.pref || !payload.customer.address){
      quote = { shipping_fee:0, cod_fee:COD_FEE_DEFAULT, size:null, note:null };
      updateSummary();
      return;
    }

    // サーバー見積を優先
    try{
      const res = await fetch(API_SHIPPING_QUOTE, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload),
      });

      if(res.ok){
        const j = await res.json();
        if(j && (j.ok === true || typeof j.shipping_fee !== "undefined")){
          quote = {
            shipping_fee: Number(j.shipping_fee||0),
            cod_fee: Number(j.cod_fee ?? COD_FEE_DEFAULT),
            size: j.size ?? null,
            note: j.note ?? null,
          };
          updateSummary();
          return;
        }
      }

      // 404/405等ならfallback
      const ship = fallbackShippingSimple();
      quote = { shipping_fee: ship, cod_fee: COD_FEE_DEFAULT, size: null, note: "簡易見積(サーバーAPI未使用)" };
      updateSummary();
    }catch(e){
      const ship = fallbackShippingSimple();
      quote = { shipping_fee: ship, cod_fee: COD_FEE_DEFAULT, size: null, note: "簡易見積(ネットワーク/例外)" };
      updateSummary();
    }
  }

  // ====== 決済処理 ======
  function disablePayButtons(disabled){
    btnCard.disabled = disabled;
    btnCod.disabled = disabled;
  }

  async function postJson(url, data){
    const res = await fetch(url, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(data),
    });
    const text = await res.text();
    let json = null;
    try{ json = JSON.parse(text); }catch{}
    return { res, text, json };
  }

  async function onPayCard(){
    showStatus("");
    const err = validateCustomer();
    if(err){ showStatus(err); return; }

    disablePayButtons(true);
    try{
      const payload = buildOrderPayload("card");
      // 送料見積があるなら乗せる（サーバーが再計算する前提でもOK）
      payload.quote = quote;

      const { res, json, text } = await postJson(API_STRIPE_CREATE, payload);

      if(!res.ok){
        showStatus(`カード決済の作成に失敗しました（HTTP ${res.status}）。サーバーの ${API_STRIPE_CREATE} を確認してください。`);
        console.error("[stripe create] body:", text);
        return;
      }

      const url = json?.url || json?.checkout_url;
      if(!url){
        showStatus("Stripe の遷移URLが見つかりません（レスポンス形式を確認してください）。");
        console.error("[stripe create] json:", json);
        return;
      }

      // Stripeへ
      location.href = url;
    }catch(e){
      console.error(e);
      showStatus("カード決済の処理中にエラーが発生しました。サーバーログも確認してください。");
    }finally{
      disablePayButtons(false);
    }
  }

  async function onPayCod(){
    showStatus("");
    const err = validateCustomer();
    if(err){ showStatus(err); return; }

    disablePayButtons(true);
    try{
      const payload = buildOrderPayload("cod");
      payload.quote = quote;

      const { res, json, text } = await postJson(API_COD_CREATE, payload);

      if(!res.ok){
        showStatus(`代引き確定に失敗しました（HTTP ${res.status}）。サーバーの ${API_COD_CREATE} を確認してください。`);
        console.error("[cod create] body:", text);
        return;
      }

      const orderId = json?.order_id || json?.id || json?.orderId || null;
      showStatus(orderId ? `注文を受け付けました。注文番号：${orderId}` : "注文を受け付けました。", true);

      // 確定後はカートを空に
      cart = {};
      saveCart();
      try{ sessionStorage.removeItem("isoya_checkout_v1"); }catch{}
      renderItems();
    }catch(e){
      console.error(e);
      showStatus("代引き確定の処理中にエラーが発生しました。サーバーログも確認してください。");
    }finally{
      disablePayButtons(false);
    }
  }

  function buildOrderPayload(method){
    const items = getItemsExpanded().map(it => ({
      id: it.id,
      name: it.name,
      price: it.price,
      qty: it.qty,
      image: it.image || "",
    }));

    const base = {
      at: new Date().toISOString(),
      payment_method: method, // "card" | "cod"
      items,
      subtotal: subtotal(),
      mode,
      customer: (mode==="pickup")
        ? { name: pickupNameEl.value.trim(), phone: pickupPhoneEl.value.trim() }
        : {
            name: nameEl.value.trim(),
            phone: phoneEl.value.trim(),
            postal: normalizePostal(postalEl.value),
            pref: prefEl.value.trim(),
            address: addressEl.value.trim(),
            note: noteEl.value.trim(),
          },
      // サーバー側で再計算する前提でも、クライアント見積を渡す（ログ・UI一致に有効）
      client_calc: {
        shipping_fee: Number(quote.shipping_fee||0),
        cod_fee: Number(quote.cod_fee||0),
        total: subtotal() + Number(quote.shipping_fee||0) + (mode==="delivery" ? Number(quote.cod_fee||0) : 0),
      }
    };
    return base;
  }

  // ====== products load ======
  async function loadProducts(){
    showStatus("");
    try{
      const res = await fetch(API_PRODUCTS, { cache:"no-store" });
      if(!res.ok) throw new Error("HTTP " + res.status);
      const j = await res.json();
      allProducts = Array.isArray(j) ? j : (j.products || []);
      if(!Array.isArray(allProducts)) allProducts = [];
    }catch(e){
      console.error(e);
      allProducts = [];
      showStatus("商品データの取得に失敗しました（/api/products）。");
    }
  }

  function dropMissingItems(){
    // products.json に存在しない商品は落とす
    const ids = new Set(allProducts.map(p => p.id));
    let changed = false;
    for(const id of Object.keys(cart)){
      if(!ids.has(id)){
        delete cart[id];
        changed = true;
      }
    }
    if(changed) saveCart();
  }

  // ====== events ======
  btnDelivery.addEventListener("click", ()=> setMode("delivery"));
  btnPickup.addEventListener("click", ()=> setMode("pickup"));

  [nameEl, phoneEl, postalEl, prefEl, addressEl].forEach(el => el.addEventListener("input", scheduleQuote));
  prefEl.addEventListener("change", scheduleQuote);

  btnCard.addEventListener("click", onPayCard);
  btnCod.addEventListener("click", onPayCod);

  // ====== start ======
  (async () => {
    await loadProducts();
    dropMissingItems();
    renderItems();
    // 初回見積（入力が揃ってなくてもCOD手数料など反映）
    quote = { shipping_fee:0, cod_fee:COD_FEE_DEFAULT, size:null, note:null };
    updateSummary();
    scheduleQuote();
  })();

})();
</script>
</body>
</html>
