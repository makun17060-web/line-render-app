<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>代引き用 住所登録</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #f7f7f7;
    }
    .card {
      background: #fff;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 0 4px rgba(0,0,0,0.1);
      max-width: 480px;
      margin: 0 auto;
    }
    h1 {
      font-size: 18px;
      margin: 0 0 12px;
    }
    p {
      font-size: 14px;
      line-height: 1.5;
      margin: 6px 0;
    }
    label {
      display: block;
      font-size: 13px;
      margin: 8px 0 4px;
    }
    input, textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 8px;
      font-size: 14px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    textarea {
      min-height: 80px;
      resize: vertical;
    }
    button {
      display: inline-block;
      margin-top: 12px;
      padding: 10px 16px;
      font-size: 14px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      background: #00c300;
      color: #fff;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .small {
      font-size: 12px;
      color: #666;
    }
    .code-box {
      font-size: 24px;
      font-weight: bold;
      letter-spacing: 4px;
      padding: 8px 12px;
      border-radius: 6px;
      background: #f0f0f0;
      text-align: center;
      margin: 8px 0 12px;
    }
    .hidden {
      display: none;
    }
    .error {
      color: #c00;
      font-size: 13px;
      margin-top: 8px;
      white-space: pre-line;
    }
    .success {
      color: #0a0;
      font-size: 13px;
      margin-top: 8px;
      white-space: pre-line;
    }
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <div class="card">
    <!-- 会員番号のみ表示用 -->
    <div id="codeView" class="hidden">
      <h1>代引き用 会員番号</h1>
      <p>
        すでに住所登録が完了しています。<br />
        電話でご注文の際は、次の会員番号をボタン入力してください。
      </p>
      <div id="codeBox" class="code-box">----</div>
      <p class="small">
        ※ 会員番号を変更したい場合や、住所を変更したい場合は、<br />
        下の「住所を変更する」ボタンから再登録してください。
      </p>
      <button id="switchToFormBtn">住所を変更する</button>
      <div id="codeViewMsg" class="success"></div>
    </div>

    <!-- 新規登録 / 再登録フォーム -->
    <div id="formView" class="hidden">
      <h1>代引き用 住所登録</h1>
      <p class="small">
        電話での代金引換ご注文をスムーズにするため、<br />
        お届け先の情報と会員番号の登録をお願いします。
      </p>

      <label for="codeInput">会員番号（4〜8桁の数字）</label>
      <input id="codeInput" type="text" inputmode="numeric" placeholder="例: 1234" />

      <label for="nameInput">お名前（必須）</label>
      <input id="nameInput" type="text" placeholder="例: 磯屋 太郎" />

      <label for="phoneInput">電話番号（ハイフンなし 9〜11桁）</label>
      <input id="phoneInput" type="tel" inputmode="numeric" placeholder="例: 09012345678" />

      <label for="zipInput">郵便番号（ハイフンなし 任意）</label>
      <input id="zipInput" type="text" inputmode="numeric" placeholder="例: 1234567" />

      <label for="addressInput">ご住所（必須）</label>
      <textarea id="addressInput" placeholder="例: 愛知県〇〇市〇〇町1-2-3 ○○マンション101号室"></textarea>

      <button id="submitBtn">登録する</button>
      <div id="formMsg" class="error"></div>
      <div id="formMsgOk" class="success"></div>
    </div>

    <!-- 共通エリア -->
    <div id="loadingMsg">
      <p>LINE情報を取得しています…</p>
    </div>
  </div>

  <script>
    // ★ ここに「phone-cod サーバー」のベースURLを入れてください
    // 例: const API_BASE = "https://server-phone-cod-js.onrender.com";
    const API_BASE = "https://phone-cod.onrender.com";

    // ★ 使用する LIFF ID（今オンライン注文で使っているものと同じでOK）
    const LIFF_ID = "2008406620-4QJ06JLv"; 

    const codeView = document.getElementById("codeView");
    const codeBox = document.getElementById("codeBox");
    const codeViewMsg = document.getElementById("codeViewMsg");
    const formView = document.getElementById("formView");
    const loadingMsg = document.getElementById("loadingMsg");

    const codeInput = document.getElementById("codeInput");
    const nameInput = document.getElementById("nameInput");
    const phoneInput = document.getElementById("phoneInput");
    const zipInput = document.getElementById("zipInput");
    const addressInput = document.getElementById("addressInput");
    const submitBtn = document.getElementById("submitBtn");
    const formMsg = document.getElementById("formMsg");
    const formMsgOk = document.getElementById("formMsgOk");

    const switchToFormBtn = document.getElementById("switchToFormBtn");

    function showLoading(text) {
      loadingMsg.classList.remove("hidden");
      loadingMsg.innerHTML = "<p>" + text + "</p>";
      codeView.classList.add("hidden");
      formView.classList.add("hidden");
    }

    function showCodeView(code) {
      loadingMsg.classList.add("hidden");
      formView.classList.add("hidden");
      codeView.classList.remove("hidden");
      codeBox.textContent = code || "----";
    }

    function showFormView() {
      loadingMsg.classList.add("hidden");
      codeView.classList.add("hidden");
      formView.classList.remove("hidden");
    }

    // 「住所を変更する」→ フォーム表示
    switchToFormBtn.addEventListener("click", () => {
      showFormView();
      formMsg.textContent = "";
      formMsgOk.textContent = "";
    });

    async function registerCustomer(lineUserId) {
      formMsg.textContent = "";
      formMsgOk.textContent = "";

      const code = codeInput.value.trim();
      const name = nameInput.value.trim();
      const phone = phoneInput.value.trim();
      const zip = zipInput.value.trim();
      const addr = addressInput.value.trim();

      if (!code) {
        formMsg.textContent = "会員番号を入力してください。";
        return;
      }
      if (!/^\d{4,8}$/.test(code)) {
        formMsg.textContent = "会員番号は4〜8桁の数字で入力してください。";
        return;
      }
      if (!name) {
        formMsg.textContent = "お名前を入力してください。";
        return;
      }
      if (!addr) {
        formMsg.textContent = "ご住所を入力してください。";
        return;
      }
      if (phone && !/^\d{9,11}$/.test(phone.replace(/-/g, ""))) {
        formMsg.textContent = "電話番号は9〜11桁の数字で入力してください（ハイフンなし）。";
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = "登録中…";

      try {
        const resp = await fetch(API_BASE + "/api/cod/customers", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            code,
            name,
            phone,
            zip,
            address: addr,
            lineUserId: lineUserId || "",
          }),
        });

        const data = await resp.json().catch(() => ({}));

        if (!resp.ok || !data.ok) {
          formMsg.textContent =
            (data && data.error) ||
            "登録時にエラーが発生しました。時間をおいてお試しください。";
        } else {
          formMsg.textContent = "";
          formMsgOk.textContent =
            "住所登録が完了しました。電話でご注文の際は、この会員番号をボタンで入力してください。";
          // 登録完了後は「会員番号だけ表示」画面に切り替える
          showCodeView(code);
        }
      } catch (e) {
        console.error(e);
        formMsg.textContent = "通信エラーが発生しました。電波状況をご確認ください。";
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "登録する";
      }
    }

    submitBtn.addEventListener("click", async () => {
      try {
        const profile = await liff.getProfile();
        await registerCustomer(profile.userId);
      } catch (e) {
        console.error(e);
        formMsg.textContent =
          "LINEの情報が取得できませんでした。LIFFを閉じて、もう一度お試しください。";
      }
    });

    async function init() {
      try {
        showLoading("LINE情報を取得しています…");

        await liff.init({ liffId: LIFF_ID });

        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        const profile = await liff.getProfile();
        const lineUserId = profile.userId;

        // まず「lineUserIdですでに登録済みか？」を確認
        let found = null;
        try {
          const resp = await fetch(
            API_BASE +
              "/api/cod/customers/by-line?lineUserId=" +
              encodeURIComponent(lineUserId)
          );

          if (resp.ok) {
            const data = await resp.json().catch(() => ({}));
            if (data && data.ok && data.code) {
              found = data;
            }
          }
        } catch (e) {
          console.warn("lookup-by-line error:", e);
        }

        if (found && found.code) {
          // 住所登録済み → 会員番号だけ表示
          showCodeView(found.code);
          codeViewMsg.textContent = "このLINEアカウントでは、住所登録が完了しています。";
        } else {
          // 未登録 or 検索エラー → フォーム表示
          showFormView();
        }
      } catch (e) {
        console.error(e);
        showLoading("エラーが発生しました。LIFFを閉じて、もう一度お試しください。");
      }
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
