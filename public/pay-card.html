<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>カード決済</title>
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",sans-serif;margin:16px}
    #payment-element{margin:12px 0}
    button{width:100%;padding:12px;font-size:16px;font-weight:800}
    .err{color:#b91c1c;margin-top:10px;white-space:pre-wrap;font-weight:800}
    .muted{color:#6b7280;font-size:12px;line-height:1.5}
  </style>
</head>
<body>
  <h2>カード情報の入力</h2>
  <div class="muted" id="info">読み込み中…</div>

  <div id="payment-element"></div>
  <button id="payBtn" type="button" disabled>支払う</button>
  <div id="err" class="err"></div>

<script>
(async () => {
  const errEl = document.getElementById("err");
  const infoEl = document.getElementById("info");
  const payBtn = document.getElementById("payBtn");

  const KEY_LAST_QUOTE = "isoya_last_quote";

  const loadQuote = () => {
    try { return JSON.parse(localStorage.getItem(KEY_LAST_QUOTE) || ""); }
    catch { return null; }
  };

  try {
    // 1) publishableKey
    const conf = await fetch("/api/stripe/config").then(r => r.json());
    const pk = conf.publishableKey;
    if (!pk) throw new Error("publishableKey が未設定です（STRIPE_PUBLISHABLE_KEY）");

    // 2) last_quote から uid / 金額を取る（ここがポイント）
    const quote = loadQuote();
    if (!quote) throw new Error("last_quote がありません（confirm から来てください）");

    const uid = String(quote.uid || "");
    const mode = String(quote.mode || "");
    // あなたの quote の構造に合わせる（totalCard が無い場合は subtotal+shippingFee）
    const amount_yen =
      Number(quote.totalCard || 0) ||
      (Number(quote.subtotal || 0) + Number(quote.shippingFee || 0));

    if (!uid) throw new Error("uid がありません（last_quote が壊れている可能性）");
    if (!Number.isFinite(amount_yen) || amount_yen <= 0) {
      throw new Error("amount_yen が不正です（合計金額が 0）: " + amount_yen);
    }

    infoEl.textContent = `お支払い金額：${amount_yen.toLocaleString("ja-JP")}円`;

    // 3) PaymentIntent を作って client_secret を取る
    const pi = await fetch("/api/stripe/create-payment-intent", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ uid, amount_yen, mode })
    }).then(r => r.json());

    const clientSecret = pi.client_secret;
    if (!clientSecret) {
      throw new Error("client_secret が取得できません: " + JSON.stringify(pi));
    }

    // 4) Payment Element 表示（これがカード入力欄）
    const stripe = Stripe(pk);
    const elements = stripe.elements({ clientSecret });
    const paymentElement = elements.create("payment");
    paymentElement.mount("#payment-element");

    payBtn.disabled = false;

    // 5) 決済確定
    payBtn.addEventListener("click", async () => {
      errEl.textContent = "";
      payBtn.disabled = true;

      const { error } = await stripe.confirmPayment({
        elements,
        confirmParams: {
          return_url: location.origin + "/stripe-success.html"
        }
      });

      if (error) {
        errEl.textContent = error.message || String(error);
        payBtn.disabled = false;
      }
    });

  } catch (e) {
    infoEl.textContent = "エラー";
    errEl.textContent = e?.message || String(e);
  }
})();
</script>
</body>
</html>
