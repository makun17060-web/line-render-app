<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>ご注文内容の最終確認・お支払い｜磯屋</title>

  <!-- LIFF（confirm.html と同じ） -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- Stripe.js -->
  <script src="https://js.stripe.com/v3/"></script>

  <style>
    :root{
      --bg:#f6f7f9;--card:#fff;--text:#111827;--muted:#6b7280;--line:#e5e7eb;
      --accent:#0b3a53;--danger:#b91c1c;--radius:14px;--shadow:0 1px 3px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:720px;margin:0 auto;padding:14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin-bottom:14px}
    .title{font-size:18px;font-weight:800;margin:0 0 6px}
    .shop{font-size:13px;color:var(--muted)}
    .row{display:flex;justify-content:space-between;align-items:flex-end;gap:12px}
    .amount{font-size:26px;font-weight:900}
    .badge{font-size:12px;color:var(--muted);border:1px solid var(--line);border-radius:999px;padding:6px 10px;white-space:nowrap}
    .hr{height:1px;background:var(--line);margin:10px 0}
    .list{font-size:14px;line-height:1.6}
    .list div{display:flex;justify-content:space-between;gap:10px}
    .total{font-weight:800;font-size:16px}
    .section-title{font-size:16px;font-weight:800;margin-bottom:8px}

    #card-element{
      padding:12px;
      border:1px solid var(--line);
      border-radius:12px;
      background:#fff;
    }

    .note{font-size:12px;color:var(--muted);line-height:1.6;margin-top:10px}
    .important{font-size:13px;color:#374151;background:#f9fafb;border:1px solid var(--line);border-radius:10px;padding:10px;margin-top:10px;line-height:1.6}

    .btn{
      width:100%;
      border:0;
      border-radius:12px;
      padding:14px;
      background:var(--accent);
      color:#fff;
      font-size:16px;
      font-weight:800;
      margin-top:14px
    }
    .btn:disabled{opacity:.6}

    .sub{font-size:12px;color:var(--muted);margin-top:10px;text-align:center;line-height:1.5}
    .err{color:var(--danger);font-weight:900;white-space:pre-wrap;margin-top:10px}
    .ok{color:#065f46;font-weight:900;white-space:pre-wrap;margin-top:10px}

    .mini{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.5}
  </style>
</head>

<body>
<div class="wrap">

  <div class="card">
    <div class="title">ご注文内容の最終確認・お支払い</div>
    <div class="shop">手造りえびせんべい 磯屋（公式）</div>
    <div class="mini" id="status">読み込み中…</div>
  </div>

  <div class="card">
    <div class="row">
      <div>
        <div class="shop">お支払い金額（税込）</div>
        <div class="amount" id="amountText">&yen;—</div>
      </div>
      <div class="badge">VISA / Master / JCB / AMEX</div>
    </div>

    <div class="hr"></div>

    <div class="list" id="items">
      <div><span id="itemName">ご注文商品</span><span id="itemPrice">&yen;—</span></div>
      <div><span>送料</span><span id="shipPrice">&yen;—</span></div>
    </div>

    <div class="hr"></div>

    <div class="list total">
      <div><span>合計</span><span id="totalText">&yen;—</span></div>
    </div>
  </div>

  <div class="card">
    <div class="section-title">クレジットカード情報入力</div>
    <div id="card-element"></div>

    <div class="note">
      🔒 安全なお支払いについて<br>
      ・カード情報は当店には保存されません<br>
      ・国際基準のセキュリティで暗号化されています
    </div>

    <div class="important">
      ※ カード会社によっては、このあと本人認証画面が表示されます。<br>
      認証後、この画面に戻って「お支払い完了」と表示されます。
    </div>

    <button class="btn" id="payBtn" disabled>読み込み中…</button>

    <div class="sub">
      クレジットカードが不安な方は<br>
      代引き・店頭受取もご利用いただけます
    </div>

    <div class="err" id="err"></div>
    <div class="ok" id="ok"></div>
  </div>
</div>

<script>
(async function(){
  "use strict";

  // confirm.html と同じ LIFF を使う（uid一致確認のため）
  const LIFF_ID_ORDER = "2008406620-G5j1gjzM";

  const KEY_UID = "isoya_userId";
  const KEY_LAST_QUOTE = "isoya_last_quote";

  const statusEl = document.getElementById("status");
  const errEl = document.getElementById("err");
  const okEl = document.getElementById("ok");

  const payBtn = document.getElementById("payBtn");

  const yenHtml = (n)=>"&yen;" + (Number(n)||0).toLocaleString("ja-JP");

  function setErr(msg){ errEl.textContent = msg || ""; }
  function setOk(msg){ okEl.textContent = msg || ""; }

  function loadJson(k){
    try { return JSON.parse(localStorage.getItem(k) || ""); } catch { return null; }
  }

  try{
    setErr(""); setOk("");
    statusEl.textContent = "確認中…";

    // 1) LIFFログイン & uid取得
    await liff.init({ liffId: LIFF_ID_ORDER });
    if(!liff.isLoggedIn()) throw new Error("ログインできません（LINE内で開き直してください）");

    const prof = await liff.getProfile();
    const uid = prof.userId;
    localStorage.setItem(KEY_UID, uid);

    // 2) confirm.html が保存した見積り（last_quote）を読む
    const last = loadJson(KEY_LAST_QUOTE);
    if(!last) throw new Error("見積り情報がありません。確認画面から進んでください。");
    if(last.uid !== uid) throw new Error("ユーザーが一致しません。最初からやり直してください。");

    const mode = String(last.mode || "");
    // quote 形式はあなたの /api/order/quote 次第なので「候補を広めに」拾う
    const shippingFee = Number(last.shippingFee ?? last.shipping_fee ?? 0);
    const totalCard = Number(last.totalCard ?? last.total_card ?? (Number(last.subtotal||0) + shippingFee));
    if(!totalCard || totalCard <= 0) throw new Error("金額が取得できません（見積りが不正です）。");

    // 3) 表示反映（とりあえずシンプルに）
    document.getElementById("amountText").innerHTML = yenHtml(totalCard);
    document.getElementById("totalText").innerHTML = yenHtml(totalCard);

    document.getElementById("itemName").textContent =
      (mode === "trial") ? "磯屋 初めてセット"
    : (mode === "original") ? "磯屋 オリジナルセット"
    : (mode === "fukubako") ? "磯屋 福箱"
    : "磯屋 ご注文商品";

    // itemPrice は “小計” を表示したいけど last_quote に subtotal が無い場合もあるので候補拾い
    const subtotal = Number(last.subtotal ?? last.itemsSubtotal ?? last.items_subtotal ?? (totalCard - shippingFee));
    document.getElementById("itemPrice").innerHTML = yenHtml(subtotal);
    document.getElementById("shipPrice").innerHTML = yenHtml(shippingFee);

    // 4) Stripe設定取得（pk）
    statusEl.textContent = "決済準備中…";
    const cfgRes = await fetch("/api/stripe/config");
    const cfg = await cfgRes.json().catch(()=>({}));
    if(!cfg.publishableKey) throw new Error("決済設定を取得できません（STRIPE_PUBLISHABLE_KEY を確認）。");

    const stripe = Stripe(cfg.publishableKey);

    // 5) PaymentIntent 作成（サーバーで金額確定）
    const piRes = await fetch("/api/stripe/create-payment-intent",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ uid, amount_yen: totalCard, mode })
    });
    const pi = await piRes.json().catch(()=>({}));
    if(!pi.client_secret) throw new Error("決済の準備に失敗しました。\n" + (pi.error || ""));

    // 6) Elements マウント（Payment Element）
    const elements = stripe.elements({
  clientSecret: pi.client_secret,
  wallets: {
    link: 'never'
  }
});

    const paymentElement = elements.create("payment");
    paymentElement.mount("#card-element");

    // 7) 支払い確定
    payBtn.disabled = false;
    payBtn.textContent = `${(totalCard||0).toLocaleString("ja-JP")}円を支払って注文を確定する`;
    statusEl.textContent = "カード情報を入力して、確定してください。";

    payBtn.addEventListener("click", async ()=>{
      setErr(""); setOk("決済処理中…");
      payBtn.disabled = true;

      // 完了ページ（あなたのドメイン内）へ
      const returnUrl = `${location.origin}/card-complete.html?mode=${encodeURIComponent(mode)}`;

      const { error } = await stripe.confirmPayment({
        elements,
        confirmParams: { return_url: returnUrl }
      });

      if(error){
        setOk("");
        setErr(error.message || "決済に失敗しました。カード情報をご確認ください。");
        payBtn.disabled = false;
      }
      // 通常は return_url に遷移（3DSでも必ず戻る）
    });

  }catch(e){
    statusEl.textContent = "エラー";
    setOk("");
    setErr(String(e && e.message ? e.message : e));
    payBtn.disabled = true;
    payBtn.textContent = "決済を開始できません";
  }
})();
</script>
</body>
</html>
