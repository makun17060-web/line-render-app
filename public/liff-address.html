// /public/liff-address.js
// ②住所入力ページ用（ddress.html）
// - LIFF init → profile取得（userId）
// - 既存住所のプリフィル
// - /api/liff/address に保存
// - 保存後 confirm.html へ

(async function () {
  const $ = (id) => document.getElementById(id);

  const postal     = $("postal");
  const prefecture = $("prefecture");
  const city       = $("city");
  const address1   = $("address1");
  const address2   = $("address2");
  const name       = $("name");
  const phone      = $("phone");
  const saveBtn    = $("saveBtn");
  const backBtn    = $("backBtn");
  const statusMsg  = $("statusMsg");

  const setStatus = (m) => statusMsg.textContent = m || "";

  let lineUserId = "";
  let lineUserName = "";

  // -----------------------------
  // 1) LIFF init + profile
  // -----------------------------
  async function initLiffAndProfile() {
    try {
      const confRes = await fetch("/api/liff/config", { cache: "no-store" });
      const conf = await confRes.json();
      const liffId = (conf?.liffId || "").trim();
      if (!liffId) throw new Error("liffId missing");

      await liff.init({ liffId });

      if (!liff.isLoggedIn()) {
        liff.login();
        return false;
      }

      const prof = await liff.getProfile();
      lineUserId = prof.userId || "";
      lineUserName = prof.displayName || "";
      return true;
    } catch (e) {
      console.log("LIFF init error:", e);
      return false;
    }
  }

  // -----------------------------
  // 2) 既存住所を読み込み → 入力欄へ
  // -----------------------------
  async function loadMyAddress() {
    try {
      if (!lineUserId) return null;
      const res = await fetch(`/api/liff/address/me?userId=${encodeURIComponent(lineUserId)}`, { cache:"no-store" });
      const data = await res.json();
      return data?.address || null;
    } catch {
      return null;
    }
  }

  function fillForm(a) {
    if (!a) return;
    postal.value     = a.postal || "";
    prefecture.value = a.prefecture || "";
    city.value       = a.city || "";
    address1.value   = a.address1 || "";
    address2.value   = a.address2 || "";
    name.value       = a.name || lineUserName || "";
    phone.value      = a.phone || "";
  }

  setStatus("LINE認証中…");
  const ok = await initLiffAndProfile();
  if (!ok || !lineUserId) {
    setStatus("LINEアプリ内で開いてください。");
    saveBtn.disabled = true;
    return;
  }

  const existing = await loadMyAddress();
  fillForm(existing);
  setStatus("");

  // -----------------------------
  // 3) 保存
  // -----------------------------
  async function saveAddress() {
    saveBtn.disabled = true;
    setStatus("保存しています…");

    const payload = {
      userId: lineUserId,
      name: name.value.trim(),
      phone: phone.value.trim(),
      postal: postal.value.trim(),
      prefecture: prefecture.value.trim(),
      city: city.value.trim(),
      address1: address1.value.trim(),
      address2: address2.value.trim(),
    };

    if (!payload.postal || !payload.prefecture || !payload.city || !payload.address1 || !payload.name) {
      setStatus("未入力の項目があります。");
      saveBtn.disabled = false;
      return;
    }

    try {
      const res = await fetch("/api/liff/address", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (!data?.ok) throw new Error(data?.error || "save_failed");

      // currentOrder に住所を入れてから confirm へ
      let order = {};
      try { order = JSON.parse(sessionStorage.getItem("currentOrder") || "{}"); } catch {}
      order.address = payload;
      order.lineUserId = lineUserId;
      order.lineUserName = lineUserName;
      sessionStorage.setItem("currentOrder", JSON.stringify(order));

      setStatus("保存しました。最終確認へ移動します…");
      location.href = "/public/confirm.html";

    } catch (e) {
      console.log(e);
      setStatus("保存に失敗しました。\n通信状況をご確認ください。");
      saveBtn.disabled = false;
    }
  }

  saveBtn.addEventListener("click", saveAddress);

  // -----------------------------
  // 4) 戻る（confirmへ）
  // -----------------------------
  backBtn.addEventListener("click", () => {
    location.href = "/public/confirm.html";
  });

})();
