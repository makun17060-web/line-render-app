// public/products.js
(() => {
  const grid = document.getElementById("productGrid");
  const summary = document.getElementById("cartSummary");
  const toAddressBtn = document.getElementById("toAddressBtn");
  const statusMsg = document.getElementById("statusMsg");

  const cart = new Map(); // productId -> qty
  let products = [];

  function imgUrl(p) {
    const v = String(p?.image || "").trim();
    if (!v) return "/public/noimage.png";
    if (/^https?:\/\//i.test(v)) return v;            // 互換：URL丸ごとでもOK
    if (v.startsWith("/")) return v;                  // 互換：/public/uploads/... 等
    return "/public/uploads/" + encodeURIComponent(v); // ★正解：ファイル名→Disk公開パス
  }

  function yen(n) {
    const x = Number(n || 0);
    return x.toLocaleString("ja-JP") + "円";
  }

  function setStatus(msg) {
    statusMsg.textContent = msg || "";
  }

  function getQty(id) {
    return cart.get(id) || 0;
  }

  function setQty(id, qty) {
    if (qty <= 0) cart.delete(id);
    else cart.set(id, qty);
    renderSummary();
  }

  function renderSummary() {
    const items = [];
    let subtotal = 0;

    for (const p of products) {
      const q = getQty(p.id);
      if (!q) continue;
      items.push(`${p.name} ×${q}`);
      subtotal += Number(p.price || 0) * q;
    }

    if (items.length === 0) {
      summary.textContent = "カートに商品は入っていません。";
      toAddressBtn.disabled = true;
      return;
    }

    summary.textContent =
      items.join("\n") +
      `\n\n小計：${yen(subtotal)}\n（送料は住所入力後に計算）`;

    toAddressBtn.disabled = false;
  }

  function makeCard(p) {
    const card = document.createElement("div");
    card.className = "card";

    const img = document.createElement("img");
    img.src = imgUrl(p);
    img.alt = p.name || "";
    img.loading = "lazy";
    img.onerror = () => {
      img.src = "/public/noimage.png";
    };

    const title = document.createElement("div");
    title.className = "card-title";
    title.textContent = p.name || "";

    const desc = document.createElement("div");
    desc.className = "card-desc";
    desc.textContent = p.desc || "";

    const vol = document.createElement("div");
    vol.className = "card-volume";
    vol.textContent = p.volume ? `内容量：${p.volume}` : "";

    const price = document.createElement("div");
    price.className = "card-price";
    price.textContent = `価格：${yen(p.price)}`;

    const stock = document.createElement("div");
    stock.className = "card-stock";
    stock.textContent = `在庫：${Number(p.stock ?? 0)}`;

    // qty row
    const qtyRow = document.createElement("div");
    qtyRow.className = "qty-row";

    const minus = document.createElement("button");
    minus.textContent = "−";

    const num = document.createElement("span");
    num.textContent = String(getQty(p.id));

    const plus = document.createElement("button");
    plus.textContent = "＋";

    function sync() {
      num.textContent = String(getQty(p.id));
    }

    minus.onclick = () => {
      const q = getQty(p.id);
      if (q <= 0) return;
      setQty(p.id, q - 1);
      sync();
    };

    plus.onclick = () => {
      const q = getQty(p.id);
      const next = q + 1;

      // 在庫上限（在庫が数値の時だけ）
      const st = Number(p.stock);
      if (Number.isFinite(st) && st >= 0 && next > st) {
        setStatus(`「${p.name}」は在庫 ${st} までです。`);
        return;
      }
      setStatus("");
      setQty(p.id, next);
      sync();
    };

    qtyRow.appendChild(minus);
    qtyRow.appendChild(num);
    qtyRow.appendChild(plus);

    card.appendChild(img);
    card.appendChild(title);
    card.appendChild(desc);
    if (vol.textContent) card.appendChild(vol);
    card.appendChild(price);
    card.appendChild(stock);
    card.appendChild(qtyRow);

    return card;
  }

  async function loadProducts() {
    setStatus("");
    grid.innerHTML = "";

    const r = await fetch("/api/products", { cache: "no-store" });
    const t = await r.text();
    let obj;
    try {
      obj = JSON.parse(t);
    } catch {
      obj = { ok: false, error: t };
    }
    if (!obj.ok) throw new Error(obj.error || "api error");

    products = Array.isArray(obj.products) ? obj.products : [];

    for (const p of products) {
      grid.appendChild(makeCard(p));
    }
    renderSummary();
  }

  toAddressBtn.onclick = () => {
    // ここはあなたの既存フローに合わせて変更OK
    // とりあえず選択内容を localStorage に保存して次ページへ渡せる形にする
    const items = [];
    for (const p of products) {
      const q = getQty(p.id);
      if (!q) continue;
      items.push({ id: p.id, name: p.name, qty: q, price: Number(p.price || 0), image: p.image || "" });
    }
    localStorage.setItem("cart_items", JSON.stringify(items));
    // 例：住所入力ページへ
    location.href = "./address.html";
  };

  // start
  loadProducts().catch((e) => {
    setStatus("商品取得に失敗しました: " + (e?.message || e));
  });
})();
