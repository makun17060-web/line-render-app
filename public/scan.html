<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Scan</title>

<style>
body{margin:0;background:#000;color:#fff;font-family:sans-serif}
.videoWrap{position:relative;height:60vh}
video{
  width:100%;
  height:100%;
  object-fit: cover; /* ←ここ重要（戻した） */
}
.reticle{
  position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
}
.reticle div{
  width:80%;height:120px;border:2px solid #fff;border-radius:12px;
}
</style>
</head>

<body>

<div class="videoWrap">
  <video id="video" playsinline></video>
  <div class="reticle"><div></div></div>
</div>

<div style="padding:10px">
  <button onclick="start()">開始</button>
  <button onclick="stop()">停止</button>
  <input id="code" placeholder="結果">
</div>

<script src="/vendor/zxing/library.min.js"></script>
<script src="/vendor/zxing/browser.min.js"></script>
<script>
window.ZXing = window.ZXing || window.ZXingBrowser;

let stream, reader, scanning=false;

function log(...a){console.log(...a)}

function normalize(v){
  return String(v||'').replace(/\D/g,'');
}

async function start(){
  if(scanning) return;

  stream = await navigator.mediaDevices.getUserMedia({
    video:{
      facingMode:"environment",
      width:{ideal:1920},
      height:{ideal:1080}
    }
  });

  const video = document.getElementById('video');
  video.srcObject = stream;
  await video.play();

  const track = stream.getVideoTracks()[0];

  // ✅ 強制ズーム
  try{
    const caps = track.getCapabilities();
    if(caps.zoom){
      await track.applyConstraints({
        advanced:[{zoom: Math.min(3, caps.zoom.max)}]
      });
    }
  }catch(e){}

  // ✅ ヒント拡張（ここ重要）
  const hints = new Map();
  hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
    ZXing.BarcodeFormat.CODE_128,
    ZXing.BarcodeFormat.ITF,
    ZXing.BarcodeFormat.CODE_39,
    ZXing.BarcodeFormat.EAN_13,
    ZXing.BarcodeFormat.EAN_8,
    ZXing.BarcodeFormat.QR_CODE
  ]);
  hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
  hints.set(ZXing.DecodeHintType.ALSO_INVERTED, true);

  reader = new ZXing.BrowserMultiFormatReader(hints, 300);

  scanning = true;

  reader.decodeFromVideoElementContinuously(video, (result, err)=>{
    if(!scanning) return;

    if(result){
      const raw = result.getText();
      const code = normalize(raw);

      document.getElementById('code').value = code;
      log("READ:", raw);

      navigator.vibrate?.(50);
      scanning=false;
      return;
    }

    if(err && err.name !== "NotFoundException"){
      log(err);
    }
  });
}

function stop(){
  scanning=false;
  reader?.reset();
  stream?.getTracks().forEach(t=>t.stop());
}
</script>

</body>
</html>