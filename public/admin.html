<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>LINE えびせん管理画面（画像＆商品）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 16px;
      background: #f5f5f5;
    }
    h1 {
      font-size: 20px;
      margin-bottom: 12px;
    }
    h2 {
      font-size: 16px;
      margin: 16px 0 8px;
    }
    .card {
      background: #fff;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,.08);
    }
    label {
      font-size: 13px;
      display: inline-block;
      margin-bottom: 4px;
    }
    input[type="text"] {
      width: 260px;
      max-width: 100%;
      padding: 6px 8px;
      font-size: 13px;
      box-sizing: border-box;
    }
    button {
      padding: 6px 12px;
      font-size: 13px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      background: #007bff;
      color: #fff;
      margin-left: 4px;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    #status {
      font-size: 12px;
      white-space: pre-line;
      margin-top: 6px;
      color: #333;
    }
    .flex-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }
    .flex-col {
      flex: 1 1 260px;
      min-width: 260px;
    }

    /* 画像一覧サムネ */
    #imageList {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .thumb {
      width: 120px;
      border-radius: 6px;
      overflow: hidden;
      background: #fafafa;
      border: 1px solid #ddd;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 11px;
    }
    .thumb img {
      width: 100%;
      height: 100px;
      object-fit: cover;
      display: block;
      background: #eee;
    }
    .thumb span {
      padding: 2px 4px 4px;
      text-align: center;
      word-break: break-all;
    }
    .thumb.selected {
      outline: 3px solid #007bff;
      border-color: #007bff;
    }

    /* 商品側 */
    #productSelect {
      width: 260px;
      max-width: 100%;
      padding: 6px 8px;
      font-size: 13px;
    }
    #productPreviewImg {
      width: 160px;
      height: 160px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid #ddd;
      background: #eee;
      display: block;
      margin-top: 6px;
    }
    #productInfo {
      font-size: 12px;
      margin-top: 4px;
    }
    small {
      font-size: 11px;
      color: #666;
    }
  </style>
</head>
<body>
  <h1>LINE えびせん 管理画面（画像アップロード & 商品サムネ設定）</h1>

  <div class="card">
    <h2>1. 接続設定</h2>
    <label for="tokenInput">管理トークン（ADMIN_API_TOKEN または ADMIN_CODE）</label><br />
    <input id="tokenInput" type="text" placeholder="例: abc123..." />
    <button id="connectBtn">接続テスト</button>
    <div id="status"></div>
  </div>

  <div class="flex-row">
    <div class="flex-col">
      <div class="card">
        <h2>2. 画像アップロード</h2>
        <input id="fileInput" type="file" accept="image/*" />
        <button id="uploadBtn">アップロード</button><br />
        <small>※ 8MB まで。正方形〜縦長・横長どれでも可です（一覧では正方形にトリミング表示）。</small>
      </div>

      <div class="card">
        <h2>3. アップロード済み画像</h2>
        <div id="imageList"></div>
      </div>
    </div>

    <div class="flex-col">
      <div class="card">
        <h2>4. 商品にサムネ画像を設定</h2>
        <label for="productSelect">商品を選択</label><br />
        <select id="productSelect">
          <option value="">（まだ読み込みされていません）</option>
        </select>

        <div id="productInfo"></div>
        <img id="productPreviewImg" src="" alt="商品サムネ" />

        <div style="margin-top:8px;">
          <button id="applyImageBtn">選択中の画像をこの商品に設定</button>
        </div>
        <small>
          ※ LINE に送る画像 URL は「https://〜」のフル URL で保存されます。<br />
          ※ サムネを変更したら、LINE の「直接注文」で新しい画像が表示されます。
        </small>
      </div>
    </div>
  </div>

  <script src="./admin.js" defer></script>
</body>
</html>
// public/admin.js

(function () {
  const $ = (id) => document.getElementById(id);

  const tokenInput = $("tokenInput");
  const connectBtn = $("connectBtn");
  const statusDiv = $("status");

  const fileInput = $("fileInput");
  const uploadBtn = $("uploadBtn");

  const imageListDiv = $("imageList");

  const productSelect = $("productSelect");
  const productInfo = $("productInfo");
  const productPreviewImg = $("productPreviewImg");
  const applyImageBtn = $("applyImageBtn");

  let adminToken = "";
  let images = [];
  let products = [];
  let selectedImageUrl = ""; // 絶対URL（https://〜）

  function logStatus(msg) {
    const now = new Date().toLocaleString();
    statusDiv.textContent = `[${now}] ${msg}`;
    console.log("[admin]", msg);
  }

  function toAbsoluteUrl(pathOrUrl) {
    if (!pathOrUrl) return "";
    // すでに http / https ならそのまま
    if (/^https?:\/\//i.test(pathOrUrl)) return pathOrUrl;
    // それ以外（/public/〜）は origin を付ける
    return window.location.origin + pathOrUrl;
  }

  // URL パラメータから code/token を拾って初期値にする
  (function initFromQuery() {
    try {
      const params = new URLSearchParams(window.location.search);
      const code = params.get("code") || params.get("token");
      if (code) {
        tokenInput.value = code;
      }
    } catch (e) {
      console.warn("query parse error", e);
    }
  })();

  async function connectionTest() {
    const t = (tokenInput.value || "").trim();
    if (!t) {
      alert("管理トークン（?code= または ADMIN_API_TOKEN）を入力してください。");
      return;
    }
    adminToken = t;
    logStatus("接続テスト中…");

    try {
      const res = await fetch(`/api/admin/connection-test?code=${encodeURIComponent(adminToken)}`, {
        method: "GET",
        credentials: "same-origin",
      });
      const json = await res.json();
      if (!json.ok) {
        logStatus("接続テスト失敗: " + JSON.stringify(json));
        alert("接続テストに失敗しました。\nトークン（code）が正しいか確認してください。");
        return;
      }
      logStatus("接続テスト成功: " + JSON.stringify(json));
      alert("接続テスト成功しました。画像一覧と商品一覧を読み込みます。");

      // 成功したら一覧をロード
      await Promise.all([loadImages(), loadProducts()]);
    } catch (e) {
      console.error(e);
      logStatus("接続テスト中にエラー: " + e.message);
      alert("接続テスト中にエラーが発生しました。コンソールを確認してください。");
    }
  }

  async function loadImages() {
    if (!adminToken) return;
    logStatus("画像一覧を取得中…");
    imageListDiv.innerHTML = "読み込み中…";

    try {
      const res = await fetch(`/api/admin/images?code=${encodeURIComponent(adminToken)}`, {
        method: "GET",
        credentials: "same-origin",
      });
      const json = await res.json();
      if (!json.ok) {
        imageListDiv.textContent = "取得エラー: " + (json.error || "");
        logStatus("画像一覧取得失敗: " + JSON.stringify(json));
        return;
      }
      images = json.items || [];
      renderImageList();
      logStatus(`画像一覧取得 OK (${images.length}件)`);
    } catch (e) {
      console.error(e);
      imageListDiv.textContent = "取得エラー";
      logStatus("画像一覧取得エラー: " + e.message);
    }
  }

  function renderImageList() {
    imageListDiv.innerHTML = "";
    if (!images.length) {
      imageListDiv.textContent = "まだ画像がありません。アップロードしてください。";
      return;
    }

    images.forEach((item, idx) => {
      const absUrl = toAbsoluteUrl(item.url);

      const div = document.createElement("div");
      div.className = "thumb";
      div.dataset.url = absUrl;

      const img = document.createElement("img");
      img.src = absUrl;
      img.alt = item.name || `image-${idx}`;

      const nameSpan = document.createElement("span");
      nameSpan.textContent = item.name || `画像${idx + 1}`;

      div.appendChild(img);
      div.appendChild(nameSpan);

      div.addEventListener("click", () => {
        document.querySelectorAll(".thumb.selected").forEach(el => el.classList.remove("selected"));
        div.classList.add("selected");
        selectedImageUrl = absUrl;
        logStatus("選択中の画像: " + selectedImageUrl);
      });

      imageListDiv.appendChild(div);
    });
  }

  async function uploadImage() {
    if (!adminToken) {
      alert("先に接続テストを行ってください。");
      return;
    }
    const file = fileInput.files[0];
    if (!file) {
      alert("アップロードする画像ファイルを選択してください。");
      return;
    }

    const form = new FormData();
    form.append("image", file);

    uploadBtn.disabled = true;
    logStatus("画像アップロード中…");

    try {
      const res = await fetch(`/api/admin/upload-image?code=${encodeURIComponent(adminToken)}`, {
        method: "POST",
        body: form,
      });
      const json = await res.json();
      if (!json.ok) {
        logStatus("アップロード失敗: " + JSON.stringify(json));
        alert("アップロードに失敗しました: " + (json.error || ""));
        return;
      }
      logStatus("アップロード成功: " + json.url);
      // すぐ一覧更新
      await loadImages();
    } catch (e) {
      console.error(e);
      logStatus("アップロードエラー: " + e.message);
      alert("アップロード中にエラーが発生しました。");
    } finally {
      uploadBtn.disabled = false;
      fileInput.value = "";
    }
  }

  async function loadProducts() {
    if (!adminToken) return;
    logStatus("商品一覧を取得中…");
    productSelect.innerHTML = `<option value="">読み込み中…</option>`;

    try {
      const res = await fetch(`/api/admin/products?code=${encodeURIComponent(adminToken)}`, {
        method: "GET",
        credentials: "same-origin",
      });
      const json = await res.json();
      if (!json.ok) {
        logStatus("商品一覧取得失敗: " + JSON.stringify(json));
        productSelect.innerHTML = `<option value="">取得エラー</option>`;
        return;
      }
      products = json.items || [];
      renderProductSelect();
      logStatus(`商品一覧取得 OK (${products.length}件)`);
    } catch (e) {
      console.error(e);
      logStatus("商品一覧取得エラー: " + e.message);
      productSelect.innerHTML = `<option value="">取得エラー</option>`;
    }
  }

  function renderProductSelect() {
    productSelect.innerHTML = "";
    if (!products.length) {
      productSelect.innerHTML = `<option value="">商品がありません</option>`;
      return;
    }
    productSelect.appendChild(new Option("商品を選択してください", ""));
    products.forEach(p => {
      const label = `${p.name}（${p.id} / ${p.price}円 / 在庫${p.stock}）`;
      productSelect.appendChild(new Option(label, p.id));
    });
  }

  function updateProductPreview() {
    const pid = productSelect.value;
    const product = products.find(p => p.id === pid);
    if (!product) {
      productInfo.textContent = "";
      productPreviewImg.src = "";
      productPreviewImg.style.visibility = "hidden";
      return;
    }
    productPreviewImg.style.visibility = "visible";
    const abs = toAbsoluteUrl(product.image || "");
    if (abs) {
      productPreviewImg.src = abs;
    } else {
      productPreviewImg.src = "";
    }
    productInfo.textContent = `現在の画像URL: ${product.image || "(未設定)"}`;
  }

  async function applyImageToProduct() {
    const pid = productSelect.value;
    if (!pid) {
      alert("商品を選択してください。");
      return;
    }
    if (!selectedImageUrl) {
      alert("左側の画像一覧から、商品に設定したい画像をクリックして選択してください。");
      return;
    }
    if (!adminToken) {
      alert("先に接続テストを行ってください。");
      return;
    }

    const absUrl = toAbsoluteUrl(selectedImageUrl); // 念のため

    logStatus(`商品 ${pid} に画像を設定中…`);
    applyImageBtn.disabled = true;

    try {
      const res = await fetch(`/api/admin/products/set-image?code=${encodeURIComponent(adminToken)}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ productId: pid, imageUrl: absUrl }),
      });
      const json = await res.json();
      if (!json.ok) {
        logStatus("設定失敗: " + JSON.stringify(json));
        alert("画像設定に失敗しました: " + (json.error || ""));
        return;
      }
      logStatus("設定成功: " + JSON.stringify(json.product));
      alert("商品に画像を設定しました。LINE での表示もこの画像になります。");

      // ローカルの products も更新してプレビュー反映
      const idx = products.findIndex(p => p.id === pid);
      if (idx >= 0) {
        products[idx].image = json.product.image;
      }
      updateProductPreview();
    } catch (e) {
      console.error(e);
      logStatus("設定エラー: " + e.message);
      alert("画像設定中にエラーが発生しました。");
    } finally {
      applyImageBtn.disabled = false;
    }
  }

  // ===== イベント紐付け =====
  connectBtn.addEventListener("click", connectionTest);
  uploadBtn.addEventListener("click", uploadImage);
  productSelect.addEventListener("change", updateProductPreview);

  // 初期表示ではプレビュー画像を隠しておく
  productPreviewImg.style.visibility = "hidden";
})();
