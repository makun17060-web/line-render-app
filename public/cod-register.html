<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>電話代引き用 住所登録</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 12px;
      background: #f7f7f7;
    }
    header {
      margin-bottom: 12px;
    }
    header h1 {
      font-size: 18px;
      margin: 0 0 4px;
    }
    header p {
      font-size: 12px;
      margin: 0;
      color: #555;
      white-space: pre-line;
    }
    .card {
      background: #fff;
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      margin-bottom: 12px;
    }
    .field {
      margin-bottom: 10px;
    }
    .field label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
    }
    .field input,
    .field textarea {
      width: 100%;
      box-sizing: border-box;
      font-size: 14px;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    .field textarea {
      min-height: 80px;
      resize: vertical;
    }
    .note {
      font-size: 11px;
      color: #777;
      margin-top: 2px;
    }
    button {
      width: 100%;
      padding: 10px;
      font-size: 15px;
      border-radius: 999px;
      border: none;
      background: #00b900;
      color: #fff;
      font-weight: 600;
    }
    button:disabled {
      opacity: 0.6;
    }
    #status {
      font-size: 12px;
      color: #d00;
      margin-top: 8px;
      white-space: pre-line;
    }
    #liffState {
      font-size: 11px;
      color: #555;
      margin-bottom: 8px;
      white-space: pre-line;
    }
  </style>
</head>
<body>
  <header>
    <h1>電話代引き用 住所登録</h1>
    <p>
      電話での代金引換ご注文の際に使う、
      「会員番号」とお届け先の情報を事前にご登録いただくページです。
    </p>
  </header>

  <div class="card">
    <div id="liffState">LIFF 初期化中です…</div>

    <form id="addrForm">
      <div class="field">
        <label>会員番号（4〜8桁の数字）<span style="color:#d00">*</span></label>
        <input type="tel" id="code" inputmode="numeric" pattern="[0-9]*" maxlength="8" />
        <div class="note">電話受付時に、ボタンで押していただく番号です。</div>
      </div>

      <div class="field">
        <label>お名前<span style="color:#d00">*</span></label>
        <input type="text" id="name" />
      </div>

      <div class="field">
        <label>電話番号（ハイフンなし 可）</label>
        <input type="tel" id="phone" inputmode="numeric" pattern="[0-9\-]*" />
        <div class="note">ご連絡先の電話番号です。</div>
      </div>

      <div class="field">
        <label>郵便番号（ハイフンなし 可）</label>
        <input type="tel" id="zip" inputmode="numeric" pattern="[0-9\-]*" />
      </div>

      <div class="field">
        <label>ご住所<span style="color:#d00">*</span></label>
        <textarea id="address" placeholder="例）愛知県知多郡美浜町〇〇…"></textarea>
      </div>

      <button type="submit" id="submitBtn" disabled>この内容で登録する</button>

      <div id="status"></div>
    </form>
  </div>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    // ★★★ ここを必ず「住所登録用 LIFF ID」に書き換えてください ★★★
    const LIFF_ID = "2008406620-4QJ06JLv";

    // 住所情報の送信先（phone-cod サーバー）
    const API_BASE = "https://phone-cod.onrender.com";
    const REGISTER_ENDPOINT = API_BASE + "/api/cod/customers";

    const liffStateEl = document.getElementById("liffState");
    const statusEl = document.getElementById("status");
    const formEl = document.getElementById("addrForm");
    const submitBtn = document.getElementById("submitBtn");

    let lineUserId = null;

    function setStatus(msg, isError = true) {
      statusEl.style.color = isError ? "#d00" : "#008800";
      statusEl.textContent = msg || "";
    }

    async function initLiff() {
      try {
        console.log("[cod-register] liff.init start", LIFF_ID);
        await liff.init({ liffId: LIFF_ID });

        if (!liff.isInClient()) {
          liffStateEl.textContent = "LINE アプリ内から開いてご利用ください。";
          submitBtn.disabled = true;
          return;
        }

        const ctx = liff.getContext();
        const profile = await liff.getProfile().catch(() => null);

        lineUserId =
          (ctx && ctx.userId) ||
          (profile && profile.userId) ||
          null;

        console.log("[cod-register] context:", ctx);
        console.log("[cod-register] profile:", profile);
        console.log("[cod-register] lineUserId:", lineUserId);

        if (lineUserId) {
          liffStateEl.textContent =
            "LIFF 初期化に成功しました。\nこのLINEアカウントに住所情報を登録します。";
        } else {
          liffStateEl.textContent =
            "LIFF 初期化に成功しましたが、ユーザーIDが取得できませんでした。";
        }

        submitBtn.disabled = false;
      } catch (e) {
        console.error("[cod-register] liff.init error:", e);
        liffStateEl.textContent =
          "LIFF の初期化に失敗しました。\n" +
          "・LINE Developers の LIFF ID とこのページの LIFF_ID が一致しているか\n" +
          "・エンドポイント URL が https://line-render-app-1.onrender.com/public/cod-register.html になっているか\n" +
          "をご確認ください。";
        submitBtn.disabled = true;
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      initLiff().catch((e) => {
        console.error(e);
      });

      formEl.addEventListener("submit", async (ev) => {
        ev.preventDefault();
        setStatus("");

        const code = document.getElementById("code").value.trim();
        const name = document.getElementById("name").value.trim();
        const phone = document.getElementById("phone").value.trim();
        const zip = document.getElementById("zip").value.trim();
        const address = document.getElementById("address").value.trim();

        if (!code || !/^\d{4,8}$/.test(code)) {
          setStatus("会員番号は 4〜8 桁の数字で入力してください。", true);
          return;
        }
        if (!name) {
          setStatus("お名前を入力してください。", true);
          return;
        }
        if (!address) {
          setStatus("ご住所を入力してください。", true);
          return;
        }

        submitBtn.disabled = true;
        setStatus("登録中です…", false);

        try {
          const body = {
            code,
            name,
            phone,
            zip,
            address,
            // サーバー側で lineUserId を使う場合は受け取れるようにしておく
            lineUserId: lineUserId || null,
          };

          const resp = await fetch(REGISTER_ENDPOINT, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(body),
          });

          const data = await resp.json().catch(() => ({}));

          if (!resp.ok || !data.ok) {
            console.error("[cod-register] API error:", resp.status, data);
            if (data.code === "DUPLICATE_CODE") {
              setStatus("この会員番号はすでに登録されています。別の番号をお試しください。");
            } else if (data.error) {
              setStatus(data.error);
            } else {
              setStatus("登録中にエラーが発生しました。時間をおいて再度お試しください。");
            }
            submitBtn.disabled = false;
            return;
          }

          setStatus("ご登録ありがとうございました。電話でのご注文の際は、この会員番号を押してください。", false);

          // 数秒後に LIFF を閉じる
          setTimeout(() => {
            try {
              if (liff.isInClient()) {
                liff.closeWindow();
              }
            } catch (e) {
              console.error(e);
            }
          }, 2500);
        } catch (e) {
          console.error("[cod-register] fetch error:", e);
          setStatus("通信エラーが発生しました。電波状況をご確認ください。");
          submitBtn.disabled = false;
        }
      });
    });
  </script>
</body>
</html>
