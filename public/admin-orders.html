// =========================
// Admin API (orders)
// =========================
const express = require("express");
const { Pool } = require("pg");

const ADMIN_API_TOKEN = (process.env.ADMIN_API_TOKEN || process.env.ADMIN_CODE || "").trim();
const LINE_CHANNEL_ACCESS_TOKEN = process.env.LINE_CHANNEL_ACCESS_TOKEN;

const COD_FEE = 330;

function requireAdmin(req, res, next) {
  const token = String(req.query.token || "").trim();
  if (!ADMIN_API_TOKEN || token !== ADMIN_API_TOKEN) {
    return res.status(401).json({ ok: false, error: "unauthorized" });
  }
  next();
}

async function linePush(to, text) {
  if (!LINE_CHANNEL_ACCESS_TOKEN) throw new Error("LINE_CHANNEL_ACCESS_TOKEN is missing");
  const r = await fetch("https://api.line.me/v2/bot/message/push", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${LINE_CHANNEL_ACCESS_TOKEN}`,
    },
    body: JSON.stringify({
      to,
      messages: [{ type: "text", text }],
    }),
  });
  if (!r.ok) {
    const t = await r.text().catch(() => "");
    throw new Error(`LINE push failed: ${r.status} ${t}`);
  }
  return true;
}

// pool が既にあるならそれを使ってOK
const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  ssl: { rejectUnauthorized: false },
});

// items(jsonb) から商品合計を計算
function calcItemsSum(items) {
  const arr = Array.isArray(items) ? items : [];
  let sum = 0;
  for (const it of arr) {
    const price = Number(it?.price || 0);
    const qty = Number(it?.qty || 0);
    sum += (price * qty);
  }
  return sum;
}

// GET /api/admin/orders?date=YYYYMMDD&token=...
app.get("/api/admin/orders", requireAdmin, async (req, res) => {
  const date = String(req.query.date || "").trim(); // YYYYMMDD
  try {
    const params = [];
    let where = "";
    if (date) {
      // created_at は timestamp without time zone
      where = "WHERE o.created_at::date = to_date($1,'YYYYMMDD')";
      params.push(date);
    }

    const sql = `
      SELECT
        o.id,
        o.user_id,
        o.member_code,
        o.phone,
        o.items,
        o.total,
        o.shipping_fee,
        o.payment_method,
        o.status,
        o.name,
        o.zip,
        o.pref,
        o.address,
        o.source,
        o.created_at,
        o.notified_user_at,
        o.notified_admin_at,
        o.notified_kind
      FROM orders o
      ${where}
      ORDER BY o.created_at DESC, o.id DESC
      LIMIT 500
    `;

    const r = await pool.query(sql, params);

    const items = r.rows.map((row) => {
      const payment = String(row.payment_method || "").toLowerCase();
      const codFee = (payment === "cod") ? COD_FEE : 0;

      const shipping = Number(row.shipping_fee || 0);
      const totalDb  = Number(row.total || 0);

      // ★重要：商品合計は total - shipping - codFee（代引が商品に混ざらない）
      const itemsFromTotal = totalDb - shipping - codFee;

      // items再計算（検算）
      const itemsCalc = calcItemsSum(row.items);

      const warn = (itemsCalc !== 0 && itemsFromTotal !== itemsCalc);
      const diff = itemsFromTotal - itemsCalc;

      return {
        id: row.id,
        orderNumber: row.id,          // ★order_number無いのでここが注文番号
        userId: row.user_id,
        lineUserId: row.user_id,

        ts: row.created_at,
        created_at: row.created_at,

        items: row.items || [],
        payment_method: row.payment_method,
        payment: row.payment_method,

        // admin が使いやすい形に寄せる
        total: totalDb,
        shipping_fee: shipping,
        shipping: shipping,
        codFee,

        // 表示用の分解（これがズレない）
        itemsTotal: itemsFromTotal,
        finalTotal: totalDb,

        // 住所は admin.html が address オブジェクトも読めるように
        address: {
          name: row.name || "",
          phone: row.phone || "",
          postal: row.zip || "",
          prefecture: row.pref || "",
          city: "",
          address1: row.address || "",
          address2: "",
        },

        // 検算情報（adminが警告出せる）
        warn: warn ? { itemsCalc, itemsFromTotal, diff } : null,

        status: row.status,
        source: row.source,
        member_code: row.member_code,
        notified_user_at: row.notified_user_at,
        notified_admin_at: row.notified_admin_at,
        notified_kind: row.notified_kind,
      };
    });

    res.json({ ok: true, items });
  } catch (e) {
    console.error("[/api/admin/orders] error:", e);
    res.status(500).json({ ok: false, error: String(e?.message || e) });
  }
});

// POST /api/admin/orders/notify-shipped?token=...
app.post("/api/admin/orders/notify-shipped", requireAdmin, express.json(), async (req, res) => {
  try {
    const { orderId, userId, message } = req.body || {};
    const oid = Number(orderId);
    const uid = String(userId || "").trim();

    if (!uid) return res.status(400).json({ ok: false, error: "see body.userId" });

    // 送信
    await linePush(uid, String(message || "").trim() || "【発送のお知らせ】\n発送いたしました。");

    // DBに発送通知済みを保存（id列で更新）
    if (isFinite(oid) && oid > 0) {
      await pool.query(
        `UPDATE orders
         SET notified_user_at = NOW(),
             notified_kind = 'shipped'
         WHERE id = $1`,
        [oid]
      );
    }

    res.json({ ok: true });
  } catch (e) {
    console.error("[/api/admin/orders/notify-shipped] error:", e);
    res.status(500).json({ ok: false, error: String(e?.message || e) });
  }
});
