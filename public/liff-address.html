<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>住所登録（LIFF）</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body{ font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; margin:0; background:#f6f7f9; color:#111827;}
    .wrap{ max-width:720px; margin:0 auto; padding:14px; }
    .card{ background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:14px; box-shadow:0 1px 3px rgba(0,0,0,.08); }
    label{ display:block; font-weight:800; margin-top:10px; }
    input,select{ width:100%; padding:10px; border-radius:10px; border:1px solid #d1d5db; font-size:16px; background:#fff; }
    button{ width:100%; margin-top:14px; padding:12px; border-radius:12px; border:0; background:#0b3a53; color:#fff; font-weight:900; font-size:16px; cursor:pointer; }
    .msg{ margin-top:10px; font-size:13px; font-weight:800; color:#b91c1c; white-space:pre-wrap; }
    .ok{ color:#065f46; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2 style="margin:0 0 8px;">住所登録</h2>
      <div id="msg" class="msg"></div>

      <label>お名前</label>
      <input id="name" autocomplete="name" />

      <label>電話</label>
      <input id="phone" inputmode="tel" autocomplete="tel" />

      <label>郵便番号</label>
      <input id="postal" inputmode="numeric" autocomplete="postal-code" />

      <label>都道府県</label>
      <input id="prefecture" autocomplete="address-level1" placeholder="例：愛知県" />

      <label>市区町村</label>
      <input id="city" autocomplete="address-level2" placeholder="例：知多郡南知多町" />

      <label>町名・番地</label>
      <input id="address1" autocomplete="street-address" placeholder="例：豊浜清水谷〜" />

      <label>建物名・部屋番号</label>
      <input id="address2" autocomplete="address-line2" />

      <button id="saveBtn">保存する</button>
    </div>
  </div>

<script>
(async function(){
  "use strict";

  const LIFF_ID = "2008406620-4kyQVyqe";
  const msgEl = document.getElementById("msg");

  const $ = (id)=>document.getElementById(id);
  const setMsg = (t, ok=false)=>{ msgEl.textContent = t||""; msgEl.className = "msg" + (ok?" ok":""); };

  function getUserId(){
    try{
      const ctx = liff.getContext && liff.getContext();
      return (ctx && ctx.userId) ? String(ctx.userId) : "";
    }catch{ return ""; }
  }

  async function initLiff(){
    try{
      // liffId を固定で持ってるなら、ここを固定値にしてOK
      // await liff.init({ liffId: LIFF_ID });
      await liff.init({ liffId: LIFF_ID || undefined });
      if (!liff.isLoggedIn()) liff.login();
    }catch(e){
      setMsg("LIFF初期化に失敗しました。\n" + (e?.message||e));
    }
  }

  async function loadAddress(userId){
    const r = await fetch(`/api/address/get?userId=${encodeURIComponent(userId)}`, { cache:"no-store" });
    const j = await r.json().catch(()=>({}));
    if (!r.ok) return;
    const a = j.address || {};
    $("name").value = a.name || "";
    $("phone").value = a.phone || "";
    $("postal").value = a.postal || "";
    $("prefecture").value = a.prefecture || "";
    $("city").value = a.city || "";
    $("address1").value = a.address1 || "";
    $("address2").value = a.address2 || "";
  }

  async function saveAddress(userId){
    const payload = {
      userId,
      name: $("name").value.trim(),
      phone: $("phone").value.trim(),
      postal: $("postal").value.trim(),
      prefecture: $("prefecture").value.trim(),
      city: $("city").value.trim(),
      address1: $("address1").value.trim(),
      address2: $("address2").value.trim(),
    };

    const r = await fetch("/api/address/set", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    const j = await r.json().catch(()=>({}));
    if (!r.ok) {
      setMsg(`保存失敗（HTTP ${r.status}）\n` + JSON.stringify(j));
      return;
    }
    setMsg("保存しました！この画面を閉じてOKです。", true);
  }

  await initLiff();

  // userIdが取れない＝LIFF外で開いてる（400の元）
  const userId = getUserId();
  if (!userId) {
    setMsg("userIdが取得できません。\n必ずLINEのLIFF内から開いてください（ブラウザ直開きだと400になります）。");
    return;
  }

  await loadAddress(userId);

  $("saveBtn").addEventListener("click", ()=> saveAddress(userId));
})();
</script>
</body>
</html>
