<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ä»£å¼•ãç”¨ ä½æ‰€ç™»éŒ²</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/versions/2.23.0/sdk.js"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #f7f7f7;
    }
    h1 {
      font-size: 18px;
      margin-bottom: 8px;
    }
    p {
      font-size: 14px;
      line-height: 1.6;
    }
    .card {
      background: #fff;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      margin-bottom: 12px;
    }
    label {
      display: block;
      font-size: 13px;
      margin-top: 8px;
      margin-bottom: 2px;
    }
    input, textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    textarea {
      min-height: 80px;
      resize: vertical;
    }
    button {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 6px;
      font-size: 15px;
      font-weight: 600;
      margin-top: 12px;
      cursor: pointer;
      background: #06c755;
      color: #fff;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .info {
      font-size: 13px;
      color: #555;
      margin-top: 4px;
    }
    .status {
      margin-top: 8px;
      font-size: 13px;
      white-space: pre-line;
    }
    .status.error {
      color: #c00;
    }
    .status.ok {
      color: #067d35;
    }
    .small {
      font-size: 12px;
      color: #777;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>ä»£å¼•ãç”¨ ãŠå±Šã‘å…ˆç™»éŒ²</h1>
    <p>
      LINE ã‹ã‚‰ã®ä»£å¼•ãé›»è©±æ³¨æ–‡ã®ãŸã‚ã«ã€<br />
      ãŠåå‰ãƒ»ã”ä½æ‰€ãƒ»ãŠé›»è©±ç•ªå·ã‚’äº‹å‰ç™»éŒ²ã—ã¦ã„ãŸã ããƒšãƒ¼ã‚¸ã§ã™ã€‚
    </p>
  </div>

  <!-- âœ… ã™ã§ã«ç™»éŒ²æ¸ˆã¿ã ã£ãŸå ´åˆã«ã ã‘è¦‹ã›ã‚‹ã‚¨ãƒªã‚¢ -->
  <div class="card" id="sectionAlready" style="display:none;">
    <h2 style="font-size:16px;margin-top:0;">ç™»éŒ²æ¸ˆã¿ã®æƒ…å ±</h2>
    <p class="info">
      ã“ã¡ã‚‰ã® LINE ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã¯ã€ã™ã§ã«ãŠå±Šã‘å…ˆã®ã”ç™»éŒ²ãŒå®Œäº†ã—ã¦ã„ã¾ã™ã€‚
    </p>
    <p>
      <strong>ã‚ãªãŸã®ä¼šå“¡ç•ªå·</strong><br />
      <span style="font-size:20px;font-weight:bold;" id="alreadyCode">----</span>
    </p>
    <p>
      <strong>ãŠåå‰</strong><br />
      <span id="alreadyName"></span>
    </p>
    <p>
      <strong>ã”ä½æ‰€</strong><br />
      ã€’<span id="alreadyZip"></span><br />
      <span id="alreadyAddress"></span>
    </p>
    <p>
      <strong>ãŠé›»è©±ç•ªå·</strong><br />
      <span id="alreadyPhone"></span>
    </p>
    <p class="small">
      â€»ä¼šå“¡ç•ªå·ã¯ã€é›»è©±æ³¨æ–‡ã®æœ€å¾Œã«ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦ã„ãŸã ãç•ªå·ã§ã™ã€‚<br />
      â€»ã”ä½æ‰€ã‚’å¤‰æ›´ã—ãŸã„å ´åˆã¯ã€æ–°ã—ã„å†…å®¹ã§å†ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚
    </p>
  </div>

  <!-- ğŸ“ æ–°è¦ or å†ç™»éŒ²ç”¨ãƒ•ã‚©ãƒ¼ãƒ  -->
  <div class="card" id="sectionForm" style="display:none;">
    <h2 style="font-size:16px;margin-top:0;">ãŠå±Šã‘å…ˆæƒ…å ±ã®ç™»éŒ² / æ›´æ–°</h2>

    <label for="code">ä¼šå“¡ç•ªå·ï¼ˆ4ã€œ8æ¡ã®æ•°å­—ï¼‰</label>
    <input id="code" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="ä¾‹ï¼‰1234" />
    <div class="info">é›»è©±æ³¨æ–‡ã®æœ€å¾Œã«æŠ¼ã—ã¦ã„ãŸã ãç•ªå·ã«ãªã‚Šã¾ã™ã€‚</div>

    <label for="name">ãŠåå‰</label>
    <input id="name" type="text" placeholder="ä¾‹ï¼‰ç£¯å±‹ å¤ªéƒ" />

    <label for="phone">é›»è©±ç•ªå·ï¼ˆãƒã‚¤ãƒ•ãƒ³ç„¡ã—ï¼‰</label>
    <input id="phone" type="tel" inputmode="numeric" pattern="[0-9]*" placeholder="ä¾‹ï¼‰09012345678" />

    <label for="zip">éƒµä¾¿ç•ªå·ï¼ˆãƒã‚¤ãƒ•ãƒ³ç„¡ã—ï¼‰</label>
    <input id="zip" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="ä¾‹ï¼‰4700000" />

    <label for="address">ã”ä½æ‰€</label>
    <textarea id="address" placeholder="ä¾‹ï¼‰æ„›çŸ¥çœŒçŸ¥å¤šéƒ¡ç¾æµœç”ºâ—¯â—¯â—¯â—¯â—¯"></textarea>

    <button id="btnSubmit">ã“ã®å†…å®¹ã§ç™»éŒ²ã™ã‚‹</button>
    <div id="status" class="status"></div>
  </div>

  <div class="status" id="loading">LINE ã¨é€šä¿¡ä¸­ã§ã™â€¦</div>

  <script>
    // â˜…ã“ã“ã‚’ã‚ãªãŸã® LIFF IDï¼ˆä½æ‰€ç™»éŒ²ç”¨ï¼‰ã«æ›¸ãæ›ãˆã¦ãã ã•ã„
    const LIFF_ID = "2008406620-4QJ06JLv";

    // â˜…ã“ã“ã« phone-cod ã‚µãƒ¼ãƒãƒ¼ã® URL ã‚’å…¥ã‚Œã¦ãã ã•ã„
    // ä¾‹ï¼‰const API_BASE = "https://phone-cod.onrender.com";
    const API_BASE = "https://server-phone-cod-js.onrender.com";

    // API ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆserver-phone-cod.js å´ï¼‰
    const API_LOOKUP_BY_LINE = API_BASE + "/api/cod/customers/by-line";
    const API_SAVE          = API_BASE + "/api/cod/customers";

    let gLineUserId = "";

    function setStatus(msg, isError = false) {
      const el = document.getElementById("status");
      el.textContent = msg || "";
      el.className = "status " + (isError ? "error" : msg ? "ok" : "");
    }

    function showSection(id, show) {
      const el = document.getElementById(id);
      if (!el) return;
      el.style.display = show ? "block" : "none";
    }

    async function initLiff() {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }
        const profile = await liff.getProfile();
        gLineUserId = profile.userId || "";
        console.log("LIFF userId =", gLineUserId);

        document.getElementById("loading").textContent = "ç™»éŒ²çŠ¶æ³ã‚’ç¢ºèªã—ã¦ã„ã¾ã™â€¦";

        // ä½æ‰€ç™»éŒ²æ¸ˆã¿ã‹ã©ã†ã‹ã‚µãƒ¼ãƒãƒ¼ã«å•ã„åˆã‚ã›
        await checkAlreadyRegistered();
      } catch (e) {
        console.error("LIFF init error:", e);
        document.getElementById("loading").textContent =
          "LIFF ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";
      }
    }

    async function checkAlreadyRegistered() {
      if (!gLineUserId) {
        document.getElementById("loading").textContent =
          "ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";
        return;
      }

      try {
        const url = API_LOOKUP_BY_LINE + "?lineUserId=" + encodeURIComponent(gLineUserId);
        const resp = await fetch(url);
        if (!resp.ok) {
          // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ã€Œæœªç™»éŒ²æ‰±ã„ã€ã§ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¦‹ã›ã‚‹
          console.warn("lookup-by-line http error:", resp.status);
          document.getElementById("loading").style.display = "none";
          showSection("sectionForm", true);
          return;
        }
        const data = await resp.json();
        console.log("lookup-by-line result:", data);

        document.getElementById("loading").style.display = "none";

        if (data && data.ok && data.customer && data.code) {
          // âœ… ç™»éŒ²æ¸ˆã¿ï¼šä¼šå“¡ç•ªå·ã ã‘ã®ç”»é¢ã‚’è¡¨ç¤º
          document.getElementById("alreadyCode").textContent = data.code;
          document.getElementById("alreadyName").textContent = data.customer.name || "";
          document.getElementById("alreadyZip").textContent = data.customer.zip || "";
          document.getElementById("alreadyAddress").textContent = data.customer.address || "";
          document.getElementById("alreadyPhone").textContent = data.customer.phone || "";

          showSection("sectionAlready", true);
          showSection("sectionForm", false); // â† ç™»éŒ²æ¸ˆã¿ã®äººã¯ãƒ•ã‚©ãƒ¼ãƒ éè¡¨ç¤º
        } else {
          // æœªç™»éŒ²ï¼šãƒ•ã‚©ãƒ¼ãƒ ã ã‘è¡¨ç¤º
          showSection("sectionForm", true);
        }
      } catch (e) {
        console.error("lookup-by-line fetch error:", e);
        document.getElementById("loading").style.display = "none";
        showSection("sectionForm", true);
      }
    }

    async function onSubmit() {
      setStatus("");
      const btn = document.getElementById("btnSubmit");
      btn.disabled = true;

      const code = document.getElementById("code").value.trim();
      const name = document.getElementById("name").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const zip = document.getElementById("zip").value.trim();
      const address = document.getElementById("address").value.trim();

      if (!code || !/^\d{4,8}$/.test(code)) {
        setStatus("ä¼šå“¡ç•ªå·ã¯ 4ã€œ8 æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", true);
        btn.disabled = false;
        return;
      }
      if (!name) {
        setStatus("ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", true);
        btn.disabled = false;
        return;
      }
      if (!address) {
        setStatus("ã”ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", true);
        btn.disabled = false;
        return;
      }
      if (phone && !/^\d{9,11}$/.test(phone)) {
        setStatus("é›»è©±ç•ªå·ã¯ 9ã€œ11 æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆãƒã‚¤ãƒ•ãƒ³ç„¡ã—ï¼‰ã€‚", true);
        btn.disabled = false;
        return;
      }

      try {
        const payload = {
          code,
          name,
          phone,
          zip,
          address,
          lineUserId: gLineUserId || "",
        };

        const resp = await fetch(API_SAVE, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(payload),
        });

        const data = await resp.json().catch(() => ({}));
        console.log("save result:", data);

        if (!resp.ok || !data.ok) {
          const msg =
            data && data.error
              ? data.error
              : "ç™»éŒ²ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";
          setStatus(msg, true);
          btn.disabled = false;
          return;
        }

        setStatus(`ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ã‚ãªãŸã®ä¼šå“¡ç•ªå·ã¯ã€Œ${code}ã€ã§ã™ã€‚`, false);

        // ç™»éŒ²å¾Œã¯ã€Œç™»éŒ²æ¸ˆã¿ã‚¨ãƒªã‚¢ã€ã«ã‚‚åæ˜ ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ ã¯éš ã™
        document.getElementById("alreadyCode").textContent = code;
        document.getElementById("alreadyName").textContent = name;
        document.getElementById("alreadyZip").textContent = zip;
        document.getElementById("alreadyAddress").textContent = address;
        document.getElementById("alreadyPhone").textContent = phone;

        showSection("sectionAlready", true);
        showSection("sectionForm", false);
      } catch (e) {
        console.error("save error:", e);
        setStatus("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚", true);
      } finally {
        btn.disabled = false;
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      document
        .getElementById("btnSubmit")
        .addEventListener("click", (e) => {
          e.preventDefault();
          onSubmit();
        });

      initLiff();
    });
  </script>
</body>
</html>
