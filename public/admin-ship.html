<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>管理（発送通知 / 注文明細）</title>
  <style>
    :root{
      --bg:#f5f6f8; --card:#fff; --text:#111827; --muted:#6b7280;
      --line:#e5e7eb; --primary:#0b3a53; --danger:#b91c1c;
      --radius:14px; --shadow:0 1px 3px rgba(0,0,0,.08);
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; background:var(--bg); color:var(--text); }
    .wrap{ max-width:1100px; margin:0 auto; padding:14px 14px 30px; }
    h1{ font-size:18px; margin:0 0 10px; }
    .bar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .card{ background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:12px; border:1px solid var(--line); }
    label{ font-size:12px; color:var(--muted); display:block; margin-bottom:4px; }
    input, textarea{ width:100%; padding:10px; border:1px solid var(--line); border-radius:10px; font-size:14px; background:#fff; }
    textarea{ min-height:92px; resize:vertical; }
    .btn{ appearance:none; border:0; border-radius:12px; padding:10px 12px; font-weight:700; cursor:pointer; background:var(--primary); color:#fff; }
    .btn.secondary{ background:#374151; }
    .btn.ghost{ background:#fff; color:var(--text); border:1px solid var(--line); }
    .btn.danger{ background:var(--danger); }
    .tabs{ display:flex; gap:8px; margin:10px 0 12px; }
    .tab{ padding:10px 12px; border-radius:999px; border:1px solid var(--line); background:#fff; cursor:pointer; font-weight:700; }
    .tab.active{ background:var(--primary); color:#fff; border-color:var(--primary); }
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 900px){ .grid{ grid-template-columns:1fr; } }

    .orders{ display:flex; flex-direction:column; gap:10px; margin-top:12px; }
    .order{ border:1px solid var(--line); border-radius:14px; background:#fff; padding:12px; box-shadow:var(--shadow); }
    .row{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between; }
    .meta{ font-size:12px; color:var(--muted); }
    .kpi{ display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; }
    .pill{ font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:#f9fafb; }
    .items{ margin-top:10px; border-top:1px dashed var(--line); padding-top:8px; white-space:pre-wrap; font-size:13px; }
    .addr{ margin-top:8px; padding:10px; background:#f9fafb; border:1px solid var(--line); border-radius:12px; white-space:pre-wrap; font-size:13px; }
    .printArea{ background:#fff; border:1px solid var(--line); border-radius:14px; padding:12px; }
    .printHead{ display:flex; justify-content:space-between; gap:10px; align-items:center; }
    .small{ font-size:12px; color:var(--muted); }
    .hr{ height:1px; background:var(--line); margin:10px 0; }
    .right{ text-align:right; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>管理（発送通知 / 注文明細）</h1>

    <div class="card">
      <div class="bar">
        <div style="min-width:260px; flex:1;">
          <label>管理トークン（ADMIN_API_TOKEN / ADMIN_CODE）</label>
          <input id="token" placeholder="例: xxxx" />
        </div>
        <div style="width:180px;">
          <label>日付（任意）</label>
          <input id="date" placeholder="YYYYMMDD 例: 20260103" />
        </div>
        <div>
          <label>&nbsp;</label>
          <button class="btn" id="loadBtn">注文を読み込む</button>
        </div>
        <div>
          <label>&nbsp;</label>
          <button class="btn ghost" id="printBtn">明細タブを印刷</button>
        </div>
        <div style="flex:1; min-width:260px;">
          <label>ステータス</label>
          <div id="status" class="small">未読み込み</div>
        </div>
      </div>

      <div class="tabs">
        <button class="tab active" id="tabShip">発送通知</button>
        <button class="tab" id="tabDetail">注文明細</button>
      </div>

      <!-- 発送通知タブ -->
      <div id="paneShip">
        <div class="small">注文を選んで、発送通知メッセージを送れます（LINE Push）。</div>
        <div id="ordersShip" class="orders"></div>
      </div>

      <!-- 注文明細タブ -->
      <div id="paneDetail" style="display:none;">
        <div class="small">印刷したい注文をここから選べます（右上「明細タブを印刷」）。</div>
        <div class="grid" style="margin-top:12px;">
          <div class="printArea">
            <div class="printHead">
              <div>
                <div style="font-weight:900;">注文明細</div>
                <div class="small" id="detailHint">左の一覧から選択してください</div>
              </div>
              <div class="small mono" id="detailId"></div>
            </div>
            <div class="hr"></div>
            <div id="detailBody" class="small">まだ選択されていません。</div>
          </div>
          <div class="printArea">
            <div style="font-weight:900;">注文一覧（クリックで表示）</div>
            <div class="hr"></div>
            <div id="ordersDetail" class="orders" style="margin-top:0;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);

  const state = {
    orders: [],
    selected: null
  };

  function yen(n){
    n = Number(n||0);
    return n.toLocaleString("ja-JP") + "円";
  }
  function toISO(ts){
    try { return new Date(ts).toLocaleString("ja-JP"); } catch { return String(ts||""); }
  }
  function itemLines(items){
    return (items||[]).map(it=>{
      const v = it.volume ? `（${it.volume}）` : "";
      return `・${it.name}${v} × ${it.qty}  @${yen(it.price)}`;
    }).join("\n");
  }
  function addrText(a){
    if(!a) return "";
    const l1 = `〒${a.postal||""} ${a.prefecture||""}${a.city||""}${a.address1||""} ${a.address2||""}`.trim();
    const l2 = `${a.name||""}`.trim();
    const l3 = a.phone ? `TEL:${a.phone}` : "";
    return [l2,l1,l3].filter(Boolean).join("\n");
  }

  async function apiGetOrders(){
    const token = $("token").value.trim();
    const date  = $("date").value.trim();
    if(!token){ $("status").textContent="トークンを入れてください"; return; }

    $("status").textContent = "読み込み中…";
    const url = "/api/admin/orders" + (date ? ("?date=" + encodeURIComponent(date)) : "");
    const r = await fetch(url, { headers: { "x-admin-token": token } });
    if(!r.ok){
      $("status").textContent = "読み込み失敗: " + r.status;
      return;
    }
    const data = await r.json();
    state.orders = (data && data.items) ? data.items : [];
    $("status").textContent = `OK: ${state.orders.length}件`;
    renderShip();
    renderDetailList();
    if(state.selected){
      const found = state.orders.find(o=>String(o.orderNumber)===String(state.selected.orderNumber));
      if(found) selectDetail(found);
    }
  }

  function renderShip(){
    const root = $("ordersShip");
    root.innerHTML = "";
    if(!state.orders.length){
      root.innerHTML = `<div class="small">注文がありません。</div>`;
      return;
    }
    state.orders.forEach(o=>{
      const cod = Number(o.codFee||0);
      const pay = (o.payment==="card") ? "カード" : "代引";
      const itemsText = itemLines(o.items);
      const addr = addrText(o.address);

      const template =
`発送が完了しました。
【注文ID】${o.orderNumber}
【お届け先】
${addr}

【内容】
${itemsText}

【商品合計】${yen(o.subtotal)}
【送料】${yen(o.shipping)}
${cod>0?`【代引手数料】${yen(cod)}\n`:""}【合計】${yen(o.finalTotal)}

追跡番号：XXXXXXXXXXXX
（ヤマト運輸）`;

      const el = document.createElement("div");
      el.className = "order";
      el.innerHTML = `
        <div class="row">
          <div>
            <div style="font-weight:900;">注文ID: ${o.orderNumber}</div>
            <div class="meta">${toISO(o.ts)} / ${pay} / ${o.region || ""}</div>
          </div>
          <div class="kpi">
            <span class="pill">小計 ${yen(o.subtotal)}</span>
            <span class="pill">送料 ${yen(o.shipping)}</span>
            ${cod>0?`<span class="pill">代引 ${yen(cod)}</span>`:""}
            <span class="pill">合計 ${yen(o.finalTotal)}</span>
          </div>
        </div>

        <div class="addr">${addr || "（住所情報なし）"}</div>
        <div class="items">${itemsText || "（明細なし）"}</div>

        <div style="margin-top:10px;">
          <label>発送通知メッセージ（編集可）</label>
          <textarea class="msg"></textarea>
          <div class="row" style="margin-top:8px;">
            <div class="small mono">送信先 userId: ${o.userId||""}</div>
            <div style="display:flex; gap:8px;">
              <button class="btn secondary copy">テンプレを入れる</button>
              <button class="btn send">この内容で送信</button>
            </div>
          </div>
        </div>
      `;
      const ta = el.querySelector("textarea.msg");
      const btnCopy = el.querySelector("button.copy");
      const btnSend = el.querySelector("button.send");
      btnCopy.onclick = ()=>{ ta.value = template; };
      btnSend.onclick = async ()=>{
        const token = $("token").value.trim();
        const msg = ta.value.trim();
        if(!msg){ alert("メッセージが空です"); return; }
        if(!token){ alert("トークンが必要です"); return; }
        const r = await fetch("/api/admin/orders/notify-shipped", {
          method:"POST",
          headers:{ "Content-Type":"application/json", "x-admin-token": token },
          body: JSON.stringify({ userId: o.userId, message: msg })
        });
        if(r.ok) alert("送信しました");
        else alert("送信失敗: " + r.status);
      };

      root.appendChild(el);
    });
  }

  function renderDetailList(){
    const root = $("ordersDetail");
    root.innerHTML = "";
    if(!state.orders.length){
      root.innerHTML = `<div class="small">注文がありません。</div>`;
      return;
    }
    state.orders.forEach(o=>{
      const cod = Number(o.codFee||0);
      const pay = (o.payment==="card") ? "カード" : "代引";
      const el = document.createElement("div");
      el.className = "order";
      el.style.cursor = "pointer";
      el.innerHTML = `
        <div class="row">
          <div>
            <div style="font-weight:900;">注文ID: ${o.orderNumber}</div>
            <div class="meta">${toISO(o.ts)} / ${pay} / ${o.region || ""}</div>
          </div>
          <div class="kpi">
            <span class="pill">小計 ${yen(o.subtotal)}</span>
            <span class="pill">送料 ${yen(o.shipping)}</span>
            ${cod>0?`<span class="pill">代引 ${yen(cod)}</span>`:""}
            <span class="pill">合計 ${yen(o.finalTotal)}</span>
          </div>
        </div>
      `;
      el.onclick = ()=>selectDetail(o);
      root.appendChild(el);
    });
  }

  function selectDetail(o){
    state.selected = o;
    $("detailHint").textContent = `${toISO(o.ts)} / ${o.payment==="card"?"カード":"代引"}`;
    $("detailId").textContent = "ORDER#" + o.orderNumber;

    const cod = Number(o.codFee||0);
    const addr = addrText(o.address);
    const itemsText = itemLines(o.items);

    $("detailBody").innerHTML = `
      <div style="font-weight:900; font-size:14px;">お届け先</div>
      <div class="addr" style="margin-top:6px;">${(addr||"（住所なし）").replaceAll("\n","<br>")}</div>

      <div class="hr"></div>

      <div style="font-weight:900; font-size:14px;">商品明細</div>
      <div class="items" style="margin-top:6px;">${(itemsText||"（明細なし）").replaceAll("\n","<br>")}</div>

      <div class="hr"></div>

      <div class="row">
        <div style="font-weight:900;">商品合計</div>
        <div class="right" style="font-weight:900;">${yen(o.subtotal)}</div>
      </div>
      <div class="row">
        <div style="font-weight:900;">送料</div>
        <div class="right" style="font-weight:900;">${yen(o.shipping)}</div>
      </div>
      ${cod>0?`
      <div class="row">
        <div style="font-weight:900;">代引手数料</div>
        <div class="right" style="font-weight:900;">${yen(cod)}</div>
      </div>`:""}
      <div class="hr"></div>
      <div class="row">
        <div style="font-weight:900; font-size:16px;">合計</div>
        <div class="right" style="font-weight:900; font-size:16px;">${yen(o.finalTotal)}</div>
      </div>
    `;
  }

  function showTab(which){
    const ship = $("tabShip"), det = $("tabDetail");
    const paneShip = $("paneShip"), paneDetail = $("paneDetail");
    if(which==="ship"){
      ship.classList.add("active"); det.classList.remove("active");
      paneShip.style.display="block"; paneDetail.style.display="none";
    }else{
      det.classList.add("active"); ship.classList.remove("active");
      paneDetail.style.display="block"; paneShip.style.display="none";
    }
  }

  $("tabShip").onclick = ()=>showTab("ship");
  $("tabDetail").onclick = ()=>showTab("detail");
  $("loadBtn").onclick = apiGetOrders;

  $("printBtn").onclick = ()=>{
    // 明細タブを表示して印刷
    showTab("detail");
    setTimeout(()=>window.print(), 50);
  };

})();
</script>
</body>
</html>
