<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>Flex配信 管理</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.5;margin:24px;max-width:1000px}
  h1{font-size:20px;margin:0 0 12px}
  fieldset{border:1px solid #ddd;border-radius:8px;padding:12px;margin:12px 0}
  label{display:block;margin:6px 0}
  input[type=text],textarea{width:100%;box-sizing:border-box;padding:8px;border:1px solid #ccc;border-radius:6px}
  textarea{height:160px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .row > *{flex:1 1 300px}
  .btn{padding:10px 16px;border-radius:8px;border:0;cursor:pointer}
  .btn-primary{background:#2563eb;color:#fff}
  .btn-secondary{background:#e5e7eb}
  .muted{color:#666;font-size:12px}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef;border:1px solid #cdd}
  .card{border:1px solid #eee;border-radius:10px;padding:10px;margin:6px 0}
  code{background:#f6f8fa;padding:2px 6px;border-radius:6px}
</style>
</head>
<body>
<h1>Flex配信 管理（products.json → 自動カルーセル）</h1>

<fieldset>
  <legend>認証</legend>
  <label>管理トークン（<code>ADMIN_API_TOKEN</code>）を入力
    <input type="text" id="token" placeholder="例: eyJhbGciOi... （保存されます）">
  </label>
  <div class="row">
    <button class="btn btn-secondary" id="saveToken">保存</button>
    <button class="btn btn-secondary" id="clearToken">削除</button>
    <span class="muted">※ Authorization: Bearer に乗せて管理APIへ送信します。</span>
  </div>
</fieldset>

<fieldset>
  <legend>商品読み込み</legend>
  <div class="row">
    <button class="btn btn-secondary" id="loadProducts">/api/admin/products を読み込む</button>
    <label style="align-self:center"><input type="checkbox" id="hideKusuke" checked> 久助（<code>kusuke-250</code>）を一覧から除外</label>
  </div>
  <div id="prodCount" class="muted"></div>
  <div id="prodList"></div>
</fieldset>

<fieldset>
  <legend>Flex 自動生成</legend>
  <div class="row">
    <label>altText
      <input type="text" id="altText" value="商品一覧">
    </label>
    <label>1メッセージの最大バブル数
      <input type="text" id="chunkSize" value="10">
    </label>
  </div>
  <div class="row">
    <button class="btn btn-secondary" id="buildFlex">カルーセルを生成</button>
    <span class="muted">※ 端末/サイズ制限に備えて分割送信できます。</span>
  </div>
  <label>生成結果（送信プレビュー・編集可）
    <textarea id="flexOut"></textarea>
  </label>
</fieldset>

<fieldset>
  <legend>配信</legend>
  <div class="row">
    <label>送信先ユーザーID（改行区切り、空なら <span class="pill">broadcast</span>）
      <textarea id="userIds" placeholder="Uxxxxxxxxx...&#10;Uyyyyyyyyy..."></textarea>
    </label>
  </div>
  <div class="row">
    <button class="btn btn-primary" id="sendNow">送信</button>
    <span class="muted">※ 空欄＝全体配信（broadcast）。値あり＝指定ユーザー配信（multicast）。</span>
  </div>
  <div id="sendResult" class="card muted"></div>
</fieldset>

<fieldset>
  <legend>ヘルスチェック</legend>
  <div class="row">
    <button class="btn btn-secondary" id="ping">/api/admin/ping</button>
  </div>
  <pre id="pingOut" class="card"></pre>
</fieldset>

<script>
const $ = sel => document.querySelector(sel);

function saveToken(){ localStorage.setItem('adminToken', $('#token').value.trim()); alert('保存しました'); }
function loadToken(){ $('#token').value = localStorage.getItem('adminToken') || ''; }
function clearToken(){ localStorage.removeItem('adminToken'); $('#token').value=''; }

async function call(path, method='GET', body){
  const token = ($('#token').value || '').trim();
  const opt = { method, headers: {'Content-Type':'application/json'} };
  if (token) opt.headers['Authorization'] = 'Bearer ' + token;
  if (body) opt.body = JSON.stringify(body);
  const r = await fetch(path, opt);
  const txt = await r.text();
  let data;
  try{ data = JSON.parse(txt); }catch{ data = { raw: txt }; }
  if (!r.ok) throw { status:r.status, data };
  return data;
}

let loadedProducts = [];

function productToBubble(p){
  return {
    type: "bubble",
    body: {
      type: "box", layout: "vertical", spacing: "sm",
      contents: [
        { type: "text", text: p.name, weight: "bold", size: "md", wrap: true },
        { type: "text", text: `価格：${(p.price||0).toLocaleString('ja-JP')}円　在庫：${p.stock ?? 0}`, size: "sm", wrap: true },
        p.desc ? { type: "text", text: p.desc, size: "sm", wrap: true } : { type: "box", layout: "vertical", contents: [] }
      ]
    },
    footer: {
      type: "box", layout: "horizontal", spacing: "md",
      contents: [
        { type: "button", style: "primary",
          action: { type: "postback", label: "数量を選ぶ", data: `order_qty?id=${encodeURIComponent(p.id)}&qty=1` } }
      ]
    }
  };
}

function chunk(array, size){ const out=[]; for(let i=0;i<array.length;i+=size) out.push(array.slice(i,i+Number(size))); return out; }

async function onLoadProducts(){
  try{
    const res = await call('/api/admin/products');
    loadedProducts = res.items || [];
    const hide = $('#hideKusuke').checked;
    const visible = hide ? loadedProducts.filter(p=>p.id!=='kusuke-250') : loadedProducts.slice();
    $('#prodCount').textContent = `読み込み: 全${loadedProducts.length}件 / 表示${visible.length}件`;
    $('#prodList').innerHTML = visible.map(p=>(
      `<div class="card"><strong>${p.name}</strong> <span class="muted">(${p.id})</span><br>価格: ${p.price} / 在庫: ${p.stock}<br><span class="muted">${(p.desc||'').replace(/</g,'&lt;')}</span></div>`
    )).join('');
  }catch(e){
    alert('読み込み失敗: ' + (e.data?.error || e.status));
  }
}

function onBuildFlex(){
  const hide = $('#hideKusuke').checked;
  const visible = hide ? loadedProducts.filter(p=>p.id!=='kusuke-250') : loadedProducts.slice();
  const bubbles = visible.map(productToBubble);
  // 「その他（自由入力）」は配信用には通常不要なので追加しない
  const chunkSize = Math.max(1, parseInt($('#chunkSize').value || '10', 10));
  const groups = chunk(bubbles, chunkSize);
  const msgs = groups.map(g => ({
    type: "flex",
    altText: ($('#altText').value || '商品一覧').slice(0,400),
    contents: g.length === 1 ? g[0] : { type:"carousel", contents: g }
  }));
  $('#flexOut').value = JSON.stringify(msgs, null, 2);
}

async function onSend(){
  const payloadText = $('#flexOut').value.trim();
  if (!payloadText) return alert('先に「カルーセルを生成」してください。');
  let msgs;
  try{ msgs = JSON.parse(payloadText); }catch{ return alert('JSONの形式が不正です'); }
  if (!Array.isArray(msgs)) msgs = [msgs];

  const ids = ($('#userIds').value || '').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  try{
    let res;
    if (ids.length === 0){
      // 全体配信: 1メッセージずつ broadcast
      for (const m of msgs){
        res = await call('/api/admin/broadcast-flex', 'POST', { altText: m.altText, contents: m.contents });
      }
    }else{
      // 指定ユーザー: まとめて multicast
      // LINEの上限の都合で 500件ずつに分けるのはサーバ側実装（/api/admin/segment/send-flex）
      // フロント側は最初のメッセージだけ送る（分割済みmsgsを逐次送信）
      for (const m of msgs){
        res = await call('/api/admin/segment/send-flex', 'POST', { userIds: ids, altText: m.altText, contents: m.contents });
      }
    }
    $('#sendResult').textContent = JSON.stringify(res, null, 2);
    alert('送信リクエストを受け付けました。');
  }catch(e){
    $('#sendResult').textContent = JSON.stringify(e.data || e, null, 2);
    alert('送信エラー: ' + (e.data?.error || e.status));
  }
}

async function onPing(){
  try{
    const res = await call('/api/admin/ping');
    $('#pingOut').textContent = JSON.stringify(res, null, 2);
  }catch(e){
    $('#pingOut').textContent = JSON.stringify(e.data || e, null, 2);
  }
}

$('#saveToken').onclick = saveToken;
$('#clearToken').onclick = clearToken;
$('#loadProducts').onclick = onLoadProducts;
$('#buildFlex').onclick = onBuildFlex;
$('#sendNow').onclick = onSend;
$('#ping').onclick = onPing;
loadToken();
</script>
</body>
</html>
HTML
